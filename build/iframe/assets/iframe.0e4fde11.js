const Hc=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerpolicy&&(r.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?r.credentials="include":i.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}};Hc();class Ce extends Error{get name(){return"AbortError"}}class bi{constructor(){this._handlers=new Set}onSubscribeFirst(){}onUnsubscribeLast(){}subscribe(e){return this._handlers.add(e),this._handlers.size===1&&this.onSubscribeFirst(),()=>this.unsubscribe(e)}unsubscribe(e){e&&(this._handlers.delete(e),this._handlers.size===0&&this.onUnsubscribeLast())}unsubscribeAll(){this._handlers.size!==0&&(this._handlers.clear(),this.onUnsubscribeLast())}get hasSubscriptions(){return this._handlers.size!==0}}class Oe extends bi{emit(e){for(const t of this._handlers)t(e)}waitFor(e){return e(this.get())?new Gc(Promise.resolve(this.get())):new zc(this,e)}flatMap(e){return new or(this,e)}}class zc{constructor(e,t){this._promise=new Promise((s,i)=>{this._reject=i,this._subscription=e.subscribe(r=>{t(r)&&(this._reject=null,s(r),this.dispose())})})}get promise(){return this._promise}dispose(){this._subscription&&(this._subscription(),this._subscription=null),this._reject&&(this._reject(new Ce),this._reject=null)}}class Gc{constructor(e){this.promise=e}dispose(){}}class Jc extends Oe{constructor(e,t){super(),this.value=e,this.eventName=t}onSubscribeFirst(){this.eventSubscription=this.value.disposableOn(this.eventName,()=>{this.emit(this.value)}),super.onSubscribeFirst()}onUnsubscribeLast(){this.eventSubscription(),super.onUnsubscribeLast()}get(){return this.value}}class Te extends Oe{constructor(e){super(),this._value=e}get(){return this._value}set(e){e!==this._value&&(this._value=e,this.emit(this._value))}}class or extends Oe{constructor(e,t){super(),this.source=e,this.mapper=t}onUnsubscribeLast(){super.onUnsubscribeLast(),this.sourceSubscription=this.sourceSubscription(),this.targetSubscription&&(this.targetSubscription=this.targetSubscription())}onSubscribeFirst(){super.onSubscribeFirst(),this.sourceSubscription=this.source.subscribe(()=>{this.updateTargetSubscription(),this.emit(this.get())}),this.updateTargetSubscription()}updateTargetSubscription(){const e=this.source.get();if(e){const t=this.mapper(e);if(t){this.targetSubscription||(this.targetSubscription=t.subscribe(()=>this.emit(this.get())));return}}this.targetSubscription&&(this.targetSubscription=this.targetSubscription())}get(){const e=this.source.get();return e?this.mapper(e)?.get():void 0}}function Qc(n,e){return e<n}class Yc extends Oe{constructor(e,t=Qc){super(),this.map=e,this.pickKey=t}updateKey(e){return this.key===void 0||this.pickKey(this.key,e)?(this.key=e,!0):!1}onReset(){this.key=void 0,this.emit(this.get())}onAdd(e,t){this.updateKey(e)&&this.emit(this.get())}onUpdate(e,t,s){this.emit(this.get())}onRemove(e,t){if(e===this.key){this.key=void 0;for(const[s]of this.map)this.updateKey(s);this.emit(this.get())}}onSubscribeFirst(){this.mapSubscription=this.map.subscribe(this);for(const[e]of this.map)this.updateKey(e)}onUnsubscribeLast(){this.mapSubscription(),this.key=void 0}get(){if(this.key!==void 0)return this.map.get(this.key)}}class ci extends Te{constructor(e,t,s=()=>{}){super(e),this.freeCallback=t,this.startCallback=s}onSubscribeFirst(){this.startCallback()}onUnsubscribeLast(){super.onUnsubscribeLast(),this.freeCallback()}}class Xt extends bi{emitReset(){for(let e of this._handlers)e.onReset(this)}emitAdd(e,t){for(let s of this._handlers)s.onAdd(e,t,this)}emitUpdate(e,t,s){for(let i of this._handlers)i.onUpdate(e,t,s,this)}emitRemove(e,t){for(let s of this._handlers)s.onRemove(e,t,this)}emitMove(e,t,s){for(let i of this._handlers)i.onMove(e,t,s,this)}}/**
 * @license
 * Based off baseSortedIndex function in Lodash <https://lodash.com/>
 * Copyright JS Foundation and other contributors <https://js.foundation/>
 * Released under MIT license <https://lodash.com/license>
 * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
 * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
 */function ze(n,e,t){let s=0,i=n.length;for(;s<i;){let r=s+i>>>1,o=t(e,n[r]);o>0?s=r+1:o<0?i=r:s=i=r}return i}class Bo extends Xt{constructor(e=[]){super(),this._items=e}append(e){this._items.push(e),this.emitAdd(this._items.length-1,e)}remove(e){const[t]=this._items.splice(e,1);this.emitRemove(e,t)}insertMany(e,t){for(let s of t)this.insert(e,s),e+=1}insert(e,t){this._items.splice(e,0,t),this.emitAdd(e,t)}move(e,t){if(e<this._items.length&&t<this._items.length){const[s]=this._items.splice(e,1);this._items.splice(t,0,s),this.emitMove(e,t,s)}}update(e,t,s=null){e<this._items.length&&(this._items[e]=t,this.emitUpdate(e,t,s))}get array(){return this._items}at(e){if(this._items&&e>=0&&e<this._items.length)return this._items[e]}get length(){return this._items.length}[Symbol.iterator](){return this._items.values()}}function Ko(n,e,t,s){const i=e.findIndex(n);if(i!==-1){const r=e[i],o=s(r);return o!==!1&&t.emitUpdate(i,r,o),!0}return!1}class Ar extends Xt{constructor(e){super(),this._items=[],this._comparator=e}setManyUnsorted(e){this.setManySorted(e)}setManySorted(e){for(let t of e)this.set(t)}findAndUpdate(e,t){return Ko(e,this._items,this,t)}getAndUpdate(e,t,s=null){const i=this.indexOf(e);if(i!==-1){const r=this._items[i],o=t(r,e);this._items[i]=o,this.emitUpdate(i,o,s)}}update(e,t=null){const s=this.indexOf(e);s!==-1&&(this._items[s]=e,this.emitUpdate(s,e,t))}indexOf(e){const t=ze(this._items,e,this._comparator);return t<this._items.length&&this._comparator(this._items[t],e)===0?t:-1}_getNext(e){let t=ze(this._items,e,this._comparator);for(;t<this._items.length&&this._comparator(this._items[t],e)<=0;)t+=1;return this.get(t)}set(e,t=null){const s=ze(this._items,e,this._comparator);s>=this._items.length||this._comparator(this._items[s],e)!==0?(this._items.splice(s,0,e),this.emitAdd(s,e)):(this._items[s]=e,this.emitUpdate(s,e,t))}get(e){return this._items[e]}remove(e){const t=this._items[e];this._items.splice(e,1),this.emitRemove(e,t)}get array(){return this._items}get length(){return this._items.length}[Symbol.iterator](){return new Xc(this)}}class Xc{constructor(e){this._consumed=!1,this._sortedArray=e,this._current=null}next(){return this._consumed?{value:void 0,done:!0}:(this._current=this._current?this._sortedArray._getNext(this._current):this._sortedArray.get(0),this._current||(this._consumed=!0),{value:this._current,done:this._consumed})}}class Zc extends Xt{constructor(e,t,s,i){super(),this._sourceUnsubscribe=null,this._mappedValues=null,this._sourceList=e,this._mapper=t,this._updater=s,this._removeCallback=i}findAndUpdate(e,t){return Ko(e,this._mappedValues,this,t)}get length(){return this._mappedValues.length}[Symbol.iterator](){return this._mappedValues.values()}}function el(n,e,t){n._mappedValues.splice(e,0,t),n.emitAdd(e,t)}function tl(n,e,t,s){const i=n._mappedValues[e];n._updater&&n._updater(i,s,t),n.emitUpdate(e,i,s)}function sl(n,e){const t=n._mappedValues[e];n._mappedValues.splice(e,1),n._removeCallback&&n._removeCallback(t),n.emitRemove(e,t)}function il(n,e,t){const s=n._mappedValues[e];n._mappedValues.splice(e,1),n._mappedValues.splice(t,0,s),n.emitMove(e,t,s)}function rl(n){n._mappedValues=[],n.emitReset()}class nl extends Zc{constructor(){super(...arguments),this._eventQueue=null,this._flushing=!1}onSubscribeFirst(){this._sourceUnsubscribe=this._sourceList.subscribe(this),this._eventQueue=[],this._mappedValues=[];let e=0;for(const t of this._sourceList)this._eventQueue.push(new xn(e,t)),e+=1;this._flush()}async _flush(){if(!this._flushing){this._flushing=!0;try{for(;this._eventQueue.length;)await this._eventQueue.shift().run(this)}finally{this._flushing=!1}}}onReset(){this._eventQueue&&(this._eventQueue.push(new ll),this._flush())}onAdd(e,t){this._eventQueue&&(this._eventQueue.push(new xn(e,t)),this._flush())}onUpdate(e,t,s){this._eventQueue&&(this._eventQueue.push(new ol(e,t,s)),this._flush())}onRemove(e){this._eventQueue&&(this._eventQueue.push(new al(e)),this._flush())}onMove(e,t){this._eventQueue&&(this._eventQueue.push(new cl(e,t)),this._flush())}onUnsubscribeLast(){this._sourceUnsubscribe(),this._eventQueue=null,this._mappedValues=null}}class xn{constructor(e,t){this.index=e,this.value=t}async run(e){const t=await e._mapper(this.value);el(e,this.index,t)}}class ol{constructor(e,t,s){this.index=e,this.value=t,this.params=s}async run(e){tl(e,this.index,this.value,this.params)}}class al{constructor(e){this.index=e}async run(e){sl(e,this.index)}}class cl{constructor(e,t){this.fromIdx=e,this.toIdx=t}async run(e){il(e,this.fromIdx,this.toIdx)}}class ll{async run(e){rl(e)}}class hl extends Xt{constructor(...e){super(),this._sourceUnsubscribes=null,this._sourceLists=e}_offsetForSource(e){const t=this._sourceLists.indexOf(e);let s=0;for(let i=0;i<t;++i)s+=this._sourceLists[i].length;return s}onSubscribeFirst(){this._sourceUnsubscribes=this._sourceLists.map(e=>e.subscribe(this))}onUnsubscribeLast(){for(const e of this._sourceUnsubscribes)e()}onReset(){this.emitReset();let e=0;for(const t of this)this.emitAdd(e,t),e+=1}onAdd(e,t,s){this.emitAdd(this._offsetForSource(s)+e,t)}onUpdate(e,t,s,i){!this._sourceUnsubscribes||this.emitUpdate(this._offsetForSource(i)+e,t,s)}onRemove(e,t,s){this.emitRemove(this._offsetForSource(s)+e,t)}onMove(e,t,s,i){const r=this._offsetForSource(i);this.emitMove(r+e,r+t,s)}get length(){let e=0;for(let t=0;t<this._sourceLists.length;++t)e+=this._sourceLists[t].length;return e}[Symbol.iterator](){let e=0,t=this._sourceLists[0][Symbol.iterator]();return{next:()=>{let s=t.next();for(;s.done;){if(e+=1,e>=this._sourceLists.length)return s;t=this._sourceLists[e][Symbol.iterator](),s=t.next()}return s}}}}class dl extends Xt{constructor(e,t){super(),this._sourceMap=e,this._comparator=(s,i)=>t(s.value,i.value),this._sortedPairs=null,this._mapSubscription=null}onAdd(e,t){const s={key:e,value:t},i=ze(this._sortedPairs,s,this._comparator);this._sortedPairs.splice(i,0,s),this.emitAdd(i,t)}onRemove(e,t){const s={key:e,value:t},i=ze(this._sortedPairs,s,this._comparator);this._sortedPairs.splice(i,1),this.emitRemove(i,t)}onUpdate(e,t,s){if(!this._sortedPairs)return;const i=this._sortedPairs.findIndex(a=>a.key===e);this._sortedPairs.splice(i,1);const r={key:e,value:t},o=ze(this._sortedPairs,r,this._comparator);this._sortedPairs.splice(o,0,r),i!==o&&this.emitMove(i,o,t),this.emitUpdate(o,t,s)}onReset(){this._sortedPairs=[],this.emitReset()}onSubscribeFirst(){this._mapSubscription=this._sourceMap.subscribe(this),this._sortedPairs=new Array(this._sourceMap.size);let e=0;for(let[t,s]of this._sourceMap)this._sortedPairs[e]={key:t,value:s},++e;this._sortedPairs.sort(this._comparator),super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._sortedPairs=null,this._mapSubscription=this._mapSubscription()}get(e){return this._sortedPairs[e].value}get length(){return this._sourceMap.size}[Symbol.iterator](){const e=this._sortedPairs.values();return{next(){const t=e.next();return t.value&&(t.value=t.value.value),t}}}}class Zt extends bi{constructor(){super()}emitReset(){for(let e of this._handlers)e.onReset()}emitAdd(e,t){for(let s of this._handlers)s.onAdd(e,t)}emitUpdate(e,t,s){for(let i of this._handlers)i.onUpdate(e,t,s)}emitRemove(e,t){for(let s of this._handlers)s.onRemove(e,t)}join(...e){return new _l([this].concat(e))}mapValues(e,t){return new yl(this,e,t)}sortValues(e){return new dl(this,e)}filterValues(e){return new ml(this,e)}observeSize(){return new vl(this)}}class ul extends Zt{constructor(e,t){super(),this._source=e,this._apply=t}hasApply(){return!!this._apply}setApply(e){this._apply=e,this._apply&&this.applyOnce(this._apply)}applyOnce(e){for(const[t,s]of this._source)e(t,s)}onAdd(e,t){this._apply&&this._apply(e,t),this.emitAdd(e,t)}onRemove(e,t){this.emitRemove(e,t)}onUpdate(e,t,s){this._apply&&this._apply(e,t,s),this.emitUpdate(e,t,s)}onSubscribeFirst(){this._subscription=this._source.subscribe(this),this._apply&&this.applyOnce(this._apply),super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._subscription&&(this._subscription=this._subscription())}onReset(){this._apply&&this.applyOnce(this._apply),this.emitReset()}[Symbol.iterator](){return this._source[Symbol.iterator]()}get size(){return this._source.size}get(e){return this._source.get(e)}}class ml extends Zt{constructor(e,t){super(),this._source=e,this._filter=t}setFilter(e){this._filter=e,this._subscription&&this._reapplyFilter()}_reapplyFilter(e=!1){if(this._filter){const t=this._included;this._included=this._included||new Map;for(const[s,i]of this._source){const r=this._filter(i,s);if(this._included.set(s,r),!e){const o=t?t.get(s):!0;this._emitForUpdate(o,r,s,i)}}}else{if(this._included&&!e)for(const[t,s]of this._source)this._included.get(t)||this.emitAdd(t,s);this._included=void 0}}onAdd(e,t){if(this._filter)if(this._included){const s=this._filter(t,e);if(this._included.set(e,s),!s)return}else throw new Error("Internal logic error: FilteredMap._included used before initialized");this.emitAdd(e,t)}onRemove(e,t){const s=!this._filter||this._included?.get(e);if(this._included)this._included.delete(e),s&&this.emitRemove(e,t);else throw new Error("Internal logic error: FilteredMap._included used before initialized")}onUpdate(e,t,s){if(!!this._included)if(this._filter){const i=this._included.get(e),r=this._filter(t,e);this._included.set(e,r),this._emitForUpdate(i,r,e,t,s)}else this.emitUpdate(e,t,s)}_emitForUpdate(e,t,s,i,r=null){e&&!t?this.emitRemove(s,i):!e&&t?this.emitAdd(s,i):e&&t&&this.emitUpdate(s,i,r)}onSubscribeFirst(){this._subscription=this._source.subscribe(this),this._reapplyFilter(!0),super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._included=void 0,this._subscription&&(this._subscription=this._subscription())}onReset(){this._reapplyFilter(),this.emitReset()}[Symbol.iterator](){return new pl(this._source,this._included)}get size(){let e=0;return this._included?.forEach(t=>{t&&(e+=1)}),e}get(e){const t=this._source.get(e);if(t&&this._filter(t,e))return t}}class pl{constructor(e,t){this._included=t,this._sourceIterator=e[Symbol.iterator]()}next(){for(;;){const e=this._sourceIterator.next();if(e.done)return e;const t=e.value[0];if(this._included?.get(t))return e}}}class _l extends Zt{constructor(e){super(),this._sources=e}onAdd(e,t,s){if(!this._isKeyAtSourceOccluded(e,t)){const i=this._getValueFromOccludedSources(e,t);i!==void 0&&this.emitRemove(t,i),this.emitAdd(t,s)}}onRemove(e,t,s){if(!this._isKeyAtSourceOccluded(e,t)){this.emitRemove(t,s);const i=this._getValueFromOccludedSources(e,t);i!==void 0&&this.emitAdd(t,i)}}onUpdate(e,t,s,i){!this._subscriptions||this._isKeyAtSourceOccluded(e,t)||this.emitUpdate(t,s,i)}onReset(){this.emitReset()}onSubscribeFirst(){this._subscriptions=this._sources.map(e=>new fl(e,this).subscribe()),super.onSubscribeFirst()}_isKeyAtSourceOccluded(e,t){const s=this._sources.indexOf(e);for(let i=0;i<s;i+=1)if(this._sources[i].get(t)!==void 0)return!0;return!1}_getValueFromOccludedSources(e,t){const s=this._sources.indexOf(e);for(let i=s+1;i<this._sources.length;i+=1){const o=this._sources[i].get(t);if(o!==void 0)return o}}onUnsubscribeLast(){if(super.onUnsubscribeLast(),this._subscriptions)for(const e of this._subscriptions)e.dispose()}[Symbol.iterator](){return new gl(this._sources)}get size(){return this._sources.reduce((e,t)=>e+t.size,0)}get(e){for(const t of this._sources){const s=t.get(e);if(s)return s}}}class gl{constructor(e){this._sourceIndex=-1,this._encounteredKeys=new Set,this._sources=e}next(){let e;for(;!e;){if(!this._currentIterator){if(this._sourceIndex+=1,this._sources.length<=this._sourceIndex)return{done:!0,value:null};this._currentIterator=this._sources[this._sourceIndex][Symbol.iterator]()}const t=this._currentIterator?.next();if(!t||t.done){this._currentIterator=void 0;continue}else{const s=t.value[0];this._encounteredKeys.has(s)||(this._encounteredKeys.add(s),e=t)}}return e}}class fl{constructor(e,t){this._source=e,this._joinedMap=t,this._subscription=void 0}subscribe(){return this._subscription=this._source.subscribe(this),this}dispose(){this._subscription&&(this._subscription=this._subscription())}onAdd(e,t){this._joinedMap.onAdd(this._source,e,t)}onRemove(e,t){this._joinedMap.onRemove(this._source,e,t)}onUpdate(e,t,s){this._joinedMap.onUpdate(this._source,e,t,s)}onReset(){this._joinedMap.onReset()}}class yl extends Zt{constructor(e,t,s){super(),this._source=e,this._mapper=t,this._updater=s,this._mappedValues=new Map}_emitSpontaneousUpdate(e,t){const s=this._mappedValues.get(e);s&&this.emitUpdate(e,s,t)}onAdd(e,t){const s=this._emitSpontaneousUpdate.bind(this,e),i=this._mapper(t,s);this._mappedValues.set(e,i),this.emitAdd(e,i)}onRemove(e){const t=this._mappedValues.get(e);this._mappedValues.delete(e)&&t&&this.emitRemove(e,t)}onUpdate(e,t,s){if(!this._mappedValues)return;const i=this._mappedValues.get(e);i!==void 0&&(this._updater?.(s,i,t),this.emitUpdate(e,i,s))}onSubscribeFirst(){this._subscription=this._source.subscribe(this);for(let[e,t]of this._source){const s=this._emitSpontaneousUpdate.bind(this,e),i=this._mapper(t,s);this._mappedValues.set(e,i)}super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._subscription&&(this._subscription=this._subscription()),this._mappedValues.clear()}onReset(){this._mappedValues.clear(),this.emitReset()}[Symbol.iterator](){return this._mappedValues.entries()}get size(){return this._mappedValues.size}get(e){return this._mappedValues.get(e)}}class ct extends Zt{constructor(e){super(),this._values=new Map(e)}update(e,t){const s=this._values.get(e);return s!==void 0?(this._values.set(e,s),this.emitUpdate(e,s,t),!0):!1}add(e,t){return this._values.has(e)?!1:(this._values.set(e,t),this.emitAdd(e,t),!0)}remove(e){const t=this._values.get(e);return t!==void 0?(this._values.delete(e),this.emitRemove(e,t),!0):!1}set(e,t){return this._values.has(e)?(this._values.set(e,t),this.update(e,void 0)):this.add(e,t)}reset(){this._values.clear(),this.emitReset()}get(e){return this._values.get(e)}get size(){return this._values.size}[Symbol.iterator](){return this._values.entries()}values(){return this._values.values()}keys(){return this._values.keys()}}class wl extends Zt{constructor(e,t){super(),this.key=e,this.observableValue=t}onSubscribeFirst(){this.subscription=this.observableValue.subscribe(e=>{this.emitUpdate(this.key,e,void 0)}),super.onSubscribeFirst()}onUnsubscribeLast(){this.subscription(),super.onUnsubscribeLast()}*[Symbol.iterator](){yield[this.key,this.observableValue.get()]}get size(){return 1}get(e){if(e==this.key)return this.observableValue.get()}}class vl extends Oe{constructor(e){super(),this.map=e}onSubscribeFirst(){this.subscription=this.map.subscribe({onAdd:(e,t)=>{this.emit(this.get())},onRemove:(e,t)=>{this.emit(this.get())},onUpdate:(e,t)=>{},onReset:()=>{this.emit(this.get())}})}onUnsubscribeLast(){this.subscription=this.subscription?.()}get(){return this.map.size}}class bl{constructor(e){this._observables=new Map,this._allowsChild=e,this._path=new je([],e),this._pathObservable=new Te(this._path)}get pathObservable(){return this._pathObservable}get path(){return this._path}push(e,...t){const s=this.path.with(new pe(e,...t));s&&this.applyPath(s)}applyPath(e){const t=this._path;this._path=e;for(let s=t.segments.length-1;s>=0;s-=1){const i=t.segments[s];this._path.get(i.type)||this._observables.get(i.type)?.emitIfChanged()}for(const s of this._path.segments)this._observables.get(s.type)?.emitIfChanged();this._pathObservable.set(this._path)}observe(e){let t=this._observables.get(e);return t||(t=new Il(this,e),this._observables.set(e,t)),t}pathFrom(e){let t,s;for(s=0;s<e.length;s+=1){if(!this._allowsChild(t,e[s]))return new je(e.slice(0,s),this._allowsChild);t=e[s]}return new je(e,this._allowsChild)}segment(e,...t){return new pe(e,...t)}}function Sl(n,e){if(n===e)return!0;if(Array.isArray(n)&&Array.isArray(e)){const t=Math.max(n.length,e.length);for(let s=0;s<t;s+=1)if(n[s]!==e[s])return!1;return!0}return!1}class pe{constructor(e,...t){this.type=e,this.value=t[0]===void 0?!0:t[0]}}class je{constructor(e=[],t){this._segments=e,this._allowsChild=t}clone(){return new je(this._segments.slice(),this._allowsChild)}with(e){let t=this._segments.length-1;do{if(this._allowsChild(this._segments[t],e)){const s=this._segments.slice(0,t+1);return s.push(e),new je(s,this._allowsChild)}t-=1}while(t>=-1)}until(e){const t=this._segments.findIndex(s=>s.type===e);return t!==-1?new je(this._segments.slice(0,t+1),this._allowsChild):new je([],this._allowsChild)}get(e){return this._segments.find(t=>t.type===e)}replace(e){const t=this._segments.findIndex(s=>s.type===e.type);if(t!==-1){const s=this._segments[t-1];if(this._allowsChild(s,e)){const i=this._segments[t+1];if(!i||this._allowsChild(e,i)){const r=this._segments.slice();return r[t]=e,new je(r,this._allowsChild)}}}}get segments(){return this._segments}}class Il extends Oe{constructor(e,t){super(),this._navigation=e,this._type=t,this._lastSetValue=e.path.get(t)?.value}get(){return this._navigation.path.get(this._type)?.value}emitIfChanged(){const e=this.get();Sl(e,this._lastSetValue)||(this._lastSetValue=e,this.emit(e))}}class Rl{constructor(e,t,s,i){this._isApplyingUrl=!1,this._history=e,this._navigation=t,this._parseUrlPath=s,this._stringifyPath=i,this._defaultSessionId=this._getLastSessionId()}_getLastSessionId(){const t=this._urlAsNavPath(this._history.getLastSessionUrl()||"").get("session")?.value;if(typeof t=="string")return t}attach(){this._subscription=this._history.subscribe(e=>this._applyUrl(e)),this._pathSubscription=this._navigation.pathObservable.subscribe(e=>this._applyNavPathToHistory(e)),this._applyUrl(this._history.get())}dispose(){this._subscription&&(this._subscription=this._subscription()),this._pathSubscription&&(this._pathSubscription=this._pathSubscription())}_applyNavPathToHistory(e){const t=this.urlForPath(e);t!==this._history.get()&&(this._isApplyingUrl?this._history.replaceUrlSilently(t):this._history.pushUrlSilently(t))}_applyNavPathToNavigation(e){this._isApplyingUrl=!0,this._navigation.applyPath(e),this._isApplyingUrl=!1}_urlAsNavPath(e){const t=this._history.urlAsPath(e);return this._navigation.pathFrom(this._parseUrlPath(t,this._navigation.path,this._defaultSessionId))}_applyUrl(e){const t=this._urlAsNavPath(e);this._applyNavPathToNavigation(t)}pushUrl(e){this._history.pushUrl(e)}tryRestoreLastUrl(){const e=this._urlAsNavPath(this._history.getLastSessionUrl()||"");return e.segments.length!==0?(this._applyNavPathToNavigation(e),!0):!1}urlForSegments(e){let t=this._navigation.path;for(const s of e)if(t=t.with(s),!t)return;return this.urlForPath(t)}urlForSegment(e,...t){return this.urlForSegments([this._navigation.segment(e,...t)])}urlUntilSegment(e){return this.urlForPath(this._navigation.path.until(e))}urlForPath(e){return this._history.pathAsUrl(this._stringifyPath(e))}openRoomActionUrl(e){const t=`${this._stringifyPath(this._navigation.path.until("session"))}/open-room/${encodeURIComponent(e)}`;return this._history.pathAsUrl(t)}createSSOCallbackURL(){return window.location.href}normalizeUrl(){const e=new URL(window.location.href);e.searchParams.delete("loginToken"),this._history.replaceUrlSilently(e.toString())}}function kl(){return new bl(El)}function El(n,e){const{type:t}=e;switch(n?.type){case void 0:return t==="login"||t==="session"||t==="sso"||t==="logout";case"session":return t==="room"||t==="rooms"||t==="settings"||t==="create-room"||t==="join-room";case"rooms":return t==="room"||t==="empty-grid-tile";case"room":return t==="lightbox"||t==="right-panel";case"right-panel":return t==="details"||t==="members"||t==="member";case"logout":return t==="forced";default:return!1}}function Ml(n,e,t){if(n.value.includes(e))return n;{const s=t.get("empty-grid-tile"),i=t.get("room");let r=0;s?r=s.value:i&&(r=n.value.indexOf(i.value));const o=n.value.slice();return o[r]=e,new pe("rooms",o)}}function Nn(n,e,...t){n.push(new pe("right-panel")),n.push(new pe(e,...t))}function ar(n,e){const t=n.path.segments,s=t.findIndex(r=>r.type==="right-panel");let i=e;return s!==-1&&(i=e.until("room"),i=i.with(t[s]),i=i.with(t[s+1])),i}function Cl(n,e,t){const s=n.substring(1).split("/"),i=s[Symbol.iterator](),r=[];let o;for(;!(o=i.next()).done;){const a=o.value;if(a==="rooms"){const c=i.next().value;if(c===void 0)break;const l=c.split(",").map(u=>decodeURIComponent(u));r.push(new pe(a,l));const h=parseInt(i.next().value||"0",10),d=l[h];d?r.push(new pe("room",d)):r.push(new pe("empty-grid-tile",h))}else if(a==="open-room"){let c=i.next().value;if(!c)break;c=decodeURIComponent(c);const l=e.get("rooms");if(l&&r.push(Ml(l,c,e)),r.push(new pe("room",c)),s.findIndex(u=>u==="open-room")>=s.length-2){const u=e.segments,p=u.findIndex(_=>_.type==="right-panel");p!==-1&&r.push(...u.slice(p))}}else if(a==="last-session"){let c=e.get("session");typeof c?.value!="string"&&t&&(c=new pe("session",t)),c&&r.push(c)}else if(a==="details"||a==="members")Nn(r,a);else if(a==="member"){let c=i.next().value;if(!c)break;c=decodeURIComponent(c),Nn(r,a,c)}else if(a.includes("loginToken")){const c=a.split("=").pop();r.push(new pe("sso",c))}else{let c=i.next().value;c&&(c=decodeURIComponent(c)),r.push(new pe(a,c))}}return r}function Tl(n){let e="",t;for(const s of n.segments){const i=Al(s.value);switch(s.type){case"rooms":e+=`/rooms/${i}`;break;case"empty-grid-tile":e+=`/${i}`;break;case"room":t?.type==="rooms"?e+=`/${t.value.indexOf(s.value)}`:e+=`/${s.type}/${i}`;break;case"right-panel":case"sso":continue;default:e+=`/${s.type}`,i&&(e+=`/${i}`)}t=s}return e}function Al(n){return n===!0?"":Array.isArray(n)?n.map(e=>encodeURIComponent(e)).join(","):encodeURIComponent(n)}var si=(n=>(n[n.Calls=1]="Calls",n[n.CrossSigning=2]="CrossSigning",n[n.SameSessionInMultipleTabs=4]="SameSessionInMultipleTabs",n))(si||{});class kt{constructor(e=0){this.flags=e}withFeature(e){return new kt(this.flags|e)}withoutFeature(e){return new kt(this.flags^e)}isFeatureEnabled(e){return(this.flags&e)!==0}get calls(){return this.isFeatureEnabled(1)}get crossSigning(){return this.isFeatureEnabled(2)}get sameSessionInMultipleTabs(){return this.isFeatureEnabled(4)}static async load(e){const t=await e.getInt("enabled_features")||0;return new kt(t)}async store(e){await e.setInt("enabled_features",this.flags)}}var ye=(n=>(n[n.All=1]="All",n[n.Debug=2]="Debug",n[n.Detail=3]="Detail",n[n.Info=4]="Info",n[n.Warn=5]="Warn",n[n.Error=6]="Error",n[n.Fatal=7]="Fatal",n[n.Off=8]="Off",n))(ye||{});class li{constructor(e){this._parentFilter=e}filter(e,t){return!(this._parentFilter&&!this._parentFilter.filter(e,t)||this._min!==void 0&&!Array.isArray(t)&&e.logLevel<this._min)}minLevel(e){return this._min=e,this}}function hi(){}class $o{constructor(){this.item=new xl(this)}log(e){return this.item}addReporter(){}get reporters(){return[]}getOpenRootItems(){return[]}forceFinish(){}child(e){return this.item}run(e,t){return t(this.item)}wrapOrRun(e,t,s){return e?e.wrap(t,s):this.run(t,s)}runDetached(e,t){return new Promise(s=>s(t(this.item))).then(hi,hi),this.item}get level(){return ye}}class xl{constructor(e){this.logger=e}wrap(e,t){return this.run(t)}run(e){return e(this)}log(e){return this}set(e){return this}runDetached(e,t){return new Promise(s=>s(t(this))).then(hi,hi),this}wrapDetached(e,t){return this.refDetached()}refDetached(){}ensureRefId(){}get level(){return ye}get duration(){return 0}catch(e){return e}child(){return this}finish(){}forceFinish(){}serialize(){}}const Nl=new $o;var Dl="assets/olm.92f1ccd0.js",Vl="assets/olm.b3e0f9b4.wasm",Pl="assets/olm_legacy.9dc48f49.js",Ll="assets/download-sandbox.48a866e9.html",Ol="assets/main.5b3f6f97.js";const jo={downloadSandbox:Ll,worker:Ol,olm:{wasm:Vl,legacyBundle:Pl,wasmBundle:Dl}};jo.serviceWorker="sw.js";class Ul{static fromQueryParams(){const e=new URLSearchParams(window.location.search),t=r=>{let o=e.get(r);return(!o||o==="")&&(o=null),o};let s=!0;const i=t("enableServiceWorker");return i&&(i==="true"?s=!0:i==="false"&&(s=!1)),{instanceId:t("instanceId")??"",defaultHomeserver:t("defaultHomeserver")??"",roomId:t("roomId")??"",enableServiceWorker:s,themeManifests:[new URL("assets/theme-chatrix.json",self.location).href],defaultTheme:{light:"chatrix",dark:"chatrix"}}}}var U=(n=>(n.Login="login",n.Logout="logout",n.ForcedLogout="forced-logout",n.SessionPicker="picker",n.SessionLoading="loading",n.Session="session",n.Error="error",n.UnknownRoom="unknown-room",n.Redirecting="redirecting",n))(U||{});function Fl(){return Object.values(U)}function Bl(){return kl()}class qo{constructor(e){this._name=e}getAll(){const e=localStorage.getItem(this._name);if(e){const t=JSON.parse(e);if(Array.isArray(t))return Promise.resolve(t)}return Promise.resolve([])}async updateLastUsed(e,t){const s=await this.getAll();if(s){const i=s.find(r=>r.id===e);i&&(i.lastUsed=t,localStorage.setItem(this._name,JSON.stringify(s)))}}async get(e){const t=await this.getAll();if(t)return t.find(s=>s.id===e)}async add(e){const t=await this.getAll();t.push(e),localStorage.setItem(this._name,JSON.stringify(t))}async delete(e){let t=await this.getAll();t=t.filter(s=>s.id!==e),localStorage.setItem(this._name,JSON.stringify(t))}}class Wo{constructor(e){this._prefix=e}async setInt(e,t){this._set(e,t)}async getInt(e,t=0){const s=window.localStorage.getItem(`${this._prefix}${e}`);return typeof s=="string"?parseInt(s,10):t}async setBool(e,t){this._set(e,t)}async getBool(e,t=!1){const s=window.localStorage.getItem(`${this._prefix}${e}`);return typeof s=="string"?s==="true":t}async setString(e,t){this._set(e,t)}async getString(e){return window.localStorage.getItem(`${this._prefix}${e}`)}async remove(e){window.localStorage.removeItem(`${this._prefix}${e}`)}async _set(e,t){window.localStorage.setItem(`${this._prefix}${e}`,t)}}class Ho extends Error{constructor(e,t){super(`${e}: ${t.message}`),this.cause=t}get name(){return"WrappedError"}}class zo extends Error{constructor(e,t,s,i){super(`${s?s.error:i} on ${e} ${t}`),this.errcode=s?s.errcode:null,this.retry_after_ms=s?s.retry_after_ms:0,this.statusCode=i}get name(){return"HomeServerError"}}class Ge extends Error{constructor(e,t){super(e||"ConnectionError"),this.isTimeout=t}get name(){return"ConnectionError"}}function Kl(n,e,t,s){const i=n(e);let r=!1;return i.elapsed().then(()=>{r=!0,t.abort()},()=>{}),s.then(o=>(i.abort(),o),o=>{throw i.abort(),o.name==="AbortError"&&r?new Ge(`Request timed out after ${e}ms`,!0):o})}function Go(n,e=Math.random){return n.includes("?")?n=n+"&":n=n+"?",n+`_cacheBuster=${Math.ceil(e()*Number.MAX_SAFE_INTEGER)}`}function Jo(n){const e=new FormData;for(const[t,s]of n)s.blob?.nativeBlob&&s.name?e.set(t,s.blob.nativeBlob,s.name):e.set(t,s);return e}class $l{constructor(e,t){this._promise=e,this._xhr=t}abort(){this._xhr.abort()}response(){return this._promise}}function jl(n,{method:e,headers:t,timeout:s,format:i,uploadProgress:r}){const o=new XMLHttpRequest;if(r&&o.upload.addEventListener("progress",a=>r(a.loaded)),o.open(e,n),i==="buffer"&&(o.responseType="arraybuffer"),t)for(const[a,c]of t.entries())try{o.setRequestHeader(a,c)}catch(l){console.info(`Could not set ${a} header: ${l.message}`)}return s&&(o.timeout=s),o}function ql(n,e,t){return new Promise((s,i)=>{n.addEventListener("load",()=>s(n)),n.addEventListener("abort",()=>i(new Ce)),n.addEventListener("error",()=>i(new Ge(`Error ${e} ${t}`))),n.addEventListener("timeout",()=>i(new Ge(`Timeout ${e} ${t}`,!0)))})}function Qo(n,e){let{cache:t,format:s,body:i,method:r}=e;t||(n=Go(n));const o=jl(n,e),a=ql(o,r,n).then(c=>{const{status:l}=c;let h=null;return s==="buffer"?h=c.response:c.getResponseHeader("Content-Type")==="application/json"&&(h=JSON.parse(c.responseText)),{status:l,body:h}});return i?.nativeBlob&&(i=i.nativeBlob),i instanceof Map&&(i=Jo(i)),o.send(i||null),new $l(a,o)}class Dn{constructor(e,t){if(t)this.promise=e,this._controller=t;else{const s=new Promise((i,r)=>{this._controller={abort(){const o=new Error("fetch request aborted");o.name="AbortError",r(o)}}});this.promise=Promise.race([e,s])}}abort(){this._controller.abort()}response(){return this.promise}}function Wl(n,e){return function(s,i){if(e?.haltRequests)return new Dn(new Promise(()=>{}),{});if(i?.uploadProgress)return Qo(s,i);let{method:r,headers:o,body:a,timeout:c,format:l,cache:h=!1}=i;const d=typeof AbortController=="function"?new AbortController:null;a?.nativeBlob&&(a=a.nativeBlob),a instanceof Map&&(a=Jo(a));let u={method:r,body:a};if(d&&(u=Object.assign(u,{signal:d.signal})),h||(s=Go(s)),u=Object.assign(u,{mode:"cors",credentials:"omit",referrer:"no-referrer",cache:"default"}),o){const g=new Headers;for(const[w,I]of o.entries())g.append(w,I);u.headers=g}const p=fetch(s,u).then(async g=>{const{status:w}=g;let I;try{l==="json"?I=await g.json():l==="buffer"?I=await g.arrayBuffer():l==="text"&&(I=await g.text())}catch(E){if(!(E.name==="SyntaxError"&&w>=400))throw E}return{status:w,body:I}},g=>{throw g.name==="AbortError"?new Ce:g instanceof TypeError?new Ge(`${r} ${s}: ${g.message}`):g}),_=new Dn(p,d);return c&&(_.promise=Kl(n,c,_,_.promise)),_}}var $=(n=>(n.session="session",n.roomState="roomState",n.roomSummary="roomSummary",n.archivedRoomSummary="archivedRoomSummary",n.invites="invites",n.roomMembers="roomMembers",n.timelineEvents="timelineEvents",n.timelineRelations="timelineRelations",n.timelineFragments="timelineFragments",n.pendingEvents="pendingEvents",n.userIdentities="userIdentities",n.deviceIdentities="deviceIdentities",n.olmSessions="olmSessions",n.inboundGroupSessions="inboundGroupSessions",n.outboundGroupSessions="outboundGroupSessions",n.groupSessionDecryptions="groupSessionDecryptions",n.operations="operations",n.accountData="accountData",n.calls="calls",n))($||{});const Ss=Object.values($);class Je extends Error{constructor(e,t=null){super(e),t&&(this.errcode=t.name),this.cause=t}get name(){return"StorageError"}}const W={get minStorageKey(){return 0},get middleStorageKey(){return 2147483647},get maxStorageKey(){return 4294967295}};function Hl(n){return"objectStore"in n?`${n.objectStore.name}.${n.name}`:n.name}function zl(n){return"objectStore"in n?n.objectStore?.transaction?.db?.name:n.transaction?.db?.name}class Yo extends Je{constructor(e,t,s=null){const i=t&&"source"in t?t.source:t,r=i?Hl(i):"",o=i?zl(i):"";let a=`${e} on ${o}.${r}`;s&&(a+=": ",typeof s.name=="string"&&(a+=`(name: ${s.name}) `),typeof s.code=="number"&&(a+=`(code: ${s.code}) `)),s&&(a+=s.message),super(a,s),this.storeName=r,this.databaseName=o}}class xr extends Yo{constructor(e){const t=e.target,s=t.source,i=t.error;super("IDBRequest failed",s,i),this.errorEvent=e}preventTransactionAbort(){this.errorEvent.preventDefault()}}class Ke extends Yo{constructor(e,t,s,i){super(`${e}(${i.map(r=>JSON.stringify(r)).join(", ")}) failed`,t,s)}}const Vn={done:!0},dt={done:!1};function di(n){const e=n.toString(16);return"0".repeat(8-e.length)+e}function cr(n){return parseInt(n,16)}function Nr(n,e,t,s=window.indexedDB){const i=s.open(n,t);return i.onupgradeneeded=async r=>{const o=r.target,a=o.result,c=o.transaction,l=r.oldVersion;try{await e(a,c,l,t)}catch{try{c.abort()}catch{}}},ae(i)}function ae(n){return new Promise((e,t)=>{n.addEventListener("success",s=>{e(s.target.result)}),n.addEventListener("error",s=>{const i=new xr(s);t(i)})})}function Is(n){return new Promise((e,t)=>{n.addEventListener("complete",()=>{e()}),n.addEventListener("abort",s=>{t(new Ce)})})}function X(n,e){return new Promise((t,s)=>{n.onerror=i=>{s(new xr(i))},n.onsuccess=i=>{const r=i.target.result;if(!r){t(!1);return}const o=e(r.value,r.key,r),a=o?.done,c=o?.jumpTo;a?t(!0):c?r.continue(c):r.continue()}}).catch(t=>{throw new Je("iterateCursor failed",t)})}async function Gl(n,e){const t=[];return await X(n,s=>(t.push(s),{done:e(t)})),t}class Pn{constructor(e,t){this._target=e,this._transaction=t}get idbFactory(){return this._transaction.idbFactory}get IDBKeyRange(){return this._transaction.IDBKeyRange}get databaseName(){return this._transaction.databaseName}_openCursor(e,t){return e&&t?this._target.openCursor(e,t):e?this._target.openCursor(e):t?this._target.openCursor(null,t):this._target.openCursor()}supports(e){return this._target.supports(e)}count(e){return ae(this._target.count(e))}get(e){return ae(this._target.get(e))}getKey(e){return this._target.supports("getKey")?ae(this._target.getKey(e)):ae(this._target.get(e)).then(t=>{if(t){let s=this._target.keyPath;return typeof s=="string"&&(s=[s]),s.reduce((i,r)=>i[r],t)}})}reduce(e,t,s){return this._reduce(e,t,s,"next")}reduceReverse(e,t,s){return this._reduce(e,t,s,"prev")}selectLimit(e,t){return this._selectLimit(e,t,"next")}selectLimitReverse(e,t){return this._selectLimit(e,t,"prev")}selectWhile(e,t){return this._selectWhile(e,t,"next")}selectWhileReverse(e,t){return this._selectWhile(e,t,"prev")}async selectAll(e,t){const s=this._openCursor(e,t),i=[];return await X(s,r=>(i.push(r),dt)),i}selectFirst(e){return this._find(e,()=>!0,"next")}selectLast(e){return this._find(e,()=>!0,"prev")}find(e,t){return this._find(e,t,"next")}findReverse(e,t){return this._find(e,t,"prev")}async findMaxKey(e){const t=this._target.openKeyCursor(e,"prev");let s;return await X(t,(i,r)=>(s=r,Vn)),s}async iterateValues(e,t){const s=this._target.openCursor(e,"next");await X(s,(i,r,o)=>({done:t(i,r,o)}))}async iterateKeys(e,t){const s=this._target.openKeyCursor(e,"next");await X(s,(i,r,o)=>({done:t(r,o)}))}async findExistingKeys(e,t,s){const i=(d,u)=>t?-this.idbFactory.cmp(d,u):this.idbFactory.cmp(d,u),r=e.slice().sort(i),o=r[0],a=r[r.length-1],c=t?"prev":"next",l=this._target.openKeyCursor(this.IDBKeyRange.bound(o,a),c);let h=0;await X(l,(d,u,p)=>{for(;h<r.length&&i(r[h],u)<0;)h+=1;let _=!1;if(r[h]===u){const g=p.primaryKey;_=s(u,g),h+=1}return _||h>=r.length?Vn:{done:!1,jumpTo:r[h]}})}_reduce(e,t,s,i){let r=s;const o=this._openCursor(e,i);return X(o,a=>(r=t(r,a),dt))}_selectLimit(e,t,s){return this._selectUntil(e,i=>i.length===t,s)}async _selectUntil(e,t,s){const i=this._openCursor(e,s),r=[];return await X(i,o=>(r.push(o),{done:t(r,o)})),r}async _selectWhile(e,t,s){const i=this._openCursor(e,s),r=[];return await X(i,o=>{const a=t(o);return a&&r.push(o),{done:!a}}),r}async iterateWhile(e,t){const s=this._openCursor(e,"next");await X(s,i=>({done:!t(i)}))}async _find(e,t,s){const i=this._openCursor(e,s);let r;if(await X(i,a=>{const c=t(a);return c&&(r=a),{done:c}}))return r}}const st=!1;function it(n,e,t){const s=t?.name,i=t?.transaction?.db?.name;console.info(`${i}.${s}.${n}(${e.map(r=>JSON.stringify(r)).join(", ")})`)}class Ln{constructor(e){this._qt=e}get keyPath(){return this._qtStore.keyPath}get _qtStore(){return"objectStore"in this._qt?this._qt.objectStore:this._qt}supports(e){return!!this._qt[e]}openKeyCursor(e,t){try{return this._qt.openKeyCursor?(st&&it("openKeyCursor",[e,t],this._qt),this._qt.openKeyCursor(e,t)):(st&&it("openCursor",[e,t],this._qt),this.openCursor(e,t))}catch(s){throw new Ke("openKeyCursor",this._qt,s,[e,t])}}openCursor(e,t){try{return st&&it("openCursor",[],this._qt),this._qt.openCursor(e,t)}catch(s){throw new Ke("openCursor",this._qt,s,[e,t])}}put(e,t){try{return st&&it("put",[e,t],this._qt),this._qtStore.put(e,t)}catch(s){throw new Ke("put",this._qt,s,[e,t])}}add(e,t){try{return st&&it("add",[e,t],this._qt),this._qtStore.add(e,t)}catch(s){throw new Ke("add",this._qt,s,[e,t])}}get(e){try{return st&&it("get",[e],this._qt),this._qt.get(e)}catch(t){throw new Ke("get",this._qt,t,[e])}}getKey(e){try{return st&&it("getKey",[e],this._qt),this._qt.getKey(e)}catch(t){throw new Ke("getKey",this._qt,t,[e])}}delete(e){try{return st&&it("delete",[e],this._qt),this._qtStore.delete(e)}catch(t){throw new Ke("delete",this._qt,t,[e])}}count(e){try{return this._qt.count(e)}catch(t){throw new Ke("count",this._qt,t,[e])}}index(e){try{return this._qtStore.index(e)}catch(t){throw new Ke("index",this._qt,t,[e])}}get indexNames(){return Array.from(this._qtStore.indexNames)}}class Xo extends Pn{constructor(e,t){super(new Ln(e),t)}get _idbStore(){return this._target}index(e){return new Pn(new Ln(this._idbStore.index(e)),this._transaction)}put(e,t){const s=this._idbStore.put(e);this._prepareErrorLog(s,t,"put",void 0,e)}add(e,t){const s=this._idbStore.add(e);this._prepareErrorLog(s,t,"add",void 0,e)}async tryAdd(e,t){try{return await ae(this._idbStore.add(e)),!0}catch(s){if(s instanceof xr)return t.log({l:"could not write",id:this._getKeys(e),e:s},t.level.Warn),s.preventTransactionAbort(),!1;throw s}}delete(e,t){const s=this._idbStore.delete(e);this._prepareErrorLog(s,t,"delete",e,void 0)}_prepareErrorLog(e,t,s,i,r){t&&t.ensureRefId(),ae(e).catch(o=>{let a;r?a=this._getKeys(r):i&&(a=[i]),this._transaction.addWriteError(o,t,s,a)})}_getKeys(e){const t=[],{keyPath:s}=this._idbStore;try{t.push(this._readKeyPath(e,s))}catch{console.warn("could not read keyPath",s)}for(const i of this._idbStore.indexNames)try{const r=this._idbStore.index(i);t.push(this._readKeyPath(e,r.keyPath))}catch{console.warn("could not read index",i)}return t}_readKeyPath(e,t){if(Array.isArray(t)){let s=e;for(const i of t)if(typeof s=="object")s=s[i];else break;return s}else return e[t]}}var On=/[\\\"\x00-\x1F]/g,et={};for(var Fs=0;Fs<32;++Fs)et[String.fromCharCode(Fs)]="\\U"+("0000"+Fs.toString(16)).slice(-4).toUpperCase();et["\b"]="\\b";et["	"]="\\t";et[`
`]="\\n";et["\f"]="\\f";et["\r"]="\\r";et['"']='\\"';et["\\"]="\\\\";function Zo(n){return On.lastIndex=0,n.replace(On,function(e){return et[e]})}function Dr(n){switch(typeof n){case"string":return'"'+Zo(n)+'"';case"number":return isFinite(n)?n:"null";case"boolean":return n;case"object":return n===null?"null":Array.isArray(n)?Jl(n):Ql(n);default:throw new Error("Cannot stringify: "+typeof n)}}function Jl(n){for(var e="[",t="",s=0;s<n.length;++s)t+=e,e=",",t+=Dr(n[s]);return e!=","?"[]":t+"]"}function Ql(n){var e="{",t="",s=Object.keys(n);s.sort();for(var i=0;i<s.length;++i){var r=s[i];t+=e+'"'+Zo(r)+'":',e=",",t+=Dr(n[r])}return e!=","?"{}":t+"}"}var Vr={stringify:Dr};function tt(...n){const e={};for(const t of n)e[t]=t;return Object.freeze(e)}const It=tt("Sync","Timeline","Retry"),we="e2ee:",Pr="m.olm.v1.curve25519-aes-sha2",Le="m.megolm.v1.aes-sha2";class ie extends Error{constructor(e,t,s=null){super(`Decryption error ${e}${s?": "+JSON.stringify(s):""}`),this.code=e,this.event=t,this.details=s}}const ea="ed25519";function lr(n,e,t,s,i,r=void 0){const o=Object.assign({},i);delete o.unsigned,delete o.signatures;const a=Vr.stringify(o),c=i?.signatures?.[e]?.[`${ea}:${t}`];try{if(!c)throw new Error("no signature");return n.ed25519_verify(s,a,c),!0}catch(l){if(r){const h=r.log({l:"Invalid signature, ignoring.",ed25519Key:s,canonicalJson:a,signature:c});h.error=l,h.logLevel=r.level.Warn}return!1}}function Yl(){return{type:"m.room.encryption",state_key:"",content:{algorithm:Le,rotation_period_ms:6048e5,rotation_period_msgs:100}}}const Bs=Object.freeze({Joined:"joined",Invited:"invited",WorldReadable:"world_readable",Shared:"shared"});function Ks(n,e){switch(e){case Bs.WorldReadable:return!0;case Bs.Shared:return n!==void 0;case Bs.Joined:return n==="join";case Bs.Invited:return n==="invite"||n==="join";default:return!1}}function Xl(n){return JSON.stringify(ta(n))}function Zl(n){return sa(JSON.parse(n))}function ta(n){if(typeof n=="object"&&n!==null&&!Array.isArray(n)){if(n.byteLength)return{_type:n.constructor.name,value:Array.from(n)};let e={};for(const t in n)n.hasOwnProperty(t)&&(e[t]=ta(n[t]));return e}else return n}function sa(n){if(typeof n=="object"&&n!==null&&!Array.isArray(n)){if(typeof n._type=="string")switch(n._type){case"Int8Array":return Int8Array.from(n.value);case"Uint8Array":return Uint8Array.from(n.value);case"Uint8ClampedArray":return Uint8ClampedArray.from(n.value);case"Int16Array":return Int16Array.from(n.value);case"Uint16Array":return Uint16Array.from(n.value);case"Int32Array":return Int32Array.from(n.value);case"Uint32Array":return Uint32Array.from(n.value);case"Float32Array":return Float32Array.from(n.value);case"Float64Array":return Float64Array.from(n.value);case"BigInt64Array":return BigInt64Array.from(n.value);case"BigUint64Array":return BigUint64Array.from(n.value);default:return n.value}let e={};for(const t in n)n.hasOwnProperty(t)&&(e[t]=sa(n[t]));return e}else return n}function ia(n){return`${n}.session.`}function eh(n,e){const t=[];for(let s=0;s<n.length;s++){const i=n.key(s);i?.startsWith(ia(e))&&t.push(i)}for(const s of t)n.removeItem(s)}class Lr{constructor(e,t){this._sessionStore=e,this._localStorage=t}get _localStorageKeyPrefix(){return ia(this._sessionStore.databaseName)}async get(e){const t=await this._sessionStore.get(e);if(t)return t.value}_writeKeyToLocalStorage(e,t){try{const s=this._localStorageKeyPrefix+e,i=Xl(t);this._localStorage.setItem(s,i)}catch(s){console.error("could not write to localStorage",s)}}writeE2EEIdentityToLocalStorage(){this._sessionStore.iterateValues(void 0,(e,t)=>(t.startsWith(we)&&this._writeKeyToLocalStorage(t,e.value),!1))}async tryRestoreE2EEIdentityFromLocalStorage(e){let t=!1;const s=this._localStorageKeyPrefix,i=s+we;for(let r=0;r<this._localStorage.length;r+=1){const o=this._localStorage.key(r);if(o.startsWith(i)){const a=Zl(this._localStorage.getItem(o)),c=o.substr(s.length),l=await this._sessionStore.getKey(c)===c;e.set(c,!l),l||(this._sessionStore.put({key:c,value:a}),t=!0)}}return t}set(e,t){e.startsWith(we)&&this._writeKeyToLocalStorage(e,t),this._sessionStore.put({key:e,value:t})}add(e,t){e.startsWith(we)&&this._writeKeyToLocalStorage(e,t),this._sessionStore.add({key:e,value:t})}remove(e){e.startsWith(we)&&this._localStorage.removeItem(this._localStorageKeyPrefix+e),this._sessionStore.delete(e)}}class Un{constructor(e){this._summaryStore=e}getAll(){return this._summaryStore.selectAll()}set(e){this._summaryStore.put(e)}get(e){return this._summaryStore.get(e)}async has(e){const t=await this._summaryStore.getKey(e);return e===t}remove(e){this._summaryStore.delete(e)}}class th{constructor(e){this._inviteStore=e}getAll(){return this._inviteStore.selectAll()}set(e){this._inviteStore.put(e)}remove(e){this._inviteStore.delete(e)}}class H{constructor(e,t){this.fragmentId=e,this.eventIndex=t}nextFragmentKey(){return new H(this.fragmentId+1,W.middleStorageKey)}nextKeyForDirection(e){return e.isForward?this.nextKey():this.previousKey()}previousKey(){return new H(this.fragmentId,this.eventIndex-1)}nextKey(){return new H(this.fragmentId,this.eventIndex+1)}static get maxKey(){return new H(W.maxStorageKey,W.maxStorageKey)}static get minKey(){return new H(W.minStorageKey,W.minStorageKey)}static get defaultLiveKey(){return H.defaultFragmentKey(W.minStorageKey)}static defaultFragmentKey(e){return new H(e,W.middleStorageKey)}toString(){return`[${this.fragmentId}/${this.eventIndex}]`}equals(e){return this.fragmentId===e?.fragmentId&&this.eventIndex===e?.eventIndex}}function Or(n,e,t){return{fragmentId:n.fragmentId,eventIndex:n.eventIndex,roomId:e,event:t}}function ws(n,e,t){t.isForward?n.push(e):n.unshift(e)}function sh(n,e,t){return t.isForward?n.concat(e):e.concat(n)}function ke(n,e,t){return`${n}|${di(e)}|${di(t)}`}function ih(n){const[e,t,s]=n.split("|");return{roomId:e,eventKey:new H(cr(t),cr(s))}}function $s(n,e){return`${n}|${e}`}function Fn(n){const[e,t]=n.split("|");return{roomId:e,eventId:t}}class js{constructor(e,t,s,i,r=!1,o=!1){this._IDBKeyRange=e,this._only=t,this._lower=s,this._upper=i,this._lowerOpen=r,this._upperOpen=o}asIDBKeyRange(e){try{if(this._only)return this._IDBKeyRange.only(ke(e,this._only.fragmentId,this._only.eventIndex));if(this._lower&&!this._upper)return this._IDBKeyRange.bound(ke(e,this._lower.fragmentId,this._lower.eventIndex),ke(e,this._lower.fragmentId,W.maxStorageKey),this._lowerOpen,!1);if(!this._lower&&this._upper)return this._IDBKeyRange.bound(ke(e,this._upper.fragmentId,W.minStorageKey),ke(e,this._upper.fragmentId,this._upper.eventIndex),!1,this._upperOpen);if(this._lower&&this._upper)return this._IDBKeyRange.bound(ke(e,this._lower.fragmentId,this._lower.eventIndex),ke(e,this._upper.fragmentId,this._upper.eventIndex),this._lowerOpen,this._upperOpen)}catch(t){throw new Je("IDBKeyRange failed with data: "+JSON.stringify(this),t)}}}class rh{constructor(e){this._timelineStore=e}onlyRange(e){return new js(this._timelineStore.IDBKeyRange,e)}upperBoundRange(e,t=!1){return new js(this._timelineStore.IDBKeyRange,void 0,void 0,e,void 0,t)}lowerBoundRange(e,t=!1){return new js(this._timelineStore.IDBKeyRange,void 0,e,void 0,t)}boundRange(e,t,s=!1,i=!1){return new js(this._timelineStore.IDBKeyRange,void 0,e,t,s,i)}async lastEvents(e,t,s){const i=H.maxKey;return i.fragmentId=t,this.eventsBefore(e,i,s)}async firstEvents(e,t,s){const i=H.minKey;return i.fragmentId=t,this.eventsAfter(e,i,s)}eventsAfter(e,t,s){const i=this.lowerBoundRange(t,!0).asIDBKeyRange(e);return this._timelineStore.selectLimit(i,s)}async eventsBefore(e,t,s){const i=this.upperBoundRange(t,!0).asIDBKeyRange(e),r=await this._timelineStore.selectLimitReverse(i,s);return r.reverse(),r}async getEventKeysForIds(e,t){const s=this._timelineStore.index("byEventId"),i=t.map(o=>$s(e,o)),r=new Map;return await s.findExistingKeys(i,!1,(o,a)=>{const{eventId:c}=Fn(o),{eventKey:l}=ih(a);return r.set(c,l),!1}),r}async findFirstOccurringEventId(e,t){const s=this._timelineStore.index("byEventId"),i=t.map(c=>$s(e,c)),r=new Array(i.length);let o;function a(){for(let c=0;c<r.length;++c){if(r[c]===void 0)return;if(r[c]===!0)return i[c]}}return await s.findExistingKeys(i,!1,(c,l)=>{const h=i.indexOf(c);return r[h]=l,o=a(),!!o}),o&&Fn(o).eventId}tryInsert(e,t){return e.key=ke(e.roomId,e.fragmentId,e.eventIndex),e.eventIdKey=$s(e.roomId,e.event.event_id),this._timelineStore.tryAdd(e,t)}update(e){this._timelineStore.put(e)}get(e,t){return this._timelineStore.get(ke(e,t.fragmentId,t.eventIndex))}getByEventId(e,t){return this._timelineStore.index("byEventId").get($s(e,t))}removeAllForRoom(e){const t=ke(e,W.minStorageKey,W.minStorageKey),s=ke(e,W.maxStorageKey,W.maxStorageKey),i=this._timelineStore.IDBKeyRange.bound(t,s);this._timelineStore.delete(i)}}const te="\0",z="\u{10FFFF}";function De(n,e,t,s){return`${n}|${e}|${t}|${s}`}function Bn(n){const[e,t,s,i]=n.split("|");return{roomId:e,targetEventId:t,relType:s,sourceEventId:i}}class nh{constructor(e){this._store=e}add(e,t,s,i){this._store.add({key:De(e,t,s,i)})}remove(e,t,s,i){this._store.delete(De(e,t,s,i))}removeAllForTarget(e,t){const s=this._store.IDBKeyRange.bound(De(e,t,te,te),De(e,t,z,z),!0,!0);this._store.delete(s)}removeAllForRoom(e){const t=this._store.IDBKeyRange.bound(De(e,te,te,te),De(e,z,z,z),!0,!0);this._store.delete(t)}async getForTargetAndType(e,t,s){const i=this._store.IDBKeyRange.bound(De(e,t,s,te),De(e,t,s,z),!0,!0);return(await this._store.selectAll(i)).map(o=>Bn(o.key))}async getAllForTarget(e,t){const s=this._store.IDBKeyRange.bound(De(e,t,te,te),De(e,t,z,z),!0,!0);return(await this._store.selectAll(s)).map(r=>Bn(r.key))}}function qs(n,e,t){return`${n}|${e}|${t}`}class oh{constructor(e){this._roomStateStore=e}get(e,t,s){const i=qs(e,t,s);return this._roomStateStore.get(i)}getAllForType(e,t){const s=this._roomStateStore.IDBKeyRange.bound(qs(e,t,""),qs(e,t,z),!1,!0);return this._roomStateStore.selectAll(s)}set(e,t){const s=qs(e,t.type,t.state_key),i={roomId:e,event:t,key:s};this._roomStateStore.put(i)}removeAllForRoom(e){const t=this._roomStateStore.IDBKeyRange.bound(e,`${e}|${z}`,!0,!0);this._roomStateStore.delete(t)}}function Ws(n,e){return`${n}|${e}`}function ah(n){const[e,t]=n.split("|");return{roomId:e,userId:t}}class ra{constructor(e){this._roomMembersStore=e}get(e,t){return this._roomMembersStore.get(Ws(e,t))}set(e){e.key=Ws(e.roomId,e.userId),this._roomMembersStore.put(e)}getAll(e){const t=this._roomMembersStore.IDBKeyRange.lowerBound(Ws(e,""));return this._roomMembersStore.selectWhile(t,s=>s.roomId===e)}async getAllUserIds(e){const t=[],s=this._roomMembersStore.IDBKeyRange.lowerBound(Ws(e,""));return await this._roomMembersStore.iterateKeys(s,i=>{const r=ah(i);return r.roomId===e?(t.push(r.userId),!1):!0}),t}removeAllForRoom(e){const t=this._roomMembersStore.IDBKeyRange.bound(e,`${e}|${z}`,!0,!0);this._roomMembersStore.delete(t)}}function Hs(n,e){return`${n}|${di(e)}`}class ch{constructor(e){this._store=e}_allRange(e){try{return this._store.IDBKeyRange.bound(Hs(e,W.minStorageKey),Hs(e,W.maxStorageKey))}catch(t){throw new Je(`error from IDBKeyRange with roomId ${e}`,t)}}all(e){return this._store.selectAll(this._allRange(e))}liveFragment(e){return this._store.findReverse(this._allRange(e),t=>typeof t.nextId!="number"&&typeof t.nextToken!="string")}add(e){e.key=Hs(e.roomId,e.id),this._store.add(e)}update(e){this._store.put(e)}get(e,t){return this._store.get(Hs(e,t))}removeAllForRoom(e){this._store.delete(this._allRange(e))}}function ft(n,e){return`${n}|${di(e)}`}function lh(n){const[e,t]=n.split("|"),s=cr(t);return{roomId:e,queueIndex:s}}class hh{constructor(e){this._eventStore=e}async getMaxQueueIndex(e){const t=this._eventStore.IDBKeyRange.bound(ft(e,W.minStorageKey),ft(e,W.maxStorageKey),!1,!1),s=await this._eventStore.findMaxKey(t);if(s)return lh(s).queueIndex}remove(e,t){const s=this._eventStore.IDBKeyRange.only(ft(e,t));this._eventStore.delete(s)}async exists(e,t){const s=this._eventStore.IDBKeyRange.only(ft(e,t));return!!await this._eventStore.getKey(s)}add(e){e.key=ft(e.roomId,e.queueIndex),this._eventStore.add(e)}update(e){this._eventStore.put(e)}getAll(){return this._eventStore.selectAll()}removeAllForRoom(e){const t=ft(e,W.minStorageKey),s=ft(e,W.maxStorageKey),i=this._eventStore.IDBKeyRange.bound(t,s);this._eventStore.delete(i)}}class dh{constructor(e){this._store=e}get(e){return this._store.get(e)}set(e){this._store.put(e)}remove(e){this._store.delete(e)}}function yt(n,e){return`${n}|${e}`}function uh(n){const[e,t]=n.split("|");return{userId:e,deviceId:t}}class mh{constructor(e){this._store=e}getAllForUserId(e){const t=this._store.IDBKeyRange.lowerBound(yt(e,""));return this._store.selectWhile(t,s=>s.userId===e)}async getAllDeviceIds(e){const t=[],s=this._store.IDBKeyRange.lowerBound(yt(e,""));return await this._store.iterateKeys(s,i=>{const r=uh(i);return r.userId===e?(t.push(r.deviceId),!1):!0}),t}get(e,t){return this._store.get(yt(e,t))}set(e){e.key=yt(e.userId,e.deviceId),this._store.put(e)}getByCurve25519Key(e){return this._store.index("byCurve25519Key").get(e)}remove(e,t){this._store.delete(yt(e,t))}removeAllForUser(e){const t=this._store.IDBKeyRange.bound(yt(e,te),yt(e,z),!0,!0);this._store.delete(t)}}function cs(n,e){return`${n}|${e}`}function ph(n){const[e,t]=n.split("|");return{senderKey:e,sessionId:t}}class _h{constructor(e){this._store=e}async getSessionIds(e){const t=[],s=this._store.IDBKeyRange.lowerBound(cs(e,""));return await this._store.iterateKeys(s,i=>{const r=ph(i);return r.senderKey===e?(t.push(r.sessionId),!1):!0}),t}getAll(e){const t=this._store.IDBKeyRange.lowerBound(cs(e,""));return this._store.selectWhile(t,s=>s.senderKey===e)}get(e,t){return this._store.get(cs(e,t))}set(e){e.key=cs(e.senderKey,e.sessionId),this._store.put(e)}remove(e,t){this._store.delete(cs(e,t))}}var Si=(n=>(n[n.NotBackedUp=0]="NotBackedUp",n[n.BackedUp=1]="BackedUp",n))(Si||{}),xs=(n=>(n[n.DeviceMessage=1]="DeviceMessage",n[n.Backup=2]="Backup",n[n.Outbound=3]="Outbound",n))(xs||{});function Bt(n,e,t){return`${n}|${e}|${t}`}class gh{constructor(e){this._store=e}async has(e,t,s){const i=Bt(e,t,s),r=await this._store.getKey(i);return i===r}get(e,t,s){return this._store.get(Bt(e,t,s))}set(e){const t=e;t.key=Bt(e.roomId,e.senderKey,e.sessionId),this._store.put(t)}removeAllForRoom(e){const t=this._store.IDBKeyRange.bound(Bt(e,te,te),Bt(e,z,z));this._store.delete(t)}countNonBackedUpSessions(){return this._store.index("byBackup").count(this._store.IDBKeyRange.only(0))}getFirstNonBackedUpSessions(e){return this._store.index("byBackup").selectLimit(this._store.IDBKeyRange.only(0),e)}async markAsBackedUp(e,t,s){const i=await this._store.get(Bt(e,t,s));i&&(i.backup=1,this._store.put(i))}async markAllAsNotBackedUp(){const e=this._store.IDBKeyRange.only(1);let t=0;return await this._store.index("byBackup").iterateValues(e,(s,i,r)=>(s.backup=0,r.update(s),t+=1,!1)),t}}class fh{constructor(e){this._store=e}remove(e){this._store.delete(e)}get(e){return this._store.get(e)}set(e){this._store.put(e)}}function zs(n,e,t){return`${n}|${e}|${t}`}class yh{constructor(e){this._store=e}get(e,t,s){return this._store.get(zs(e,t,s))}set(e,t,s,i){i.key=zs(e,t,s),this._store.put(i)}removeAllForRoom(e){const t=this._store.IDBKeyRange.bound(zs(e,te,te),zs(e,z,z));this._store.delete(t)}}function ps(n,e){return`${n}|${e}`}class wh{constructor(e){this._store=e}getAll(){return this._store.selectAll()}async getAllByTypeAndScope(e,t){const s=ps(t,e),i=[];return await this._store.index("byScopeAndType").iterateWhile(s,r=>r.scopeTypeKey!==s?!1:(i.push(r),!0)),i}add(e){e.scopeTypeKey=ps(e.scope,e.type),this._store.add(e)}update(e){this._store.put(e)}remove(e){this._store.delete(e)}async removeAllForScope(e){const t=this._store.IDBKeyRange.bound(ps(e,te),ps(e,z));await this._store.index("byScopeAndType").iterateValues(t,(i,r,o)=>(o.delete(),!0))}}class vh{constructor(e){this._store=e}async get(e){return await this._store.get(e)}set(e){this._store.put(e)}}function Kt(n,e,t){return`${n}|${e}|${t}`}function Kn(n){const[e,t,s]=n.key.split("|");return{intent:e,roomId:t,callId:s,timestamp:n.timestamp}}class bh{constructor(e){this._callStore=e}async getByIntent(e){const t=this._callStore.IDBKeyRange.bound(Kt(e,te,te),Kt(e,z,z),!0,!0);return(await this._callStore.selectAll(t)).map(i=>Kn(i))}async getByIntentAndRoom(e,t){const s=this._callStore.IDBKeyRange.bound(Kt(e,t,te),Kt(e,t,z),!0,!0);return(await this._callStore.selectAll(s)).map(r=>Kn(r))}add(e){const t={key:Kt(e.intent,e.roomId,e.callId),timestamp:e.timestamp};this._callStore.add(t)}remove(e,t,s){this._callStore.delete(Kt(e,t,s))}}class Sh{constructor(e,t,s,i){this.error=e,this.refItem=t,this.operationName=s,this.keys=i}}class $n{constructor(e,t,s){this._txn=e,this._allowedStoreNames=t,this._stores={},this._storage=s,this._writeErrors=[]}get idbFactory(){return this._storage.idbFactory}get IDBKeyRange(){return this._storage.IDBKeyRange}get databaseName(){return this._storage.databaseName}get logger(){return this._storage.logger}_idbStore(e){if(!this._allowedStoreNames.includes(e))throw new Je(`Invalid store for transaction: ${e}, only ${this._allowedStoreNames.join(", ")} are allowed.`);return new Xo(this._txn.objectStore(e),this)}_store(e,t){if(!this._stores[e]){const s=this._idbStore(e);this._stores[e]=t(s)}return this._stores[e]}get session(){return this._store($.session,e=>new Lr(e,this._storage.localStorage))}get roomSummary(){return this._store($.roomSummary,e=>new Un(e))}get archivedRoomSummary(){return this._store($.archivedRoomSummary,e=>new Un(e))}get invites(){return this._store($.invites,e=>new th(e))}get timelineFragments(){return this._store($.timelineFragments,e=>new ch(e))}get timelineEvents(){return this._store($.timelineEvents,e=>new rh(e))}get timelineRelations(){return this._store($.timelineRelations,e=>new nh(e))}get roomState(){return this._store($.roomState,e=>new oh(e))}get roomMembers(){return this._store($.roomMembers,e=>new ra(e))}get pendingEvents(){return this._store($.pendingEvents,e=>new hh(e))}get userIdentities(){return this._store($.userIdentities,e=>new dh(e))}get deviceIdentities(){return this._store($.deviceIdentities,e=>new mh(e))}get olmSessions(){return this._store($.olmSessions,e=>new _h(e))}get inboundGroupSessions(){return this._store($.inboundGroupSessions,e=>new gh(e))}get outboundGroupSessions(){return this._store($.outboundGroupSessions,e=>new fh(e))}get groupSessionDecryptions(){return this._store($.groupSessionDecryptions,e=>new yh(e))}get operations(){return this._store($.operations,e=>new wh(e))}get accountData(){return this._store($.accountData,e=>new vh(e))}get calls(){return this._store($.calls,e=>new bh(e))}async complete(e){try{await Is(this._txn)}catch(t){throw this._writeErrors.length?(this._logWriteErrors(e),this._writeErrors[0].error):t}}getCause(e){return e instanceof Je&&e.errcode==="AbortError"&&this._writeErrors.length?this._writeErrors[0].error:e}abort(e){try{this._txn.abort()}catch{e?.set("couldNotAbortTxn",!0)}this._writeErrors.length&&this._logWriteErrors(e)}addWriteError(e,t,s,i){(e.errcode!=="AbortError"||this._writeErrors.length===0)&&this._writeErrors.push(new Sh(e,t,s,i))}_logWriteErrors(e){const t=i=>{e||i.set("allowedStoreNames",this._allowedStoreNames);for(const r of this._writeErrors)i.wrap({l:r.operationName,id:r.keys},o=>{r.refItem&&o.refDetached(r.refItem),o.catch(r.error)})},s=`${this._writeErrors.length} storage write operation(s) failed`;e?e.wrap(s,t):this.logger.run(s,t)}}const jn="782rh281re38-boguskey";class Ih{constructor(e,t,s,i,r,o){this._db=e,this.idbFactory=t,this.IDBKeyRange=s,this._hasWebkitEarlyCloseTxnBug=i,this.storeNames=$,this.localStorage=r,this.logger=o}_validateStoreNames(e){const t=e.findIndex(s=>!Ss.includes(s));if(t!==-1)throw new Je(`Tried top, a transaction unknown store ${e[t]}`)}async readTxn(e){this._validateStoreNames(e);try{const t=this._db.transaction(e,"readonly");return this._hasWebkitEarlyCloseTxnBug&&await ae(t.objectStore(e[0]).get(jn)),new $n(t,e,this)}catch(t){throw new Je("readTxn failed",t)}}async readWriteTxn(e){this._validateStoreNames(e);try{const t=this._db.transaction(e,"readwrite");return this._hasWebkitEarlyCloseTxnBug&&await ae(t.objectStore(e[0]).get(jn)),new $n(t,e,this)}catch(t){throw new Je("readWriteTxn failed",t)}}close(){this._db.close()}get databaseName(){return this._db.name}}async function Rh(n){const e=n.transaction(Ss,"readonly"),t={};return await Promise.all(Ss.map(async s=>{const i=t[s]=[],r=e.objectStore(s);await X(r.openCursor(),o=>(i.push(o),dt))})),t}async function kh(n,e){const t=n.transaction(Ss,"readwrite");for(const s of Ss){const i=t.objectStore(s);for(const r of e[s])i.add(r)}await Is(t)}function hr(n){return n.unsigned?.prev_content||n.prev_content}const Pe="m.room.redaction";function dr(n){return!!n?.unsigned?.redacted_because}var j=(n=>(n[n.None=1]="None",n[n.BeingCreated=2]="BeingCreated",n[n.Invited=4]="Invited",n[n.Joined=8]="Joined",n[n.Replaced=16]="Replaced",n[n.Archived=32]="Archived",n))(j||{}),ve=(n=>(n[n.DirectMessage=0]="DirectMessage",n[n.Private=1]="Private",n[n.Public=2]="Public",n))(ve||{});function qt(n,e){let t;const s=o=>{const a=e(o);a instanceof Promise&&(t=t??[],t.push(a))},i=n.state?.events;if(i)for(let o=0;o<i.length;o++)s(i[o]);let r=n.timeline?.events;if(r)for(let o=0;o<r.length;o++){const a=r[o];typeof a.state_key=="string"&&s(a)}if(t)return Promise.all(t).then(()=>{})}const ge="m.room.member";class P{constructor(e){this._data=e}static fromUserId(e,t,s){return new P({roomId:e,userId:t,membership:s})}static fromMemberEvent(e,t){const s=t?.state_key;if(typeof s!="string")return;const i=t.content,r=hr(t),o=i?.membership,a=i?.displayname||r?.displayname,c=i?.avatar_url||r?.avatar_url;return this._validateAndCreateMember(e,s,o,a,c)}static fromReplacingMemberEvent(e,t){const s=t&&t.state_key;if(typeof s!="string")return;const i=hr(t);return this._validateAndCreateMember(e,s,i?.membership,i?.displayname,i?.avatar_url)}static _validateAndCreateMember(e,t,s,i,r){if(typeof s=="string")return new P({roomId:e,userId:t,membership:s,avatarUrl:r,displayName:i})}get data(){return this._data}get membership(){return this._data.membership}get displayName(){return this._data.displayName}get name(){return this._data.displayName||this._data.userId}get avatarUrl(){return this._data.avatarUrl}get roomId(){return this._data.roomId}get userId(){return this._data.userId}serialize(){return this._data}equals(e){const t=this._data,s=e._data;return t.roomId===s.roomId&&t.userId===s.userId&&t.membership===s.membership&&t.displayName===s.displayName&&t.avatarUrl===s.avatarUrl}}class Ur{constructor(e,t){this.member=e,this.previousMembership=t}get roomId(){return this.member.roomId}get userId(){return this.member.userId}get membership(){return this.member.membership}get wasInvited(){return this.previousMembership==="invite"&&this.membership!=="invite"}get hasLeft(){return this.previousMembership==="join"&&this.membership!=="join"}get hasJoined(){return this.previousMembership!=="join"&&this.membership==="join"}}const na=[Mh,Ch,Th,Ah,xh,Nh,Dh,Vh,Ph,Lh,Oh,Uh,Fh,Bh,Kh,$h,jh];function Eh(n){return{databaseName:n.name,get idbFactory(){throw new Error("unused")},get IDBKeyRange(){throw new Error("unused")},addWriteError(){}}}function Mh(n){n.createObjectStore("session",{keyPath:"key"}),n.createObjectStore("roomSummary",{keyPath:"roomId"}),n.createObjectStore("timelineFragments",{keyPath:"key"}),n.createObjectStore("timelineEvents",{keyPath:"key"}).createIndex("byEventId","eventIdKey",{unique:!0}),n.createObjectStore("roomState",{keyPath:"key"}),n.createObjectStore("pendingEvents",{keyPath:"key"})}async function Ch(n,e){const t=new ra(n.createObjectStore("roomMembers",{keyPath:"key"})),s=e.objectStore("roomState");await X(s.openCursor(),i=>{if(i.event.type===ge){s.delete(i.key);const r=P.fromMemberEvent(i.roomId,i.event);r&&t.set(r.serialize())}return dt})}async function Th(n,e,t){const s=e.objectStore("session");try{const r=await ae(s.get(1));if(r){s.delete(1);const{syncToken:o,syncFilterId:a,serverVersions:c}=r.value,l=new Lr(s,t);l.set("sync",{token:o,filterId:a}),l.set("serverVersions",c)}}catch(i){e.abort(),console.error("could not migrate session",i.stack)}}function Ah(n){n.createObjectStore("userIdentities",{keyPath:"userId"}),n.createObjectStore("deviceIdentities",{keyPath:"key"}).createIndex("byCurve25519Key","curve25519Key",{unique:!0}),n.createObjectStore("olmSessions",{keyPath:"key"}),n.createObjectStore("inboundGroupSessions",{keyPath:"key"}),n.createObjectStore("outboundGroupSessions",{keyPath:"roomId"}),n.createObjectStore("groupSessionDecryptions",{keyPath:"key"}),n.createObjectStore("operations",{keyPath:"id"}).createIndex("byTypeAndScope","typeScopeKey",{unique:!1})}async function xh(n,e){const t=e.objectStore("roomSummary"),s=e.objectStore("roomState"),i=[];await X(t.openCursor(),r=>(i.push(r),dt));for(const r of i){const o=await ae(s.get(`${r.roomId}|m.room.encryption|`));o&&(r.encryption=o?.event?.content,delete r.isEncrypted,t.put(r))}}function Nh(n){n.createObjectStore("accountData",{keyPath:"type"})}function Dh(n){n.createObjectStore("invites",{keyPath:"roomId"})}function Vh(n){n.createObjectStore("archivedRoomSummary",{keyPath:"summary.roomId"})}async function Ph(n,e){try{const t=e.objectStore("operations");t.deleteIndex("byTypeAndScope"),await X(t.openCursor(),(s,i,r)=>{const{typeScopeKey:o}=s;delete s.typeScopeKey;const[a,c]=o.split("|");return s.scopeTypeKey=ps(c,a),r.update(s),dt}),t.createIndex("byScopeAndType","scopeTypeKey",{unique:!1})}catch(t){e.abort(),console.error("could not migrate operations",t.stack)}}function Lh(n){n.createObjectStore("timelineRelations",{keyPath:"key"})}function Oh(){}async function Uh(n,e){const t=e.objectStore("session"),s=await ae(t.get("ssssKey"));s&&t.put({key:`${we}ssssKey`,value:s.value})}async function Fh(n,e,t,s){const i=e.objectStore("session"),r=new Lr(new Xo(i,Eh(n)),t);r.writeE2EEIdentityToLocalStorage();const o=await r.tryRestoreE2EEIdentityFromLocalStorage(s);s.set("restored",o)}async function Bh(n,e){for(const t of n.objectStoreNames){const s=e.objectStore(t);switch(t){case"inboundGroupSessions":case"outboundGroupSessions":case"olmSessions":case"operations":continue;case"session":{await X(s.openCursor(),(i,r,o)=>(r.startsWith(we)||o.delete(),dt));break}default:{s.clear();break}}}}async function Kh(n,e,t,s){e.objectStore("inboundGroupSessions").createIndex("byBackup","backup",{unique:!1})}async function $h(n,e,t,s){const i=e.objectStore("inboundGroupSessions");let r=0,o=0;await X(i.openCursor(),(a,c,l)=>(a.session?(a.backup=Si.NotBackedUp,a.source=xs.DeviceMessage,l.update(a),r+=1):o+=1,dt)),s.set("countWithoutSession",o),s.set("countWithSession",r)}function jh(n){n.createObjectStore("calls",{keyPath:"key"})}async function qh(n){const e="hydrogen_webkit_test_inactive_txn_bug";try{const t=await Nr(e,r=>{r.createObjectStore("test",{keyPath:"key"})},1,n),s=t.transaction(["test"],"readonly");await ae(s.objectStore("test").get("somekey")),await new Promise(r=>setTimeout(r,0));const i=t.transaction(["test"],"readwrite");await Promise.resolve(),i.objectStore("test").add({key:"somekey",value:"foo"}),await Is(i),t.close()}catch(t){if(t.name==="TransactionInactiveError")return!0}return!1}const oa=n=>`hydrogen_session_${n}`,ji=function(n,e,t,s){const i=(r,o,a,c)=>zh(r,o,a,c,t,s);return Nr(oa(n),i,na.length,e)};async function Wh(){const n=this;if(n?.navigator?.storage?.persist)return await n.navigator.storage.persist();if(n?.document.requestStorageAccess)try{return await n.document.requestStorageAccess(),!0}catch(e){return console.warn("requestStorageAccess threw an error:",e),!1}else return!1}class Hh{constructor(e,t=!1,s=self.indexedDB,i=self.IDBKeyRange,r=self.localStorage){this._serviceWorkerHandler=e,this._runSyncInWorker=t,this._idbFactory=s,this._IDBKeyRange=i,this._localStorage=r}async create(e,t){this._runSyncInWorker||await this._serviceWorkerHandler?.preventConcurrentSessionAccess(e),Wh().then(r=>{r||t.log("no persisted storage, database can be evicted by browser",t.level.Warn)});const s=await qh(this._idbFactory),i=await ji(e,this._idbFactory,this._localStorage,t);return new Ih(i,this._idbFactory,this._IDBKeyRange,s,this._localStorage,t.logger)}async delete(e){const t=oa(e);try{eh(this._localStorage,t)}catch{}try{const s=this._idbFactory.deleteDatabase(t);await ae(s)}catch{}}async export(e,t){const s=await ji(e,this._idbFactory,this._localStorage,t);return await Rh(s)}async import(e,t,s){const i=await ji(e,this._idbFactory,this._localStorage,s);return await kh(i,t)}}async function zh(n,e,t,s,i,r){const o=t||0;return r.wrap({l:"storage migration",oldVersion:t,version:s},async a=>{for(let c=o;c<s;++c){const l=na[c];await a.wrap(`v${c+1}`,h=>l(n,e,i,h))}})}class Gh{constructor(){this._encoder=null,this._decoder=null}encode(e){return this._encoder||(this._encoder=new TextEncoder),this._encoder.encode(e)}decode(e){return this._decoder||(this._decoder=new TextDecoder),this._decoder.decode(e)}}var Et={};(function(){for(var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",e=new Uint8Array(256),t=0;t<n.length;t++)e[n.charCodeAt(t)]=t;Et.encode=function(s){var i=new Uint8Array(s),r,o=i.length,a="";for(r=0;r<o;r+=3)a+=n[i[r]>>2],a+=n[(i[r]&3)<<4|i[r+1]>>4],a+=n[(i[r+1]&15)<<2|i[r+2]>>6],a+=n[i[r+2]&63];return o%3===2?a=a.substring(0,a.length-1)+"=":o%3===1&&(a=a.substring(0,a.length-2)+"=="),a},Et.decode=function(s){var i=s.length*.75,r=s.length,o,a=0,c,l,h,d;s[s.length-1]==="="&&(i--,s[s.length-2]==="="&&i--);var u=new ArrayBuffer(i),p=new Uint8Array(u);for(o=0;o<r;o+=4)c=e[s.charCodeAt(o)],l=e[s.charCodeAt(o+1)],h=e[s.charCodeAt(o+2)],d=e[s.charCodeAt(o+3)],p[a++]=c<<2|l>>4,p[a++]=(l&15)<<4|h>>2,p[a++]=(h&3)<<6|d&63;return u}})();class Jh{encodeUnpadded(e){const t=Et.encode(e),s=t.indexOf("=");return s!==-1?t.substr(0,s):t}encode(e){return Et.encode(e)}decode(e){return Et.decode(e)}}function Qh(n){if(n.length>=255)throw new TypeError("Alphabet too long");for(var e=new Uint8Array(256),t=0;t<e.length;t++)e[t]=255;for(var s=0;s<n.length;s++){var i=n.charAt(s),r=i.charCodeAt(0);if(e[r]!==255)throw new TypeError(i+" is ambiguous");e[r]=s}var o=n.length,a=n.charAt(0),c=Math.log(o)/Math.log(256),l=Math.log(256)/Math.log(o);function h(p){if(p instanceof Uint8Array||(ArrayBuffer.isView(p)?p=new Uint8Array(p.buffer,p.byteOffset,p.byteLength):Array.isArray(p)&&(p=Uint8Array.from(p))),!(p instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(p.length===0)return"";for(var _=0,g=0,w=0,I=p.length;w!==I&&p[w]===0;)w++,_++;for(var E=(I-w)*l+1>>>0,A=new Uint8Array(E);w!==I;){for(var v=p[w],R=0,D=E-1;(v!==0||R<g)&&D!==-1;D--,R++)v+=256*A[D]>>>0,A[D]=v%o>>>0,v=v/o>>>0;if(v!==0)throw new Error("Non-zero carry");g=R,w++}for(var K=E-g;K!==E&&A[K]===0;)K++;for(var Dt=a.repeat(_);K<E;++K)Dt+=n.charAt(A[K]);return Dt}function d(p){if(typeof p!="string")throw new TypeError("Expected String");if(p.length===0)return new Uint8Array;for(var _=0,g=0,w=0;p[_]===a;)g++,_++;for(var I=(p.length-_)*c+1>>>0,E=new Uint8Array(I);p[_];){var A=e[p.charCodeAt(_)];if(A===255)return;for(var v=0,R=I-1;(A!==0||v<w)&&R!==-1;R--,v++)A+=o*E[R]>>>0,E[R]=A%256>>>0,A=A/256>>>0;if(A!==0)throw new Error("Non-zero carry");w=v,_++}for(var D=I-w;D!==I&&E[D]===0;)D++;for(var K=new Uint8Array(g+(I-D)),Dt=g;D!==I;)K[Dt++]=E[D++];return K}function u(p){var _=d(p);if(_)return _;throw new Error("Non-base"+o+" character")}return{encode:h,decodeUnsafe:d,decode:u}}var Yh=Qh;const Xh=Yh,Zh="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";var qn=Xh(Zh);class ed{encode(e){return qn.encode(e)}decode(e){return qn.decode(e)}}class td{constructor(){this.utf8=new Gh,this.base64=new Jh,this.base58=new ed}}class sd{constructor(e){this._workerPool=e}megolmDecrypt(e,t){const s=e.export_session(e.first_known_index());return this._workerPool.send({type:"megolm_decrypt",ciphertext:t,sessionKey:s})}async createAccountAndOTKs(e,t){let s;window.msCrypto&&(s=[window.msCrypto.getRandomValues(new Uint8Array(64)),window.msCrypto.getRandomValues(new Uint8Array(t*32))]);const i=await this._workerPool.send({type:"olm_create_account_otks",randomValues:s,otkAmount:t}).response();e.unpickle("",i)}async createOutboundOlmSession(e,t,s,i){const r=e.pickle("");let o;window.msCrypto&&(o=[window.msCrypto.getRandomValues(new Uint8Array(64))]);const a=await this._workerPool.send({type:"olm_create_outbound",accountPickle:r,theirIdentityKey:s,theirOneTimeKey:i,randomValues:o}).response();t.unpickle("",a)}dispose(){this._workerPool.dispose()}}class id{constructor(e){this.options=e,this._queuedItems=this._loadQueuedItems(),window.addEventListener("pagehide",this,!1),this._flushInterval=this.options.platform.clock.createInterval(()=>this._tryFlush(),this.options.flushInterval??60*1e3)}setLogger(e){this.logger=e}reportItem(e,t,s){const i=this.prepareItemForQueue(e,t,s);i&&this._queuedItems.push(i)}async export(){const e=await this._openDB();try{const s=e.transaction(["logs"],"readonly").objectStore("logs"),i=await Gl(s.openCursor(),()=>!1),r=this.getSerializedOpenItems(),o=i.concat(this._queuedItems).concat(r);return new rd(o,this,this.options.platform)}finally{try{e.close()}catch{}}}dispose(){window.removeEventListener("pagehide",this,!1),this._flushInterval.dispose()}handleEvent(e){e.type==="pagehide"&&this._finishAllAndFlush()}async _tryFlush(){const e=await this._openDB();try{const t=e.transaction(["logs"],"readwrite"),s=t.objectStore("logs"),i=this._queuedItems.length;for(const a of this._queuedItems)s.add(a);const r=await ae(s.count()),o=this.options.limit??3e3;if(r>o){let a=r-o+Math.round(.1*o);await X(s.openCursor(),(c,l,h)=>(h.delete(),a-=1,{done:a===0}))}await Is(t),this._queuedItems.splice(0,i)}catch(t){console.error("Could not flush logs",t)}finally{try{e.close()}catch{}}}_finishAllAndFlush(){this.logger&&(this.logger.log({l:"pagehide, closing logs",t:"navigation"}),this.logger.forceFinish()),this._persistQueuedItems(this._queuedItems)}_loadQueuedItems(){const e=`${this.options.name}_queuedItems`;try{const t=window.localStorage.getItem(e);if(t)return window.localStorage.removeItem(e),JSON.parse(t)}catch(t){console.error("Could not load queued log items",t)}return[]}_openDB(){return Nr(this.options.name,e=>e.createObjectStore("logs",{keyPath:"id",autoIncrement:!0}),1)}prepareItemForQueue(e,t,s){let i=e.serialize(t,void 0,s);if(i)return this.options.serializedTransformer&&(i=this.options.serializedTransformer(i)),{json:JSON.stringify(i)}}_persistQueuedItems(e){try{window.localStorage.setItem(`${this.options.name}_queuedItems`,JSON.stringify(e))}catch(t){console.error("Could not persist queued log items in localStorage, they will likely be lost",t)}}async removeItems(e){const t=await this._openDB();try{const s=t.transaction(["logs"],"readwrite"),i=s.objectStore("logs");for(const r of e)if(typeof r.id=="number")i.delete(r.id);else{const o=this._queuedItems.indexOf(r);o===-1&&this._queuedItems.splice(o,1)}await Is(s)}finally{try{t.close()}catch{}}}getSerializedOpenItems(){const e=[];if(!this.logger)return e;const t=new li;for(const s of this.logger.getOpenRootItems()){const i=this.prepareItemForQueue(s,t,!1);i&&e.push(i)}return e}}class rd{constructor(e,t,s){this._items=e,this._logger=t,this._platform=s}get count(){return this._items.length}removeFromStore(){return this._logger.removeItems(this._items)}asBlob(){const e=this.toJSON(),t=this._platform.encoding.utf8.encode(e);return this._platform.createBlob(t,"application/json")}toJSON(){const e={formatVersion:1,appVersion:this._platform.updateService?.version,platform:this._platform.description,items:this._items.map(s=>JSON.parse(s.json))};return JSON.stringify(e)}}class nd{reportItem(e){aa(e)}setLogger(e){this.logger=e}printOpenItems(){if(!!this.logger)for(const e of this.logger.getOpenRootItems())this.reportItem(e)}}const od=["l","id"];function ad(n){return Object.entries(n).filter(([e])=>!od.includes(e)).reduce((e,[t,s])=>(e=e||{},e[t]=s,e),null)}function aa(n){const e=`${cd(n)} (@${n.start}ms, duration: ${n.duration}ms)`,t=ad(n.values),s=n.children||t;if(s?(n.error?console.group(e):console.groupCollapsed(e),n.error&&console.error(n.error)):n.error?console.error(n.error):console.log(e),t&&console.table(t),n.children)for(const i of n.children)aa(i);s&&console.groupEnd()}function cd(n){return n.values.t==="network"?`${n.values.method} ${n.values.url}`:n.values.l&&typeof n.values.id<"u"?`${n.values.l} ${n.values.id}`:n.values.l&&typeof n.values.status<"u"?`${n.values.l} (${n.values.status})`:n.values.l&&typeof n.values.type<"u"?`${n.values.l} (${n.values.type})`:n.values.l&&n.error?`${n.values.l} failed`:typeof n.values.ref<"u"?`ref ${n.values.ref}`:n.values.l||n.values.type}class Wt{constructor(e,t,s,i){this._logger=s,this.start=s._now(),this._values=typeof e=="string"?{l:e}:e,this.logLevel=t,this._filterCreator=i}runDetached(e,t,s,i){return this._logger.runDetached(e,t,s,i)}wrapDetached(e,t,s,i){this.refDetached(this.runDetached(e,t,s,i))}refDetached(e,t){e.ensureRefId(),this.log({ref:e.values.refId},t)}ensureRefId(){this._values.refId||this.set("refId",this._logger._createRefId())}wrap(e,t,s,i){return this.child(e,s,i).run(t)}get duration(){if(this.end)return this.end-this.start}durationWithoutType(e){const t=this.durationOfType(e);if(this.duration&&t)return this.duration-t}durationOfType(e){return this._values.t===e?this.duration:this._children?this._children.reduce((t,s)=>{const i=s.durationOfType(e);return t+(i??0)},0):0}log(e,t){const s=this.child(e,t);return s.end=s.start,s}set(e,t){if(typeof e=="object"){const s=e;Object.assign(this._values,s)}else this._values[e]=t;return this}serialize(e,t,s){if(this._filterCreator)try{e=this._filterCreator(new li(e),this)}catch(o){console.error("Error creating log filter",o)}let i=null;if(this._children&&(i=this._children.reduce((o,a)=>{const c=a.serialize(e,this.start,!1);return c&&(o===null&&(o=[]),o.push(c)),o},null)),e&&!e.filter(this,i))return;const r={s:typeof t=="number"?this.start-t:this.start,d:this.duration,v:this._values,l:this.logLevel};return this.error&&(r.e={stack:this.error.stack,name:this.error.name,message:this.error.message.split(`
`)[0]}),s&&(r.f=!0),i&&(r.c=i),r}run(e){this.end!==void 0&&console.trace("log item is finished, additional logs will likely not be recorded");try{const t=e(this);return t instanceof Promise?t.then(s=>(this.finish(),s),s=>{throw this.catch(s)}):(this.finish(),t)}catch(t){throw this.catch(t)}}finish(){if(this.end===void 0){if(this._children)for(const e of this._children)e.finish();this.end=this._logger._now()}}forceFinish(){this.finish()}get level(){return ye}catch(e){return this.error=e,this.logLevel=ye.Error,this.finish(),e}child(e,t,s){this.end&&console.trace(`log item ${this.values.l} finished, additional log ${JSON.stringify(e)} will likely not be recorded`),t||(t=this.logLevel||ye.Info);const i=new Wt(e,t,this._logger,s);return this._children||(this._children=[]),this._children.push(i),i}get logger(){return this._logger}get values(){return this._values}get children(){return this._children}}class ld{constructor({platform:e}){this._openItems=new Set,this.reporters=[],this._platform=e}log(e,t=ye.Info){const s=new Wt(e,t,this);return s.end=s.start,this._persistItem(s,void 0,!1),s}child(e,t=ye.Info,s){const i=new hd(e,t,this,s);return this._openItems.add(i),i}wrapOrRun(e,t,s,i,r){return e?e.wrap(t,s,i,r):this.run(t,s,i,r)}runDetached(e,t,s,i){s||(s=ye.Info);const r=new Wt(e,s,this);return this._run(r,t,s,!1,i),r}run(e,t,s,i){s===void 0&&(s=ye.Info);const r=new Wt(e,s,this);return this._run(r,t,s,!0,i)}_run(e,t,s,i,r){this._openItems.add(e);const o=()=>{let a=new li;if(r)try{a=r(a,e)}catch(c){console.error("Error while creating log filter",c)}else a=a.minLevel(s);try{this._persistItem(e,a,!1)}catch(c){console.error("Could not persist log item",c)}this._openItems.delete(e)};try{let a=e.run(t);if(a instanceof Promise){if(a=a.then(c=>(o(),c),c=>{if(o(),i)throw c}),i)return a}else if(o(),i)return a}catch(a){if(o(),i)throw a}}addReporter(e){e.setLogger(this),this.reporters.push(e)}getOpenRootItems(){return this._openItems}forceFinish(){for(const e of this._openItems){e.forceFinish();try{this._persistItem(e,new li,!0)}catch(t){console.error("Could not serialize log item",t)}}this._openItems.clear()}_removeItemFromOpenList(e){this._openItems.delete(e)}_persistItem(e,t,s){for(var i=0;i<this.reporters.length;i+=1)this.reporters[i].reportItem(e,t,s)}get level(){return ye}_now(){return this._platform.clock.now()}_createRefId(){return Math.round(this._platform.random()*Number.MAX_SAFE_INTEGER)}}class hd extends Wt{finish(){super.finish(),this._logger._persistItem(this,void 0,!1),this._logger._removeItemFromOpenList(this)}forceFinish(){super.finish()}}function ca(n){return typeof n!="object"||"nodeType"in n||Array.isArray(n)}function Gt(n,e){return Object.entries(n).reduce((t,[s,i])=>(typeof i=="function"&&(i=i(e)),i?t+(t.length?" ":"")+s:t),"")}function Ht(n,e,t){e==="className"&&(e="class"),t===!1?n.removeAttribute(e):(t===!0&&(t=e),n.setAttribute(e,t))}function dd(n,e,t){return la(Fr,n,e,t)}function la(n,e,t,s){t&&ca(t)&&(s=t,t=void 0);const i=document.createElementNS(n,e);if(t)for(let[r,o]of Object.entries(t))typeof o=="object"&&(o=o!==null&&r==="className"?Gt(o,void 0):!1),Ht(i,r,o);if(s){Array.isArray(s)||(s=[s]);for(let r of s)typeof r=="string"&&(r=Qe(r)),i.appendChild(r)}return i}function Qe(n){return document.createTextNode(n)}const Fr="http://www.w3.org/1999/xhtml",ud="http://www.w3.org/2000/svg",ha={[Fr]:["br","a","ol","ul","li","div","h1","h2","h3","h4","h5","h6","p","strong","em","span","img","section","header","main","footer","dialog","article","aside","del","blockquote","details","summary","table","thead","tbody","tr","th","td","hr","pre","code","button","time","input","textarea","select","option","optgroup","label","form","progress","output","video","style"],[ud]:["svg","g","path","circle","ellipse","rect","use"]},N={};for(const[n,e]of Object.entries(ha))for(const t of e)N[t]=function(s,i){return la(n,t,s,i)};function Rs(n,e){let t;try{t=n.mount(e)}catch(s){console.error(s),t=md(s)}return t}function md(n){const e=new Error().stack;let t=null;return e&&(t=e.split(`
`)[1]),N.div([N.h2("Something went wrong\u2026"),N.h3(n.message),N.p(`This occurred while running ${t}.`),N.pre(n.stack)])}function Wn(n,e,t){if(e===n.childElementCount)n.appendChild(t);else{const i=n.children[e];n.insertBefore(t,i)}}function pd(n){n.innerHTML=""}function Br(n){return async e=>{e.target?.setAttribute("disabled","disabled"),await n(e),e.target?.removeAttribute("disabled")}}class mt{constructor({list:e,onItemClick:t,className:s,tagName:i="ul",parentProvidesUpdates:r=!0},o){this._onItemClick=t,this._list=e,this._className=s,this._tagName=i,this._root=void 0,this._subscription=void 0,this._childCreator=o,this._childInstances=void 0,this._mountArgs={parentProvidesUpdates:r}}root(){return this._root}update(e){if(e.list){if(this._subscription)for(this._unloadList();this._root.lastChild;)this._root.lastChild.remove();this._list=e.list,this.loadList()}}mount(){const e={};this._className&&(e.className=this._className);const t=this._root=dd(this._tagName,e);return this.loadList(),this._onItemClick&&t.addEventListener("click",this),t}handleEvent(e){e.type==="click"&&this._handleClick(e)}unmount(){this._list&&this._unloadList()}_handleClick(e){if(e.target===this._root||!this._onItemClick)return;let t=e.target;for(;t.parentNode!==this._root;)t=t.parentNode;const s=Array.prototype.indexOf.call(this._root.childNodes,t),i=this._childInstances[s];i&&this._onItemClick(i,e)}_unloadList(){this._subscription=this._subscription();for(let e of this._childInstances)e.unmount();this._childInstances=void 0}loadList(){if(!this._list)return;this._subscription=this._list.subscribe(this),this._childInstances=[];const e=document.createDocumentFragment();for(let t of this._list){const s=this._childCreator(t);this._childInstances.push(s),e.appendChild(Rs(s,this._mountArgs))}this._root.appendChild(e)}onReset(){for(const e of this._childInstances)e.root().remove(),e.unmount();this._childInstances.length=0}onAdd(e,t){this.addChild(e,t)}onRemove(e,t){this.removeChild(e)}onMove(e,t,s){this.moveChild(e,t)}onUpdate(e,t,s){this.updateChild(e,t,s)}addChild(e,t){const s=this._childCreator(t);this._childInstances.splice(e,0,s),Wn(this._root,e,Rs(s,this._mountArgs))}removeChild(e){const[t]=this._childInstances.splice(e,1);t.root().remove(),t.unmount()}moveChild(e,t){const[s]=this._childInstances.splice(e,1);this._childInstances.splice(t,0,s),s.root().remove(),Wn(this._root,t,s.root())}updateChild(e,t,s){if(this._childInstances){const i=this._childInstances[e];i&&i.update(t,s)}}recreateItem(e,t){if(this._childInstances){const s=this._childCreator(t);if(!s)this.onRemove(e,t);else{const[i]=this._childInstances.splice(e,1,s);this._root.replaceChild(s.mount(this._mountArgs),i.root()),i.unmount()}}}getChildInstanceByIndex(e){return this._childInstances?.[e]}}class da{constructor(e){this._value=e,this._boundUpdateFromValue=null}subscribeOnMount(e){e&&e.parentProvidesUpdates||this._subscribe()}unmount(){this._unsubscribe()}get value(){return this._value}_updateFromValue(e){this.update(this._value,e)}_subscribe(){typeof this._value?.on=="function"&&(this._boundUpdateFromValue=this._updateFromValue.bind(this),this._value.on("change",this._boundUpdateFromValue))}_unsubscribe(){this._boundUpdateFromValue&&(typeof this._value.off=="function"&&this._value.off("change",this._boundUpdateFromValue),this._boundUpdateFromValue=null)}}function _d(n){for(const e of Object.values(n))if(typeof e=="function")return!0;return!1}class b extends da{constructor(){super(...arguments),this._eventListeners=void 0,this._bindings=void 0,this._root=void 0,this._subViews=void 0}_attach(){if(this._eventListeners)for(let{node:e,name:t,fn:s,useCapture:i}of this._eventListeners)e.addEventListener(t,s,i)}_detach(){if(this._eventListeners)for(let{node:e,name:t,fn:s,useCapture:i}of this._eventListeners)e.removeEventListener(t,s,i)}mount(e){const t=new ua(this);try{this._root=this.render(t,this._value)}finally{t.close()}return this.subscribeOnMount(e),this._attach(),this._root}unmount(){if(this._detach(),super.unmount(),this._subViews)for(const e of this._subViews)e.unmount()}root(){return this._root}update(e,t){if(this._value=e,this._bindings)for(const s of this._bindings)s()}_addEventListener(e,t,s,i=!1){this._eventListeners||(this._eventListeners=[]),this._eventListeners.push({node:e,name:t,fn:s,useCapture:i})}_addBinding(e){this._bindings||(this._bindings=[]),this._bindings.push(e)}addSubView(e){this._subViews||(this._subViews=[]),this._subViews.push(e)}removeSubView(e){if(!this._subViews)return;const t=this._subViews.indexOf(e);t!==-1&&this._subViews.splice(t,1)}updateSubViews(e,t){if(this._subViews)for(const s of this._subViews)s.update(e,t)}}class ua{constructor(e){this._closed=!1,this._templateView=e}close(){this._closed=!0}_addBinding(e){this._closed&&console.trace("Adding a binding after render will likely cause memory leaks"),this._templateView._addBinding(e)}get _value(){return this._templateView.value}addEventListener(e,t,s,i=!1){this._templateView._addEventListener(e,t,s,i)}_addAttributeBinding(e,t,s){let i;const r=()=>{const o=s(this._value);i!==o&&(i=o,Ht(e,t,o))};this._addBinding(r),r()}_addClassNamesBinding(e,t){this._addAttributeBinding(e,"className",s=>Gt(t,s))}_addTextBinding(e){const t=e(this._value)+"",s=Qe(t);let i=t;const r=()=>{const o=e(this._value)+"";i!==o&&(i=o,s.textContent=o)};return this._addBinding(r),s}_isEventHandler(e,t){return e.startsWith("on")&&e.length>2&&typeof t=="function"}_setNodeAttributes(e,t){for(let[s,i]of Object.entries(t))if(typeof i=="object"){if(s!=="className"||i===null)continue;_d(i)?this._addClassNamesBinding(e,i):Ht(e,s,Gt(i,this._value))}else if(this._isEventHandler(s,i)){const r=s.substr(2,1).toLowerCase()+s.substr(3),o=i;this._templateView._addEventListener(e,r,o)}else typeof i=="function"?this._addAttributeBinding(e,s,i):Ht(e,s,i)}_setNodeChildren(e,t){Array.isArray(t)||(t=[t]);for(let s of t)typeof s=="function"?s=this._addTextBinding(s):typeof s=="string"&&(s=Qe(s)),e.appendChild(s)}_addReplaceNodeBinding(e,t){let s=e(this._value),i=t(null);const r=()=>{const o=e(this._value);if(s!==o){s=o;const a=t(i);i.parentNode&&i.parentNode.replaceChild(a,i),i=a}};return this._addBinding(r),i}el(e,t,s){return this.elNS(Fr,e,t,s)}elNS(e,t,s,i){let r;s&&(ca(s)?i=s:r=s);const o=document.createElementNS(e,t);return r&&this._setNodeAttributes(o,r),i&&this._setNodeChildren(o,i),o}view(e,t){return this._templateView.addSubView(e),Rs(e,t)}mapView(e,t){return this._addReplaceNodeBinding(e,s=>{if(s&&s.nodeType!==Node.COMMENT_NODE){const r=this._templateView._subViews;if(r){const o=r.findIndex(a=>a.root()===s);if(o!==-1){const[a]=r.splice(o,1);a.unmount()}}}const i=t(e(this._value));return i?this.view(i):document.createComment("node binding placeholder")})}map(e,t){return this.mapView(e,s=>new ui(this._value,(i,r)=>{const o=t(s,i,r);return o||document.createComment("map placeholder")}))}ifView(e,t){return this.mapView(s=>!!e(s),s=>s?t(this._value):null)}if(e,t){return this.ifView(e,s=>new ui(s,t))}mapSideEffect(e,t){let s=e(this._value);const i=()=>{const r=e(this._value);s!==r&&(t(r,s,this._value),s=r)};this._addBinding(i),t(s,void 0,this._value)}}for(const[n,e]of Object.entries(ha))for(const t of e)ua.prototype[t]=function(s,i){return this.elNS(n,t,s,i)};class ui extends b{constructor(e,t){super(e),this._render=t}render(e,t){return this._render(e,t)}}function Rt(n,e,t=void 0){const s=!!n.avatarUrl(e);let i=Gt({avatar:!0,[`size-${e}`]:!0,[`usercolor${n.avatarColorNumber}`]:!s});t&&(i+=` ${t}`);const r=s?ma(n,e):Qe(n.avatarLetter),o=N.div({className:i,title:n.avatarTitle,"data-testid":"avatar"},[r]);return s&&(Ht(o,"data-avatar-letter",n.avatarLetter),Ht(o,"data-avatar-color",n.avatarColorNumber)),o}function ma(n,e){const t=e.toString();return N.img({src:n.avatarUrl(e),width:t,height:t,title:n.avatarTitle})}function gd(n){const e=n.target,t=e.parentElement;return e.tagName==="IMG"&&t.classList.contains("avatar")}function Hn(n){if(!gd(n))return;const e=n.target.parentElement,t=e.getAttribute("data-avatar-color");e.classList.add(`usercolor${t}`);const s=e.getAttribute("data-avatar-letter");e.textContent=s}class xe extends da{constructor(e,t){super(e),this._root=null,this._avatarUrl=null,this._avatarTitle=null,this._avatarLetter=null,this._size=t}_avatarUrlChanged(){return this.value.avatarUrl(this._size)!==this._avatarUrl?(this._avatarUrl=this.value.avatarUrl(this._size),!0):!1}_avatarTitleChanged(){return this.value.avatarTitle!==this._avatarTitle?(this._avatarTitle=this.value.avatarTitle,!0):!1}_avatarLetterChanged(){return this.value.avatarLetter!==this._avatarLetter?(this._avatarLetter=this.value.avatarLetter,!0):!1}mount(e){return this._avatarUrlChanged(),this._avatarLetterChanged(),this._avatarTitleChanged(),this._root=Rt(this.value,this._size),this.subscribeOnMount(e),this._root}root(){return this._root}update(e){if(this._avatarUrlChanged()){const s=`usercolor${e.avatarColorNumber}`;e.avatarUrl(this._size)?(this._root.replaceChild(ma(e,this._size),this._root.firstChild),this._root.classList.remove(s)):(this._root.textContent=e.avatarLetter,this._root.classList.add(s))}const t=!!e.avatarUrl(this._size);if(this._avatarTitleChanged()&&t){const s=this._root.firstChild;s.tagName==="IMG"&&s.setAttribute("title",e.avatarTitle)}this._avatarLetterChanged()&&!t&&(this._root.textContent=e.avatarLetter)}}let qi;function Se(n,e=void 0){qi===void 0&&(qi=document.querySelector(".hydrogen"));const t=Object.assign({spinner:!0},e);return qi?.classList.contains("legacy")?n.div({className:t},[n.div(),n.div(),n.div(),n.div()]):n.svg({className:t,viewBox:"0 0 100 100"},n.circle({cx:"50%",cy:"50%",r:"45%",pathLength:"100"}))}class fd extends b{render(e,t){const s={active:i=>i.isOpen,hidden:i=>i.hidden};return e.li({className:s},[e.a({href:t.url},[e.view(new xe(t,32),{parentProvidesUpdates:!0}),e.div({className:"description"},[e.div({className:{name:!0,unread:i=>i.isUnread}},i=>i.name),e.map(i=>i.busy,i=>i?Se(e):e.div({className:{badge:!0,highlighted:r=>r.isHighlighted,hidden:r=>!r.badgeCount}},r=>r.badgeCount))])])])}update(e,t){super.update(e),this.updateSubViews(e,t)}}class O extends b{static option(e,t){return new yd(e,t)}constructor(e){super(),this._options=e}render(e){return e.ul({className:"menu",role:"menu"},this._options.map(t=>t.toDOM(e)))}}class yd{constructor(e,t){this.label=e,this.callback=t,this.icon=null,this.destructive=!1}setIcon(e){return this.icon=e,this}setDestructive(){return this.destructive=!0,this}toDOM(e){const t={destructive:this.destructive};return this.icon&&(t.icon=!0,t[this.icon]=!0),e.li({className:t},e.button({className:"menu-item",onClick:this.callback},this.label))}}class es{constructor(e,t=null){this._view=e,this._target=null,this._arrangement=null,this._scroller=null,this._fakeRoot=null,this._trackingTemplateView=null,this._closeCallback=t}_getPopupContainer(){const e=this._target.closest(".hydrogen");let t=e.querySelector(".popupContainer");return t||(t=N.div({className:"popupContainer"}),e.appendChild(t)),t}trackInTemplateView(e){this._trackingTemplateView=e,this._trackingTemplateView.addSubView(this)}showRelativeTo(e,t=0){this._target=e,this._verticalPadding=t,this._scroller=wd(this._target),this._view.mount(),this._getPopupContainer().appendChild(this._popup),this._position(),this._scroller&&document.body.addEventListener("scroll",this,!0),setTimeout(()=>{document.body.addEventListener("click",this,!1)},10)}get isOpen(){return!!this._view}close(){this._view&&(this._view.unmount(),this._trackingTemplateView.removeSubView(this),this._scroller&&document.body.removeEventListener("scroll",this,!0),document.body.removeEventListener("click",this,!1),this._popup.remove(),this._view=null,this._closeCallback&&this._closeCallback())}get _popup(){return this._view.root()}handleEvent(e){e.type==="scroll"?this._position()||this.close():e.type==="click"&&this._onClick(e)}_onClick(){this.close()}_position(){const e=this._target.getBoundingClientRect(),t=this._popup.clientWidth,s=this._popup.clientHeight,i=(this._scroller?this._scroller:document.documentElement).getBoundingClientRect();if(e.top>i.bottom||e.left>i.right||e.bottom<i.top||e.right<i.left)return!1;if(i.bottom>=e.bottom+s)this._popup.style.top=`${e.bottom+this._verticalPadding}px`;else if(i.top<=e.top-s)this._popup.style.top=`${e.top-s-this._verticalPadding}px`;else return!1;if(i.right>=e.right+t)this._popup.style.left=`${e.left}px`;else if(i.left<=e.left-t)this._popup.style.left=`${e.right-t}px`;else return!1;return!0}root(){return this._fakeRoot}mount(){return this._fakeRoot=document.createComment("popup"),this._fakeRoot}unmount(){this.close()}update(){}}function wd(n){let e=n;do if(e=e.parentElement,e.scrollHeight>e.clientHeight){const s=window.getComputedStyle(e).getPropertyValue("overflow-y");if(s==="auto"||s==="scroll")return e}while(e!==document.body)}class vd extends b{render(e,t){const s=()=>{i.value="",i.blur(),r.blur(),t.clear()},i=e.input({type:"text",placeholder:t?.label,"aria-label":t?.label,autocomplete:t?.autocomplete,enterkeyhint:"search",name:t?.name,onInput:o=>t.set(o.target.value),onKeydown:o=>{(o.key==="Escape"||o.key==="Esc")&&s()},onFocus:()=>i.select()}),r=e.button({onClick:s,title:t.i18n`Clear`,"aria-label":t.i18n`Clear`});return e.div({className:"FilterField"},[i,r])}}class pa extends b{constructor(e){super(e),this._createMenuPopup=null}render(e,t){const s=o=>o.gridEnabled?o.i18n`Show single room`:o.i18n`Enable grid layout`,i=e.view(new mt({className:"RoomList",list:t.tileViewModels},o=>new fd(o))),r=e.div({className:"utilities"},[e.a({className:"button-utility close-session",href:t.closeUrl,"aria-label":t.i18n`Back to account list`,title:t.i18n`Back to account list`}),e.view(new vd({i18n:t.i18n,label:t.i18n`Filter rooms…`,name:"room-filter",autocomplete:!0,set:o=>{t.setFilter(o)&&(i.scrollTop=0)},clear:()=>t.clearFilter()})),e.button({onClick:()=>t.toggleGrid(),className:{"button-utility":!0,grid:!0,on:o=>o.gridEnabled},title:s,"aria-label":s}),e.a({className:"button-utility settings",href:t.settingsUrl,"aria-label":t.i18n`Settings`,title:t.i18n`Settings`}),e.button({className:"button-utility create","aria-label":t.i18n`Create room`,onClick:o=>this._toggleCreateMenu(o)})]);return e.div({className:"LeftPanel"},[r,i])}_toggleCreateMenu(e){if(this._createMenuPopup&&this._createMenuPopup.isOpen)this._createMenuPopup.close();else{const t=this.value,s=[];s.push(O.option(t.i18n`Create Room`,()=>t.showCreateRoomView())),s.push(O.option(t.i18n`Join Room`,()=>t.showJoinRoomView())),this._createMenuPopup=new es(new O(s)),this._createMenuPopup.trackInTemplateView(this),this._createMenuPopup.showRelativeTo(e.target,10)}}}function zn(n){return n.offsetTop+n.clientHeight}function Gn(n,e,t=n.children.length-1){for(var s=t;s>=0;s--)if(n.children[s].offsetTop<e)return s;return 0}class _a extends b{constructor(e,t){super(e),this.viewClassForTile=t,this.anchoredBottom=0,this.stickToBottom=!0}render(e,t){requestAnimationFrame(()=>{this.restoreScrollPosition()}),this.tilesView=new bd(t.tiles,()=>this.restoreScrollPosition(),this.viewClassForTile);const s=e.div({className:"Timeline"},[e.div({className:"Timeline_scroller bottom-aligned-scroll",onScroll:()=>this.onScroll()},e.view(this.tilesView)),e.button({className:{Timeline_jumpDown:!0,hidden:i=>!i.showJumpDown},title:"Jump down",onClick:()=>this.jumpDown()})]);return typeof ResizeObserver=="function"&&(this.resizeObserver=new ResizeObserver(()=>{this.restoreScrollPosition()}),this.resizeObserver.observe(s)),s}get scrollNode(){return this.root().firstElementChild}get tilesNode(){return this.tilesView.root()}jumpDown(){const{scrollNode:e}=this;this.stickToBottom=!0,e.scrollTop=e.scrollHeight}unmount(){super.unmount(),this.resizeObserver&&(this.resizeObserver.unobserve(this.root()),this.resizeObserver=void 0)}restoreScrollPosition(){const{scrollNode:e,tilesNode:t}=this,s=e.clientHeight-t.clientHeight;if(s>0){t.style.setProperty("margin-top",`${s}px`);const i=this.value.tiles.length;this.updateVisibleRange(0,i-1)}else if(t.style.removeProperty("margin-top"),this.stickToBottom)e.scrollTop=e.scrollHeight;else if(this.anchoredNode){const i=zn(this.anchoredNode);if(i!==this.anchoredBottom){const r=i-this.anchoredBottom;typeof e.scrollBy=="function"?e.scrollBy(0,r):e.scrollTop=e.scrollTop+r,this.anchoredBottom=i}}}onScroll(){const{scrollNode:e,tilesNode:t}=this,{scrollHeight:s,scrollTop:i,clientHeight:r}=e;let o;if(this.stickToBottom=Math.abs(s-(i+r))<1,this.stickToBottom)o=this.value.tiles.length-1;else{const c=i+r,l=Gn(t,c);this.anchoredNode=t.childNodes[l],this.anchoredBottom=zn(this.anchoredNode),o=l}let a=Gn(t,i,o);this.updateVisibleRange(a,o)}updateVisibleRange(e,t){const s=this.tilesView.getChildInstanceByIndex(e),i=this.tilesView.getChildInstanceByIndex(t);this.value.setVisibleTileRange(s?.value,i?.value)}}class bd extends mt{constructor(e,t,s){super({list:e,onItemClick:(i,r)=>i.onClick(r)},i=>{const r=s(i);return new r(i,s)}),this.viewClassForTile=s,this.onChanged=t}onReset(){super.onReset(),this.onChanged()}onUpdate(e,t,s){if(s==="shape"){const i=this.viewClassForTile(t),r=this.getChildInstanceByIndex(e);if(!i||!(r instanceof i)){super.recreateItem(e,t);return}}super.onUpdate(e,t,s),this.onChanged()}onAdd(e,t){super.onAdd(e,t),this.onChanged()}onRemove(e,t){super.onRemove(e,t),this.onChanged()}onMove(e,t,s){super.onMove(e,t,s),this.onChanged()}}class ga extends b{render(e,t){return e.div({className:"TimelineLoadingView"},[Se(e),e.div(t.isEncrypted?t.i18n`Loading encrypted messages…`:t.i18n`Loading messages…`)])}}class Sd extends b{constructor(e,t){super(e),this._viewClassForTile=t,this._input=null,this._attachmentPopup=null,this._focusInput=null,this._rafResizeHandle=void 0}render(e,t){this._input=e.textarea({onKeydown:r=>this._onKeyDown(r),onInput:()=>{t.setInput(this._input.value),this._input.value?this._adjustHeight():this._clearHeight()},placeholder:r=>r.isEncrypted?"Send an encrypted message\u2026":"Send a message\u2026",rows:"1"}),this._focusInput=()=>this._input.focus(),this.value.on("focus",this._focusInput);const s=e.map(r=>r.replyViewModel,(r,o)=>{const a=r&&this._viewClassForTile(r);return a?o.div({className:"MessageComposer_replyPreview"},[o.span({className:"replying"},"Replying"),o.button({className:"cancel",onClick:()=>this._clearReplyingTo()},"Close"),o.view(new a(r,this._viewClassForTile,{interactive:!1},"div"))]):null}),i=e.div({className:"MessageComposer_input"},[this._input,e.button({className:"sendFile",title:t.i18n`Pick attachment`,onClick:r=>this._toggleAttachmentMenu(r)},t.i18n`Send file`),e.button({className:"send",title:t.i18n`Send`,onClick:()=>this._trySend()},t.i18n`Send`)]);return e.div({className:{MessageComposer:!0,MessageComposer_canSend:r=>r.canSend}},[s,i])}unmount(){this._focusInput&&this.value.off("focus",this._focusInput),super.unmount()}_clearReplyingTo(){this.value.clearReplyingTo()}async _trySend(){this._input.focus();const{value:e}=this._input,t=()=>{this._input.value=e,this._adjustHeight()};this._input.value="",this._clearHeight();try{await this.value.sendMessage(e)||t()}catch(s){t(),console.error(s)}}_onKeyDown(e){e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),this._trySend())}_toggleAttachmentMenu(e){if(this._attachmentPopup&&this._attachmentPopup.isOpen)this._attachmentPopup.close();else{const t=this.value;this._attachmentPopup=new es(new O([O.option(t.i18n`Send video`,()=>t.sendVideo()).setIcon("video"),O.option(t.i18n`Send picture`,()=>t.sendPicture()).setIcon("picture"),O.option(t.i18n`Send file`,()=>t.sendFile()).setIcon("file")])),this._attachmentPopup.trackInTemplateView(this),this._attachmentPopup.showRelativeTo(e.target,12)}}_adjustHeight(){this._rafResizeHandle||(this._rafResizeHandle=window.requestAnimationFrame(()=>{const e=this._input.scrollHeight;this._input.style.height=`${e}px`,this._rafResizeHandle=void 0}))}_clearHeight(){this._input.style.removeProperty("height")}}class Id extends b{render(e){return e.div({className:"DisabledComposerView"},e.h3(t=>t.description))}}class ts extends b{constructor(e,t={inline:!1}){super(e),this.options=t}render(e,t){const s=e.button({className:"ErrorView_submit",onClick:Br(async r=>{r.stopPropagation(),await t.submitLogs()?alert("Logs submitted!"):alert("Could not submit logs")})},"Submit logs"),i=e.button({className:"ErrorView_close",onClick:r=>{r.stopPropagation(),t.close()},title:"Dismiss error"});return e.div({className:{ErrorView:!0,ErrorView_inline:this.options.inline,ErrorView_block:!this.options.inline}},[e.p({className:"ErrorView_message"},t.message),s,i])}}class Rd extends b{render(e,t){const s=e.view(new mt({className:"CallView_members",list:t.memberViewModels},i=>new kd(i)));return this.bindMembersCssClasses(e,s),e.div({class:"CallView"},[s,e.div({class:"CallView_buttons"},[e.button({className:{CallView_mutedMicrophone:i=>i.isMicrophoneMuted,CallView_unmutedMicrophone:i=>!i.isMicrophoneMuted},onClick:Wi(()=>t.toggleMicrophone())}),e.button({className:{CallView_mutedCamera:i=>i.isCameraMuted,CallView_unmutedCamera:i=>!i.isCameraMuted},onClick:Wi(()=>t.toggleCamera())}),e.button({className:"CallView_hangup",onClick:Wi(()=>t.hangup())})]),e.if(i=>!!i.errorViewModel,i=>i.div({className:"CallView_error"},i.view(new ts(t.errorViewModel))))])}bindMembersCssClasses(e,t){if(e.mapSideEffect(s=>s.memberCount,s=>{t.classList.forEach((i,r,o)=>{i.startsWith("size")&&o.remove(i)}),t.classList.add(`size${s}`)}),typeof ResizeObserver=="function"){const s=(i,r)=>{r?t.classList.add(i):t.classList.remove(i)};this.resizeObserver=new ResizeObserver(()=>{const i=t.clientWidth/t.clientHeight,r=i<.5,o=!r&&i<1.8,a=!r&&!o;s("tall",r),s("square",o),s("wide",a)}),this.resizeObserver.observe(t)}}unmount(){this.resizeObserver&&(this.resizeObserver.unobserve(this.root().querySelector(".CallView_members")),this.resizeObserver=void 0),super.unmount()}}class kd extends b{render(e,t){const s=e.video({autoplay:!0,disablePictureInPicture:!0,className:{hidden:i=>i.isCameraMuted}});return e.mapSideEffect(i=>i.stream,i=>{s.srcObject=i}),e.div({className:"StreamView"},[s,e.div({className:{StreamView_avatar:!0,hidden:i=>!i.isCameraMuted}},e.view(new xe(t,96),{parentProvidesUpdates:!0})),e.div({className:{StreamView_muteStatus:!0,hidden:i=>!i.isCameraMuted&&!i.isMicrophoneMuted,microphoneMuted:i=>i.isMicrophoneMuted&&!i.isCameraMuted,cameraMuted:i=>i.isCameraMuted}}),e.if(i=>!!i.errorViewModel,i=>i.div({className:"StreamView_error"},i.view(new ts(t.errorViewModel))))])}update(e,t){super.update(e),this.updateSubViews(e,t)}}function Wi(n){return async e=>{e.target?.setAttribute("disabled","disabled"),await n(e),e.target?.removeAttribute("disabled")}}class Kr extends b{constructor(e,t){super(e),this._viewClassForTile=t,this._optionsPopup=null}render(e,t){return e.main({className:"RoomView middle"},[e.div({className:"RoomHeader middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close room`}),e.view(new xe(t,32)),e.div({className:"room-description"},[e.h2(s=>s.name)]),e.button({className:"button-utility room-options","aria-label":t.i18n`Room options`,onClick:s=>this._toggleOptionsMenu(s)})]),e.div({className:"RoomView_body"},[e.if(s=>s.errorViewModel,s=>s.div({className:"RoomView_error"},s.view(new ts(t.errorViewModel)))),e.mapView(s=>s.callViewModel,s=>s?new Rd(s):null),e.mapView(s=>s.timelineViewModel,s=>s?new _a(s,this._viewClassForTile):new ga(t)),e.mapView(s=>s.composerViewModel,s=>{switch(s?.kind){case"composer":return new Sd(t.composerViewModel,this._viewClassForTile);case"disabled":return new Id(t.composerViewModel)}})])])}_toggleOptionsMenu(e){if(this._optionsPopup&&this._optionsPopup.isOpen)this._optionsPopup.close();else{const t=this.value,s=[];if(s.push(O.option(t.i18n`Room details`,()=>t.openDetailsPanel())),t.features.calls&&s.push(O.option(t.i18n`Start call`,()=>t.startCall())),t.canLeave&&s.push(O.option(t.i18n`Leave room`,()=>this._confirmToLeaveRoom()).setDestructive()),t.canForget&&s.push(O.option(t.i18n`Forget room`,()=>t.forgetRoom()).setDestructive()),t.canRejoin&&s.push(O.option(t.i18n`Rejoin room`,()=>t.rejoinRoom())),!s.length)return;this._optionsPopup=new es(new O(s)),this._optionsPopup.trackInTemplateView(this),this._optionsPopup.showRelativeTo(e.target,10)}}_confirmToLeaveRoom(){confirm(this.value.i18n`Are you sure you want to leave "${this.value.name}"?`)&&this.value.leaveRoom()}}class $r extends b{render(e,t){return e.main({className:"RoomView UnknownRoomView middle"},[e.div({className:"UnknownRoomView_header RoomHeader middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Cancel room join`}),e.div({className:"room-description"},[e.h2(t.i18n`Join room`)]),e.button({className:"button-utility room-options","aria-label":t.i18n`Room options`,onClick:s=>this._toggleOptionsMenu(s,t)})]),e.div({className:"UnknownRoomView_body centered-column"},[e.div({className:"UnknownRoomView_container"},[e.h2([t.i18n`You are currently not in ${t.roomIdOrAlias}.`]),e.if(s=>s.joinAllowed,s=>s.div([s.h3(t.i18n`Want to join it?`),s.button({className:"button-action primary",onClick:()=>t.join(),disabled:i=>i.busy},t.i18n`Join room`)])),e.if(s=>s.checkingPreviewCapability,s=>s.div({className:"checkingPreviewCapability"},[Se(s),s.p(t.i18n`Checking preview capability...`)])),e.if(s=>s.error,s=>s.p({className:"error"},t.error))])])])}_toggleOptionsMenu(e,t){if(super._optionsPopup&&super._optionsPopup.isOpen)super._optionsPopup.close();else{const s=new es(new O([O.option(t.i18n`Settings`,()=>t.navigation.push("settings"))]));s.trackInTemplateView(this),s.showRelativeTo(e.target,10),super._optionsPopup=s}}}class Ed extends mt{constructor(e){const t={className:"Timeline_messageReactions",tagName:"div",list:e.reactions,onItemClick:s=>s.onClick()};super(t,s=>new Md(s))}}class Md extends b{render(e,t){return e.button({className:{active:s=>s.isActive,pending:s=>s.isPending}},[t.key," ",s=>`${s.count}`])}onClick(){this.value.toggle()}}class ss extends b{constructor(e,t,s,i="li"){super(e),this._menuPopup=null,this._tagName=i,this._viewClassForTile=t,this._renderFlags=s}get _interactive(){return this._renderFlags?.interactive??!0}get _isReplyPreview(){return this._renderFlags?.reply}render(e,t){const s=[this.renderMessageBody(e,t)];this._interactive&&s.push(e.button({className:"Timeline_messageOptions"},"\u22EF"));const i=e.el(this._tagName,{className:{Timeline_message:!0,own:t.isOwn,unsent:t.isUnsent,unverified:o=>o.isUnverified,disabled:!this._interactive,continuation:o=>o.isContinuation},"data-event-id":t.eventId},s);e.mapSideEffect(o=>o.isContinuation,(o,a)=>{if(o&&a===!1)i.removeChild(i.querySelector(".Timeline_messageAvatar")),i.removeChild(i.querySelector(".Timeline_messageSender"));else if(!o&&!this._isReplyPreview){const c=N.a({href:t.memberPanelLink,className:"Timeline_messageAvatar"},[Rt(t,30)]),l=N.div({className:`Timeline_messageSender usercolor${t.avatarColorNumber}`,title:t.sender},t.displayName);i.insertBefore(c,i.firstChild),i.insertBefore(l,i.firstChild)}});let r=null;return e.mapSideEffect(o=>o.reactions,o=>{o&&this._interactive&&!r?(r=new Ed(o),this.addSubView(r),i.appendChild(Rs(r))):!o&&r&&(i.removeChild(r.root()),r.unmount(),this.removeSubView(r),r=null)}),i}onClick(e){e.target.className==="Timeline_messageOptions"&&this._toggleMenu(e.target)}_toggleMenu(e){if(this._menuPopup&&this._menuPopup.isOpen)this._menuPopup.close();else{const t=this.createMenuOptions(this.value);if(!t.length)return;this.root().classList.add("menuOpen");const s=()=>this.root().classList.remove("menuOpen");this._menuPopup=new es(new O(t),s),this._menuPopup.trackInTemplateView(this),this._menuPopup.showRelativeTo(e,2)}}createMenuOptions(e){const t=[];return e.canReact&&e.shape!=="redacted"&&!e.isPending&&(t.push(new Cd(e)),t.push(O.option(e.i18n`Reply`,()=>e.startReply()))),e.canAbortSending?t.push(O.option(e.i18n`Cancel`,()=>e.abortSending())):e.canRedact&&t.push(O.option(e.i18n`Delete`,()=>e.redact()).setDestructive()),t}renderMessageBody(){}}class Cd{constructor(e){this._vm=e}toDOM(e){const t=["\u{1F44D}","\u{1F44E}","\u{1F604}","\u{1F389}","\u{1F615}","\u2764\uFE0F","\u{1F680}","\u{1F440}"].map(i=>e.button({onClick:()=>this._vm.react(i)},i)),s=e.button({onClick:()=>{const i=prompt("Enter your reaction (emoji)");i&&this._vm.react(i)}},"\u2026");return e.li({className:"quick-reactions"},[...t,s])}}class Td extends b{constructor(e,t){super(e),this._viewClassForTile=t}render(e,t){const s=this._viewClassForTile(t);if(!s)throw new Error(`Shape ${t.shape} is unrecognized.`);const i=new s(t,this._viewClassForTile,{reply:!0,interactive:!1});return e.div({className:"ReplyPreviewView"},e.blockquote([e.a({className:"link",href:t.permaLink},"In reply to"),e.a({className:"pill",href:t.senderProfileLink},[Rt(t,12,void 0),t.displayName]),e.br(),e.view(i)]))}}class Ad extends b{render(e){return e.blockquote({className:"ReplyPreviewView"},[e.div({className:"Timeline_messageBody statusMessage"},"This reply could not be found.")])}}class xd extends ss{renderMessageBody(e,t){const s=e.time({className:{hidden:!t.time}},t.time),i=e.div({className:{Timeline_messageBody:!0,statusMessage:o=>o.shape==="message-status"}},e.mapView(o=>o.replyTile,o=>this._isReplyPreview?null:t.isReply&&!o?new Ad:o?new Td(o,this._viewClassForTile):null)),r=o=>o?.nodeType!==Node.COMMENT_NODE&&o.className!=="ReplyPreviewView";return e.mapSideEffect(o=>o.body,o=>{for(;r(i.lastChild);)i.removeChild(i.lastChild);for(const a of o.parts)i.appendChild(fa(a));i.appendChild(s)}),i}}function Nd(n){const e=n.items.map(s=>N.li(Mt(s))),t=n.startOffset;return t?N.ol({start:t},e):N.ul(e)}function Dd(n){const e={src:n.src};return n.width&&(e.width=n.width),n.height&&(e.height=n.height),n.alt&&(e.alt=n.alt),n.title&&(e.title=n.title),N.img(e)}function Vd(n){const e=`avatar size-12 usercolor${n.avatarColorNumber}`,t=N.div({class:e},Qe(n.avatarInitials)),s=Mt(n.children);return s.unshift(t),N.a({class:"pill",href:n.href,rel:"noopener",target:"_blank"},s)}function Pd(n){const e=[];if(n.head){const s=n.head.map(i=>N.th(Mt(i)));e.push(N.thead(N.tr(s)))}const t=[];for(const s of n.body){const i=s.map(r=>N.td(Mt(r)));t.push(N.tr(i))}return e.push(N.tbody(t)),N.table(e)}const Ld={header:n=>N["h"+Math.min(6,n.level)](Mt(n.inlines)),codeblock:n=>N.pre(N.code(Qe(n.text))),table:n=>Pd(n),code:n=>N.code(Qe(n.text)),text:n=>Qe(n.text),link:n=>N.a({href:n.url,className:"link",target:"_blank",rel:"noopener"},Mt(n.inlines)),pill:Vd,format:n=>N[n.format](Mt(n.children)),rule:()=>N.hr(),list:Nd,image:Dd,newline:()=>N.br()};function fa(n){const e=Ld[n.type];return e?e(n):Qe(`[unknown part type ${n.type}]`)}function Mt(n){return Array.from(n,fa)}class ya extends ss{renderMessageBody(e,t){let i=`padding-top: ${t.height/t.width*100}%;`;t.platform.isIE11&&(i=`height: ${t.height}px`);const r=[e.div({className:"spacer",style:i}),this.renderMedia(e,t),e.time(t.time)],o=e.div({className:{status:!0,hidden:a=>!a.status}},a=>a.status);if(r.push(o),t.isPending){const a=e.progress({min:0,max:100,value:c=>c.uploadPercentage,className:{hidden:c=>!c.isUploading}});r.push(a)}return e.div({className:"Timeline_messageBody"},[e.div({className:"media",style:`max-width: ${t.width}px`,"data-testid":"media"},r),e.if(a=>a.error,a=>a.p({className:"error"},t.error))])}createMenuOptions(e){const t=super.createMenuOptions(e);if(!e.isPending){let s;switch(e.shape){case"image":s=e.i18n`Download image`;break;case"video":s=e.i18n`Download video`;break;default:s=e.i18n`Download media`;break}t.push(O.option(s,()=>e.downloadMedia()))}return t}}class Od extends ya{renderMedia(e,t){const s=e.img({src:i=>i.thumbnailUrl,alt:i=>i.label,title:i=>i.label,style:`max-width: ${t.width}px; max-height: ${t.height}px;`});return t.isPending||!t.lightboxUrl?s:e.a({href:t.lightboxUrl},s)}}function mi(n,e){return new Promise((t,s)=>{let i;const r=a=>{i(),s(a.target.error)},o=()=>{i(),t()};i=()=>{n.removeEventListener(e,o),n.removeEventListener("error",r)},n.addEventListener(e,o),n.addEventListener("error",r)})}class Ud extends ya{renderMedia(e){const t=e.video({src:s=>s.videoUrl||`data:${s.mimeType},`,title:s=>s.label,controls:!0,preload:"none",poster:s=>s.thumbnailUrl,onPlay:this._onPlay.bind(this),style:s=>`max-width: ${s.width}px; max-height: ${s.height}px;${s.isPending?"z-index: -1":""}`});return t.addEventListener("error",this._onError.bind(this)),t}async _onPlay(e){const t=this.value;if(!t.videoUrl)try{const s=e.target;await t.loadVideo();const i=mi(s,"loadeddata");s.load(),await i,s.play()}catch{}}_onError(e){const t=this.value,s=e.target,i=s.error;if(i instanceof window.MediaError&&i.code===4)if(!s.src.startsWith("data:"))t.setViewError(new Error(`this browser does not support videos of type ${t.mimeType}.`));else return;else t.setViewError(i)}}class Fd extends ss{renderMessageBody(e,t){const s=[];return t.isPending?s.push(i=>i.label):s.push(e.button({className:"link",onClick:()=>t.download()},i=>i.label),e.time(t.time)),e.p({className:"Timeline_messageBody statusMessage"},s)}}class Bd extends ss{renderMessageBody(e,t){return e.p({className:"Timeline_messageBody statusMessage"},[e.span(t.label),e.a({className:"Timeline_locationLink",href:t.mapsLink,target:"_blank",rel:"noopener"},t.i18n`Open in maps`),e.time(t.time)])}}class Kd extends ss{renderMessageBody(e,t){return e.p({className:"Timeline_messageBody statusMessage"},t.label)}}class $d extends b{constructor(e){super(e)}render(e,t){return e.li({className:"AnnouncementView","data-event-id":t.eventId},e.div(s=>s.announcement))}onClick(){}}class jd extends ss{renderMessageBody(e){return e.p({className:"Timeline_messageBody statusMessage"},t=>t.description)}createMenuOptions(e){const t=super.createMenuOptions(e);return e.isRedacting&&t.push(O.option(e.i18n`Cancel`,()=>e.abortPendingRedaction())),t}}var ee=(n=>(n.Message="message",n.MessageStatus="message-status",n.Announcement="announcement",n.File="file",n.Gap="gap",n.Image="image",n.Location="location",n.MissingAttachment="missing-attachment",n.Redacted="redacted",n.Video="video",n.DateHeader="date-header",n.Call="call",n))(ee||{});class qd extends b{constructor(e){super(e)}render(e,t){const s={GapView:!0,isLoading:i=>i.isLoading,isAtTop:i=>i.isAtTop};return e.li({className:s},[e.div({class:"GapView_container"},[e.if(i=>i.showSpinner,i=>Se(i)),e.span(i=>i.status)]),e.if(i=>!!i.errorViewModel,i=>i.view(new ts(t.errorViewModel,{inline:!0})))])}onClick(){}}class Wd extends b{render(e,t){return e.li({className:"CallTileView AnnouncementView"},e.div([e.if(s=>s.errorViewModel,s=>s.div({className:"CallTileView_error"},s.view(new ts(t.errorViewModel,{inline:!0})))),e.div([e.div({className:"CallTileView_title"},s=>s.title),e.div({className:"CallTileView_subtitle"},[t.typeLabel," \u2022 ",e.span({className:"CallTileView_memberCount"},s=>s.memberCount)]),e.view(new mt({className:"CallTileView_members",tagName:"div",list:t.memberViewModels},s=>new xe(s,24))),e.div(s=>s.duration),e.div([e.button({className:"CallTileView_join button-action primary",hidden:s=>!s.canJoin},"Join"),e.button({className:"CallTileView_leave button-action primary destructive",hidden:s=>!s.canLeave},"Leave")])])]))}onClick(e){e.target.classList.contains("CallTileView_join")?this.value.join():e.target.classList.contains("CallTileView_leave")&&this.value.leave()}}class Hd extends b{constructor(e){super(e)}render(e,t){return e.h2({className:"DateHeader"},e.time({dateTime:t.machineReadableDate},t.relativeDate))}onClick(){}}function ks(n){switch(n.shape){case ee.Gap:return qd;case ee.Announcement:return $d;case ee.Message:case ee.MessageStatus:return xd;case ee.Image:return Od;case ee.Video:return Ud;case ee.File:return Fd;case ee.Location:return Bd;case ee.MissingAttachment:return Kd;case ee.Redacted:return jd;case ee.Call:return Wd;case ee.DateHeader:return Hd;default:throw new Error(`Tiles of shape "${n.shape}" are not supported, check the tileClassForEntry function in the view model`)}}class wa extends b{constructor(e){super(e)}render(e,t){return e.div({className:"RoomView WorldReadableRoomView middle"},[e.div({className:"RoomHeader middle-header"},[e.view(new xe(t,32)),e.div({className:"room-description"},[e.h2(s=>s.room.name)])]),e.div({className:"RoomView_body"},[e.div({className:"RoomView_error"},[e.if(s=>s.error,s=>s.div([s.p({},i=>i.error),s.button({className:"RoomView_error_closerButton",onClick:i=>t.dismissError(i)})]))]),e.mapView(s=>s.timelineViewModel,s=>s?new _a(s,ks):new ga(t)),e.div({className:"WorldReadableRoomComposerView"},[e.h3(s=>s.i18n`Join the room to participate`),e.if(s=>s.joinAllowed,s=>s.button({className:"joinRoomButton",onClick:()=>t.join(),disabled:i=>i.busy},t.i18n`Join Room`)),e.if(s=>!s.joinAllowed,s=>s.button({className:"loginButton",onClick:()=>t.login()},t.i18n`Log In`))])])])}}class Xe{constructor(e,t=void 0){typeof e=="function"&&!t&&(t=e,e=null),this._root=t?t(N,e):this.render(N,e)}mount(){return this._root}root(){return this._root}unmount(){}update(){}}class va extends Xe{constructor(e="Loading"){super(e,(t,s)=>t.div({className:"LoadingView"},[Se(t),s]))}}class jr extends b{render(e,t){return e.main({className:"RoomView middle"},[e.div({className:"RoomHeader middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close room`}),e.view(new xe(t,32)),e.div({className:"room-description"},[e.h2(s=>s.name)])]),e.div({className:"RoomView_body"},[e.mapView(s=>s.error,s=>s?new zd(t):new va(t.i18n`Setting up the room…`))])])}}class zd extends b{render(e,t){return e.div({className:"RoomBeingCreated_error centered-column"},[e.h3(t.i18n`Could not create the room, something went wrong:`),e.div({className:"RoomView_error form-group"},t.error),e.div({className:"button-row"},e.button({className:"button-action primary destructive",onClick:()=>t.cancel()},t.i18n`Cancel`))])}}class qr extends b{render(e,t){let s=[];t.isDirectMessage&&s.push(Rt(t,128,"InviteView_dmAvatar"));let i;return t.isDirectMessage?i=[e.strong(t.name),` (${t.inviter?.id}) wants to chat with you.`]:t.inviter?i=[Rt(t.inviter,24),e.strong(t.inviter.name),` (${t.inviter.id}) invited you.`]:i="You were invited to join.",s.push(e.p({className:"InviteView_inviter"},i)),t.isDirectMessage||s.push(e.div({className:"InviteView_roomProfile"},[Rt(t,64,"InviteView_roomAvatar"),e.h3(t.name),e.p({className:"InviteView_roomDescription"},t.roomDescription)])),e.main({className:"InviteView middle"},[e.div({className:"RoomHeader middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close invite`}),Rt(t,32),e.div({className:"room-description"},[e.h2(r=>r.name)])]),e.if(r=>r.error,r=>r.div({className:"RoomView_error"},o=>o.error)),e.div({className:"InviteView_body"},[e.div({className:"InviteView_invite"},[...s,e.div({className:"InviteView_buttonRow"},e.button({className:"button-action primary",disabled:r=>r.busy,onClick:()=>t.accept()},t.i18n`Accept`)),e.div({className:"InviteView_buttonRow"},e.button({className:"button-action primary destructive",disabled:r=>r.busy,onClick:()=>t.reject()},t.i18n`Reject`))])])])}}class ba extends b{render(e,t){const s=e.a({href:t.closeUrl,title:t.i18n`Close`,className:"close"}),i=e.div({role:"img","aria-label":c=>c.name,title:c=>c.name,className:{picture:!0,hidden:c=>!c.imageUrl},style:c=>`background-image: url('${c.imageUrl}'); max-width: ${c.imageWidth}px; max-height: ${c.imageHeight}px;`}),r=e.div({className:{loading:!0,hidden:c=>!!c.imageUrl}},[Se(e),e.div(t.i18n`Loading image…`)]),o=e.div({className:"details"},[e.strong(c=>c.name),e.br(),"uploaded by ",e.strong(c=>c.sender),c=>` at ${c.time} on ${c.date}.`]),a=e.div({role:"dialog",className:"lightbox",onClick:c=>this.clickToClose(c),onKeydown:c=>this.closeOnEscKey(c)},[i,r,o,s]);return Gd(e,a),a}clickToClose(e){e.target===this.root()&&this.value.close()}closeOnEscKey(e){(e.key==="Escape"||e.key==="Esc")&&this.value.close()}}function Gd(n,e){const t=Jd(e),s=t[0],i=t[t.length-1];n.addEventListener(e,"keydown",r=>{r.key==="Tab"&&(r.shiftKey?document.activeElement===s&&(i.focus(),r.preventDefault()):document.activeElement===i&&(s.focus(),r.preventDefault()))},!0),Promise.resolve().then(()=>{s.focus()})}function Jd(n){return n.querySelectorAll("a[href], button, textarea, input, select")}class Sa extends b{render(e,t){return e.div({className:{SessionStatusView:!0,hidden:s=>!s.isShown}},[Se(e,{hidden:s=>!s.isWaiting}),e.p(s=>s.statusLabel),e.if(s=>s.isConnectNowShown,s=>s.button({className:"link",onClick:()=>t.connectNow()},"Retry now")),e.if(s=>s.isSecretStorageShown,s=>s.a({href:t.setupKeyBackupUrl},"Go to settings")),e.if(s=>s.canDismiss,s=>s.div({className:"end"},s.button({className:"dismiss",onClick:()=>t.dismiss()})))])}}class Ia extends b{constructor(e,t){super(e),this._viewClassForTile=t}render(e,t){const s=[];for(let i=0;i<t.height*t.width;i+=1)s.push(e.div({onClick:()=>t.focusTile(i),onFocusin:()=>t.focusTile(i),className:{container:!0,[`tile${i}`]:!0,focused:r=>r.focusIndex===i}},e.mapView(r=>r.roomViewModelAt(i),r=>r?r.kind==="roomBeingCreated"?new jr(r):r.kind==="invite"?new qr(r):new Kr(r,this._viewClassForTile):new Xe(o=>o.div({className:"room-placeholder"},[o.h2({className:"focused"},t.i18n`Select a room on the left`),o.h2({className:"unfocused"},t.i18n`Click to select this tile`)])))));return s.push(e.div({className:i=>`focus-ring tile${i.focusIndex}`})),e.div({className:"RoomGridView middle layout3x2"},s)}}class Ra extends b{render(e,t){return e.div([e.map(s=>s.status,(s,i,r)=>{switch(s){case"Enabled":return Qd(i,r);case"NewVersionAvailable":return Yd(i,r);case"SetupKey":return Xd(i,r);case"SetupPhrase":return Zd(i,r);case"Pending":return i.p(r.i18n`Waiting to go online…`)}}),e.map(s=>s.backupWriteStatus,(s,i,r)=>{switch(s){case"Writing":{const o=i.progress({min:0,max:100,value:a=>a.backupPercentage});return i.div(["Backup in progress ",o," ",a=>a.backupInProgressLabel])}case"Stopped":{let o;return r.backupError?o=`Backup has stopped because of an error: ${r.backupError}`:o="Backup has stopped",i.p(o," ",i.button({onClick:()=>r.startBackup()},"Backup now"))}case"Done":return i.p("All keys are backed up.");default:return null}}),e.if(s=>s.isMasterKeyTrusted,s=>s.p("Cross-signing master key found and trusted.")),e.if(s=>s.canSignOwnDevice,s=>s.button({onClick:Br(async i=>{await t.signOwnDevice()})},"Sign own device"))])}}function Qd(n,e){const t=[n.p([e.i18n`Key backup is enabled, using backup version ${e.backupVersion}. `,n.button({onClick:()=>e.disable()},e.i18n`Disable`)])];return e.dehydratedDeviceId&&t.push(n.p(e.i18n`A dehydrated device id was set up with id ${e.dehydratedDeviceId} which you can use during your next login with your secret storage key.`)),n.div(t)}function Yd(n,e){const t=[n.p([e.i18n`A new backup version has been created from another device. Disable key backup and enable it again with the new key.`,n.button({onClick:()=>e.disable()},e.i18n`Disable`)])];return n.div(t)}function Xd(n,e){const t=n.button({className:"link",onClick:()=>e.showPhraseSetup()},e.i18n`use a security phrase`);return n.div([n.p(e.i18n`Enter your secret storage security key below to ${e.purpose}, which will enable you to decrypt messages received before you logged into this session. The security key is a code of 12 groups of 4 characters separated by a space that Element created for you when setting up security.`),Ea(n),ka(n,e,e.i18n`Security key`,(s,i)=>e.enterSecurityKey(s,i)),n.p([e.i18n`Alternatively, you can `,t,e.i18n` if you have one.`])])}function Zd(n,e){const t=n.button({className:"link",onClick:()=>e.showKeySetup()},e.i18n`use your security key`);return n.div([n.p(e.i18n`Enter your secret storage security phrase below to ${e.purpose}, which will enable you to decrypt messages received before you logged into this session. The security phrase is a freeform secret phrase you optionally chose when setting up security in Element. It is different from your password to login, unless you chose to set them to the same value.`),Ea(n),ka(n,e,e.i18n`Security phrase`,(s,i)=>e.enterSecurityPhrase(s,i)),n.p([e.i18n`You can also `,t,e.i18n`.`])])}function ka(n,e,t,s){let i;const r=()=>s(o.value,i?.checked||!1),o=n.input({type:"password",disabled:c=>c.isBusy,placeholder:t}),a=[n.p([o,n.button({disabled:c=>c.isBusy,onClick:r},e.decryptAction)])];if(e.offerDehydratedDeviceSetup){i=n.input({type:"checkbox",id:"enable-dehydrated-device"});const c=n.a({href:"https://github.com/uhoreg/matrix-doc/blob/dehydration/proposals/2697-device-dehydration.md",target:"_blank",rel:"noopener"},"more info");a.push(n.p([i,n.label({for:i.id},[e.i18n`Back up my device as well (`,c,")"])]))}return n.div({className:"row"},[n.div({className:"label"},t),n.div({className:"content"},a)])}function Ea(n){return n.if(e=>e.error,(e,t)=>e.div([e.p({className:"error"},s=>s.i18n`Could not enable key backup: ${s.error}.`),e.p(t.i18n`Try double checking that you did not mix up your security key, security phrase and login password as explained above.`)]))}class eu extends b{render(e,t){return e.div({className:"FeaturesView"},[e.p("Enable experimental features here that are still in development. These are not yet ready for primetime, so expect bugs."),e.ul(t.featureViewModels.map(s=>e.li(e.view(new tu(s)))))])}}class tu extends b{render(e,t){let s=`feature_${t.id}`;return e.div({className:"FeatureView"},[e.input({type:"checkbox",id:s,checked:i=>i.enabled,onChange:i=>t.enableFeature(i.target.checked)}),e.div({class:"FeatureView_container"},[e.h4(e.label({for:s},t.name)),e.p(t.description)])])}}class Ma extends b{render(e,t){let s=t.version;t.showUpdateButton&&(s=e.span([t.version,e.button({onClick:()=>t.checkForUpdate()},t.i18n`Check for updates`)]));const i=(a,c,l,h="")=>a.div({className:`row ${h}`},[a.div({className:"label"},c),a.div({className:"content"},l)]),r=[];r.push(e.h3("Session"),i(e,t.i18n`User ID`,t.userId),i(e,t.i18n`Session ID`,t.deviceId,"code"),i(e,t.i18n`Session key`,t.fingerprintKey,"code"),i(e,"",e.button({onClick:()=>t.logout(),disabled:a=>a.isLoggingOut},t.i18n`Log out`))),r.push(e.h3("Key backup & security"),e.view(new Ra(t.keyBackupViewModel))),r.push(e.h3("Notifications"),e.map(a=>a.pushNotifications.supported,(a,c)=>{if(a===null)return c.p(t.i18n`Loading…`);if(a){const l=d=>d.pushNotifications.enabled?d.i18n`Push notifications are enabled`:d.i18n`Push notifications are disabled`,h=d=>d.pushNotifications.enabled?d.i18n`Disable`:d.i18n`Enable`;return i(c,l,c.button({onClick:()=>t.togglePushNotifications(),disabled:d=>d.pushNotifications.updating},h))}else return c.p(t.i18n`Push notifications are not supported on this browser`)}),e.if(a=>a.pushNotifications.supported&&a.pushNotifications.enabled,a=>a.div([a.p(["If you think push notifications are not being delivered, ",a.button({className:"link",onClick:()=>t.checkPushEnabledOnServer()},"check")," if they got disabled on the server"]),a.map(c=>c.pushNotifications.enabledOnServer,(c,l)=>{if(c===!0)return l.p("Push notifications are still enabled on the server, so everything should be working. Sometimes notifications can get dropped if they can't be delivered within a given time.");if(c===!1)return l.p("Push notifications have been disabled on the server, likely due to a bug. Please re-enable them by clicking Disable and then Enable again above.")}),a.map(c=>c.pushNotifications.serverError,(c,l)=>{if(c)return l.p("Couldn't not check on server: "+c.message)})]))),r.push(e.h3("Preferences"),i(e,t.i18n`Scale down images when sending`,this._imageCompressionRange(e,t)),e.if(a=>a.activeTheme,(a,c)=>i(a,c.i18n`Use the following theme`,this._themeOptions(a,c))));const o=[];return t.canSendLogsToServer&&o.push(e.button({onClick:Br(()=>t.sendLogsToServer())},`Submit logs to ${t.logsServer}`)),o.push(e.button({onClick:()=>t.exportLogs()},"Download logs")),r.push(e.h3("Experimental features"),e.view(new eu(t.featuresViewModel))),r.push(e.h3("Application"),i(e,t.i18n`Version`,s),i(e,t.i18n`Storage usage`,a=>`${a.storageUsage} / ${a.storageQuota}`),i(e,t.i18n`Debug logs`,o),e.p({className:{hidden:a=>!a.logsFeedbackMessage}},a=>a.logsFeedbackMessage),e.p(["Debug logs contain application usage data including your username, the IDs or aliases of the rooms or groups you have visited, the usernames of other users and the names of files you send. They do not contain messages. For more information, review our ",e.a({href:"https://element.io/privacy",target:"_blank",rel:"noopener"},"privacy policy"),"."]),e.p([])),e.main({className:"Settings middle"},[e.div({className:"middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close settings`}),e.h2("Settings")]),e.div({className:"SettingsBody"},r)])}_imageCompressionRange(e,t){const i=Math.ceil(t.minSentImageSizeLimit/32)*32,r=(Math.floor(t.maxSentImageSizeLimit/32)+1)*32,o=a=>t.setSentImageSizeLimit(parseInt(a.target.value,10));return[e.input({type:"range",step:32,min:i,max:r,value:a=>a.sentImageSizeLimit||r,onInput:o,onChange:o})," ",e.output(a=>a.sentImageSizeLimit?a.i18n`resize to ${a.sentImageSizeLimit}px`:a.i18n`no resizing`)]}_themeOptions(e,t){const{themeName:s,themeVariant:i}=t.activeTheme,r=[];for(const _ of Object.keys(t.themeMapping))r.push(e.option({value:_,selected:_===s},_));const o=e.select({onChange:_=>{const g=_.target.value;if(!("id"in t.themeMapping[g])){const w=h.checked?"dark":u.checked?"light":"default";a(w);return}t.changeThemeOption(g)}},r),a=_=>{const g=o.options[o.selectedIndex].value;t.changeThemeOption(g,_)},c=i==="dark",l=i==="light",h=e.input({type:"radio",name:"radio-chooser",value:"dark",id:"dark",checked:c}),d=e.input({type:"radio",name:"radio-chooser",value:"default",id:"default",checked:!(c||l)}),u=e.input({type:"radio",name:"radio-chooser",value:"light",id:"light",checked:l}),p=e.form({className:{hidden:()=>{const _=o.options[o.selectedIndex].value;return"id"in t.themeMapping[_]}},onChange:_=>a(_.target.value)},[d,e.label({for:"default"},"Match system theme"),h,e.label({for:"dark"},"dark"),u,e.label({for:"light"},"light")]);return e.div({className:"theme-chooser"},[o,p])}}class Ca extends b{render(e,t){return e.main({className:"CreateRoomView middle"},[e.div({className:"CreateRoomView_header middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Cancel room creation`}),e.h2("Create room")]),e.div({className:"CreateRoomView_body centered-column"},[e.form({className:"CreateRoomView_detailsForm form",onChange:s=>this.onFormChange(s),onSubmit:s=>this.onSubmit(s)},[e.div({className:"vertical-layout"},[e.button({type:"button",className:"CreateRoomView_selectAvatar",onClick:()=>t.selectAvatar()},e.mapView(s=>s.hasAvatar,s=>s?new xe(t,64):new Xe(void 0,i=>i.div({className:"CreateRoomView_selectAvatarPlaceholder"})))),e.div({className:"stretch form-row text"},[e.label({for:"name"},t.i18n`Room name`),e.input({onInput:s=>t.setName(s.target.value),type:"text",name:"name",id:"name",placeholder:t.i18n`Enter a room name`})])]),e.div({className:"form-row text"},[e.label({for:"topic"},t.i18n`Topic (optional)`),e.textarea({onInput:s=>t.setTopic(s.target.value),name:"topic",id:"topic",placeholder:t.i18n`Topic`})]),e.div({className:"form-group"},[e.div({className:"form-row check"},[e.input({type:"radio",name:"isPublic",id:"isPrivate",value:"false",checked:!t.isPublic}),e.label({for:"isPrivate"},t.i18n`Private room, only upon invitation.`)]),e.div({className:"form-row check"},[e.input({type:"radio",name:"isPublic",id:"isPublic",value:"true",checked:t.isPublic}),e.label({for:"isPublic"},t.i18n`Public room, anyone can join`)])]),e.div({className:{"form-row check":!0,hidden:s=>s.isPublic}},[e.input({type:"checkbox",name:"isEncrypted",id:"isEncrypted",checked:t.isEncrypted}),e.label({for:"isEncrypted"},t.i18n`Enable end-to-end encryption`)]),e.div({className:{"form-row text":!0,hidden:s=>!s.isPublic}},[e.label({for:"roomAlias"},t.i18n`Room alias`),e.input({onInput:s=>t.setRoomAlias(s.target.value),type:"text",name:"roomAlias",id:"roomAlias",placeholder:t.i18n`Room alias (<alias>, or #<alias> or #<alias>:hs.tld`})]),e.div({className:"form-group"},[e.div(e.button({className:"link",type:"button",onClick:()=>t.toggleAdvancedShown()},s=>s.isAdvancedShown?s.i18n`Hide advanced settings`:s.i18n`Show advanced settings`)),e.div({className:{"form-row check":!0,hidden:s=>!s.isAdvancedShown}},[e.input({type:"checkbox",name:"isFederationDisabled",id:"isFederationDisabled",checked:t.isFederationDisabled}),e.label({for:"isFederationDisabled"},[t.i18n`Disable federation`,e.p({className:"form-row-description"},t.i18n`Can't be changed later. This will prevent people on other homeservers from joining the room. This is typically used when only people from your own organisation (if applicable) should be allowed in the room, and is otherwise not needed.`)])])]),e.div({className:"button-row"},[e.button({className:"button-action primary",type:"submit",disabled:s=>!s.canCreate},t.i18n`Create room`)])])])])}onFormChange(e){switch(e.target.name){case"isEncrypted":this.value.setEncrypted(e.target.checked);break;case"isPublic":this.value.setPublic(e.currentTarget.isPublic.value==="true");break;case"isFederationDisabled":this.value.setFederationDisabled(e.target.checked);break}}onSubmit(e){e.preventDefault(),this.value.create()}}class su extends b{render(e,t){const s=()=>t.isEncrypted?t.i18n`On`:t.i18n`Off`;return e.div({className:"RoomDetailsView"},[e.div({className:"RoomDetailsView_avatar"},[e.view(new xe(t,52)),e.mapView(i=>i.isEncrypted,i=>new iu(i))]),e.div({className:"RoomDetailsView_name"},[e.h2(i=>i.name)]),this._createRoomAliasDisplay(t),e.div({className:"RoomDetailsView_rows"},[this._createRightPanelButtonRow(e,t.i18n`People`,{MemberCount:!0},i=>i.memberCount,()=>t.openPanel("members")),this._createRightPanelRow(e,t.i18n`Encryption`,{EncryptionStatus:!0},s)])])}_createRoomAliasDisplay(e){return e.canonicalAlias?N.div({className:"RoomDetailsView_id"},[e.canonicalAlias]):""}_createRightPanelRow(e,t,s,i){const r=Gt({RoomDetailsView_label:!0,...s});return e.div({className:"RoomDetailsView_row"},[e.div({className:r},[t]),e.div({className:"RoomDetailsView_value"},i)])}_createRightPanelButtonRow(e,t,s,i,r){const o=Gt({RoomDetailsView_label:!0,...s});return e.button({className:"RoomDetailsView_row",onClick:r},[e.div({className:o},[t]),e.div({className:"RoomDetailsView_value"},i)])}}class iu extends b{render(e,t){return e.div({className:"EncryptionIconView"},[e.div({className:t?"EncryptionIconView_encrypted":"EncryptionIconView_unencrypted"})])}}class ru{constructor(e,t){this.start=e,this.end=t}get length(){return this.end-this.start}contains(e){return e.start>=this.start&&e.end<=this.end}containsIndex(e){return e>=this.start&&e<this.end}toLocalIndex(e){return e-this.start}intersects(e){return e.start<this.end&&this.start<e.end}forEachInIterator(e,t){let s=0;for(s=0;s<this.start;s+=1)e.next();for(s=0;s<this.length;s+=1){const i=e.next();if(i.done)break;t(i.value,this.start+s)}}[Symbol.iterator](){return new nu(this)}reverseIterable(){return new ou(this)}clampIndex(e,t=this.end-1){return Math.min(Math.max(this.start,e),t)}getIndexZone(e){return e<this.start?Ct.Before:e<this.end?Ct.Inside:Ct.After}}var Ct=(n=>(n[n.Before=1]="Before",n[n.Inside=2]="Inside",n[n.After=3]="After",n))(Ct||{});class nu{constructor(e){this.range=e,this.idx=e.start-1}next(){return this.idx<this.range.end-1?(this.idx+=1,{value:this.idx,done:!1}):{value:void 0,done:!0}}}class ou{constructor(e){this.range=e,this.idx=e.end}[Symbol.iterator](){return this}next(){return this.idx>this.range.start?(this.idx-=1,{value:this.idx,done:!1}):{value:void 0,done:!0}}}function au(n,e){let t=0;for(;t<e;)if(t+=1,n.next().done)return!1;return!0}function Gs(n,e){if(au(n,e)){const t=n.next();if(!t.done)return t.value}}var jt=(n=>(n[n.Move=0]="Move",n[n.Add=1]="Add",n[n.Remove=2]="Remove",n[n.RemoveAndAdd=3]="RemoveAndAdd",n[n.UpdateRange=4]="UpdateRange",n))(jt||{});class vs extends ru{constructor(e,t,s,i=t-e){super(e,t),this._totalLength=s,this._viewportItemCount=i}expand(e){if(this.length===0)return this;const t=Math.max(0,this.start-e),s=Math.min(this.totalLength,this.end+e);return new vs(t,s,this.totalLength,this._viewportItemCount)}get totalLength(){return this._totalLength}get viewportItemCount(){return this._viewportItemCount}static fromViewport(e,t,s,i){const r=Math.min(Math.max(0,Math.floor(i/t)),e),o=e-r,a=s!==0?Math.ceil(s/t):0,c=Math.min(a,o);return new vs(r,r+c,e,a)}queryAdd(e,t,s){const i=this.viewportItemCount>this.length?this.end:this.end-1;if(e<=i){const r=this.clampIndex(e,i),o=r===e?t:Gs(s[Symbol.iterator](),r);return this.createAddResult(r,o)}else return{type:4,newRange:this.deriveRange(1,0)}}queryRemove(e,t){if(e<this.end){const s=this.clampIndex(e);return this.createRemoveResult(s,t)}else return{type:4,newRange:this.deriveRange(-1,0)}}queryMove(e,t,s,i){const r=this.getIndexZone(e),o=this.getIndexZone(t);if(r===o){if(r===Ct.Before||r===Ct.After)return;if(r===Ct.Inside)return{type:0,fromIdx:e,toIdx:t}}else{const a=this.clampIndex(t),c=this.clampIndex(e),l=a===t?s:Gs(i[Symbol.iterator](),a);return{type:3,removeIdx:c,addIdx:a,value:l}}}createAddResult(e,t){if(this.viewportItemCount>this.length)return{type:1,addIdx:e,value:t,newRange:this.deriveRange(1,1)};{const s=this.clampIndex(Number.MAX_SAFE_INTEGER);return{type:3,removeIdx:s,addIdx:e,value:t,newRange:this.deriveRange(1,0)}}}createRemoveResult(e,t){if(this.end<this.totalLength){const s=this.clampIndex(Number.MAX_SAFE_INTEGER),i=Gs(t[Symbol.iterator](),s);return{type:3,removeIdx:e,value:i,addIdx:s,newRange:this.deriveRange(-1,0)}}else if(this.start!==0){const s=this.deriveRange(-1,0,1),i=s.start,r=Gs(t[Symbol.iterator](),i);return{type:3,removeIdx:e,value:r,addIdx:i,newRange:s}}else return{type:2,removeIdx:e,newRange:this.deriveRange(-1,0)}}deriveRange(e,t,s=0){const i=this.start-s,r=this.totalLength+e,o=Math.min(Math.max(i,this.end-s+t),r);return new vs(i,o,r,this.viewportItemCount)}}class cu extends mt{constructor({itemHeight:e,overflowItems:t=20,...s},i){super(s,i),this.itemHeight=e,this.overflowItems=t}handleEvent(e){e.type==="scroll"?this.handleScroll():super.handleEvent(e)}handleScroll(){const e=this._getVisibleRange();if(e.length!==0&&!this.renderRange.contains(e)){const t=this.renderRange;this.renderRange=e.expand(this.overflowItems),this.renderUpdate(t,this.renderRange)}}async loadList(){if(await new Promise(t=>requestAnimationFrame(t)),await new Promise(t=>requestAnimationFrame(t)),!this._list)return;this._subscription=this._list.subscribe(this);const e=this._getVisibleRange();this.renderRange=e.expand(this.overflowItems),this._childInstances=[],this.reRenderFullRange(this.renderRange)}_getVisibleRange(){const{clientHeight:e,scrollTop:t}=this.root();if(e===0)throw new Error("LazyListView height is 0");return vs.fromViewport(this._list.length,this.itemHeight,e,t)}reRenderFullRange(e){pd(this._listElement);const t=document.createDocumentFragment(),s=this._list[Symbol.iterator]();this._childInstances.length=0,e.forEachInIterator(s,i=>{const r=this._childCreator(i);this._childInstances.push(r),t.appendChild(Rs(r,this._mountArgs))}),this._listElement.appendChild(t),this.adjustPadding(e)}renderUpdate(e,t){if(t.intersects(e)){for(const s of e.reverseIterable())if(!t.containsIndex(s)){const i=s-e.start;this.removeChild(i)}t.forEachInIterator(this._list[Symbol.iterator](),(s,i)=>{if(!e.containsIndex(i)){const r=i-t.start;this.addChild(r,s)}}),this.adjustPadding(t)}else this.reRenderFullRange(t)}adjustPadding(e){const t=e.start*this.itemHeight,s=(e.totalLength-e.end)*this.itemHeight,i=this._listElement.style;i.paddingTop=`${t}px`,i.paddingBottom=`${s}px`}mount(){const e=super.mount();return this.scrollContainer=N.div({className:"LazyListParent"},e),this.scrollContainer.addEventListener("scroll",this),this.scrollContainer}unmount(){this.root().removeEventListener("scroll",this),this.scrollContainer=void 0,super.unmount()}root(){return this.scrollContainer}get _listElement(){return super.root()}onAdd(e,t){const s=this.renderRange.queryAdd(e,t,this._list);this.applyRemoveAddResult(s)}onRemove(e,t){const s=this.renderRange.queryRemove(e,this._list);this.applyRemoveAddResult(s)}onMove(e,t,s){const i=this.renderRange.queryMove(e,t,s,this._list);i&&(i.type===jt.Move?this.moveChild(this.renderRange.toLocalIndex(i.fromIdx),this.renderRange.toLocalIndex(i.toIdx)):this.applyRemoveAddResult(i))}onUpdate(e,t,s){this.renderRange.containsIndex(e)&&this.updateChild(this.renderRange.toLocalIndex(e),t,s)}applyRemoveAddResult(e){(e.type===jt.Remove||e.type===jt.RemoveAndAdd)&&this.removeChild(this.renderRange.toLocalIndex(e.removeIdx)),e.newRange&&(this.renderRange=e.newRange,this.adjustPadding(this.renderRange)),(e.type===jt.Add||e.type===jt.RemoveAndAdd)&&this.addChild(this.renderRange.toLocalIndex(e.addIdx),e.value)}}class lu extends b{render(e,t){return e.li({className:"MemberTileView"},e.a({href:t.detailsUrl},[e.view(new xe(t,32)),e.div({className:"MemberTileView_name"},s=>s.name)]))}}class hu extends cu{constructor(e){super({list:e.memberTileViewModels,className:"MemberListView",itemHeight:40},t=>new lu(t))}}class du extends b{render(e,t){return e.div({className:"MemberDetailsView"},[e.view(new xe(t,128)),e.div({className:"MemberDetailsView_name"},e.h2(s=>s.name)),e.div({className:"MemberDetailsView_id"},t.userId),this._createSection(e,t.i18n`Role`,s=>s.role),this._createSection(e,t.i18n`Security`,t.isEncrypted?t.i18n`Messages in this room are end-to-end encrypted.`:t.i18n`Messages in this room are not end-to-end encrypted.`),this._createOptions(e,t)])}_createSection(e,t,s){return e.div({className:"MemberDetailsView_section"},[e.div({className:"MemberDetailsView_label"},t),e.div({className:"MemberDetailsView_value"},s)])}_createOptions(e,t){return e.div({className:"MemberDetailsView_section"},[e.div({className:"MemberDetailsView_label"},t.i18n`Options`),e.div({className:"MemberDetailsView_options"},[e.a({href:t.linkToUser,target:"_blank",rel:"noopener"},t.i18n`Open Link to User`),e.button({className:"text",onClick:()=>t.openDirectMessage()},t.i18n`Open direct message`)])])}}class Ta extends b{render(e){return e.div({className:"RightPanelView"},[e.ifView(t=>t.activeViewModel,t=>new uu(t)),e.mapView(t=>t.activeViewModel,t=>this._viewFromType(t))])}_viewFromType(e){switch(e?.type){case"room-details":return new su(e);case"member-list":return new hu(e);case"member-details":return new du(e);default:return new va}}}class uu extends b{render(e,t){return e.div({className:"RightPanelView_buttons"},[e.button({className:{back:!0,"button-utility":!0,hide:!t.activeViewModel.shouldShowBackButton},onClick:()=>t.showPreviousPanel()}),e.button({className:"close button-utility",onClick:()=>t.closePanel()})])}}class Aa extends b{render(e,t){const s=e.input({type:"text",name:"id",id:"id",placeholder:t.i18n`Enter a room id or alias`,disabled:i=>i.joinInProgress});return e.main({className:"JoinRoomView middle"},[e.div({className:"JoinRoomView_header middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Cancel room join`}),e.h2("Join room")]),e.div({className:"JoinRoomView_body centered-column"},[e.form({className:"JoinRoomView_detailsForm form",onSubmit:i=>this.onSubmit(i,s.value)},[e.div({className:"vertical-layout"},[e.div({className:"stretch form-row text"},[e.label({for:"id"},t.i18n`Room id`),s])]),e.div({className:"button-row"},[e.button({className:"button-action primary",type:"submit",disabled:i=>i.joinInProgress},t.i18n`Join`)]),e.map(i=>i.status,(i,r)=>r.div({className:"JoinRoomView_status"},[Se(r,{hidden:o=>!o.joinInProgress}),r.span(i)]))])])])}onSubmit(e,t){e.preventDefault(),this.value.join(t)}}class mu extends b{render(e,t){return e.div({className:"CallToastNotificationView"},[e.div({className:"CallToastNotificationView__top"},[e.view(new xe(t,24)),e.span({className:"CallToastNotificationView__name"},s=>s.roomName),e.button({className:"button-action CallToastNotificationView__dismiss-btn",onClick:()=>t.dismiss()})]),e.div({className:"CallToastNotificationView__description"},[e.span(t.i18n`Video call started`)]),e.div({className:"CallToastNotificationView__info"},[e.span({className:"CallToastNotificationView__call-type"},t.i18n`Video`),e.span({className:"CallToastNotificationView__member-count"},s=>s.memberCount)]),e.div({className:"CallToastNotificationView__action"},[e.button({className:"button-action primary",onClick:()=>t.join()},t.i18n`Join`)]),e.if(s=>!!s.errorViewModel,s=>s.div({className:"CallView_error"},s.view(new ts(t.errorViewModel))))])}}class pu extends b{render(e,t){const s=new mt({list:t.toastViewModels,parentProvidesUpdates:!1},i=>new mu(i));return e.div({className:"ToastCollectionView"},[e.view(s)])}}class xa extends b{render(e,t){return e.div({className:{SessionView:!0,"middle-shown":s=>!!s.activeMiddleViewModel,"right-shown":s=>!!s.rightPanelViewModel}},[e.view(new pu(t.toastCollectionViewModel)),e.view(new Sa(t.sessionStatusViewModel)),e.view(new pa(t.leftPanelViewModel)),e.mapView(s=>s.activeMiddleViewModel,()=>t.roomGridViewModel?new Ia(t.roomGridViewModel,ks):t.settingsViewModel?new Ma(t.settingsViewModel):t.createRoomViewModel?new Ca(t.createRoomViewModel):t.joinRoomViewModel?new Aa(t.joinRoomViewModel):t.currentRoomViewModel?t.currentRoomViewModel.kind==="invite"?new qr(t.currentRoomViewModel):t.currentRoomViewModel.kind==="room"?new Kr(t.currentRoomViewModel,ks):t.currentRoomViewModel.kind==="roomBeingCreated"?new jr(t.currentRoomViewModel):t.currentRoomViewModel.kind==="preview"?new wa(t.currentRoomViewModel):new $r(t.currentRoomViewModel):new Xe(s=>s.div({className:"room-placeholder"},s.h2(t.i18n`Choose a room on the left side.`)))),e.mapView(s=>s.lightboxViewModel,s=>s?new ba(s):null),e.mapView(s=>s.rightPanelViewModel,s=>s?new Ta(s):null)])}}function Na(n){return "3565504203"?n.a({target:"_blank",href:"https://github.com/vector-im/hydrogen-web/releases/tag/v0.9.1"},`Hydrogen v0.9.1 (${"3565504203"}) on Github`):n.a({target:"_blank",href:"https://github.com/vector-im/hydrogen-web"},"Hydrogen on Github")}class _u extends b{render(e,t){const s=o=>!!o.isBusy,i=e.input({id:"username",type:"text",placeholder:t.i18n`Username`,disabled:s}),r=e.input({id:"password",type:"password",placeholder:t.i18n`Password`,disabled:s});return e.div({className:"PasswordLoginView form"},[e.if(o=>o.error,o=>o.div({className:"error"},a=>a.error)),e.form({onSubmit:o=>{o.preventDefault(),t.login(i.value,r.value)}},[e.if(o=>o.errorMessage,(o,a)=>o.p({className:"error"},a.i18n(a.errorMessage))),e.div({className:"form-row text"},[e.label({for:"username"},t.i18n`Username`),i]),e.div({className:"form-row text"},[e.label({for:"password"},t.i18n`Password`),r]),e.div({className:"button-row"},[e.button({className:"button-action primary",type:"submit",disabled:s},t.i18n`Log In`)])])])}}class gu extends b{render(e,t){return e.div({className:"Settings"},[e.h3(t.i18n`Restore your encrypted history?`),e.ifView(s=>s.decryptDehydratedDeviceViewModel,s=>new Ra(s.decryptDehydratedDeviceViewModel)),e.map(s=>s.deviceDecrypted,(s,i)=>s?i.p(t.i18n`That worked out, you're good to go!`):i.p(t.i18n`This will claim the dehydrated device ${t.dehydratedDeviceId}, and will set up a new one.`)),e.div({className:"button-row"},[e.button({className:"button-action primary",onClick:()=>{t.finish()},type:"button"},s=>s.deviceDecrypted?s.i18n`Continue`:s.i18n`Continue without restoring`)])])}}class Ii extends b{render(e){const t=e.if(i=>i.hasError,(i,r)=>i.button({onClick:()=>r.exportLogs()},r.i18n`Export logs`)),s=e.if(i=>i.hasError,(i,r)=>i.button({onClick:()=>r.logout()},r.i18n`Log out`));return e.div({className:"SessionLoadStatusView"},[e.p({className:"status"},[Se(e,{hidden:i=>!i.loading}),e.p(i=>i.loadLabel),t,s]),e.ifView(i=>i.accountSetupViewModel,i=>new gu(i.accountSetupViewModel))])}}class fu extends b{render(e){return e.div({className:"CompleteSSOView"},[e.p({className:"CompleteSSOView_title"},"Finishing up your SSO Login"),e.if(t=>t.errorMessage,(t,s)=>t.p({className:"error"},s.i18n(s.errorMessage))),e.mapView(t=>t.loadViewModel,t=>t?new Ii(t):null)])}}class Da extends b{render(e,t){const s=i=>i.isBusy;return e.div({className:"PreSessionScreen"},[e.button({className:"button-utility LoginView_back",onClick:()=>t.goBack(),disabled:s}),e.div({className:"logo"}),e.h1([t.i18n`Sign In`]),e.mapView(i=>i.completeSSOLoginViewModel,i=>i?new fu(i):null),e.if(i=>i.showHomeserver,(i,r)=>i.div({className:"LoginView_sso form-row text"},[i.label({for:"homeserver"},r.i18n`Homeserver`),i.input({id:"homeserver",type:"text",placeholder:r.i18n`Your matrix homeserver`,value:r.homeserver,disabled:s,onInput:o=>r.setHomeserver(o.target.value),onChange:()=>r.queryHomeserver()}),i.p({className:{LoginView_forwardInfo:!0,hidden:o=>!o.resolvedHomeserver}},o=>o.i18n`You will connect to ${o.resolvedHomeserver}.`),i.if(o=>o.errorMessage,(o,a)=>o.p({className:"error"},a.i18n(a.errorMessage)))])),e.if(i=>i.isFetchingLoginOptions,i=>i.div({className:"LoginView_query-spinner"},[Se(i),i.p("Fetching available login options...")])),e.mapView(i=>i.passwordLoginViewModel,i=>i?new _u(i):null),e.if(i=>i.passwordLoginViewModel&&i.startSSOLoginViewModel,i=>i.p({className:"LoginView_separator"},t.i18n`or`)),e.mapView(i=>i.startSSOLoginViewModel,i=>i?new yu(i):null),e.mapView(i=>i.loadViewModel,i=>i?new Ii(i):null),e.p(Na(e))])}}class yu extends b{render(e,t){return e.div({className:"StartSSOLoginView"},e.button({className:"StartSSOLoginView_button button-action secondary",type:"button",onClick:()=>t.startSSOLogin(),disabled:s=>s.isBusy},t.i18n`Log in with SSO`))}}class Va extends b{render(e,t){const s=new ui(t,r=>r.div([r.p("Are you sure you want to log out?"),r.div({className:"button-row"},[r.a({className:"button-action",type:"submit",href:t.cancelUrl},["Cancel"]),r.button({className:"button-action primary destructive",type:"submit",onClick:()=>t.logout()},t.i18n`Log out`)])])),i=new ui(t,r=>r.p({className:"status",hidden:o=>!o.showStatus},[Se(r,{hidden:o=>!o.busy}),r.span(o=>o.status)]));return e.div({className:"LogoutScreen"},[e.div({className:"content"},[e.mapView(r=>r.showConfirm,r=>r?s:i)])])}}class Pa extends b{render(e){return e.div({className:"LogoutScreen"},[e.div({className:"content"},e.map(t=>t.showStatus,(t,s,i)=>t?s.p({className:"status"},[Se(s,{hidden:r=>!r.showSpinner}),s.span(r=>r.status)]):s.div([s.p("Your access token is no longer valid! You can reauthenticate in the next screen."),s.div({className:"button-row"},[s.button({className:"button-action primary",type:"submit",onClick:()=>i.proceed()},i.i18n`Proceed`)])])))])}}class La extends b{render(e,t){return e.div({className:"PreSessionScreen"},[e.div({className:"logo"}),e.div({className:"SessionLoadView"},[e.view(new Ii(t))]),e.div({className:{"button-row":!0,hidden:s=>s.loading}},e.a({className:"button-action primary",href:t.backUrl},t.i18n`Go back`))])}}class wu extends b{_onDeleteClick(){confirm("Are you sure?")&&this.value.delete()}_onClearClick(){confirm("Are you sure?")&&this.value.clear()}render(e,t){return e.li([e.a({className:"session-info",href:t.openUrl},[e.div({className:`avatar usercolor${t.avatarColorNumber}`},s=>s.avatarInitials),e.div({className:"user-id"},s=>s.label)])])}}class Oa extends b{render(e,t){const s=new mt({list:t.sessions,parentProvidesUpdates:!1},i=>new wu(i));return e.div({className:"PreSessionScreen"},[e.div({className:"logo"}),e.div({className:"SessionPickerView"},[e.h1(["Continue as \u2026"]),e.view(s),e.div({className:"button-row"},[e.a({className:"button-action primary",href:t.cancelUrl},t.i18n`Sign In`)]),e.ifView(i=>i.loadViewModel,()=>new Ii(t.loadViewModel)),e.p(Na(e))])])}}class vu extends b{render(e,t){return e.mapView(s=>s.activeSection,s=>{switch(s){case"error":return new Xe(i=>i.div({className:"StatusView"},[i.h1("Something went wrong"),i.p(t.errorText)]));case"session":return new xa(t.sessionViewModel);case"login":return new Da(t.loginViewModel);case"logout":return new Va(t.logoutViewModel);case"forced-logout":return new Pa(t.forcedLogoutViewModel);case"picker":return new Oa(t.sessionPickerViewModel);case"redirecting":return new Xe(i=>i.p("Redirecting..."));case"loading":return new La(t.sessionLoadViewModel);default:throw new Error(`Unknown section: ${t.activeSection}`)}})}}class bu{constructor(e){this._reject=null,this._handle=null,this._promise=new Promise((t,s)=>{this._reject=s,this._handle=setTimeout(()=>{this._reject=null,t()},e)})}elapsed(){return this._promise}abort(){this._reject&&(this._reject(new Ce),clearTimeout(this._handle),this._handle=null,this._reject=null)}dispose(){this.abort()}}class Su{constructor(e,t){this._handle=setInterval(t,e)}dispose(){this._handle&&(clearInterval(this._handle),this._handle=null)}}class Iu{constructor(){this._start=window.performance.now()}measure(){return window.performance.now()-this._start}}class Ru{createMeasure(){return new Iu}createTimeout(e){return new bu(e)}createInterval(e,t){return new Su(t,e)}now(){return Date.now()}}class Jn{constructor(){this._waitingForReply=new Map,this._messageIdCounter=0,this._navigation=null,this._registration=null,this._registrationPromise=null,this._currentController=null,this.haltRequests=!1}setNavigation(e){this._navigation=e}async registerAndStart(e){return this._registrationPromise=(async()=>{navigator.serviceWorker.addEventListener("message",this),navigator.serviceWorker.addEventListener("controllerchange",this),this._registration=await navigator.serviceWorker.register(e),await navigator.serviceWorker.ready,this._currentController=navigator.serviceWorker.controller,this._registration.addEventListener("updatefound",this),this._registrationPromise=null,this._registration.waiting&&this._registration.active&&this._proposeUpdate(),console.log("Service Worker registered")})()}_onMessage(e){const{data:t}=e,s=t.replyTo;if(s){const i=this._waitingForReply.get(s);i&&(this._waitingForReply.delete(s),i(t.payload))}if(t.type==="hasSessionOpen"){const i=this._navigation.observe("session").get()===t.payload.sessionId;e.source.postMessage({replyTo:t.id,payload:i})}else if(t.type==="hasRoomOpen"){const i=this._navigation.observe("session").get()===t.payload.sessionId,r=this._navigation.observe("room").get()===t.payload.roomId;e.source.postMessage({replyTo:t.id,payload:i&&r})}else if(t.type==="closeSession"){const{sessionId:i}=t.payload;this._closeSessionIfNeeded(i).finally(()=>{e.source.postMessage({replyTo:t.id})})}else t.type==="haltRequests"?(this.haltRequests=!0,e.source.postMessage({replyTo:t.id})):t.type==="openRoom"&&this._navigation.push("room",t.payload.roomId)}_closeSessionIfNeeded(e){const t=this._navigation?.path.get("session");return e&&t?.value===e?new Promise(s=>{const i=this._navigation.pathObservable.subscribe(r=>{const o=r.get("session");(!o||o.value!==e)&&(i(),s())});this._navigation.push("session")}):Promise.resolve()}async _proposeUpdate(){if(document.hidden)return;const e=await this._sendAndWaitForReply("version",null,this._registration.waiting);confirm(`Version ${e.version} (${e.buildHash}) is available. Reload to apply?`)&&(await this._sendAndWaitForReply("haltRequests"),this._send("skipWaiting",null,this._registration.waiting))}handleEvent(e){switch(e.type){case"message":this._onMessage(e);break;case"updatefound":this._registration.installing.addEventListener("statechange",this);break;case"statechange":{e.target.state==="installed"&&(this._proposeUpdate(),e.target.removeEventListener("statechange",this));break}case"controllerchange":this._currentController?document.location.reload():this._currentController=navigator.serviceWorker.controller;break}}async _send(e,t,s=void 0){this._registrationPromise&&await this._registrationPromise,s||(s=this._registration.active),s.postMessage({type:e,payload:t})}async _sendAndWaitForReply(e,t,s=void 0){this._registrationPromise&&await this._registrationPromise,s||(s=this._registration.active),this._messageIdCounter+=1;const i=this._messageIdCounter,r=new Promise(o=>{this._waitingForReply.set(i,o)});return s.postMessage({type:e,id:i,payload:t}),await r}async checkForUpdate(){this._registrationPromise&&await this._registrationPromise,this._registration.update()}get version(){return"0.9.1"}get buildHash(){return "3565504203"}async preventConcurrentSessionAccess(e){return this._sendAndWaitForReply("closeSession",{sessionId:e})}async getRegistration(){return this._registrationPromise&&await this._registrationPromise,this._registration}}class ku{constructor(e,t){this._serviceWorkerHandler=e,this._pushConfig=t}async enablePush(e,t){const s=await this._serviceWorkerHandler?.getRegistration();if(s?.pushManager){const r=(await s.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this._pushConfig.applicationServerKey})).toJSON(),o=r.keys.p256dh,a={endpoint:r.endpoint,auth:r.keys.auth,events_only:!0,default_payload:t};return e.httpPusher(this._pushConfig.gatewayUrl,this._pushConfig.appId,o,a)}}async disablePush(){const e=await this._serviceWorkerHandler?.getRegistration();if(e?.pushManager){const t=await e.pushManager.getSubscription();t&&await t.unsubscribe()}}async isPushEnabled(){const e=await this._serviceWorkerHandler?.getRegistration();return e?.pushManager?!!await e.pushManager.getSubscription():!1}async supportsPush(){if(!this._pushConfig)return!1;const e=await this._serviceWorkerHandler?.getRegistration();return e&&"pushManager"in e}async enableNotifications(){return"Notification"in window?await Notification.requestPermission()==="granted":!1}async supportsNotifications(){return"Notification"in window}async areNotificationsEnabled(){return"Notification"in window?Notification.permission==="granted":!1}async showNotification(e,t=void 0){if("Notification"in window){new Notification(e,{body:t});return}(await this._serviceWorkerHandler?.getRegistration())?.showNotification(e,{body:t})}}class Ua extends Oe{constructor(){super(),this._lastSessionHash=void 0}handleEvent(e){e.type==="hashchange"&&(this.emit(this.get()),this._storeHash(this.get()))}get(){return document.location.search.includes("loginToken")?document.location.search:document.location.hash}replaceUrlSilently(e){window.history.replaceState(null,null,e),this._storeHash(e)}pushUrlSilently(e){window.history.pushState(null,null,e),this._storeHash(e)}pushUrl(e){document.location.hash=e}urlAsPath(e){return e.startsWith("#")?e.substr(1):e}pathAsUrl(e){return`#${e}`}onSubscribeFirst(){this._lastSessionHash=window.localStorage?.getItem("hydrogen_last_url_hash"),window.addEventListener("hashchange",this)}onUnsubscribeLast(){window.removeEventListener("hashchange",this)}_storeHash(e){window.localStorage?.setItem("hydrogen_last_url_hash",e)}getLastSessionUrl(){return this._lastSessionHash}}class Eu extends Oe{constructor(){super(),this._onOffline=this._onOffline.bind(this),this._onOnline=this._onOnline.bind(this)}_onOffline(){this.emit(!1)}_onOnline(){this.emit(!0)}get(){return navigator.onLine}onSubscribeFirst(){window.addEventListener("offline",this._onOffline),window.addEventListener("online",this._onOnline)}onUnsubscribeLast(){window.removeEventListener("offline",this._onOffline),window.removeEventListener("online",this._onOnline)}}function oe(n,e){return n instanceof Promise?n:new Promise((t,s)=>{n.oncomplete=i=>t(i.target.result),n.onerror=()=>s(new Error("Crypto error on "+e))})}class Mu{constructor(e){this._subtleCrypto=e}async verify(e,t,s,i){const r={name:"HMAC",hash:{name:Tt(i)}},o=await oe(this._subtleCrypto.importKey("raw",e,r,!1,["verify"]),"importKey");return await oe(this._subtleCrypto.verify(r,o,t,s),"verify")}async compute(e,t,s){const i={name:"HMAC",hash:{name:Tt(s)}},r=await oe(this._subtleCrypto.importKey("raw",e,i,!1,["sign"]),"importKey"),o=await oe(this._subtleCrypto.sign(i,r,t),"sign");return new Uint8Array(o)}}class Cu{constructor(e,t,s){this._subtleCrypto=e,this._crypto=t,this._cryptoExtras=s}async pbkdf2(e,t,s,i,r){if(!this._subtleCrypto.deriveBits)throw new Error("PBKDF2 is not supported");const o=await oe(this._subtleCrypto.importKey("raw",e,{name:"PBKDF2"},!1,["deriveBits"]),"importKey"),a=await oe(this._subtleCrypto.deriveBits({name:"PBKDF2",salt:s,iterations:t,hash:Tt(i)},o,r),"deriveBits");return new Uint8Array(a)}async hkdf(e,t,s,i,r){if(!this._subtleCrypto.deriveBits)return this._cryptoExtras.hkdf(this._crypto,e,t,s,i,r);const o=await oe(this._subtleCrypto.importKey("raw",e,{name:"HKDF"},!1,["deriveBits"]),"importKey"),a=await oe(this._subtleCrypto.deriveBits({name:"HKDF",salt:t,info:s,hash:Tt(i)},o,r),"deriveBits");return new Uint8Array(a)}}class Tu{constructor(e,t){this._subtleCrypto=e,this._crypto=t}async decryptCTR({key:e,jwkKey:t,iv:s,data:i,counterLength:r=64}){const o={name:"AES-CTR",counter:s,length:r};let a;try{const c=e||t,l=t?"jwk":"raw";a=await oe(this._subtleCrypto.importKey(l,c,o,!1,["decrypt"]),"importKey")}catch(c){throw new Error(`Could not import key for AES-CTR decryption: ${c.message}`)}try{const c=await oe(this._subtleCrypto.decrypt(o,a,i),"decrypt");return new Uint8Array(c)}catch(c){throw new Error(`Could not decrypt with AES-CTR: ${c.message}`)}}async encryptCTR({key:e,jwkKey:t,iv:s,data:i}){const r={name:"AES-CTR",counter:s,length:64};let o;const a=e||t,c=t?"jwk":"raw";try{o=await oe(this._subtleCrypto.importKey(c,a,r,!1,["encrypt"]),"importKey")}catch(l){throw new Error(`Could not import key for AES-CTR encryption: ${l.message}`)}try{const l=await oe(this._subtleCrypto.encrypt(r,o,i),"encrypt");return new Uint8Array(l)}catch(l){throw new Error(`Could not encrypt with AES-CTR: ${l.message}`)}}async generateKey(e,t=256){const s=await oe(this._subtleCrypto.generateKey({name:"AES-CTR",length:t},!0,["encrypt","decrypt"]));return oe(this._subtleCrypto.exportKey(e,s))}async generateIV(){return Fa(this._crypto)}}function Fa(n){const e=n.getRandomValues(new Uint8Array(8)),t=new Uint8Array(16);for(let s=0;s<e.length;s+=1)t[s]=e[s];return t}function Qn(n){if(n.alg!=="A256CTR")throw new Error(`Unknown algorithm: ${n.alg}`);if(!n.key_ops.includes("decrypt"))throw new Error("decrypt missing from key_ops");if(n.kty!=="oct")throw new Error(`Invalid key type, "oct" expected: ${n.kty}`);const t=n.k.replace(/-/g,"+").replace(/_/g,"/");return Et.decode(t)}function Au(n){const e=Et.encode(n),t=e.indexOf("=");return t!==-1?e.substr(0,t):e}function xu(n){return Au(n).replace(/\+/g,"-").replace(/\//g,"_")}function Nu(n){return{alg:"A256CTR",ext:!0,k:xu(n),key_ops:["encrypt","decrypt"],kty:"oct"}}class Du{constructor(e,t){this._aesjs=e,this._crypto=t}async decryptCTR({key:e,jwkKey:t,iv:s,data:i,counterLength:r=64}){if(r!==64)throw new Error(`Unsupported counter length: ${r}`);t&&(e=Qn(t));const o=this._aesjs;var a=new o.ModeOfOperation.ctr(new Uint8Array(e),new o.Counter(new Uint8Array(s)));return a.decrypt(new Uint8Array(i))}async encryptCTR({key:e,jwkKey:t,iv:s,data:i}){t&&(e=Qn(t));const r=this._aesjs;var o=new r.ModeOfOperation.ctr(new Uint8Array(e),new r.Counter(new Uint8Array(s)));return o.encrypt(new Uint8Array(i))}async generateKey(e,t=256){let s=crypto.getRandomValues(new Uint8Array(t/8));return e==="jwk"&&(s=Nu(s)),s}async generateIV(){return Fa(this._crypto)}}function Tt(n){if(n!=="SHA-256"&&n!=="SHA-512")throw new Error(`Invalid hash name: ${n}`);return n}class Vu{constructor(e){const t=window.crypto||window.msCrypto,s=t.subtle||t.webkitSubtle;this._subtleCrypto=s,!s.deriveBits&&e?.aesjs?this.aes=new Du(e.aesjs,t):this.aes=new Tu(s,t),this.hmac=new Mu(s),this.derive=new Cu(s,this,e)}async digest(e,t){return await oe(this._subtleCrypto.digest(Tt(e),t))}digestSize(e){switch(Tt(e)){case"SHA-512":return 64;case"SHA-256":return 32;default:throw new Error(`Not implemented for ${Tt(e)}`)}}}async function Pu(){if(navigator?.storage?.estimate){const{quota:n,usage:e}=await navigator.storage.estimate();return{quota:n,usage:e}}else return{quota:null,usage:null}}class Lu{constructor(e){this.worker=e,this.busy=!1}attach(e){this.worker.addEventListener("message",e),this.worker.addEventListener("error",e)}detach(e){this.worker.removeEventListener("message",e),this.worker.removeEventListener("error",e)}}class Ou{constructor(e,t){this._promise=new Promise((s,i)=>{this._resolve=s,this._reject=i}),this._message=e,this._pool=t,this._worker=null}abort(){this._isNotDisposed&&(this._pool._abortRequest(this),this._dispose())}response(){return this._promise}_dispose(){this._reject=null,this._resolve=null}get _isNotDisposed(){return this._resolve&&this._reject}}class Uu{constructor(e,t){this._workers=[];for(let s=0;s<t;++s){const i=new Lu(new Worker(e));i.attach(this),this._workers[s]=i}this._requests=new Map,this._counter=0,this._pendingFlag=!1,this._init=null}init(){const e=new Promise((t,s)=>{this._init={resolve:t,reject:s}});return this.sendAll({type:"ping"}).then(this._init.resolve,this._init.reject).finally(()=>{this._init=null}),e}handleEvent(e){if(e.type==="message"){const t=e.data,s=this._requests.get(t.replyToId);if(s){if(s._worker.busy=!1,s._isNotDisposed){if(t.type==="success")s._resolve(t.payload);else if(t.type==="error"){const i=new Error(t.message);i.stack=t.stack,s._reject(i)}s._dispose()}this._requests.delete(t.replyToId)}this._sendPending()}else e.type==="error"&&(this._init&&this._init.reject(new Error("worker error during init")),console.error("worker error",e))}_getPendingRequest(){for(const e of this._requests.values())if(!e._worker)return e}_getFreeWorker(){for(const e of this._workers)if(!e.busy)return e}_sendPending(){this._pendingFlag=!1;let e;do{e=!1;const t=this._getPendingRequest();if(t){const s=this._getFreeWorker();s&&(this._sendWith(t,s),e=!0)}}while(e)}_sendWith(e,t){e._worker=t,t.busy=!0,t.worker.postMessage(e._message)}_enqueueRequest(e){this._counter+=1,e.id=this._counter;const t=new Ou(e,this);return this._requests.set(e.id,t),t}send(e){const t=this._enqueueRequest(e),s=this._getFreeWorker();return s&&this._sendWith(t,s),t}sendAll(e){const t=this._workers.map(s=>{const i=this._enqueueRequest(Object.assign({},e));return this._sendWith(i,s),i.response()});return Promise.all(t)}dispose(){for(const e of this._workers)e.detach(this),e.worker.terminate()}_trySendPendingInNextTick(){this._pendingFlag||(this._pendingFlag=!0,Promise.resolve().then(()=>{this._sendPending()}))}_abortRequest(e){e._reject(new Ce),e._worker&&(e._worker.busy=!1),this._requests.delete(e._message.id),this._trySendPendingInNextTick()}}const Fu={"image/jpeg":!0,"image/gif":!0,"image/png":!0,"video/mp4":!0,"video/webm":!0,"video/ogg":!0,"video/quicktime":!0,"video/VP8":!0,"audio/mp4":!0,"audio/webm":!0,"audio/aac":!0,"audio/mpeg":!0,"audio/ogg":!0,"audio/wave":!0,"audio/wav":!0,"audio/x-wav":!0,"audio/x-pn-wav":!0,"audio/flac":!0,"audio/x-flac":!0},Yn="application/octet-stream";class xt{constructor(e,t=null){this._blob=e,this._buffer=t,this._url=null}static fromBuffer(e,t){return t=t?t.split(";")[0].trim():"",Fu[t]||(t=Yn),new xt(new Blob([e],{type:t}),e)}static fromBlob(e){return new xt(e)}get nativeBlob(){return this._blob}async readAsBuffer(){if(this._buffer)return this._buffer;{const e=new FileReader,t=new Promise((s,i)=>{e.addEventListener("load",r=>s(r.target.result)),e.addEventListener("error",r=>i(r.target.error))});return e.readAsArrayBuffer(this._blob),t}}get url(){return this._url||(this._url=URL.createObjectURL(this._blob)),this._url}get size(){return this._blob.size}get mimeType(){return this._blob.type||Yn}dispose(){this._url&&(URL.revokeObjectURL(this._url),this._url=null)}}class Es{static async fromBlob(e){const t=await Xn(e),{width:s,height:i}=t;return new Es(e,s,i,t)}constructor(e,t,s,i){this.blob=e,this.width=t,this.height=s,this._domElement=i}get maxDimension(){return Math.max(this.width,this.height)}async _getDomElement(){return this._domElement||(this._domElement=await Xn(this.blob)),this._domElement}async scale(e){const t=this.width/this.height,s=Math.min(1,e/(t>=1?this.width:this.height)),i=Math.round(this.width*s),r=Math.round(this.height*s),o=document.createElement("canvas");o.width=i,o.height=r;const a=o.getContext("2d"),c=await this._getDomElement();a.drawImage(c,0,0,i,r);let l=this.blob.mimeType==="image/jpeg"?"image/jpeg":"image/png",h;if(o.toBlob)h=await new Promise(u=>o.toBlob(u,l));else if(o.msToBlob)l="image/png",h=o.msToBlob();else throw new Error("canvas can't be turned into blob");const d=xt.fromBlob(h);return new Es(d,i,r,null)}dispose(){this.blob.dispose()}}class Wr extends Es{get duration(){if(typeof this._domElement.duration=="number")return Math.round(this._domElement.duration*1e3)}static async fromBlob(e){const t=await Ku(e),{videoWidth:s,videoHeight:i}=t;return new Wr(e,s,i,t)}}function Bu(){const n=document.createElement("canvas");n.width=1,n.height=1;const e=n.getContext("2d"),t=[Math.round(Math.random()*255),Math.round(Math.random()*255),Math.round(Math.random()*255)];e.fillStyle=`rgb(${t[0]}, ${t[1]}, ${t[2]})`,e.fillRect(0,0,1,1);const s=e.getImageData(0,0,1,1).data;return s[0]===t[0]&&s[1]===t[1]&&s[2]===t[2]}async function Xn(n){const e=document.createElement("img"),t=mi(e,"load");return e.src=n.url,await t,e}async function Ku(n){const e=document.createElement("video");e.muted=!0;const t=mi(e,"loadedmetadata");e.src=n.url,e.load(),await t;const s=mi(e,"seeked");return await new Promise(i=>setTimeout(i,200)),e.currentTime=.1,await s,e}async function $u(n,e,t,s,i){let r=n.querySelector("iframe.downloadSandbox");if(!r){r=document.createElement("iframe"),r.setAttribute("sandbox","allow-scripts allow-downloads allow-downloads-without-user-activation"),r.setAttribute("src",e),r.className="hidden downloadSandbox",n.appendChild(r);let o;await new Promise((a,c)=>{o=()=>{r.removeEventListener("load",a),r.removeEventListener("error",c)},r.addEventListener("load",a),r.addEventListener("error",c)}),o()}if(i){const o=await t.readAsBuffer();r.contentWindow.postMessage({type:"downloadBuffer",buffer:o,mimeType:t.mimeType,filename:s},"*")}else r.contentWindow.postMessage({type:"downloadBlob",blob:t.nativeBlob,filename:s},"*")}function Hi(n){typeof n=="function"?n():n.dispose()}function ju(n){return n&&(typeof n=="function"||typeof n.dispose=="function")}class Ri{constructor(){this._disposables=[]}track(e){if(!ju(e))throw new Error("Not a disposable");return this.isDisposed?(console.warn("Disposables already disposed, disposing new value"),Hi(e),e):(this._disposables.push(e),e)}untrack(e){if(!this._disposables)return;const t=this._disposables.indexOf(e);t>=0&&this._disposables.splice(t,1)}dispose(){if(this._disposables){for(const e of this._disposables)Hi(e);this._disposables=void 0}}get isDisposed(){return this._disposables===void 0}disposeTracked(e){if(e==null||this.isDisposed)return;const t=this._disposables.indexOf(e);if(t!==-1){const[s]=this._disposables.splice(t,1);Hi(s)}else console.warn("disposable not found, did it leak?",e)}}/*! @license DOMPurify 2.4.5 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/2.4.5/LICENSE */function ot(n){return ot=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ot(n)}function ur(n,e){return ur=Object.setPrototypeOf||function(s,i){return s.__proto__=i,s},ur(n,e)}function qu(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function ii(n,e,t){return qu()?ii=Reflect.construct:ii=function(i,r,o){var a=[null];a.push.apply(a,r);var c=Function.bind.apply(i,a),l=new c;return o&&ur(l,o.prototype),l},ii.apply(null,arguments)}function Re(n){return Wu(n)||Hu(n)||zu(n)||Gu()}function Wu(n){if(Array.isArray(n))return mr(n)}function Hu(n){if(typeof Symbol<"u"&&n[Symbol.iterator]!=null||n["@@iterator"]!=null)return Array.from(n)}function zu(n,e){if(!!n){if(typeof n=="string")return mr(n,e);var t=Object.prototype.toString.call(n).slice(8,-1);if(t==="Object"&&n.constructor&&(t=n.constructor.name),t==="Map"||t==="Set")return Array.from(n);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return mr(n,e)}}function mr(n,e){(e==null||e>n.length)&&(e=n.length);for(var t=0,s=new Array(e);t<e;t++)s[t]=n[t];return s}function Gu(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var Ju=Object.hasOwnProperty,Zn=Object.setPrototypeOf,Qu=Object.isFrozen,Yu=Object.getPrototypeOf,Xu=Object.getOwnPropertyDescriptor,ce=Object.freeze,Ae=Object.seal,Zu=Object.create,Ba=typeof Reflect<"u"&&Reflect,pi=Ba.apply,pr=Ba.construct;pi||(pi=function(e,t,s){return e.apply(t,s)});ce||(ce=function(e){return e});Ae||(Ae=function(e){return e});pr||(pr=function(e,t){return ii(e,Re(t))});var em=be(Array.prototype.forEach),eo=be(Array.prototype.pop),ls=be(Array.prototype.push),ri=be(String.prototype.toLowerCase),zi=be(String.prototype.toString),tm=be(String.prototype.match),Ie=be(String.prototype.replace),sm=be(String.prototype.indexOf),im=be(String.prototype.trim),re=be(RegExp.prototype.test),Gi=rm(TypeError);function be(n){return function(e){for(var t=arguments.length,s=new Array(t>1?t-1:0),i=1;i<t;i++)s[i-1]=arguments[i];return pi(n,e,s)}}function rm(n){return function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return pr(n,t)}}function M(n,e,t){t=t||ri,Zn&&Zn(n,null);for(var s=e.length;s--;){var i=e[s];if(typeof i=="string"){var r=t(i);r!==i&&(Qu(e)||(e[s]=r),i=r)}n[i]=!0}return n}function wt(n){var e=Zu(null),t;for(t in n)pi(Ju,n,[t])===!0&&(e[t]=n[t]);return e}function Js(n,e){for(;n!==null;){var t=Xu(n,e);if(t){if(t.get)return be(t.get);if(typeof t.value=="function")return be(t.value)}n=Yu(n)}function s(i){return console.warn("fallback value for",i),null}return s}var to=ce(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","section","select","shadow","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),Ji=ce(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","filter","font","g","glyph","glyphref","hkern","image","line","lineargradient","marker","mask","metadata","mpath","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),Qi=ce(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),nm=ce(["animate","color-profile","cursor","discard","fedropshadow","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),Yi=ce(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover"]),om=ce(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),so=ce(["#text"]),io=ce(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","face","for","headers","height","hidden","high","href","hreflang","id","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","pattern","placeholder","playsinline","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","xmlns","slot"]),Xi=ce(["accent-height","accumulate","additive","alignment-baseline","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),ro=ce(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),Qs=ce(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),am=Ae(/\{\{[\w\W]*|[\w\W]*\}\}/gm),cm=Ae(/<%[\w\W]*|[\w\W]*%>/gm),lm=Ae(/\${[\w\W]*}/gm),hm=Ae(/^data-[\-\w.\u00B7-\uFFFF]/),dm=Ae(/^aria-[\-\w]+$/),um=Ae(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),mm=Ae(/^(?:\w+script|data):/i),pm=Ae(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),_m=Ae(/^html$/i),gm=function(){return typeof window>"u"?null:window},fm=function(e,t){if(ot(e)!=="object"||typeof e.createPolicy!="function")return null;var s=null,i="data-tt-policy-suffix";t.currentScript&&t.currentScript.hasAttribute(i)&&(s=t.currentScript.getAttribute(i));var r="dompurify"+(s?"#"+s:"");try{return e.createPolicy(r,{createHTML:function(a){return a},createScriptURL:function(a){return a}})}catch{return console.warn("TrustedTypes policy "+r+" could not be created."),null}};function Ka(){var n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:gm(),e=function(m){return Ka(m)};if(e.version="2.4.5",e.removed=[],!n||!n.document||n.document.nodeType!==9)return e.isSupported=!1,e;var t=n.document,s=n.document,i=n.DocumentFragment,r=n.HTMLTemplateElement,o=n.Node,a=n.Element,c=n.NodeFilter,l=n.NamedNodeMap,h=l===void 0?n.NamedNodeMap||n.MozNamedAttrMap:l,d=n.HTMLFormElement,u=n.DOMParser,p=n.trustedTypes,_=a.prototype,g=Js(_,"cloneNode"),w=Js(_,"nextSibling"),I=Js(_,"childNodes"),E=Js(_,"parentNode");if(typeof r=="function"){var A=s.createElement("template");A.content&&A.content.ownerDocument&&(s=A.content.ownerDocument)}var v=fm(p,t),R=v?v.createHTML(""):"",D=s,K=D.implementation,Dt=D.createNodeIterator,xc=D.createDocumentFragment,Nc=D.getElementsByTagName,Dc=t.importNode,cn={};try{cn=wt(s).documentMode?s.documentMode:{}}catch{}var Ne={};e.isSupported=typeof E=="function"&&K&&typeof K.createHTMLDocument<"u"&&cn!==9;var Mi=am,Ci=cm,Ti=lm,Vc=hm,Pc=dm,Lc=mm,ln=pm,Ai=um,G=null,hn=M({},[].concat(Re(to),Re(Ji),Re(Qi),Re(Yi),Re(so))),J=null,dn=M({},[].concat(Re(io),Re(Xi),Re(ro),Re(Qs))),q=Object.seal(Object.create(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),ns=null,xi=null,un=!0,Ni=!0,mn=!1,pn=!0,Vt=!1,_t=!1,Di=!1,Vi=!1,Pt=!1,Ds=!1,Vs=!1,_n=!0,gn=!1,Oc="user-content-",Pi=!0,os=!1,Lt={},Ot=null,fn=M({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]),yn=null,wn=M({},["audio","video","img","source","image","track"]),Li=null,vn=M({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),Ps="http://www.w3.org/1998/Math/MathML",Ls="http://www.w3.org/2000/svg",Ue="http://www.w3.org/1999/xhtml",Ut=Ue,Oi=!1,Ui=null,Uc=M({},[Ps,Ls,Ue],zi),gt,Fc=["application/xhtml+xml","text/html"],Bc="text/html",Q,Ft=null,Kc=s.createElement("form"),bn=function(m){return m instanceof RegExp||m instanceof Function},Fi=function(m){Ft&&Ft===m||((!m||ot(m)!=="object")&&(m={}),m=wt(m),gt=Fc.indexOf(m.PARSER_MEDIA_TYPE)===-1?gt=Bc:gt=m.PARSER_MEDIA_TYPE,Q=gt==="application/xhtml+xml"?zi:ri,G="ALLOWED_TAGS"in m?M({},m.ALLOWED_TAGS,Q):hn,J="ALLOWED_ATTR"in m?M({},m.ALLOWED_ATTR,Q):dn,Ui="ALLOWED_NAMESPACES"in m?M({},m.ALLOWED_NAMESPACES,zi):Uc,Li="ADD_URI_SAFE_ATTR"in m?M(wt(vn),m.ADD_URI_SAFE_ATTR,Q):vn,yn="ADD_DATA_URI_TAGS"in m?M(wt(wn),m.ADD_DATA_URI_TAGS,Q):wn,Ot="FORBID_CONTENTS"in m?M({},m.FORBID_CONTENTS,Q):fn,ns="FORBID_TAGS"in m?M({},m.FORBID_TAGS,Q):{},xi="FORBID_ATTR"in m?M({},m.FORBID_ATTR,Q):{},Lt="USE_PROFILES"in m?m.USE_PROFILES:!1,un=m.ALLOW_ARIA_ATTR!==!1,Ni=m.ALLOW_DATA_ATTR!==!1,mn=m.ALLOW_UNKNOWN_PROTOCOLS||!1,pn=m.ALLOW_SELF_CLOSE_IN_ATTR!==!1,Vt=m.SAFE_FOR_TEMPLATES||!1,_t=m.WHOLE_DOCUMENT||!1,Pt=m.RETURN_DOM||!1,Ds=m.RETURN_DOM_FRAGMENT||!1,Vs=m.RETURN_TRUSTED_TYPE||!1,Vi=m.FORCE_BODY||!1,_n=m.SANITIZE_DOM!==!1,gn=m.SANITIZE_NAMED_PROPS||!1,Pi=m.KEEP_CONTENT!==!1,os=m.IN_PLACE||!1,Ai=m.ALLOWED_URI_REGEXP||Ai,Ut=m.NAMESPACE||Ue,q=m.CUSTOM_ELEMENT_HANDLING||{},m.CUSTOM_ELEMENT_HANDLING&&bn(m.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(q.tagNameCheck=m.CUSTOM_ELEMENT_HANDLING.tagNameCheck),m.CUSTOM_ELEMENT_HANDLING&&bn(m.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(q.attributeNameCheck=m.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),m.CUSTOM_ELEMENT_HANDLING&&typeof m.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements=="boolean"&&(q.allowCustomizedBuiltInElements=m.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),Vt&&(Ni=!1),Ds&&(Pt=!0),Lt&&(G=M({},Re(so)),J=[],Lt.html===!0&&(M(G,to),M(J,io)),Lt.svg===!0&&(M(G,Ji),M(J,Xi),M(J,Qs)),Lt.svgFilters===!0&&(M(G,Qi),M(J,Xi),M(J,Qs)),Lt.mathMl===!0&&(M(G,Yi),M(J,ro),M(J,Qs))),m.ADD_TAGS&&(G===hn&&(G=wt(G)),M(G,m.ADD_TAGS,Q)),m.ADD_ATTR&&(J===dn&&(J=wt(J)),M(J,m.ADD_ATTR,Q)),m.ADD_URI_SAFE_ATTR&&M(Li,m.ADD_URI_SAFE_ATTR,Q),m.FORBID_CONTENTS&&(Ot===fn&&(Ot=wt(Ot)),M(Ot,m.FORBID_CONTENTS,Q)),Pi&&(G["#text"]=!0),_t&&M(G,["html","head","body"]),G.table&&(M(G,["tbody"]),delete ns.tbody),ce&&ce(m),Ft=m)},Sn=M({},["mi","mo","mn","ms","mtext"]),In=M({},["foreignobject","desc","title","annotation-xml"]),$c=M({},["title","style","font","a","script"]),Os=M({},Ji);M(Os,Qi),M(Os,nm);var Bi=M({},Yi);M(Bi,om);var jc=function(m){var f=E(m);(!f||!f.tagName)&&(f={namespaceURI:Ut,tagName:"template"});var y=ri(m.tagName),V=ri(f.tagName);return Ui[m.namespaceURI]?m.namespaceURI===Ls?f.namespaceURI===Ue?y==="svg":f.namespaceURI===Ps?y==="svg"&&(V==="annotation-xml"||Sn[V]):Boolean(Os[y]):m.namespaceURI===Ps?f.namespaceURI===Ue?y==="math":f.namespaceURI===Ls?y==="math"&&In[V]:Boolean(Bi[y]):m.namespaceURI===Ue?f.namespaceURI===Ls&&!In[V]||f.namespaceURI===Ps&&!Sn[V]?!1:!Bi[y]&&($c[y]||!Os[y]):!!(gt==="application/xhtml+xml"&&Ui[m.namespaceURI]):!1},Fe=function(m){ls(e.removed,{element:m});try{m.parentNode.removeChild(m)}catch{try{m.outerHTML=R}catch{m.remove()}}},Ki=function(m,f){try{ls(e.removed,{attribute:f.getAttributeNode(m),from:f})}catch{ls(e.removed,{attribute:null,from:f})}if(f.removeAttribute(m),m==="is"&&!J[m])if(Pt||Ds)try{Fe(f)}catch{}else try{f.setAttribute(m,"")}catch{}},Rn=function(m){var f,y;if(Vi)m="<remove></remove>"+m;else{var V=tm(m,/^[\r\n\t ]+/);y=V&&V[0]}gt==="application/xhtml+xml"&&Ut===Ue&&(m='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+m+"</body></html>");var de=v?v.createHTML(m):m;if(Ut===Ue)try{f=new u().parseFromString(de,gt)}catch{}if(!f||!f.documentElement){f=K.createDocument(Ut,"template",null);try{f.documentElement.innerHTML=Oi?R:de}catch{}}var se=f.body||f.documentElement;return m&&y&&se.insertBefore(s.createTextNode(y),se.childNodes[0]||null),Ut===Ue?Nc.call(f,_t?"html":"body")[0]:_t?f.documentElement:se},kn=function(m){return Dt.call(m.ownerDocument||m,m,c.SHOW_ELEMENT|c.SHOW_COMMENT|c.SHOW_TEXT,null,!1)},qc=function(m){return m instanceof d&&(typeof m.nodeName!="string"||typeof m.textContent!="string"||typeof m.removeChild!="function"||!(m.attributes instanceof h)||typeof m.removeAttribute!="function"||typeof m.setAttribute!="function"||typeof m.namespaceURI!="string"||typeof m.insertBefore!="function"||typeof m.hasChildNodes!="function")},as=function(m){return ot(o)==="object"?m instanceof o:m&&ot(m)==="object"&&typeof m.nodeType=="number"&&typeof m.nodeName=="string"},Be=function(m,f,y){!Ne[m]||em(Ne[m],function(V){V.call(e,f,y,Ft)})},En=function(m){var f;if(Be("beforeSanitizeElements",m,null),qc(m)||re(/[\u0080-\uFFFF]/,m.nodeName))return Fe(m),!0;var y=Q(m.nodeName);if(Be("uponSanitizeElement",m,{tagName:y,allowedTags:G}),m.hasChildNodes()&&!as(m.firstElementChild)&&(!as(m.content)||!as(m.content.firstElementChild))&&re(/<[/\w]/g,m.innerHTML)&&re(/<[/\w]/g,m.textContent)||y==="select"&&re(/<template/i,m.innerHTML))return Fe(m),!0;if(!G[y]||ns[y]){if(!ns[y]&&Cn(y)&&(q.tagNameCheck instanceof RegExp&&re(q.tagNameCheck,y)||q.tagNameCheck instanceof Function&&q.tagNameCheck(y)))return!1;if(Pi&&!Ot[y]){var V=E(m)||m.parentNode,de=I(m)||m.childNodes;if(de&&V)for(var se=de.length,Z=se-1;Z>=0;--Z)V.insertBefore(g(de[Z],!0),w(m))}return Fe(m),!0}return m instanceof a&&!jc(m)||(y==="noscript"||y==="noembed")&&re(/<\/no(script|embed)/i,m.innerHTML)?(Fe(m),!0):(Vt&&m.nodeType===3&&(f=m.textContent,f=Ie(f,Mi," "),f=Ie(f,Ci," "),f=Ie(f,Ti," "),m.textContent!==f&&(ls(e.removed,{element:m.cloneNode()}),m.textContent=f)),Be("afterSanitizeElements",m,null),!1)},Mn=function(m,f,y){if(_n&&(f==="id"||f==="name")&&(y in s||y in Kc))return!1;if(!(Ni&&!xi[f]&&re(Vc,f))){if(!(un&&re(Pc,f))){if(!J[f]||xi[f]){if(!(Cn(m)&&(q.tagNameCheck instanceof RegExp&&re(q.tagNameCheck,m)||q.tagNameCheck instanceof Function&&q.tagNameCheck(m))&&(q.attributeNameCheck instanceof RegExp&&re(q.attributeNameCheck,f)||q.attributeNameCheck instanceof Function&&q.attributeNameCheck(f))||f==="is"&&q.allowCustomizedBuiltInElements&&(q.tagNameCheck instanceof RegExp&&re(q.tagNameCheck,y)||q.tagNameCheck instanceof Function&&q.tagNameCheck(y))))return!1}else if(!Li[f]){if(!re(Ai,Ie(y,ln,""))){if(!((f==="src"||f==="xlink:href"||f==="href")&&m!=="script"&&sm(y,"data:")===0&&yn[m])){if(!(mn&&!re(Lc,Ie(y,ln,"")))){if(y)return!1}}}}}}return!0},Cn=function(m){return m.indexOf("-")>0},Tn=function(m){var f,y,V,de;Be("beforeSanitizeAttributes",m,null);var se=m.attributes;if(!!se){var Z={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:J};for(de=se.length;de--;){f=se[de];var Us=f,Y=Us.name,$i=Us.namespaceURI;if(y=Y==="value"?f.value:im(f.value),V=Q(Y),Z.attrName=V,Z.attrValue=y,Z.keepAttr=!0,Z.forceKeepAttr=void 0,Be("uponSanitizeAttribute",m,Z),y=Z.attrValue,!Z.forceKeepAttr&&(Ki(Y,m),!!Z.keepAttr)){if(!pn&&re(/\/>/i,y)){Ki(Y,m);continue}Vt&&(y=Ie(y,Mi," "),y=Ie(y,Ci," "),y=Ie(y,Ti," "));var An=Q(m.nodeName);if(!!Mn(An,V,y)){if(gn&&(V==="id"||V==="name")&&(Ki(Y,m),y=Oc+y),v&&ot(p)==="object"&&typeof p.getAttributeType=="function"&&!$i)switch(p.getAttributeType(An,V)){case"TrustedHTML":y=v.createHTML(y);break;case"TrustedScriptURL":y=v.createScriptURL(y);break}try{$i?m.setAttributeNS($i,Y,y):m.setAttribute(Y,y),eo(e.removed)}catch{}}}}Be("afterSanitizeAttributes",m,null)}},Wc=function S(m){var f,y=kn(m);for(Be("beforeSanitizeShadowDOM",m,null);f=y.nextNode();)Be("uponSanitizeShadowNode",f,null),!En(f)&&(f.content instanceof i&&S(f.content),Tn(f));Be("afterSanitizeShadowDOM",m,null)};return e.sanitize=function(S){var m=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},f,y,V,de,se;if(Oi=!S,Oi&&(S="<!-->"),typeof S!="string"&&!as(S)){if(typeof S.toString!="function")throw Gi("toString is not a function");if(S=S.toString(),typeof S!="string")throw Gi("dirty is not a string, aborting")}if(!e.isSupported){if(ot(n.toStaticHTML)==="object"||typeof n.toStaticHTML=="function"){if(typeof S=="string")return n.toStaticHTML(S);if(as(S))return n.toStaticHTML(S.outerHTML)}return S}if(Di||Fi(m),e.removed=[],typeof S=="string"&&(os=!1),os){if(S.nodeName){var Z=Q(S.nodeName);if(!G[Z]||ns[Z])throw Gi("root node is forbidden and cannot be sanitized in-place")}}else if(S instanceof o)f=Rn("<!---->"),y=f.ownerDocument.importNode(S,!0),y.nodeType===1&&y.nodeName==="BODY"||y.nodeName==="HTML"?f=y:f.appendChild(y);else{if(!Pt&&!Vt&&!_t&&S.indexOf("<")===-1)return v&&Vs?v.createHTML(S):S;if(f=Rn(S),!f)return Pt?null:Vs?R:""}f&&Vi&&Fe(f.firstChild);for(var Us=kn(os?S:f);V=Us.nextNode();)V.nodeType===3&&V===de||En(V)||(V.content instanceof i&&Wc(V.content),Tn(V),de=V);if(de=null,os)return S;if(Pt){if(Ds)for(se=xc.call(f.ownerDocument);f.firstChild;)se.appendChild(f.firstChild);else se=f;return(J.shadowroot||J.shadowrootmod)&&(se=Dc.call(t,se,!0)),se}var Y=_t?f.outerHTML:f.innerHTML;return _t&&G["!doctype"]&&f.ownerDocument&&f.ownerDocument.doctype&&f.ownerDocument.doctype.name&&re(_m,f.ownerDocument.doctype.name)&&(Y="<!DOCTYPE "+f.ownerDocument.doctype.name+`>
`+Y),Vt&&(Y=Ie(Y,Mi," "),Y=Ie(Y,Ci," "),Y=Ie(Y,Ti," ")),v&&Vs?v.createHTML(Y):Y},e.setConfig=function(S){Fi(S),Di=!0},e.clearConfig=function(){Ft=null,Di=!1},e.isValidAttribute=function(S,m,f){Ft||Fi({});var y=Q(S),V=Q(m);return Mn(y,V,f)},e.addHook=function(S,m){typeof m=="function"&&(Ne[S]=Ne[S]||[],ls(Ne[S],m))},e.removeHook=function(S){if(Ne[S])return eo(Ne[S])},e.removeHooks=function(S){Ne[S]&&(Ne[S]=[])},e.removeAllHooks=function(){Ne={}},e}var ym=Ka();class wm{constructor(e){this._bodyNode=e}get rootNodes(){return Array.from(this._bodyNode.childNodes)}getChildNodes(e){return Array.from(e.childNodes)}getAttributeNames(e){return Array.from(e.getAttributeNames())}getAttributeValue(e,t){return e.getAttribute(t)}isTextNode(e){return e.nodeType===Node.TEXT_NODE}getNodeText(e){return e.textContent}isElementNode(e){return e.nodeType===Node.ELEMENT_NODE}getNodeElementName(e){return e.tagName}}const vm={ALLOWED_URI_REGEXP:/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp|xxx|mxc):|[^a-z]|[a-z+.-]+(?:[^a-z+.-:]|$))/i,FORBID_TAGS:["mx-reply"],KEEP_CONTENT:!1};function bm(n){const e=ym.sanitize(n,vm),t=new DOMParser().parseFromString(`<!DOCTYPE html><html><body>${e}</body></html>`,"text/html").body;return new wm(t)}const Sm=200,Im=-60,Rm=8;class km{constructor(e){this.mediaDevices=e}enumerate(){return this.mediaDevices.enumerateDevices()}async getMediaTracks(e,t){const s=await this.mediaDevices.getUserMedia(this.getUserMediaContraints(e,t));return s.addEventListener("removetrack",i=>{console.log(`removing track ${i.track.id} (${i.track.kind}) from stream ${s.id}`)}),s}async getScreenShareTrack(){return await this.mediaDevices.getDisplayMedia(this.getScreenshareContraints())}getUserMediaContraints(e,t){const s=!!navigator.webkitGetUserMedia;return{audio:e?{deviceId:typeof e!="boolean"?{ideal:e.deviceId}:void 0}:!1,video:t?{deviceId:typeof t!="boolean"?{ideal:t.deviceId}:void 0,width:s?{exact:640}:{ideal:640},height:s?{exact:360}:{ideal:360}}:!1}}getScreenshareContraints(){return{audio:!1,video:!0}}createVolumeMeasurer(e,t){return new Em(e,t)}}class Em{constructor(e,t){this.measuringVolumeActivity=!1,this.speakingThreshold=Im,this.speaking=!1,this.volumeLooper=()=>{if(!this.analyser||!this.measuringVolumeActivity)return;this.analyser.getFloatFrequencyData(this.frequencyBinCount);let s=-1/0;for(let r=0;r<this.frequencyBinCount.length;r++)this.frequencyBinCount[r]>s&&(s=this.frequencyBinCount[r]);this.speakingVolumeSamples.shift(),this.speakingVolumeSamples.push(s),this.callback();let i=!1;for(let r=0;r<this.speakingVolumeSamples.length;r++)if(this.speakingVolumeSamples[r]>this.speakingThreshold){i=!0;break}this.speaking!==i&&(this.speaking=i,this.callback()),this.volumeLooperTimeout=setTimeout(this.volumeLooper,Sm)},this.stream=e,this.callback=t,this.speakingVolumeSamples=new Array(Rm).fill(-1/0),this.initVolumeMeasuring(),this.measureVolumeActivity(!0)}get isSpeaking(){return this.speaking}measureVolumeActivity(e){if(e){if(!this.audioContext||!this.analyser||!this.frequencyBinCount)return;this.measuringVolumeActivity=!0,this.volumeLooper()}else this.measuringVolumeActivity=!1,this.speakingVolumeSamples.fill(-1/0),this.callback()}initVolumeMeasuring(){const e=window.AudioContext||window.webkitAudioContext;if(!e)return;this.audioContext=new e,this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=512,this.analyser.smoothingTimeConstant=.1,this.audioContext.createMediaStreamSource(this.stream).connect(this.analyser),this.frequencyBinCount=new Float32Array(this.analyser.frequencyBinCount)}setSpeakingThreshold(e){this.speakingThreshold=e}stop(){clearTimeout(this.volumeLooperTimeout),this.analyser.disconnect(),this.audioContext?.close()}}var x=(n=>(n.GroupCall="org.matrix.msc3401.call",n.GroupCallMember="org.matrix.msc3401.call.member",n.Invite="m.call.invite",n.Candidates="m.call.candidates",n.Answer="m.call.answer",n.Hangup="m.call.hangup",n.Reject="m.call.reject",n.SelectAnswer="m.call.select_answer",n.Negotiate="m.call.negotiate",n.SDPStreamMetadataChanged="m.call.sdp_stream_metadata_changed",n.SDPStreamMetadataChangedPrefix="org.matrix.call.sdp_stream_metadata_changed",n.Replaces="m.call.replaces",n.AssertedIdentity="m.call.asserted_identity",n.AssertedIdentityPrefix="org.matrix.call.asserted_identity",n))(x||{});const Ve="org.matrix.msc3077.sdp_stream_metadata";var rt=(n=>(n.Usermedia="m.usermedia",n.Screenshare="m.screenshare",n))(rt||{}),B=(n=>(n.UserHangup="user_hangup",n.LocalOfferFailed="local_offer_failed",n.NoUserMedia="no_user_media",n.UnknownDevices="unknown_devices",n.SendInvite="send_invite",n.CreateAnswer="create_answer",n.SendAnswer="send_answer",n.SetRemoteDescription="set_remote_description",n.SetLocalDescription="set_local_description",n.AnsweredElsewhere="answered_elsewhere",n.IceFailed="ice_failed",n.InviteTimeout="invite_timeout",n.Replaced="replaced",n.SignallingFailed="signalling_timeout",n.UserBusy="user_busy",n.Transfered="transferred",n.NewSession="new_session",n))(B||{}),Ms=(n=>(n.Ring="m.ring",n.Prompt="m.prompt",n.Room="m.room",n))(Ms||{}),ni=(n=>(n.Video="m.video",n.Voice="m.voice",n))(ni||{});class Mm{createPeerConnection(e,t,s){const i=new RTCPeerConnection({iceTransportPolicy:e?"relay":void 0,iceServers:t,iceCandidatePoolSize:s});return new Proxy(i,{get(r,o,a){o==="close"&&console.trace("calling peerConnection.close");const c=r[o];return typeof c=="function"?c.bind(r):c}})}prepareSenderForPurpose(e,t,s){s===rt.Screenshare&&this.getRidOfRTXCodecs(e,t)}getRidOfRTXCodecs(e,t){if(!RTCRtpReceiver.getCapabilities||!RTCRtpSender.getCapabilities)return;const s=RTCRtpReceiver.getCapabilities("video")?.codecs??[],r=[...RTCRtpSender.getCapabilities("video")?.codecs??[],...s];for(const a of r)if(a.mimeType==="video/rtx"){const c=r.indexOf(a);r.splice(c,1)}const o=e.getTransceivers().find(a=>a.sender===t);o&&(o.sender.track?.kind==="video"||o.receiver.track?.kind==="video")&&o.setCodecPreferences(r)}}var at=(n=>(n[n.Dark=0]="Dark",n[n.Light=1]="Light",n))(at||{});function Cm(n,e,t){let s=n.replaceAll("#ff00ff",e);if(s=s.replaceAll("#00ffff",t),n===s)throw new Error("svg-colorizer made no color replacements! The input svg should only contain colors #ff00ff (primary, case-sensitive) and #00ffff (secondary, case-sensitive).");return s}class Tm{constructor(e,t,s,i){this._platform=e,this._iconVariables=t,this._resolvedVariables=s,this._manifestLocation=i}async toVariables(){const{parsedStructure:e,promises:t}=await this._fetchAndParseIcons();return await Promise.all(t),this._produceColoredIconVariables(e)}async _fetchAndParseIcons(){const e=[],t={};for(const[s,i]of Object.entries(this._iconVariables)){const r=new URL(`https://${i}`),o=r.hostname,a=new URL(o,new URL(this._manifestLocation,window.location.origin)),c=this._platform.request(a,{method:"GET",format:"text",cache:!0}).response();e.push(c);const l=r.searchParams;t[s]={svg:c,primary:l.get("primary"),secondary:l.get("secondary")}}return{parsedStructure:t,promises:e}}async _produceColoredIconVariables(e){let t={};for(const[s,{svg:i,primary:r,secondary:o}]of Object.entries(e)){const{body:a}=await i;if(!r)throw new Error(`Primary color variable ${r} not in list of variables!`);const c=this._resolvedVariables[r],l=this._resolvedVariables[o],h=Cm(a,c,l),d=`url('data:image/svg+xml;utf8,${encodeURIComponent(h)}')`;t[s]=d}return t}}var ki={exports:{}},Am=function(n){var e={};function t(s){if(e[s])return e[s].exports;var i=e[s]={i:s,l:!1,exports:{}};return n[s].call(i.exports,i,i.exports,t),i.l=!0,i.exports}return t.m=n,t.c=e,t.d=function(s,i,r){t.o(s,i)||Object.defineProperty(s,i,{enumerable:!0,get:r})},t.r=function(s){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(s,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(s,"__esModule",{value:!0})},t.t=function(s,i){if(1&i&&(s=t(s)),8&i||4&i&&typeof s=="object"&&s&&s.__esModule)return s;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:s}),2&i&&typeof s!="string")for(var o in s)t.d(r,o,function(a){return s[a]}.bind(null,o));return r},t.n=function(s){var i=s&&s.__esModule?function(){return s.default}:function(){return s};return t.d(i,"a",i),i},t.o=function(s,i){return Object.prototype.hasOwnProperty.call(s,i)},t.p="",t(t.s=0)}([function(n,e,t){function s(l){let h,d;const u={light:function(){return!_()},dark:_,lighten:I,darken:w,saturate:E,desaturate:function(v=0){return E(v*=-1)},increaseContrast:function(v=0){return A(v*=-1)},decreaseContrast:A,active:function(){return A(.123)},highlight:function(){return A(.1)},selected:function(){return A(.066)},text:function(){return d=g()?i("#333333"):i("#FFFFFF"),u},shadow:function(){return d=g()?i("#000000"):i("#FFFFFF"),u},hex:function(){const v=d;return d=h,"#"+v.map(R=>parseInt(R+"",10).toString(16).padStart(2,"0")).join("")},rgb:function(){const v=d;return d=h,`rgb(${v.join()})`},rgba:function(v=1){const R=d;return d=h,`rgba(${R.join()}, ${v})`},setHex:p,setRgb:function(v=[0,0,0]){let[R,D,K]=v;return R=c(R,0,255),D=c(D,0,255),K=c(K,0,255),h=[R,D,K],d=[R,D,K],u}};function p(v="#000000"){return h=i(v),d=h,u}function _(){const[v,R,D]=d;return d=h,(299*v+587*R+114*D)/1e3<128}function g(){const[v,R,D]=d;return(299*v+587*R+114*D)/1e3>=128}function w(v=0){return I(v*=-1)}function I(v=0){let[R,D,K]=a(d);return K=c(K+v,0,1),d=r([R,D,K]),u}function E(v=0){let[R,D,K]=a(d);return D=c(D+v,0,1),d=r([R,D,K]),u}function A(v=0){return g()?w(v):I(v)}return p(l),u}function i(l){if(typeof l!="string")throw new TypeError("Expected a string");(l=l.replace(/^#/,"")).length===3&&(l=l[0]+l[0]+l[1]+l[1]+l[2]+l[2]);var h=parseInt(l,16);return[h>>16,h>>8&255,255&h]}function r(l){const[h,d,u]=l;let p,_,g;if(d===0)p=_=g=u;else{const w=function(A,v,R){return R<0&&(R+=1),R>1&&(R-=1),R<.16666666666666666?A+6*(v-A)*R:R<.5?v:R<.6666666666666666?A+(v-A)*(.6666666666666666-R)*6:A},I=u<.5?u*(1+d):u+d-u*d,E=2*u-I;p=c(w(E,I,h+1/3),0,1),_=c(w(E,I,h),0,1),g=c(w(E,I,h-1/3),0,1)}return[Math.round(255*p),Math.round(255*_),Math.round(255*g)]}t.r(e),t.d(e,"offColor",function(){return s}),t.d(e,"hexRgb",function(){return i}),t.d(e,"hslToRgb",function(){return r}),t.d(e,"color",function(){return o}),t.d(e,"rgbToHsl",function(){return a});const o=s;function a(l){const h=l[0]/255,d=l[1]/255,u=l[2]/255,p=Math.max(h,d,u),_=Math.min(h,d,u);let g=(p+_)/2,w=(p+_)/2;const I=(p+_)/2;if(p===_)g=w=0;else{const E=p-_;switch(w=I>.5?E/(2-p-_):E/(p+_),p){case h:g=(d-u)/E+(d<u?6:0);break;case d:g=(u-h)/E+2;break;case u:g=(h-d)/E+4}g/=6}return[g,w,I]}function c(l,h,d){return l=(l=l<=d?l:d)>=h?l:h}}]);ki.exports=Am;var $a=ki.exports;const Zi=ki.exports.offColor??$a.offColor;function no(n,e,t,s){const i=parseInt(t);switch(s&&(e==="darker"?e="lighter":e==="lighter"&&(e="darker")),e){case"darker":return Zi(n).darken(i/100).hex();case"lighter":return Zi(n).lighten(i/100).hex();case"alpha":return Zi(n).rgba(i/100)}}class xm{constructor(e,t,s){this._aliases={},this._derivedAliases=[],this._baseVariables=e,this._variablesToDerive=t,this._isDark=s}toVariables(){const e={};this._detectAliases();for(const t of this._variablesToDerive){const s=this._derive(t);s&&(e[t]=s)}for(const[t,s]of Object.entries(this._aliases))e[t]=this._baseVariables[s]??e[s];for(const t of this._derivedAliases){const s=this._deriveAlias(t,e);s&&(e[t]=s)}return e}_detectAliases(){const e=[];for(const t of this._variablesToDerive){const[s,i]=t.split("=");i?this._aliases[s]=i:e.push(t)}this._variablesToDerive=e}_derive(e){const t=/(.+)--(.+)-(.+)/,s=e.match(t);if(s){const[,i,r,o]=s,a=this._baseVariables[i];if(!a)if(this._aliases[i]){this._derivedAliases.push(e);return}else throw new Error(`Cannot find value for base variable "${i}"!`);return no(a,r,o,this._isDark)}}_deriveAlias(e,t){const s=/(.+)--(.+)-(.+)/,i=e.match(s);if(i){const[,r,o,a]=i,c=t[r];if(!c)throw new Error(`Cannot find value for alias "${r}" when trying to derive ${e}!`);return no(c,o,a,this._isDark)}}}ki.exports.offColor??$a.offColor;class Nm{constructor(e,t){this._themeMapping={},this._preferredColorScheme=t,this._platform=e}async parse(e,t,s,i){await i.wrap("RuntimeThemeParser.parse",async()=>{const{cssLocation:r,derivedVariables:o,icons:a}=this._getSourceData(t,s,i),c=e.name;if(!c)throw new Error("Theme name not found in manifest!");let l={},h={};for(const[d,u]of Object.entries(e.values?.variants))try{const p=`${e.id}-${d}`,{name:_,default:g,dark:w,variables:I}=u,E=new xm(I,o,w).toVariables();Object.assign(I,E);const A=await new Tm(this._platform,a,I,s).toVariables();Object.assign(I,E,A);const v=`${c} ${_}`;if(g){Object.assign(w?l:h,{variantName:_,id:p,cssLocation:r,variables:I});continue}this._themeMapping[v]={cssLocation:r,id:p,variables:I}}catch(p){console.error(p);continue}if(l.id&&h.id){const d=this._preferredColorScheme===at.Dark?l:h;this._themeMapping[c]={dark:l,light:h,default:d}}else{const d=l.id?l:h;this._themeMapping[`${c} ${d.variantName}`]={id:d.id,cssLocation:d.cssLocation}}})}_getSourceData(e,t,s){return s.wrap("getSourceData",()=>{const i=e.source?.["runtime-asset"];if(!i)throw new Error(`Run-time asset not found in source section for theme at ${t}`);const r=new URL(i,new URL(t,window.location.origin)).href,o=e.source?.["derived-variables"];if(!o)throw new Error(`Derived variables not found in source section for theme at ${t}`);const a=e.source?.icon;if(!a)throw new Error(`Icon mapping not found in source section for theme at ${t}`);return{cssLocation:r,derivedVariables:o,icons:a}})}get themeMapping(){return this._themeMapping}}class Dm{constructor(e){this._themeMapping={},this._preferredColorScheme=e}parse(e,t,s){s.wrap("BuiltThemeParser.parse",()=>{const i=e.source?.["built-assets"],r=e.name;if(!r)throw new Error(`Theme name not found in manifest at ${t}`);let o={},a={};for(let[c,l]of Object.entries(i)){try{l=new URL(l,new URL(t,window.location.origin)).href}catch{continue}const h=c.match(/.+-(.+)/)?.[1],d=e.values?.variants[h];if(!d)throw new Error(`Variant ${h} is missing in manifest at ${t}`);const{name:u,default:p,dark:_}=d,g=`${r} ${u}`;if(p){const w=_?o:a;w.variantName=u,w.id=c,w.cssLocation=l;continue}this._themeMapping[g]={cssLocation:l,id:c}}if(o.id&&a.id){const c=this._preferredColorScheme===at.Dark?o:a;this._themeMapping[r]={dark:o,light:a,default:c}}else{const c=o.id?o:a;this._themeMapping[`${r} ${c.variantName}`]={id:c.id,cssLocation:c.cssLocation}}})}get themeMapping(){return this._themeMapping}}class Vm{constructor(e){this._platform=e}async init(e,t){await this._platform.logger.wrapOrRun(t,"ThemeLoader.init",async s=>{let i=!0;const r=[],o=[],a=await Promise.all(e.map(d=>this._platform.request(d,{method:"GET",format:"json",cache:!0}).response())),c=new Nm(this._platform,this.preferredColorScheme),l=new Dm(this.preferredColorScheme),h=[];for(let d=0;d<a.length;++d){const u=a[d],{status:p,body:_}=u;if(!(p>=200&&p<=299)){console.error(`Failed to load manifest at ${e[d]}, status: ${p}`),s.log({l:"Manifest fetch failed",location:e[d],status:p},ye.Error),r.push(e[d]);continue}i=!1;try{if(_.extends){const g=a.findIndex(A=>"value"in A&&A.value.body.id===_.extends);if(g===-1)throw new Error(`Base manifest for derived theme at ${e[d]} not found!`);const{body:w}=a[g].value,I=e[g],E=c.parse(_,w,I,s);h.push(E)}else l.parse(_,e[d],s)}catch(g){console.error(g),o.push(g.message)}}if(await Promise.all(h),this._themeMapping={...l.themeMapping,...c.themeMapping},i)throw new Error(`All configured theme manifests failed to load, the following were tried: ${r.join(", ")}`);if(Object.keys(this._themeMapping).length===0&&o.length)throw new Error(`Failed to parse theme manifests, the following errors were encountered: ${o.join(", ")}`);this._addDefaultThemeToMapping(s),s.log({l:"Preferred colorscheme",scheme:this.preferredColorScheme===at.Dark?"dark":"light"}),s.log({l:"Result",themeMapping:this._themeMapping})})}async setTheme(e,t,s){await this._platform.logger.wrapOrRun(s,{l:"change theme",name:e,variant:t},async i=>{let r,o,a=this._themeMapping[e];if("id"in a)r=a.cssLocation,o=a.variables;else{if(!t)throw new Error("themeVariant is undefined!");r=a[t].cssLocation,o=a[t].variables}await this._platform.replaceStylesheet(r,i),o?(s?.log({l:"Derived Theme",variables:o}),this._injectCSSVariables(o)):this._removePreviousCSSVariables(),this._platform.settingsStorage.setString("theme-name",e),t?this._platform.settingsStorage.setString("theme-variant",t):this._platform.settingsStorage.remove("theme-variant")})}_injectCSSVariables(e){const t=document.documentElement;for(const[s,i]of Object.entries(e))t.style.setProperty(`--${s}`,i);this._injectedVariables=e}_removePreviousCSSVariables(){if(!this._injectedVariables)return;const e=document.documentElement;for(const t of Object.keys(this._injectedVariables))e.style.removeProperty(`--${t}`);this._injectedVariables=void 0}get themeMapping(){return this._themeMapping}async getActiveTheme(){let e=await this._platform.settingsStorage.getString("theme-name"),t=await this._platform.settingsStorage.getString("theme-variant");return(!e||!this._themeMapping[e])&&(e="Default"in this._themeMapping?"Default":Object.keys(this._themeMapping)[0],this._themeMapping[e][t]||(t="default"in this._themeMapping[e]?"default":void 0)),{themeName:e,themeVariant:t}}getDefaultTheme(){switch(this.preferredColorScheme){case at.Dark:return this._platform.config.defaultTheme?.dark;case at.Light:return this._platform.config.defaultTheme?.light}}_findThemeDetailsFromId(e){for(const[t,s]of Object.entries(this._themeMapping)){if("id"in s&&s.id===e)return{themeName:t,themeData:s};if("light"in s&&s.light?.id===e)return{themeName:t,themeData:s.light};if("dark"in s&&s.dark?.id===e)return{themeName:t,themeData:s.dark}}}_addDefaultThemeToMapping(e){e.wrap("addDefaultThemeToMapping",t=>{const s=this.getDefaultTheme();if(s){const i=this._findThemeDetailsFromId(s);if(i){this._themeMapping.Default={id:"default",cssLocation:i.themeData.cssLocation};const r=i.themeData.variables;r&&(this._themeMapping.Default.variables=r)}}t.log({l:"Default Theme",theme:s})})}get preferredColorScheme(){if(window.matchMedia("(prefers-color-scheme: dark)").matches)return at.Dark;if(window.matchMedia("(prefers-color-scheme: light)").matches)return at.Light}}var ja=(n=>(n[n.Minute=6e4]="Minute",n[n.Hours=36e5]="Hours",n[n.Day=864e5]="Day",n))(ja||{});function Pm(n){let e=0,t=0,s=0;n>=864e5&&(e=Math.floor(n/864e5),n-=e*864e5),n>=36e5&&(t=Math.floor(n/36e5),n-=t*36e5),n>=6e4&&(s=Math.floor(n/6e4),n-=s*6e4);const i=Math.floor(n/1e3);let r="";return e&&(r=`${e}d `),(t||e)&&(r+=`${t}h `),(s||t||e)&&(r+=`${s}m `),r+=`${i}s`,r}class Lm{constructor(e){this.clock=e,this.todayMidnight=new Date,this.todayMidnight.setHours(0,0,0,0),this.relativeDayFormatter=new Intl.RelativeTimeFormat(void 0,{numeric:"auto"}),this.weekdayFormatter=new Intl.DateTimeFormat(void 0,{weekday:"long"}),this.currentYearFormatter=new Intl.DateTimeFormat(void 0,{weekday:"long",month:"long",day:"numeric"}),this.otherYearFormatter=new Intl.DateTimeFormat(void 0,{weekday:"long",year:"numeric",month:"long",day:"numeric"}),this.timeFormatter=new Intl.DateTimeFormat(void 0,{hour:"numeric",minute:"2-digit"})}formatTime(e){return this.timeFormatter.format(e)}formatMachineReadableDate(e){return`${e.getFullYear()}-${e.getMonth()+1}-${e.getDate()}`}formatRelativeDate(e){let t=Math.floor((e.getTime()-this.todayMidnight.getTime())/ja.Day);return t>=-1&&t<=1?Om(this.relativeDayFormatter.format(t,"day")):t>-7&&t<0?this.weekdayFormatter.format(e):this.todayMidnight.getFullYear()===e.getFullYear()?this.currentYearFormatter.format(e):this.otherYearFormatter.format(e)}formatDuration(e){return Pm(e)}}function Om(n){return n.slice(0,1).toLocaleUpperCase()+n.slice(1)}const Um=3e4,L=tt("InitialSync","CatchupSync","Syncing","Stopped");function Fm(n){try{const e=n?.timeline?.events;return Array.isArray(e)&&e.length===0}catch{return!0}}class Bm{constructor({hsApi:e,session:t,storage:s,logger:i}){this._hsApi=e,this._logger=i,this._session=t,this._storage=s,this._currentRequest=null,this._status=new Te(L.Stopped),this._error=null}get status(){return this._status}get error(){return this._error}async start(){if(this._status.get()!==L.Stopped)return;this._error=null;let e=this._session.syncToken;e?this._status.set(L.CatchupSync):this._status.set(L.InitialSync),this._syncLoop(e)}async _syncLoop(e){for(;this._status.get()!==L.Stopped;){let t,s,i=this._status.get()===L.CatchupSync||this._status.get()===L.InitialSync;await this._logger.run("sync",async r=>{r.set("token",e),r.set("status",this._status.get());try{const o=this._status.get()===L.Syncing?Um:0,a=await this._syncRequest(e,o,r);e=a.syncToken,t=a.roomStates,s=a.sessionChanges,this._status.get()!==L.Syncing&&a.hadToDeviceMessages?this._status.set(L.CatchupSync):this._status.set(L.Syncing)}catch(o){if(o.name==="ConnectionError"&&o.isTimeout)return;this._error=o,o.name!=="AbortError"&&(r.error=o,r.logLevel=r.level.Fatal),r.set("stopping",!0),this._status.set(L.Stopped)}this._status.get()!==L.Stopped&&await r.wrap("afterSyncCompleted",o=>this._runAfterSyncCompleted(s,t,o))},this._logger.level.Info,(r,o)=>o.durationWithoutType("network")>=2e3||o.error||i?r.minLevel(o.level.Detail):r.minLevel(o.level.Info))}}async _runAfterSyncCompleted(e,t,s){const i=this._status.get()===L.CatchupSync,r=(async()=>{try{await s.wrap("session",a=>this._session.afterSyncCompleted(e,i,a))}catch{}})(),o=t.map(async a=>{try{await a.room.afterSyncCompleted(a.changes,s)}catch{}});await Promise.all(o.concat(r))}async _syncRequest(e,t,s){let{syncFilterId:i}=this._session;!await this._session.isGuest()&&typeof i!="string"&&(this._currentRequest=this._hsApi.createFilter(this._session.user.id,{room:{state:{lazy_load_members:!0}}},{log:s}),i=(await this._currentRequest.response()).filter_id);const o=t+80*1e3;this._currentRequest=this._hsApi.sync(e,i,t,{timeout:o,log:s});const a=await this._currentRequest.response(),c=!e,l=new Km,h=this._parseInvites(a.rooms),{roomStates:d,archivedRoomStates:u}=await this._parseRoomsResponse(a.rooms,h,c,s);try{l.lock=await s.wrap("obtainSyncLock",()=>this._session.obtainSyncLock(a)),await s.wrap("prepare",_=>this._prepareSync(l,d,a,_)),await s.wrap("afterPrepareSync",_=>Promise.all(d.map(g=>g.room.afterPrepareSync(g.preparation,_)))),await s.wrap("write",async _=>this._writeSync(l,h,d,u,a,i,c,_))}finally{l.dispose()}s.wrap("after",_=>this._afterSync(l,h,d,u,_));const p=a.to_device?.events;return{syncToken:a.next_batch,roomStates:d,sessionChanges:l.changes,hadToDeviceMessages:Array.isArray(p)&&p.length>0}}_openPrepareSyncTxn(){const e=this._storage.storeNames;return this._storage.readTxn([e.deviceIdentities,e.olmSessions,e.inboundGroupSessions,e.timelineFragments,e.timelineEvents])}async _prepareSync(e,t,s,i){const r=await this._openPrepareSyncTxn();e.preparation=await i.wrap("session",a=>this._session.prepareSync(s,e.lock,r,a));const o=e.preparation?.newKeysByRoom;if(o){const{hasOwnProperty:a}=Object.prototype;for(const c of o.keys())if(!(s.rooms?.join&&a.call(s.rooms.join,c))){let h=this._session.rooms.get(c);h&&t.push(new oo(h,!1,{},h.membership))}}await Promise.all(t.map(async a=>{const c=o?.get(a.room.id);a.preparation=await i.wrap("room",async l=>(a.isNewRoom&&await a.room.load(null,r,l),a.room.prepareSync(a.roomResponse,a.membership,c,r,l)),i.level.Detail)})),await r.complete()}async _writeSync(e,t,s,i,r,o,a,c){const l=await this._openSyncTxn();try{e.changes=await c.wrap("session",h=>this._session.writeSync(r,o,e.preparation,l,h)),await Promise.all(t.map(async h=>{h.changes=await c.wrap("invite",d=>h.invite.writeSync(h.membership,h.roomResponse,l,d))})),await Promise.all(s.map(async h=>{h.changes=await c.wrap("room",d=>h.room.writeSync(h.roomResponse,a,h.preparation,l,d))})),await Promise.all(i.map(async h=>{const d=h.roomState?.summaryChanges;h.changes=await c.wrap("archivedRoom",u=>h.archivedRoom.writeSync(d,h.roomResponse,h.membership,l,u))}))}catch(h){throw l.abort(c),l.getCause(h)}await l.complete(c)}_afterSync(e,t,s,i,r){r.wrap("session",o=>this._session.afterSync(e.changes,o),r.level.Detail);for(let o of i)r.wrap("archivedRoom",a=>{o.archivedRoom.afterSync(o.changes,a),o.archivedRoom.release()},r.level.Detail);for(let o of s)r.wrap("room",a=>o.room.afterSync(o.changes,a),r.level.Detail);for(let o of t)r.wrap("invite",a=>o.invite.afterSync(o.changes,a),r.level.Detail);this._session.applyRoomCollectionChangesAfterSync(t,s,i,r)}_openSyncTxn(){const e=this._storage.storeNames;return this._storage.readWriteTxn([e.session,e.roomSummary,e.archivedRoomSummary,e.invites,e.roomState,e.roomMembers,e.timelineEvents,e.timelineRelations,e.timelineFragments,e.pendingEvents,e.userIdentities,e.groupSessionDecryptions,e.deviceIdentities,e.outboundGroupSessions,e.operations,e.accountData,e.olmSessions,e.inboundGroupSessions,e.calls])}async _parseRoomsResponse(e,t,s,i){const r=[],o=[];if(e){const a=["join","leave"];for(const c of a){const l=e[c];if(l)for(const[h,d]of Object.entries(l)){if(s&&Fm(d))continue;const u=this._session.invites.get(h);u&&t.push(new ao(u,!1,null,c));const p=this._createRoomSyncState(h,d,c,s);p&&r.push(p);const _=await this._createArchivedRoomSyncState(h,p,d,c,s,i);_&&o.push(_)}}}return{roomStates:r,archivedRoomStates:o}}_createRoomSyncState(e,t,s,i){let r=!1,o=this._session.rooms.get(e);if(!o&&(s==="join"||i&&s==="leave")&&(o=this._session.createJoinedRoom(e),r=!0),o)return new oo(o,r,t,s)}async _createArchivedRoomSyncState(e,t,s,i,r,o){let a;if(t?.shouldAdd&&!r?a=this._session.createOrGetArchivedRoomForSync(e):i==="leave"&&(t?a=this._session.createOrGetArchivedRoomForSync(e):a=await this._session.loadArchivedRoom(e,o)),a)return new $m(a,t,s,i)}_parseInvites(e){const t=[];if(e?.invite)for(const[s,i]of Object.entries(e.invite)){let r=this._session.invites.get(s),o=!1;r||(r=this._session.createInvite(s),o=!0),t.push(new ao(r,o,i,"invite"))}return t}stop(){this._status.get()!==L.Stopped&&(this._status.set(L.Stopped),this._currentRequest&&(this._currentRequest.abort(),this._currentRequest=null))}}class Km{constructor(){this.lock=null,this.preparation=null,this.changes=null}dispose(){this.lock?.release()}}class oo{constructor(e,t,s,i){this.room=e,this.isNewRoom=t,this.roomResponse=s,this.membership=i,this.preparation=null,this.changes=null}get id(){return this.room.id}get shouldAdd(){return this.isNewRoom&&this.membership==="join"}get shouldRemove(){return!this.isNewRoom&&this.membership!=="join"}get summaryChanges(){return this.changes?.summaryChanges}}class $m{constructor(e,t,s,i,r){this.archivedRoom=e,this.roomState=t,this.roomResponse=s,this.membership=i,this.isInitialSync=r,this.changes=null}get id(){return this.archivedRoom.id}get shouldAdd(){return(this.roomState||this.isInitialSync)&&this.membership==="leave"}get shouldRemove(){return this.membership==="join"}}class ao{constructor(e,t,s,i){this.invite=e,this.isNewInvite=t,this.membership=i,this.roomResponse=s,this.changes=null}get id(){return this.invite.id}get shouldAdd(){return this.isNewInvite}get shouldRemove(){return this.membership!=="invite"}}function jm(n){return new SharedWorker("assets/sync-worker.88015204.js",{name:n})}var _r=(n=>(n.StartSync="StartSync",n.AddPendingEvent="AddPendingEvent",n))(_r||{}),gr=(n=>(n.StatusChanged="StatusChanged",n.SyncChanges="SyncChanges",n))(gr||{});class qm{constructor(e){this._requests=new Map,this._worker=e,this._worker instanceof SharedWorker?this._worker.port.onmessage=this.onMessage.bind(this):this._worker.onmessage=this.onMessage.bind(this)}async sendAndWaitForResponse(e){if(this._requests.has(e.id))throw`A request with id ${e.id} is already ongoing`;let t;const s=new Promise(i=>{t=i});return this._requests.set(e.id,{resolve:t}),this.send(e),s}send(e){this._worker instanceof SharedWorker?this._worker.port.postMessage(e):this._worker.postMessage(e)}async onMessage(e){const t=e.data;if(!t?.request)return;const s=t.request,i=this._requests.get(s.id);!i||(this._requests.delete(s.id),await i.resolve(t))}}class Wm{constructor(e){this._listeners=new Map,this._channel=new BroadcastChannel(e),this._channel.onmessage=this.onMessage.bind(this)}setListener(e,t){if(this._listeners.has(e))throw`A listener for events of type ${e} is already set`;this._listeners.set(e,t)}async onMessage(e){const t=e.data,s=this._listeners.get(t.type);!s||await s(t)}}function co(){return Hm()}function Hm(){return Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString()}const fr=Number.MAX_SAFE_INTEGER;class qa{constructor(e){this._fragmentIdComparer=e}compare(e){return this.fragmentId===e.fragmentId?this.entryIndex-e.entryIndex:this.fragmentId===fr?1:e.fragmentId===fr?-1:this._fragmentIdComparer.compare(this.fragmentId,e.fragmentId)}asEventKey(){return new H(this.fragmentId,this.entryIndex)}}const zm="m.reaction",lt="m.annotation";function Gm(n,e){return{"m.relates_to":{event_id:n,key:e,rel_type:lt}}}function Hr(n){return n.event_id||n["m.in_reply_to"]?.event_id}function Wa(n,e){n.event_id!==void 0?n.event_id=e:n["m.in_reply_to"]&&(n["m.in_reply_to"].event_id=e)}function Jm(n){if(n.type===Pe)return n.redacts;{const e=nt(n);if(e)return Hr(e)}return null}function ut(n){return n?.["m.relates_to"]}function nt(n){return ut(n.content)}class Qm{constructor(){this._entries=[]}get firstTimestamp(){return this._entries.reduce((e,t)=>t.isRedaction?e:Math.min(t.timestamp,e),Number.MAX_SAFE_INTEGER)}get annotationEntry(){return this._entries.find(e=>!e.isRedaction)}get redactionEntry(){return this._entries.find(e=>e.isRedaction)}get count(){return this._entries.reduce((e,t)=>e+(t.isRedaction?-1:1),0)}add(e){this._entries.push(e)}remove(e){const t=this._entries.indexOf(e);return t===-1?!1:(this._entries.splice(t,1),!0)}get willAnnotate(){const e=this._entries.reduce((t,s)=>!t||s.pendingEvent.queueIndex>t.pendingEvent.queueIndex?s:t,null);return e?!e.isRedaction:!1}get isEmpty(){return this._entries.length===0}}function lo(n){return n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function Ym(n){switch(n){case"m.file":return"sent a file.";case"m.image":return"sent an image.";case"m.video":return"sent a video.";case"m.audio":return"sent an audio file."}return null}function Xm(n){return n==="m.emote"?"* ":""}function Zm(n,e,t,s){return{msgtype:e,body:t,format:"org.matrix.custom.html",formatted_body:s,"m.relates_to":{"m.in_reply_to":{event_id:n}}}}function ep(n,e,t){const s=Ym(n.content.msgtype),i=Xm(n.content.msgtype),r=n.sender,o=n.displayName||r,a=s||n.content.formatted_body||n.content.body&&lo(n.content.body)||"",c=`<mx-reply><blockquote>In reply to ${i}<a href="https://matrix.to/#/${r}">${o}</a><br />${a}</blockquote></mx-reply>`,h=(s||n.content.body||"").split(`
`);h[0]=`> ${i}<${r}> ${h[0]}`;const u=h.join(`
> `)+`

`+t,p=c+lo(t);return Zm(n.id,e,u,p)}class Ha extends qa{constructor(e){super(e),this._pendingRedactions=null,this._pendingAnnotations=null,this._contextEntry=null,this._contextForEntries=null}get isReply(){return!!this.relation?.["m.in_reply_to"]}get isRedacting(){return!!this._pendingRedactions}get isRedacted(){return this.isRedacting}get isRedaction(){return this.eventType===Pe}get redactionReason(){return this._pendingRedactions?this._pendingRedactions[0].content?.reason:null}setContextEntry(e){this._contextEntry=e,e._setAsContextOf(this)}_setAsContextOf(e){this._contextForEntries||(this._contextForEntries=[]),this._contextForEntries.push(e)}get contextForEntries(){return this._contextForEntries}get contextEntry(){return this._contextEntry}addLocalRelation(e){if(e.eventType===Pe&&e.isRelatedToId(this.id)){if(this._pendingRedactions||(this._pendingRedactions=[]),this._pendingRedactions.push(e),this._pendingRedactions.length===1)return"isRedacted"}else{const t=e.redactingEntry||e;if(t.isRelatedToId(this.id)&&t.relation.rel_type===lt&&this._addPendingAnnotation(e))return"pendingAnnotations"}}removeLocalRelation(e){if(e.eventType===Pe&&e.isRelatedToId(this.id)&&this._pendingRedactions){const t=this._pendingRedactions.length;if(this._pendingRedactions=this._pendingRedactions.filter(s=>s!==e),this._pendingRedactions.length===0&&(this._pendingRedactions=null,t!==0))return"isRedacted"}else{const t=e.redactingEntry||e;if(t.isRelatedToId(this.id)&&t.relation?.rel_type===lt&&this._pendingAnnotations&&this._removePendingAnnotation(e))return"pendingAnnotations"}}_addPendingAnnotation(e){this._pendingAnnotations||(this._pendingAnnotations=new Map);const{key:t}=(e.redactingEntry||e).relation;if(t){let s=this._pendingAnnotations.get(t);return s||(s=new Qm,this._pendingAnnotations.set(t,s)),s.add(e),!0}return!1}_removePendingAnnotation(e){const{key:t}=(e.redactingEntry||e).relation;if(t){let s=this._pendingAnnotations.get(t);return s.remove(e)&&s.isEmpty&&this._pendingAnnotations.delete(t),this._pendingAnnotations.size===0&&(this._pendingAnnotations=null),!0}return!1}async abortPendingRedaction(){if(this._pendingRedactions)for(const e of this._pendingRedactions)await e.pendingEvent.abort()}get pendingRedaction(){return this._pendingRedactions?this._pendingRedactions[0]:null}annotate(e){return Gm(this.id,e)}createReplyContent(e,t){return ep(this,e,t)}isRelatedToId(e){return e&&this.relatedEventId===e}haveAnnotation(e){const t=this.annotations?.[e]?.me||!1,s=this.pendingAnnotations?.get(e),i=s?.willAnnotate||!1;return t&&(!s||i)||!t&&i}get relation(){return ut(this.content)}get pendingAnnotations(){return this._pendingAnnotations}get annotations(){return null}}class tp extends Ha{constructor({pendingEvent:e,member:t,clock:s,redactingEntry:i}){super(null),this._pendingEvent=e,this._member=t,this._timestamp=s.now()-(100-e.queueIndex),this._redactingEntry=i}get fragmentId(){return fr}get entryIndex(){return this._pendingEvent.queueIndex}get content(){return this._pendingEvent.content}get event(){return null}get eventType(){return this._pendingEvent.eventType}get stateKey(){return null}get sender(){return this._member?.userId}get displayName(){return this._member?.name}get avatarUrl(){return this._member?.avatarUrl}get timestamp(){return this._timestamp}get isPending(){return!0}get id(){return this._pendingEvent.txnId}get pendingEvent(){return this._pendingEvent}notifyUpdate(){}isRelatedToId(e){return e&&e===this._pendingEvent.relatedTxnId?!0:super.isRelatedToId(e)}get relatedEventId(){return this._pendingEvent.relatedEventId}get redactingEntry(){return this._redactingEntry}get contextEventId(){return this.isReply?this._pendingEvent.relatedEventId??this._pendingEvent.relatedTxnId:null}}const F=tt("Waiting","EncryptingAttachments","UploadingAttachments","Encrypting","Sending","Sent","Error"),ho=["m.relates_to"];class sp{constructor({data:e,remove:t,emitUpdate:s,attachments:i}){this._data=e,this._attachments=i,this._emitUpdate=s,this._removeFromQueueCallback=t,this._aborted=!1,this._status=F.Waiting,this._sendRequest=null,this._attachmentsTotalBytes=0,this._attachments&&(this._attachmentsTotalBytes=Object.values(this._attachments).reduce((r,o)=>r+o.size,0))}get roomId(){return this._data.roomId}get queueIndex(){return this._data.queueIndex}get eventType(){return this._data.eventType}get txnId(){return this._data.txnId}get remoteId(){return this._data.remoteId}get content(){return this._data.content}get relatedTxnId(){return this._data.relatedTxnId}get relatedEventId(){const e=ut(this.content);return e?Hr(e):this._data.relatedEventId}setRelatedEventId(e){const t=ut(this.content);t?Wa(t,e):this._data.relatedEventId=e}get data(){return this._data}getAttachment(e){return this._attachments&&this._attachments[e]}get needsSending(){return!this.remoteId&&!this.aborted}get needsEncryption(){return this._data.needsEncryption&&!this.aborted}get needsUpload(){return this._data.needsUpload&&!this.aborted}get isMissingAttachments(){return this.needsUpload&&!this._attachments}setEncrypting(){this._status=F.Encrypting,this._emitUpdate("status")}get contentForEncryption(){const e=Object.assign({},this._data.content);for(const t of ho)delete e[t];return e}_preserveContentFields(e){const t=this._data.content;for(const s of ho)t[s]!==void 0&&(e[s]=t[s])}setEncrypted(e,t){this._preserveContentFields(t),this._data.encryptedEventType=e,this._data.encryptedContent=t,this._data.needsEncryption=!1}setError(e){this._status=F.Error,this._error=e,this._emitUpdate("status")}setWaiting(){this._status=F.Waiting,this._emitUpdate("status")}get status(){return this._status}get error(){return this._error}get hasStartedSending(){return this._status===F.Sending||this._status===F.Sent}get attachmentsTotalBytes(){return this._attachmentsTotalBytes}get attachmentsSentBytes(){return this._attachments&&Object.values(this._attachments).reduce((e,t)=>e+t.sentBytes,0)}async uploadAttachments(e,t){if(!this.needsUpload)return;if(!this._attachments)throw new Error("attachments missing");if(this.needsEncryption){this._status=F.EncryptingAttachments,this._emitUpdate("status");for(const i of Object.values(this._attachments))if(await t.wrap("encrypt",()=>(t.set("size",i.size),i.encrypt())),this.aborted)throw new Ce}this._status=F.UploadingAttachments,this._emitUpdate("status");const s=Object.entries(this._attachments);s.sort(([,i],[,r])=>i.size-r.size);for(const[i,r]of s)await t.wrap("upload",o=>(o.set("size",r.size),r.upload(e,()=>{this._emitUpdate("attachmentsSentBytes")},o))),r.applyToContent(i,this.content);this._data.needsUpload=!1}async abort(){if(!this._aborted){if(this._aborted=!0,this._attachments)for(const e of Object.values(this._attachments))e.abort();this._sendRequest?.abort(),await this._removeFromQueueCallback()}}get aborted(){return this._aborted}async send(e,t){this._status=F.Sending,this._emitUpdate("status");const s=this._data.encryptedEventType||this._data.eventType,i=this._data.encryptedContent||this._data.content;s===Pe?this._sendRequest=e.redact(this.roomId,this._data.relatedEventId,this.txnId,i,{log:t}):this._sendRequest=e.send(this.roomId,s,this.txnId,i,{log:t});const r=await this._sendRequest.response();this._sendRequest=null,this._data.remoteId=r.event_id,t.set("id",this._data.remoteId),this._status=F.Sent,this._emitUpdate("status")}dispose(){if(this._attachments)for(const e of Object.values(this._attachments))e.dispose()}}class _e extends Ha{constructor(e,t){super(t),this._eventEntry=e,this._decryptionError=null,this._decryptionResult=null}clone(){const e=new _e(this._eventEntry,this._fragmentIdComparer);return e.updateFrom(this),e}updateFrom(e){e._decryptionResult&&(this._decryptionResult=e._decryptionResult),e._decryptionError&&(this._decryptionError=e._decryptionError),this._contextForEntries=e.contextForEntries,this._contextEntry=e.contextEntry}get data(){return this._eventEntry}get event(){return this._eventEntry.event}get fragmentId(){return this._eventEntry.fragmentId}get entryIndex(){return this._eventEntry.eventIndex}get content(){return this._decryptionResult?.event?.content||this._eventEntry.event.content}get prevContent(){return hr(this._eventEntry.event)}get eventType(){return this._decryptionResult?.event?.type||this._eventEntry.event.type}get stateKey(){return this._eventEntry.event.state_key}get sender(){return this._eventEntry.event.sender}get displayName(){return this._eventEntry.displayName}get avatarUrl(){return this._eventEntry.avatarUrl}get timestamp(){return this._eventEntry.event.origin_server_ts}get id(){return this._eventEntry.event.event_id}setDecryptionResult(e){this._decryptionResult=e}get isEncrypted(){return this._eventEntry.event.type==="m.room.encrypted"}get isDecrypted(){return!!this._decryptionResult?.event}get isVerified(){return this.isEncrypted&&this._decryptionResult?.isVerified}get isUnverified(){return this.isEncrypted&&this._decryptionResult?.isUnverified}setDecryptionError(e){this._decryptionError=e}get decryptionError(){return this._decryptionError}get relatedEventId(){return Jm(this.event)}get isRedacted(){return super.isRedacted||dr(this._eventEntry.event)}get redactionReason(){const e=this._eventEntry.event.unsigned?.redacted_because;return e?e.content?.reason:super.redactionReason}get annotations(){return this._eventEntry.annotations}get relation(){const e=this._eventEntry.event.content;return e&&ut(e)||ut(this.content)}get contextEventId(){return this.isReply?this.relatedEventId:null}}function ip(n){return{changes:n}}function rp(n,e){const{changes:t}=e,{roomResponse:s,newEntries:i,updatedEntries:r,memberChanges:o,newLiveKey:a,removedPendingEvents:c}=t,l=i.map(w=>new _e(w,n._fragmentIdComparer)),h=r.map(w=>new _e(w,n._fragmentIdComparer)),d=new Map;for(let[w,I]of o)d.set(w,new Ur(new P(I.member),I.previousMembership));const u=new H(a.fragmentId,a.eventIndex),p=t.summaryChanges,_=t.heroChanges,g=t.powerLevelsEvent;return{room:n,changes:{roomResponse:s,newEntries:l,updatedEntries:h,memberChanges:d,newLiveKey:u,summaryChanges:p,heroChanges:_,powerLevelsEvent:g,removedPendingEvents:c}}}class np{constructor(e){this._status=new Te(L.Stopped),this._error=null;const{session:t,logger:s}=e;this._session=t,this._logger=s;const i=this._session.sessionId;if(!i)throw"sessionId is required for starting the sync worker";const r=`sync-${i}`;this._workerProxy=new qm(jm(r)),this._eventBus=new Wm(r),this._eventBus.setListener(gr.StatusChanged,this.onStatusChanged.bind(this)),this._eventBus.setListener(gr.SyncChanges,this.onSyncChanges.bind(this)),this._session.sendQueuePool.on("pendingEvent",this.onPendingEvent.bind(this))}get status(){return this._status}get error(){return this._error}async start(){const e={id:co(),type:_r.StartSync,data:{sessionId:this._session.sessionId,deviceId:this._session.deviceId,userId:this._session.userId,homeserver:this._session.homeserver,accessToken:this._session.accessToken}},t=await this._workerProxy.sendAndWaitForResponse(e);if(this._status.set(t.data.syncStatus),t?.error)throw t.error}stop(){}async onPendingEvent(e){const{data:t}=e,s={id:co(),type:_r.AddPendingEvent,data:{pendingEvent:t}},i=await this._workerProxy.sendAndWaitForResponse(s);if(i?.error)throw i.error}onStatusChanged(e){this._status.set(e.data.newValue)}async onSyncChanges(e){const t=e.data.session,s=e.data.rooms;if(e.data.syncStatus===L.InitialSync){location.reload();return}await this._logger.run("sync changes",async r=>{await r.wrap("session",o=>{o.log({l:"changes",...t});const a=ip(t);this._session.afterSync(a.changes,o)}),await r.wrap("rooms",o=>{const a=this._session.rooms;for(const c of s){const{roomId:l,changes:h}=c;o.log({l,...h});const d=a.get(l);if(!d)continue;const u=rp(d,c);d.sendQueue.removePendingEvents(u.changes.removedPendingEvents),u.changes.removedPendingEvents=[],d.afterSync(u.changes,o)}})})}}class op{constructor(e){const{logger:t,runSyncInWorker:s}=e;this._logger=t,this._runSyncInWorker=s}make(e){const{hsApi:t,storage:s,session:i}=e;return this._runSyncInWorker?new np({session:i,logger:this._logger}):new Bm({logger:this._logger,hsApi:t,storage:s,session:i})}}function uo(n){return new Promise(function(e,t){var s=document.createElement("script");s.setAttribute("src",n),s.onload=e,s.onerror=t,document.body.appendChild(s)})}async function ap(n){return window.msCrypto&&!window.crypto&&(window.crypto=window.msCrypto),n?(window.WebAssembly?(await uo(n.wasmBundle),await window.Olm.init({locateFile:()=>n.wasm})):(await uo(n.legacyBundle),await window.Olm.init()),window.Olm):null}function cp(n){return n.startsWith("/")?n:new URL(n,document.location.href).pathname}async function lp(n){const e=new Uu(n.worker,4);return await e.init(),await e.sendAll({type:"load_olm",path:cp(n.olm.legacyBundle)}),new sd(e)}function hp(n){if(!window.visualViewport)return;const e=()=>{const t=n.querySelector(".SessionView");if(!t)return;const s=n.querySelector(".bottom-aligned-scroll");let i,r,o;s&&(i=s.scrollTop,r=s.offsetHeight);const a=t.offsetTop+t.offsetHeight-window.visualViewport.height;n.style.setProperty("--ios-viewport-height",window.visualViewport.height.toString()+"px"),n.style.setProperty("--ios-viewport-top",a.toString()+"px"),s&&(o=s.offsetHeight,s.scrollTop=i+r-o)};return window.visualViewport.addEventListener("resize",e),()=>{window.visualViewport.removeEventListener("resize",e)}}class dp{constructor({container:e,assetPaths:t,config:s,configURL:i,logger:r,options:o=null,cryptoExtras:a=null}){this._container=e,this._assetPaths=t,this._config=s,this._configURL=i,this.settingsStorage=new Wo("hydrogen_setting_v1_"),this.clock=new Ru,this.encoding=new td,this.random=Math.random,this.logger=r??this._createLogger(o?.development),this.history=new Ua,this.onlineStatus=new Eu,this.timeFormatter=new Lm,this._serviceWorkerHandler=null,t.serviceWorker&&"serviceWorker"in navigator&&(this._serviceWorkerHandler=new Jn),this.notificationService=void 0,this._assetPaths.olm&&(this.crypto=new Vu(a)),this.sessionInfoStorage=new qo("hydrogen_sessions_v1"),this.estimateStorageUsage=Pu,typeof fetch=="function"?this.request=Wl(this.clock.createTimeout,this._serviceWorkerHandler):this.request=Qo;const c=!!window.MSInputMethodContext&&!!document.documentMode;this.isIE11=c;const l=/iPad|iPhone|iPod/.test(navigator.platform)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1&&!window.MSStream;this.isIOS=l,this._disposables=new Ri,this._olmPromise=void 0,this._workerPromise=void 0,this.mediaDevices=new km(navigator.mediaDevices),this.webRTC=new Mm,this._themeLoader=new Vm(this),this._runSyncInWorker=void 0}get runSyncInWorker(){return this._runSyncInWorker}async init(){try{this._serviceWorkerHandler instanceof Jn&&await this._serviceWorkerHandler.registerAndStart(this._assetPaths.serviceWorker),await this.logger.run("Platform init",async e=>{if(!this._config){if(!this._configURL)throw new Error("Neither config nor configURL was provided!");const{status:t,body:s}=await this.request(this._configURL,{method:"GET",format:"json",cache:!0}).response();if(t===404)throw new Error(`Could not find ${this._configURL}. Did you copy over config.sample.json?`);if(t>=400)throw new Error(`Got status ${t} while trying to fetch ${this._configURL}`);this._config=s}if(this.notificationService=new ku(this._serviceWorkerHandler,this._config.push),this._themeLoader){const t=this.config.themeManifests;await this._themeLoader?.init(t,e);const{themeName:s,themeVariant:i}=await this._themeLoader.getActiveTheme();e.log({l:"Active theme",name:s,variant:i}),await this._themeLoader.setTheme(s,i,e)}this.features=await kt.load(this.settingsStorage),this._runSyncInWorker=this.features.sameSessionInMultipleTabs,typeof SharedWorker>"u"&&(this._runSyncInWorker=!1),window.WebAssembly||(this._runSyncInWorker=!1),this.syncFactory=new op({logger:this.logger,runSyncInWorker:this.runSyncInWorker}),this.storageFactory=new Hh(this._serviceWorkerHandler,this._runSyncInWorker)})}catch(e){throw this._container.innerText=e.message,e}}_createLogger(e){const t=new ld({platform:this}),s=r=>(r.e?.stack&&(r.e.stack=r.e.stack.replace(/\/\?loginToken=(.+)/,"?loginToken=<snip>")),r),i=new id({name:"hydrogen_logs",platform:this,serializedTransformer:s});return t.addReporter(i),e&&t.addReporter(new nd),t}get updateService(){return this._serviceWorkerHandler}loadOlm(){return this._olmPromise||(this._olmPromise=ap(this._assetPaths.olm)),this._olmPromise}get config(){return this._config}async loadOlmWorker(){if(!window.WebAssembly)return this._workerPromise||(this._workerPromise=lp(this._assetPaths)),this._workerPromise}createAndMountRootView(e){if(this.isIE11&&(this._container.className+=" legacy"),this.isIOS){this._container.className+=" ios";const s=hp(this._container);s&&this._disposables.track(s)}this._container.addEventListener("error",Hn,!0),this._disposables.track(()=>this._container.removeEventListener("error",Hn,!0)),window.__hydrogenViewModel=e;const t=new vu(e);this._container.appendChild(t.mount())}setNavigation(e){this._serviceWorkerHandler?.setNavigation(e)}createBlob(e,t){return xt.fromBuffer(e,t)}saveFileAs(e,t){navigator.msSaveBlob?navigator.msSaveBlob(e.nativeBlob,t):$u(this._container,this._assetPaths.downloadSandbox,e,t,this.isIOS)}restart(){document.location.reload()}openFile(e=null){const t=document.createElement("input");t.setAttribute("type","file"),t.className="hidden",e&&t.setAttribute("accept",e);const s=new Promise(i=>{const r=()=>{t.removeEventListener("change",r,!0);const o=t.files[0];this._container.removeChild(t),o?i({name:o.name,blob:xt.fromBlob(o)}):i()};t.addEventListener("change",r,!0)});return this._container.appendChild(t),t.click(),s}openUrl(e){location.href=e}parseHTML(e){return bm(e)}async loadImage(e){return Es.fromBlob(e)}async loadVideo(e){return Wr.fromBlob(e)}hasReadPixelPermission(){return Bu()}get devicePixelRatio(){return window.devicePixelRatio||1}get version(){return"0.9.1"}get themeLoader(){return this._themeLoader}async replaceStylesheet(e,t){const s=await this.logger.wrapOrRun(t,{l:"replaceStylesheet",location:e},async i=>{let r;const o=document.querySelector("head");document.querySelectorAll(".theme").forEach(l=>l.remove());const a=document.createElement("link");a.href=e,a.rel="stylesheet",a.type="text/css",a.className="theme";const c=new Promise(l=>{a.onerror=()=>{r=new Error(`Failed to load stylesheet from ${e}`),i.catch(r),l()},a.onload=()=>{l()}});return o.appendChild(a),await c,r});if(s)throw s}get description(){return"web-"+(navigator.userAgent??"<unknown>")}dispose(){this._disposables.dispose()}}class up extends Ua{constructor(e){super(),this._instanceId=e}get(){return window.location.search.includes("loginToken")?window.location.search:window.location.hash}onSubscribeFirst(){this._lastSessionHash=window.localStorage?.getItem(this.urlHashKey),window.addEventListener("hashchange",this)}_storeHash(e){window.localStorage?.setItem(this.urlHashKey,e)}replaceUrlSilently(e){super.replaceUrlSilently(e)}getLastSessionUrl(){return super.getLastSessionUrl()}get urlHashKey(){return`chatrix_${this._instanceId}_last_url_hash`}}class mp{constructor(){this._waitingForReply=new Map,this._messageIdCounter=0,this._navigation=null,this._registration=null,this._registrationPromise=null,this._currentController=null,this.haltRequests=!1}get version(){return"0.9.1"}get buildHash(){return "3565504203"}setNavigation(e){this._navigation=e}registerAndStart(e){this._registrationPromise=(async()=>{navigator.serviceWorker.addEventListener("message",this),navigator.serviceWorker.addEventListener("controllerchange",this),this._registration=await navigator.serviceWorker.register(e),await navigator.serviceWorker.ready,this._currentController=navigator.serviceWorker.controller,this._registration.addEventListener("updatefound",this),this._registrationPromise=null,this._registration.waiting&&this._registration.active&&await this._proposeUpdate(),console.log("Service Worker registered")})()}_onMessage(e){const{data:t}=e,s=t.replyTo;if(s){const i=this._waitingForReply.get(s);i&&(this._waitingForReply.delete(s),i(t.payload))}if(t.type==="hasSessionOpen"){const i=this._navigation.observe("session").get()===t.payload.sessionId;e.source.postMessage({replyTo:t.id,payload:i})}else if(t.type==="hasRoomOpen"){const i=this._navigation.observe("session").get()===t.payload.sessionId,r=this._navigation.observe("room").get()===t.payload.roomId;e.source.postMessage({replyTo:t.id,payload:i&&r})}else if(t.type==="closeSession"){const{sessionId:i}=t.payload;this._closeSessionIfNeeded(i).finally(()=>{e.source.postMessage({replyTo:t.id})})}else t.type==="haltRequests"?(this.haltRequests=!0,e.source.postMessage({replyTo:t.id})):t.type==="openRoom"&&this._navigation.push("room",t.payload.roomId)}_closeSessionIfNeeded(e){const t=this._navigation?.path.get("session");return e&&t?.value===e?new Promise(s=>{const i=this._navigation.pathObservable.subscribe(r=>{const o=r.get("session");(!o||o.value!==e)&&(i(),s())});this._navigation.push("session")}):Promise.resolve()}async _proposeUpdate(){document.hidden||!await this.confirm()||(console.log("Applying update"),await this._sendAndWaitForReply("haltRequests"),await this._send("skipWaiting",null,this._registration.waiting))}async confirm(){const e=document.getElementsByClassName("chatrix-update-confirm").item(0);return!e||typeof e.showModal!="function"?Promise.reject():(e.showModal(),new Promise(function(t){e.addEventListener("close",()=>{t(e.returnValue==="update")})}))}handleEvent(e){switch(e.type){case"message":this._onMessage(e);break;case"updatefound":this._registration.installing.addEventListener("statechange",this);break;case"statechange":{e.target.state==="installed"&&(this._proposeUpdate(),e.target.removeEventListener("statechange",this));break}case"controllerchange":this._currentController?document.location.reload():this._currentController=navigator.serviceWorker.controller;break}}async _send(e,t,s=void 0){this._registrationPromise&&await this._registrationPromise,s||(s=this._registration.active),s.postMessage({type:e,payload:t})}async _sendAndWaitForReply(e,t,s=void 0){this._registrationPromise&&await this._registrationPromise,s||(s=this._registration.active),this._messageIdCounter+=1;const i=this._messageIdCounter,r=new Promise(o=>{this._waitingForReply.set(i,o)});return s.postMessage({type:e,id:i,payload:t}),await r}async checkForUpdate(){this._registrationPromise&&await this._registrationPromise,this._registration.update()}async preventConcurrentSessionAccess(e){return this._sendAndWaitForReply("closeSession",{sessionId:e})}async getRegistration(){return this._registrationPromise&&await this._registrationPromise,this._registration}}class pp extends dp{constructor(e){const t=structuredClone(e.assetPaths);delete e.assetPaths?.serviceWorker,super(e);let s;e.config.enableServiceWorker&&t.serviceWorker&&"serviceWorker"in navigator&&(s=new mp,s.registerAndStart(t.serviceWorker)),super._serviceWorkerHandler=s,super.settingsStorage=new Wo("chatrix_setting_v1_"),super.sessionInfoStorage=new qo("chatrix_sessions_v1"),super.history=new up(this.config.instanceId)}get history(){return super.history}set history(e){super.history=e}setNavigation(e){super.setNavigation(e)}async init(){return super.init()}get config(){return super.config}get reconnector(){return super.reconnector}get settingsStorage(){return super.settingsStorage}set settingsStorage(e){super.settingsStorage=e}get sessionInfoStorage(){return super.sessionInfoStorage}set sessionInfoStorage(e){super.sessionInfoStorage=e}get request(){return super.request}set request(e){super.request=e}openUrl(e){console.log(`Redirecting to ${e}`),parent.location.href=e}}class _p extends Rl{constructor(e,t,s,i){super(e,t,s,i),this._hist=e}createSSOCallbackURL(){return parent.location.href}normalizeUrl(){let e=this.removeLoginToken(window.location.pathname,window.location.search,window.location.hash);this._hist.replaceUrlSilently(e);let t=this.removeLoginToken(parent.location.pathname,parent.location.search,parent.location.hash);parent.history.replaceState(null,"",t)}removeLoginToken(e,t,s){const i=new URLSearchParams(t);i.delete("loginToken");let r=e;return i.toString()!==""&&(r+="?"+i.toString()),r+s}}class Nt{constructor(){this._handlersByName={}}emit(e,t){const s=this._handlersByName[e];s&&s.forEach(i=>i(t))}disposableOn(e,t){return this.on(e,t),()=>{this.off(e,t)}}on(e,t){let s=this._handlersByName[e];s||(this.onFirstSubscriptionAdded(e),this._handlersByName[e]=s=new Set),s.add(t)}off(e,t){const s=this._handlersByName[e];s&&(s.delete(t),s.size===0&&(delete this._handlersByName[e],this.onLastSubscriptionRemoved(e)))}onFirstSubscriptionAdded(e){}onLastSubscriptionRemoved(e){}}class k extends Nt{constructor(e){super(),this._isDisposed=!1,this._options=e}childOptions(e){return Object.assign({},this._options,e)}get options(){return this._options}getOption(e){return this._options[e]}observeNavigation(e,t){const i=this.navigation.observe(e).subscribe(r=>{t(r,e)});this.track(i)}track(e){return this.disposables||(this.disposables=new Ri),this.disposables.track(e)}untrack(e){if(this.disposables)return this.disposables.untrack(e)}dispose(){this.disposables&&this.disposables.dispose(),this._isDisposed=!0}get isDisposed(){return this._isDisposed}disposeTracked(e){if(this.disposables)return this.disposables.disposeTracked(e)}i18n(e,...t){let s="";for(let i=0;i<e.length;++i)s=s+e[i],i<t.length&&(s=s+t[i]);return s}emitChange(e){this._options.emitChange?this._options.emitChange(e):this.emit("change",e)}get platform(){return this._options.platform}get clock(){return this._options.platform.clock}get logger(){return this.platform.logger}get urlRouter(){return this._options.urlRouter}get features(){return this._options.features}get navigation(){return this._options.navigation}get timeFormatter(){return this._options.platform.timeFormatter}}function mo(n){!n.startsWith("http://")&&!n.startsWith("https://")&&(n="https://"+n);try{return new URL(n).origin}catch{return""}}async function gp(n,e){const t={format:"json",timeout:3e4,method:"GET"};try{const s=`${n}/.well-known/matrix/client`;return await e(s,t).response()}catch(s){if(s.name==="ConnectionError")return null;throw s}}async function za(n,e){n=mo(n);const t=await gp(n,e);if(t&&t.status===200){const{body:s}=t,i=s["m.homeserver"]?.base_url;typeof i=="string"&&(n=mo(i))}return n}class Ga{constructor(e){this._abortable=void 0;const t=i=>(this._abortable=i,i);this._progress=new Te(void 0);const s=i=>{this._progress.set(i)};this.result=e(t,s)}get progress(){return this._progress}abort(){this._abortable?.abort(),this._abortable=void 0}}function Ja(n){return Object.entries(n||{}).filter(([,e])=>e!==void 0).map(([e,t])=>(typeof t=="object"&&(t=JSON.stringify(t)),`${encodeURIComponent(e)}=${encodeURIComponent(t)}`)).join("&")}function fp(n){if(n instanceof xt){const e=n;return{mimeType:e.mimeType,body:e}}else{if(n instanceof Map)return{mimeType:"multipart/form-data",body:n};if(typeof n=="object"){const e=JSON.stringify(n);return{mimeType:"application/json",body:e}}else throw new Error("Unknown body type: "+n)}}class yp{constructor(e,t,s,i){let r;if(i?.log){const o=i?.log;r=o.child({t:"network",url:t,method:e},o.level.Info)}this._log=r,this._sourceRequest=s,this._promise=s.response().then(o=>{if(r?.set("status",o.status),o.status>=200&&o.status<300||i?.allowedStatusCodes?.includes(o.status))return r?.finish(),o.body;if(o.status>=500){const a=new Ge("Internal Server Error");throw r?.catch(a),a}else if(o.status>=400&&!o.body?.errcode){const a=new Ge(`HTTP error status ${o.status} without errcode in body, assume this is a load balancer complaining the server is offline.`);throw r?.catch(a),a}else{const a=new zo(e,t,o.body,o.status);throw r?.set("errcode",a.errcode),r?.catch(a),a}},o=>{if(o.name==="AbortError"&&this._sourceRequest){const a=new Ge("Service worker aborted, either updating or hit #187.");throw r?.catch(a),a}else throw o.name==="ConnectionError"&&r?.set("timeout",o.isTimeout),r?.catch(o),o})}abort(){this._sourceRequest&&(this._log?.set("aborted",!0),this._sourceRequest.abort(),this._sourceRequest=void 0)}response(){return this._promise}async responseCode(){return(await this._sourceRequest.response()).status}}const Ys="/_matrix/client/r0",Xs="/_matrix/client/v3",er="/_matrix/client/unstable/org.matrix.msc2697.v2";class $e{constructor({homeserver:e,accessToken:t,request:s,reconnector:i}){this._homeserver=e,this._accessToken=t,this._requestFn=s,this._reconnector=i}_url(e,t=Ys){return this._homeserver+t+e}_baseRequest(e,t,s,i,r,o){const a=Ja(s);t=`${t}?${a}`;let c;const l=new Map;if(o&&l.set("Authorization",`Bearer ${o}`),l.set("Accept","application/json"),i){const u=fp(i);l.set("Content-Type",u.mimeType),c=u.body}const h=this._requestFn(t,{method:e,headers:l,body:c,timeout:r?.timeout,uploadProgress:r?.uploadProgress,format:"json",cache:e!=="GET"}),d=new yp(e,t,h,r);return this._reconnector&&d.response().catch(u=>{u.name==="ConnectionError"&&this._reconnector.onRequestFailed(this)}),d}_unauthedRequest(e,t,s,i,r){return this._baseRequest(e,t,s,i,r)}_authedRequest(e,t,s,i,r){return this._baseRequest(e,t,s,i,r,this._accessToken)}_post(e,t,s,i){return this._authedRequest("POST",this._url(e,i?.prefix||Ys),t,s,i)}_put(e,t,s,i){return this._authedRequest("PUT",this._url(e,i?.prefix||Ys),t,s,i)}_get(e,t,s,i){return this._authedRequest("GET",this._url(e,i?.prefix||Ys),t,s,i)}sync(e,t,s,i){return this._get("/sync",{since:e,timeout:s,filter:t},void 0,i)}resolveRoomAlias(e){return this._unauthedRequest("GET",this._url(`/directory/room/${encodeURIComponent(e)}`,Xs))}context(e,t,s,i){return this._get(`/rooms/${encodeURIComponent(e)}/context/${encodeURIComponent(t)}`,{filter:i,limit:s})}messages(e,t,s){return this._get(`/rooms/${encodeURIComponent(e)}/messages`,t,void 0,s)}members(e,t,s){return this._get(`/rooms/${encodeURIComponent(e)}/members`,t,void 0,s)}send(e,t,s,i,r){return this._put(`/rooms/${encodeURIComponent(e)}/send/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},i,r)}redact(e,t,s,i,r){return this._put(`/rooms/${encodeURIComponent(e)}/redact/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},i,r)}receipt(e,t,s,i){return this._post(`/rooms/${encodeURIComponent(e)}/receipt/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},{},i)}state(e,t,s,i){return this._get(`/rooms/${encodeURIComponent(e)}/state/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},void 0,i)}sendState(e,t,s,i,r){return this._put(`/rooms/${encodeURIComponent(e)}/state/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},i,r)}currentState(e){return this._get(`/rooms/${encodeURIComponent(e)}/state`,{},void 0)}getLoginFlows(){return this._unauthedRequest("GET",this._url("/login"))}register(e,t,s,i,r=!1,o={}){o.allowedStatusCodes=[401];const a={auth:i,password:t,initial_device_displayname:s,inhibit_login:r};return e&&(a.username=e),this._unauthedRequest("POST",this._url("/register",Xs),void 0,a,o)}passwordLogin(e,t,s,i){return this._unauthedRequest("POST",this._url("/login"),void 0,{type:"m.login.password",identifier:{type:"m.id.user",user:e},password:t,initial_device_display_name:s},i)}tokenLogin(e,t,s,i){return this._unauthedRequest("POST",this._url("/login"),void 0,{type:"m.login.token",identifier:{type:"m.id.user"},token:e,txn_id:t,initial_device_display_name:s},i)}guestLogin(e,t){return this._unauthedRequest("POST",this._url("/register",Xs),{kind:"guest"},{initial_device_displayname:e||"Guest account on "+this._homeserver})}whoami(){return this._get("/account/whoami",void 0,void 0,{prefix:Xs})}createFilter(e,t,s){return this._post(`/user/${encodeURIComponent(e)}/filter`,{},t,s)}versions(e){return this._unauthedRequest("GET",`${this._homeserver}/_matrix/client/versions`,void 0,void 0,e)}uploadKeys(e,t,s){let i="/keys/upload";return e&&(i=i+`/${encodeURIComponent(e)}`),this._post(i,{},t,s)}uploadSignatures(e,t){return this._post("/keys/signatures/upload",{},e,t)}queryKeys(e,t){return this._post("/keys/query",{},e,t)}claimKeys(e,t){return this._post("/keys/claim",{},e,t)}sendToDevice(e,t,s,i){return this._put(`/sendToDevice/${encodeURIComponent(e)}/${encodeURIComponent(s)}`,{},t,i)}roomKeysVersion(e,t){let s="";return e&&(s=`/${encodeURIComponent(e)}`),this._get(`/room_keys/version${s}`,void 0,void 0,t)}roomKeyForRoomAndSession(e,t,s,i){return this._get(`/room_keys/keys/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{version:e},void 0,i)}uploadRoomKeysToBackup(e,t,s){return this._put("/room_keys/keys",{version:e},t,s)}uploadAttachment(e,t,s){return this._authedRequest("POST",`${this._homeserver}/_matrix/media/r0/upload`,{filename:t},e,s)}setPusher(e,t){return this._post("/pushers/set",{},e,t)}getPushers(e){return this._get("/pushers",void 0,void 0,e)}join(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/join`,{},{},t)}joinIdOrAlias(e,t){return this._post(`/join/${encodeURIComponent(e)}`,{},{},t)}leave(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/leave`,{},{},t)}forget(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/forget`,{},{},t)}logout(e){return this._post("/logout",{},{},e)}getDehydratedDevice(e={}){return e.prefix=er,this._get("/dehydrated_device",void 0,void 0,e)}createDehydratedDevice(e,t={}){return t.prefix=er,this._put("/dehydrated_device",{},e,t)}claimDehydratedDevice(e,t={}){return t.prefix=er,this._post("/dehydrated_device/claim",{},{device_id:e},t)}profile(e,t){return this._get(`/profile/${encodeURIComponent(e)}`)}createRoom(e,t){return this._post("/createRoom",{},e,t)}setAccountData(e,t,s,i){return this._put(`/user/${encodeURIComponent(e)}/account_data/${encodeURIComponent(t)}`,{},s,i)}getTurnServer(e){return this._get("/voip/turnServer",void 0,void 0,e)}}class Qa{constructor(e){this._start=2e3,this._current=2e3;const t=2e3;this._start=t,this._current=t,this._createTimeout=e,this._max=60*5*1e3}async waitForRetry(){this._timeout=this._createTimeout(this._current);try{await this._timeout.elapsed();const e=2*this._current;this._current=Math.min(this._max,e)}catch(e){if(!(e instanceof Ce))throw e}finally{this._timeout=void 0}}abort(){this._timeout&&this._timeout.abort()}reset(){this._current=this._start,this.abort()}get nextValue(){return this._current}}var zt=(n=>(n[n.Waiting=0]="Waiting",n[n.Reconnecting=1]="Reconnecting",n[n.Online=2]="Online",n))(zt||{});class wp{constructor({retryDelay:e,createMeasure:t,onlineStatus:s}){this._onlineStatus=s,this._retryDelay=e,this._createTimeMeasure=t,this._state=new Te(2),this._isStarted=!1,this._isReconnecting=!1}get lastVersionsResponse(){return this._versionsResponse}get connectionStatus(){return this._state}get retryIn(){return this._state.get()===0?this._retryDelay.nextValue-this._stateSince.measure():0}get isStarted(){return this._isStarted}start(){this._isStarted=!0}stop(){this._isStarted=!1}async onRequestFailed(e){if(!!this._isStarted&&!this._isReconnecting){this._isReconnecting=!0;const t=this._onlineStatus&&this._onlineStatus.subscribe(s=>{s&&this.tryNow()});try{await this._reconnectLoop(e)}catch(s){console.error(s)}finally{t&&t(),this._isReconnecting=!1}}}tryNow(){this._retryDelay&&this._retryDelay.abort()}_setState(e){e!==this._state.get()&&(e===0?this._stateSince=this._createTimeMeasure():this._stateSince=null,this._state.set(e))}async _reconnectLoop(e){for(this._versionsResponse=void 0,this._retryDelay.reset();this._isStarted&&!this._versionsResponse;)try{this._setState(1);const t=e.versions({timeout:3e4});this._versionsResponse=await t.response(),this._setState(2)}catch(t){if(t.name==="ConnectionError")this._setState(0),await this._retryDelay.waitForRetry();else throw t}}}async function vp(n,e,t){if(t===void 0||t.key===void 0||t.iv===void 0||t.hashes===void 0||t.hashes.sha256===void 0)throw new Error("Invalid info. Missing info.key, info.iv or info.hashes.sha256 key");const{crypto:s}=n,{base64:i}=n.encoding;var r=i.decode(t.iv),o=i.encode(i.decode(t.hashes.sha256));const a=await s.digest("SHA-256",e);if(i.encode(new Uint8Array(a))!=o)throw new Error("Mismatched SHA-256 digest");var c;return t.v=="v1"||t.v=="v2"?c=64:c=128,await s.aes.decryptCTR({jwkKey:t.key,iv:r,data:e,counterLength:c})}async function bp(n,e){const{crypto:t}=n,{base64:s}=n.encoding,i=await t.aes.generateIV(),r=await t.aes.generateKey("jwk",256),o=await e.readAsBuffer(),a=await t.aes.encryptCTR({jwkKey:r,iv:i,data:o}),c=await t.digest("SHA-256",a);return{blob:n.createBlob(a,"application/octet-stream"),info:{v:"v2",key:r,iv:s.encodeUnpadded(i),hashes:{sha256:s.encodeUnpadded(c)}}}}class Sp{constructor({homeserver:e,platform:t}){this._homeserver=e,this._platform=t}mxcUrlThumbnail(e,t,s,i){const r=this._parseMxcUrl(e);if(r){const[o,a]=r;return`${this._homeserver}/_matrix/media/r0/thumbnail/${encodeURIComponent(o)}/${encodeURIComponent(a)}`+"?"+Ja({width:Math.round(t),height:Math.round(s),method:i})}}mxcUrl(e){const t=this._parseMxcUrl(e);if(t){const[s,i]=t;return`${this._homeserver}/_matrix/media/r0/download/${encodeURIComponent(s)}/${encodeURIComponent(i)}`}}_parseMxcUrl(e){const t="mxc://";if(e.startsWith(t))return e.substr(t.length).split("/",2)}async downloadEncryptedFile(e,t=!1){const s=this.mxcUrl(e.url),{body:i}=await this._platform.request(s,{method:"GET",format:"buffer",cache:t}).response(),r=await vp(this._platform,i,e);return this._platform.createBlob(r,e.mimetype)}async downloadPlaintextFile(e,t,s=!1){const i=this.mxcUrl(e),{body:r}=await this._platform.request(i,{method:"GET",format:"buffer",cache:s}).response();return this._platform.createBlob(r,t)}async downloadAttachment(e,t=!1){return e.file?this.downloadEncryptedFile(e.file,t):this.downloadPlaintextFile(e.url,e.info?.mimetype,t)}}class Ip{constructor(e,t){this.methodName=e,this.args=t,this._responsePromise=new Promise((s,i)=>{this.responseResolve=s,this.responseReject=i})}abort(){this._requestResult?this._requestResult.abort():(this.responseReject(new Ce),this.responseCodeReject?.(new Ce))}response(){return this._responsePromise}responseCode(){return this.requestResult?this.requestResult.responseCode():(this._responseCodePromise||(this._responseCodePromise=new Promise((e,t)=>{this.responseCodeResolve=e,this.responseCodeReject=t})),this._responseCodePromise)}async setRequestResult(e){this._requestResult=e;const t=await this._requestResult?.response();this.responseResolve(t);const s=await this._requestResult?.responseCode();this.responseCodeResolve?.(s)}get requestResult(){return this._requestResult}}class Ya{constructor(e){this._scheduler=e}}for(const n of Object.getOwnPropertyNames($e.prototype))n!=="constructor"&&!n.startsWith("_")&&(Ya.prototype[n]=function(...e){return this._scheduler._hsApiRequest(n,e)});class Rp{constructor({hsApi:e,clock:t}){this._requests=new Set,this._stopped=!1,this._wrapper=new Ya(this),this._hsApi=e,this._clock=t}get hsApi(){return this._wrapper}stop(){this._stopped=!0;for(const e of this._requests)e.abort();this._requests.clear()}start(){this._stopped=!1}_hsApiRequest(e,t){const s=new Ip(e,t);return this._doSend(s),s}async _doSend(e){this._requests.add(e);try{let t;for(;!this._stopped;)try{const s=this._hsApi[e.methodName].apply(this._hsApi,e.args);await e.setRequestResult(s);return}catch(s){if(s instanceof zo&&s.errcode==="M_LIMIT_EXCEEDED")Number.isSafeInteger(s.retry_after_ms)?await this._clock.createTimeout(s.retry_after_ms).elapsed():(t||(t=new Qa(this._clock.createTimeout)),await t.waitForRetry());else{e.responseReject(s);return}}this._stopped&&e.abort()}finally{this._requests.delete(e)}}}function kp(n,e,t,s,i){return e.length&&(n=e.reduce((r,o)=>Tp(r,o,t,s,i),n)),n}function Ep(n,e,t,s){e.summary&&(n=Ap(n,e.summary)),t!==n.membership&&(n=n.cloneIfNeeded(),n.membership=t),e.account_data&&(n=e.account_data.events.reduce(Cp,n)),qt(e,r=>{n=Xa(n,r,s)});const i=e.unread_notifications;return i&&(n=Mp(n,i)),n}function Mp(n,e){const t=e.highlight_count||0;t!==n.highlightCount&&(n=n.cloneIfNeeded(),n.highlightCount=t);const s=e.notification_count;return s!==n.notificationCount&&(n=n.cloneIfNeeded(),n.notificationCount=s),n}function Cp(n,e){if(e?.type==="m.tag"){let t=e?.content?.tags;(!t||Array.isArray(t)||typeof t!="object")&&(t=null),n=n.cloneIfNeeded(),n.tags=t}return n}function Xa(n,e,t){if(e.type==="m.room.create")n=n.cloneIfNeeded(),n.lastMessageTimestamp=e.origin_server_ts;else if(e.type==="m.room.encryption"){const s=e.content?.algorithm;!n.encryption&&s===Le&&(n=n.cloneIfNeeded(),n.encryption=e.content)}else if(e.type==="m.room.name"){const s=e.content?.name;s!==n.name&&(n=n.cloneIfNeeded(),n.name=s)}else if(e.type==="m.room.avatar"){const s=e.content?.url;s!==n.avatarUrl&&(n=n.cloneIfNeeded(),n.avatarUrl=s)}else if(e.type==="m.room.canonical_alias"){const s=e.content;n=n.cloneIfNeeded(),n.canonicalAlias=s.alias}else if(e.type==="m.room.member"){const s=e.content;if(s.is_direct===!0&&s.membership==="invite"&&!n.isDirectMessage){let i;e.sender===t?i=e.state_key:e.state_key===t&&(i=e.sender),i&&(n=n.cloneIfNeeded(),n.isDirectMessage=!0,n.dmUserId=i)}else s.membership==="leave"&&n.isDirectMessage&&n.dmUserId===e.state_key&&(n=n.cloneIfNeeded(),n.isDirectMessage=!1,n.dmUserId=null)}return n}function Tp(n,e,t,s,i){return e.eventType==="m.room.message"&&((!n.lastMessageTimestamp||e.timestamp>n.lastMessageTimestamp)&&(n=n.cloneIfNeeded(),n.lastMessageTimestamp=e.timestamp),!t&&e.sender!==i&&s&&(n=n.cloneIfNeeded(),n.isUnread=!0)),n}function Ap(n,e){const t=e["m.heroes"],s=e["m.joined_member_count"],i=e["m.invited_member_count"];return t&&Array.isArray(t)&&(n=n.cloneIfNeeded(),n.heroes=t),Number.isInteger(i)&&(n=n.cloneIfNeeded(),n.inviteCount=i),Number.isInteger(s)&&(n=n.cloneIfNeeded(),n.joinCount=s),n}class qe{constructor(e,t){this.roomId=e?e.roomId:t,this.name=e?e.name:null,this.lastMessageTimestamp=e?e.lastMessageTimestamp:null,this.isUnread=e?e.isUnread:!1,this.encryption=e?e.encryption:null,this.membership=e?e.membership:null,this.inviteCount=e?e.inviteCount:0,this.joinCount=e?e.joinCount:0,this.heroes=e?e.heroes:null,this.canonicalAlias=e?e.canonicalAlias:null,this.hasFetchedMembers=e?e.hasFetchedMembers:!1,this.isTrackingMembers=e?e.isTrackingMembers:!1,this.avatarUrl=e?e.avatarUrl:null,this.notificationCount=e?e.notificationCount:0,this.highlightCount=e?e.highlightCount:0,this.tags=e?e.tags:null,this.isDirectMessage=e?e.isDirectMessage:!1,this.dmUserId=e?e.dmUserId:null,this.cloned=!!e}changedKeys(e){return Object.getOwnPropertyNames(this).filter(s=>s!=="cloned"&&this[s]!==e[s])}cloneIfNeeded(){return this.cloned?this:new qe(this)}serialize(){return Object.entries(this).reduce((e,[t,s])=>(t!=="cloned"&&s!==null&&(e[t]=s),e),{})}applyTimelineEntries(e,t,s,i){return kp(this,e,t,s,i)}applySyncResponse(e,t,s){return Ep(this,e,t,s)}get needsHeroes(){return!this.name&&!this.canonicalAlias&&this.heroes&&this.heroes.length>0}isNewJoin(e){return this.membership==="join"&&e.membership!=="join"}}class xp{constructor(e){this._data=null,this.applyChanges(new qe(null,e))}get data(){return this._data}writeClearUnread(e){const t=new qe(this._data);return t.isUnread=!1,t.notificationCount=0,t.highlightCount=0,e.roomSummary.set(t.serialize()),t}writeHasFetchedMembers(e,t){const s=new qe(this._data);return s.hasFetchedMembers=e,t.roomSummary.set(s.serialize()),s}writeIsTrackingMembers(e,t){const s=new qe(this._data);return s.isTrackingMembers=e,t.roomSummary.set(s.serialize()),s}writeData(e,t){if(e!==this._data)return t.roomSummary.set(e.serialize()),e}writeArchivedData(e,t){if(e!==this._data)return t.archivedRoomSummary.set(e.serialize()),e}async writeAndApplyData(e,t){if(e===this._data)return!1;const s=await t.readWriteTxn([t.storeNames.roomSummary]);try{s.roomSummary.set(e.serialize())}catch(i){throw s.abort(),i}return await s.complete(),this.applyChanges(e),!0}applyChanges(e){this._data=e,this._data.cloned=!1}async load(e){this.applyChanges(new qe(e))}}function zr(n){return typeof n=="number"}const Np=["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"].reduce(function(n,e){return n[e]=1,n},{}),Dp={"m.room.member":{membership:1},"m.room.create":{creator:1},"m.room.join_rules":{join_rule:1},"m.room.power_levels":{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1},"m.room.aliases":{aliases:1}};function Vp(n,e){for(const i of Object.keys(e))Np[i]||delete e[i];const{content:t}=e,s=Dp[e.type];for(const i of Object.keys(t))s?.[i]||delete t[i];e.unsigned=e.unsigned||{},e.unsigned.redacted_because=n}function Pp(n,e){const t=[];for(;zr(n.previousId);){const s=e.get(n.previousId);if(!s)break;if(s.nextId!==n.id)throw new Error(`Previous fragment ${s.id} doesn't point back to ${n.id}`);e.delete(n.previousId),t.unshift(s),n=s}return t}function Lp(n,e){const t=[];for(;zr(n.nextId);){const s=e.get(n.nextId);if(!s)break;if(s.previousId!==n.id)throw new Error(`Next fragment ${s.id} doesn't point back to ${n.id}`);e.delete(n.nextId),t.push(s),n=s}return t}function Op(n){const e=new Map;for(let s of n)e.set(s.id,s);const t=[];for(;e.size;){const s=e.values().next().value;e.delete(s.id);const i=Pp(s,e),r=Lp(s,e),o=i.concat(s,r);t.push(o)}return t.map(s=>new Up(s))}class tr{constructor(e,t,s){this.id=e,this.previousId=t,this.nextId=s}}class Up{constructor(e){this._idToSortIndex=new Map,e.forEach((t,s)=>{this._idToSortIndex.set(t.id,s)})}compare(e,t){const s=this._idToSortIndex.get(e);if(s===void 0)throw new Error(`first id ${e} isn't part of this island`);const i=this._idToSortIndex.get(t);if(i===void 0)throw new Error(`second id ${t} isn't part of this island`);return s-i}get fragmentIds(){return this._idToSortIndex.keys()}}class po extends Error{get name(){return"CompareError"}}class Fp{constructor(e){this._fragmentsById=e.reduce((t,s)=>(t.set(s.id,s),t),new Map),this.rebuild(e)}_getIsland(e){const t=this._idToIsland.get(e);if(t===void 0)throw new po(`Unknown fragment id ${e}`);return t}compare(e,t){if(e===t)return 0;const s=this._getIsland(e),i=this._getIsland(t);if(s!==i)throw new po(`${e} and ${t} are on different islands, can't tell order`);return s.compare(e,t)}rebuild(e){const t=Op(e);this._idToIsland=new Map;for(let s of t)for(let i of s.fragmentIds)this._idToIsland.set(i,s)}add(e){const t=new tr(e.id,e.previousId,e.nextId);this._fragmentsById.set(e.id,t),this.rebuild(this._fragmentsById.values())}append(e,t){const s=new tr(e,t,null),i=this._fragmentsById.get(t);i&&(i.nextId=e),this._fragmentsById.set(e,s),this.rebuild(this._fragmentsById.values())}prepend(e,t){const s=new tr(e,null,t),i=this._fragmentsById.get(t);i&&(i.previousId=e),this._fragmentsById.set(e,s),this.rebuild(this._fragmentsById.values())}}class Za{constructor({roomId:e,ownUserId:t,fragmentIdComparer:s}){this._roomId=e,this._ownUserId=t,this._fragmentIdComparer=s}async writeRelation(e,t,s){const{relatedEventId:i}=e;if(i){const r=nt(e.event);r&&r.rel_type&&t.timelineRelations.add(this._roomId,r.event_id,r.rel_type,e.id);const o=await t.timelineEvents.getByEventId(this._roomId,i);if(o){const a=await this._applyRelation(e,o,t,s);if(a)return a.map(c=>(t.timelineEvents.update(c),new _e(c,this._fragmentIdComparer)))}}return null}async writeGapRelation(e,t,s,i){const r=new _e(e,this._fragmentIdComparer),o=await this.writeRelation(r,s,i);if(t.isBackward&&!dr(e.event)){const a=await s.timelineRelations.getAllForTarget(this._roomId,r.id);if(a.length)for(const c of a){const l=await s.timelineEvents.getByEventId(this._roomId,c.sourceEventId);if(l){const h=new _e(l,this._fragmentIdComparer);await this._applyRelation(h,e,s,i)}}}return o}async _applyRelation(e,t,s,i){if(e.eventType===Pe)return i.wrap("redact",async r=>{const o=t.event,a=nt(o);if(this._applyRedaction(e.event,t,s,r)){const l=[t];if(a){const h=await this._reaggregateRelation(o,a,s,r);h&&l.push(h)}return l}return null});{const r=nt(e.event);if(r&&!dr(t.event)&&r.rel_type===lt&&i.wrap("react",c=>this._aggregateAnnotation(e.event,t,c)))return[t]}return null}_applyRedaction(e,t,s,i){const r=t.event;i.set("redactionId",e.event_id),i.set("id",r.event_id);const o=nt(r);return o&&o.rel_type&&s.timelineRelations.remove(this._roomId,o.event_id,o.rel_type,r.event_id),s.timelineRelations.removeAllForTarget(this._roomId,r.event_id),Vp(e,r),delete t.annotations,!0}_aggregateAnnotation(e,t){const s=nt(e);if(!s)return!1;let{annotations:i}=t;i||(t.annotations=i={});let r=i[s.key];r||(i[s.key]=r={count:0,me:!1,firstTimestamp:Number.MAX_SAFE_INTEGER});const o=e.sender===this._ownUserId;return r.me=r.me||o,r.count+=1,r.firstTimestamp=Math.min(r.firstTimestamp,e.origin_server_ts),!0}async _reaggregateRelation(e,t,s,i){return t.rel_type===lt?i.wrap("reaggregate annotations",r=>this._reaggregateAnnotation(t.event_id,t.key,s,r)):null}async _reaggregateAnnotation(e,t,s,i){const r=await s.timelineEvents.getByEventId(this._roomId,e);if(!r||!r.annotations)return null;i.set("id",e);const o=await s.timelineRelations.getForTargetAndType(this._roomId,e,lt);return i.set("relations",o.length),delete r.annotations[t],Bp(r.annotations)&&delete r.annotations,await Promise.all(o.map(async a=>{const c=await s.timelineEvents.getByEventId(this._roomId,a.sourceEventId);c||i.log({l:"missing annotation",id:a.sourceEventId}),nt(c.event).key===t&&this._aggregateAnnotation(c.event,r,i)})),r}}function Bp(n){for(const e in n)if(n.hasOwnProperty(e))return!1;return!0}class Ze{constructor(e){this.isForward=e}get isBackward(){return!this.isForward}asApiString(){return this.isForward?"f":"b"}reverse(){return this.isForward?Ze.Backward:Ze.Forward}static get Forward(){return Kp}static get Backward(){return $p}}const Kp=new Ze(!0),$p=new Ze(!1);class Ee extends qa{constructor(e,t,s){super(s),this._fragment=e,this._isFragmentStart=t}static start(e,t){return new Ee(e,!0,t)}static end(e,t){return new Ee(e,!1,t)}get started(){return this._isFragmentStart}get hasEnded(){return!this.started}get fragment(){return this._fragment}get fragmentId(){return this._fragment.id}get entryIndex(){return this.started?W.minStorageKey:W.maxStorageKey}get isGap(){return!!this.token&&!this.edgeReached}get token(){return this.started?this.fragment.previousToken:this.fragment.nextToken}set token(e){this.started?this.fragment.previousToken=e:this.fragment.nextToken=e}get edgeReached(){return this.started?this.fragment.startReached:this.fragment.endReached}set edgeReached(e){this.started?this.fragment.startReached=e:this.fragment.endReached=e}get linkedFragmentId(){return this.started?this.fragment.previousId:this.fragment.nextId}set linkedFragmentId(e){this.started?this.fragment.previousId=e:this.fragment.nextId=e}get hasLinkedFragment(){return zr(this.linkedFragmentId)}get direction(){return this.started?Ze.Backward:Ze.Forward}withUpdatedFragment(e){return new Ee(e,this._isFragmentStart,this._fragmentIdComparer)}createNeighbourEntry(e){return new Ee(e,!this._isFragmentStart,this._fragmentIdComparer)}addLocalRelation(){}removeLocalRelation(){}}function jp(n){const e=new Set;return n.filter(t=>e.has(t.event_id)?!1:(e.add(t.event_id),!0))}class qp{constructor({roomId:e,fragmentIdComparer:t,memberWriter:s,relationWriter:i}){this._roomId=e,this._memberWriter=s,this._relationWriter=i,this._fragmentIdComparer=t,this._lastLiveKey=null}async load(e,t){const s=await e.timelineFragments.liveFragment(this._roomId);if(s){const[i]=await e.timelineEvents.lastEvents(this._roomId,s.id,1),r=i?i.eventIndex:H.defaultLiveKey.eventIndex;this._lastLiveKey=new H(s.id,r)}this._lastLiveKey&&t.set("live key",this._lastLiveKey.toString())}async _createLiveFragment(e,t){const s=await e.timelineFragments.liveFragment(this._roomId);if(s)return s;{t||(t=null);const i={roomId:this._roomId,id:H.defaultLiveKey.fragmentId,previousId:null,nextId:null,previousToken:t,nextToken:null};return e.timelineFragments.add(i),this._fragmentIdComparer.add(i),i}}async _replaceLiveFragment(e,t,s,i){const r=await i.timelineFragments.get(this._roomId,e);if(!r)throw new Error(`old live fragment doesn't exist: ${e}`);r.nextId=t,i.timelineFragments.update(r);const o={roomId:this._roomId,id:t,previousId:e,nextId:null,previousToken:s,nextToken:null};return i.timelineFragments.add(o),this._fragmentIdComparer.append(t,e),{oldFragment:r,newFragment:o}}async _ensureLiveFragment(e,t,s,i,r){if(e){if(s.limited){const o=e.fragmentId;e=e.nextFragmentKey();const{oldFragment:a,newFragment:c}=await this._replaceLiveFragment(o,e.fragmentId,s.prev_batch,i);t.push(Ee.end(a,this._fragmentIdComparer)),t.push(Ee.start(c,this._fragmentIdComparer)),r.log({l:"live fragment",limited:!0,id:e.fragmentId})}}else{let o=await this._createLiveFragment(i,s.prev_batch);e=new H(o.id,H.defaultLiveKey.eventIndex),t.push(Ee.start(o,this._fragmentIdComparer)),r.log({l:"live fragment",first:!0,id:e.fragmentId})}return e}async _writeStateEvents(e,t,s){let i=0;for(const r of e)r.type!==ge&&(t.roomState.set(this._roomId,r),i+=1);s.set("stateEvents",i)}async _writeTimeline(e,t,s,i,r,o){const a=[],c=[];if(e?.length){i=await this._ensureLiveFragment(i,a,t,r,o),o.set("timelineEvents",e.length);let l=0;for(const h of e){i=i.nextKey();const d=Or(i,this._roomId,h);let u=await s.lookupMemberAtEvent(h.sender,h,r);if(u&&(d.displayName=u.displayName,d.avatarUrl=u.avatarUrl),!await r.timelineEvents.tryInsert(d,o))continue;const _=new _e(d,this._fragmentIdComparer);a.push(_);const g=await this._relationWriter.writeRelation(_,r,o);g&&c.push(...g),typeof h.state_key=="string"&&h.type!==ge&&(l+=1,r.roomState.set(this._roomId,h))}o.set("timelineStateEventCount",l)}return{currentKey:i,entries:a,updatedEntries:c}}async _handleRejoinOverlap(e,t,s){if(this._lastLiveKey){const{fragmentId:i}=this._lastLiveKey,[r]=await t.timelineEvents.lastEvents(this._roomId,i,1);if(r){const o=r.event.event_id,{events:a}=e,c=a.findIndex(l=>l.event_id===o);if(c!==-1)return s.set("overlap_event_id",o),Object.assign({},e,{limited:!1,events:a.slice(c+1)})}}return e.limited?e:(s.set("force_limited_without_overlap",!0),Object.assign({},e,{limited:!0}))}async writeSync(e,t,s,i,r){let{timeline:o}=e;r.set("isRejoin",t),t&&(o=await this._handleRejoinOverlap(o,i,r));let a;Array.isArray(o?.events)&&(a=jp(o.events));const{state:c}=e;let l;Array.isArray(c?.events)&&(l=c.events);const h=this._memberWriter.prepareMemberSync(l,a,s);l&&await this._writeStateEvents(l,i,r);const{currentKey:d,entries:u,updatedEntries:p}=await this._writeTimeline(a,o,h,this._lastLiveKey,i,r),_=await h.write(i);return{entries:u,updatedEntries:p,newLiveKey:d,memberChanges:_,memberSync:h}}afterSync(e){this._lastLiveKey=e}get lastMessageKey(){return this._lastLiveKey}}class ec{constructor(e){this.limit=e,this._entries=[]}get size(){return this._entries.length}_get(e){return this._getByIndexAndMoveUp(this._entries.findIndex(e))}_getByIndexAndMoveUp(e){if(e!==-1){const t=this._entries[e];return e>0&&(this._entries.splice(e,1),this._entries.unshift(t)),t}}_set(e,t){let s=t?this._entries.findIndex(t):-1;this._entries.unshift(e),s===-1?this._entries.length>this.limit&&(s=this._entries.length-1):s+=1,s!==-1&&(this.onEvictEntry(this._entries[s]),this._entries.splice(s,1))}onEvictEntry(e){}}class tc extends ec{constructor(e,t){super(e),this._keyFn=t}get(e){return this._get(t=>this._keyFn(t)===e)}set(e){const t=this._keyFn(e);this._set(e,s=>this._keyFn(s)===t)}}class Wp{constructor(e){this._roomId=e,this._cache=new tc(5,t=>t.userId)}prepareMemberSync(e,t,s){return new Hp(this,e,t,s)}async _writeMember(e,t){let s=this._cache.get(e.userId);if(!s){const i=await t.roomMembers.get(this._roomId,e.userId);i&&(s=new P(i))}if(!s||!s.equals(e))return t.roomMembers.set(e.serialize()),this._cache.set(e),new Ur(e,s?.membership)}async lookupMember(e,t){let s=this._cache.get(e);if(!s){const i=await t.roomMembers.get(this._roomId,e);i&&(s=new P(i),this._cache.set(s))}return s}}class Hp{constructor(e,t,s,i){this._memberWriter=e,this._timelineEvents=s,this._hasFetchedMembers=i,this._newStateMembers=null,t&&(this._newStateMembers=this._stateEventsToMembers(t))}get _roomId(){return this._memberWriter._roomId}_stateEventsToMembers(e){let t;for(const s of e)if(s.type===ge){const i=P.fromMemberEvent(this._roomId,s);i&&(t||(t=new Map),t.set(i.userId,i))}return t}_timelineEventsToMembers(e){let t;for(let s=e.length-1;s>=0;s--){const i=e[s],r=i.state_key;if(i.type===ge&&!t?.has(r)){const o=P.fromMemberEvent(this._roomId,i);o&&(t||(t=new Map),t.set(o.userId,o))}}return t}async lookupMemberAtEvent(e,t,s){let i;return this._timelineEvents&&(i=this._findPrecedingMemberEventInTimeline(e,t),i)||(i=this._newStateMembers?.get(e),i)?i:await this._memberWriter.lookupMember(e,s)}async write(e){const t=new Map;let s;if(this._timelineEvents&&(s=this._timelineEventsToMembers(this._timelineEvents)),this._newStateMembers){for(const i of this._newStateMembers.values())if(!s?.has(i.userId)){const r=await this._memberWriter._writeMember(i,e);r&&(!this._hasFetchedMembers&&!r.previousMembership&&(r.previousMembership=i.membership),t.set(r.userId,r))}}if(s)for(const i of s.values()){const r=await this._memberWriter._writeMember(i,e);r&&t.set(r.userId,r)}return t}_findPrecedingMemberEventInTimeline(e,t){let s=-1;for(let i=this._timelineEvents.length-1;i>=0;i--)if(this._timelineEvents[i].event_id===t.event_id){s=i;break}for(let i=s-1;i>=0;i--){const r=this._timelineEvents[i];if(r.type===ge&&r.state_key===e){const o=P.fromMemberEvent(this._roomId,r);if(o)return o}}}}class zp{constructor({roomId:e,storage:t,fragmentIdComparer:s,relationWriter:i}){this._roomId=e,this._storage=t,this._fragmentIdComparer=s,this._relationWriter=i}async _findOverlappingEvents(e,t,s,i){const r=t.map(l=>l.event_id),o=await s.timelineEvents.getEventKeysForIds(this._roomId,r);i.set("existingEvents",o.size);const a=t.filter(l=>!o.has(l.event_id));i.set("nonOverlappingEvents",a.length);let c;if(e.hasLinkedFragment){i.set("linkedFragmentId",e.linkedFragmentId);for(const l of o.values())if(l.fragmentId===e.linkedFragmentId){i.set("foundLinkedFragment",!0);const h=await s.timelineFragments.get(this._roomId,e.linkedFragmentId);c=e.createNeighbourEntry(h);break}}return{nonOverlappingEvents:a,neighbourFragmentEntry:c}}async _findFragmentEdgeEventKey(e,t){const{fragmentId:s,direction:i}=e,r=await this._findFragmentEdgeEvent(s,i,t);return r?new H(r.fragmentId,r.eventIndex):H.defaultFragmentKey(e.fragmentId)}async _findFragmentEdgeEvent(e,t,s){if(t.isBackward){const[i]=await s.timelineEvents.firstEvents(this._roomId,e,1);return i}else{const[i]=await s.timelineEvents.lastEvents(this._roomId,e,1);return i}}async _storeEvents(e,t,s,i,r,o){const a=[],c=[];let l=t;for(let h=0;h<e.length;++h){const d=e[h];l=l.nextKeyForDirection(s);const u=Or(l,this._roomId,d),p=this._findMember(d.sender,i,e,h,s);p&&(u.displayName=p.displayName,u.avatarUrl=p.avatarUrl);const _=await this._relationWriter.writeGapRelation(u,s,r,o);if(_&&c.push(..._),await r.timelineEvents.tryInsert(u,o)){const g=new _e(u,this._fragmentIdComparer);ws(a,g,s)}}return{entries:a,updatedEntries:c}}_findMember(e,t,s,i,r){function o(l){return l.type===ge&&l.state_key===e}const a=r.isBackward?1:-1;for(let l=i+a;l>=0&&l<s.length;l+=a){const h=s[l];if(o(h))return P.fromMemberEvent(this._roomId,h)}for(let l=i;l>=0&&l<s.length;l-=a){const h=s[l];if(o(h))return P.fromReplacingMemberEvent(this._roomId,h)}const c=t?.find(o);if(c)return P.fromMemberEvent(this._roomId,c)}async _updateFragments(e,t,s,i,r,o){const{direction:a}=e,c=[];return ws(i,e,a),t?(o.set("closedGapWith",t.fragmentId),t.token=null,e.token=null,r.timelineFragments.update(t.fragment),ws(i,t,a),c.push(e.fragment),c.push(t.fragment)):e.token=s,r.timelineFragments.update(e.fragment),c}async writeFragmentFill(e,t,s,i,r){const{fragmentId:o,direction:a}=e,{chunk:c,state:l}=t;let{end:h}=t;if(!Array.isArray(c))throw new Error("Invalid chunk in response");if(typeof h!="string"&&typeof h<"u")throw new Error("Invalid end token in response");const d=await i.timelineFragments.get(this._roomId,o);if(!d)throw new Error(`Unknown fragment: ${o}`);if(e=e.withUpdatedFragment(d),e.token!==s)throw new Error("The pagination token has changed locally while fetching messages.");if(c.length===0)return e.edgeReached=!0,await i.timelineFragments.update(e.fragment),{entries:[e],updatedEntries:[],fragments:[]};let u=await this._findFragmentEdgeEventKey(e,i);r.set("lastKey",u.toString());const{nonOverlappingEvents:p,neighbourFragmentEntry:_}=await this._findOverlappingEvents(e,c,i,r),{entries:g,updatedEntries:w}=await this._storeEvents(p,u,a,l,i,r),I=await this._updateFragments(e,_,h,g,i,r);return{entries:g,updatedEntries:w,fragments:I}}}class _o{constructor(e,t){this.decryptRequest=null,this._promise=e(this,t)}complete(){return this._promise}dispose(){this.decryptRequest&&(this.decryptRequest.dispose(),this.decryptRequest=null)}}async function Gp(n,e,t,s,i,r){let o=[];const a=r.timelineEvents,c=r.timelineFragments;for(;o.length<s&&e;){let l;t.isForward?l=await a.eventsAfter(n,e,s):l=await a.eventsBefore(n,e,s);let h=l.map(d=>new _e(d,i));if(o=sh(o,h,t),o.length<s){const d=await c.get(n,e.fragmentId);let u=new Ee(d,t.isBackward,i);if(ws(o,u,t),!u.token&&u.hasLinkedFragment){const p=await c.get(n,u.linkedFragmentId);i.add(p);const _=new Ee(p,t.isForward,i);ws(o,_,t),e=_.asEventKey()}else e=null}}return o}class sc{constructor({roomId:e,storage:t,fragmentIdComparer:s}){this._roomId=e,this._storage=t,this._fragmentIdComparer=s,this._decryptEntries=null}enableEncryption(e){this._decryptEntries=e}get readTxnStores(){const e=[this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineFragments];return this._decryptEntries&&e.push(this._storage.storeNames.inboundGroupSessions),e}readFrom(e,t,s,i){return new _o(async(r,o)=>{const a=await this._storage.readTxn(this.readTxnStores);return await this._readFrom(e,t,s,r,a,o)},i)}readFromEnd(e,t=null,s){return new _o(async(i,r)=>{const o=t||await this._storage.readTxn(this.readTxnStores),a=await o.timelineFragments.liveFragment(this._roomId);let c;if(!a)c=[];else{this._fragmentIdComparer.add(a);const l=Ee.end(a,this._fragmentIdComparer),h=l.asEventKey();c=await this._readFrom(h,Ze.Backward,e,i,o,r),c.unshift(l)}return c},s)}async readById(e,t){let s=[this._storage.storeNames.timelineEvents];this._decryptEntries&&s.push(this._storage.storeNames.inboundGroupSessions);const i=await this._storage.readTxn(s),r=await i.timelineEvents.getByEventId(this._roomId,e);if(r){const o=new _e(r,this._fragmentIdComparer);return this._decryptEntries&&await this._decryptEntries([o],i,t).complete(),o}}async _readFrom(e,t,s,i,r,o){const a=await Gp(this._roomId,e,t,s,this._fragmentIdComparer,r);if(this._decryptEntries){i.decryptRequest=this._decryptEntries(a,r,o);try{await i.decryptRequest.complete()}finally{i.decryptRequest=null}}return a}}class Jp extends _e{get fragmentId(){throw new Error("Cannot access fragmentId for non-persisted EventEntry")}get entryIndex(){throw new Error("Cannot access entryIndex for non-persisted EventEntry")}get isNonPersisted(){return!0}get isRedacting(){return!1}get isRedacted(){return super.isRedacting}}class Qp{constructor(e){this._userId=e}get id(){return this._userId}}class _i{constructor({roomId:e,storage:t,closeCallback:s,fragmentIdComparer:i,pendingEvents:r,clock:o,powerLevelsObservable:a,hsApi:c}){this._roomId=e,this._storage=t,this._closeCallback=s,this._fragmentIdComparer=i,this._disposables=new Ri,this._pendingEvents=r,this._clock=o,this._remoteEntries=new Ar((l,h)=>l.compare(h)),this._ownMember=null,this._timelineReader=new sc({roomId:this._roomId,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer}),this._readerRequest=null,this._allEntries=null,this._contextEntriesNotInTimeline=new Map,this._decryptEntries=null,this._hsApi=c,this.initializePowerLevels(a)}initializePowerLevels(e){e&&(this._powerLevels=e.get(),this._disposables.track(e.subscribe(t=>this._powerLevels=t)))}async load(e,t,s){const i=await this._storage.readTxn(this._timelineReader.readTxnStores.concat(this._storage.storeNames.roomMembers,this._storage.storeNames.roomState)),r=await i.roomMembers.get(this._roomId,e.id);r?this._ownMember=new P(r):this._ownMember=P.fromUserId(this._roomId,e.id,t);const o=this._disposables.track(this._timelineReader.readFromEnd(20,i,s));try{const a=await o.complete();this._loadContextEntriesWhereNeeded(a),this._setupEntries(a)}finally{this._disposables.disposeTracked(o)}}_setupEntries(e){this._remoteEntries.setManySorted(e),this._pendingEvents?this._localEntries=new nl(this._pendingEvents,t=>this._mapPendingEventToEntry(t),(t,s)=>{t.notifyUpdate(s)},t=>this._applyAndEmitLocalRelationChange(t,s=>s.removeLocalRelation(t))):this._localEntries=new Bo,this._allEntries=new hl(this._remoteEntries,this._localEntries)}async _mapPendingEventToEntry(e){let t;e.eventType===Pe&&(t=await this._getOrLoadEntry(e.relatedTxnId,e.relatedEventId));const s=new tp({pendingEvent:e,member:this._ownMember,clock:this._clock,redactingEntry:t});return this._loadContextEntriesWhereNeeded([s]),this._applyAndEmitLocalRelationChange(s,i=>i.addLocalRelation(s)),s}_applyAndEmitLocalRelationChange(e,t){const s=i=>{const r=t(i);return r||!1};if(this._findAndUpdateEntryById(e.pendingEvent.relatedTxnId,e.relatedEventId,s),e.redactingEntry){const i=e.redactingEntry.pendingEvent?.relatedTxnId;this._findAndUpdateEntryById(i,e.redactingEntry.relatedEventId,s),e.redactingEntry.contextForEntries?.forEach(r=>this._emitUpdateForEntry(r,"contextEntry"))}}_findAndUpdateEntryById(e,t,s){let i=!1;e&&(i=this._localEntries.findAndUpdate(r=>r.id===e,s)),!i&&t&&this._remoteEntries.findAndUpdate(r=>r.id===t,s)}async getOwnAnnotationEntry(e,t){const s=await this._storage.readWriteTxn([this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineRelations]),i=await s.timelineRelations.getForTargetAndType(this._roomId,e,lt);for(const r of i){const o=await s.timelineEvents.getByEventId(this._roomId,r.sourceEventId);if(o&&o.event.sender===this._ownMember.userId&&nt(o.event).key===t){const a=new _e(o,this._fragmentIdComparer);return this._addLocalRelationsToNewRemoteEntries([a]),a}}return null}updateOwnMember(e){this._ownMember=e}_addLocalRelationsToNewRemoteEntries(e){if(!!this._localEntries?.hasSubscriptions){for(const t of this._localEntries)if(t.relatedEventId&&e.find(i=>i.id===t.relatedEventId)?.addLocalRelation(t),t.redactingEntry){const s=t.redactingEntry.relatedEventId;e.find(r=>r.id===s)?.addLocalRelation(t)}}}static _entryUpdater(e,t){return e.contextForEntries?.forEach(s=>s.setContextEntry(t)),t.updateFrom(e),t}replaceEntries(e){this._addLocalRelationsToNewRemoteEntries(e);for(const t of e)try{this._remoteEntries.getAndUpdate(t,_i._entryUpdater);const s=this._contextEntriesNotInTimeline.get(t.id);s&&(_i._entryUpdater(s,t),this._contextEntriesNotInTimeline.set(t.id,t)),t.contextForEntries?.forEach(i=>this._emitUpdateForEntry(i,"contextEntry"))}catch(s){if(s.name==="CompareError")continue;throw s}}addEntries(e){this._addLocalRelationsToNewRemoteEntries(e),this._updateEntriesFetchedFromHomeserver(e),this._moveEntryToRemoteEntries(e),this._loadContextEntriesWhereNeeded(e),this._remoteEntries.setManySorted(e)}_updateEntriesFetchedFromHomeserver(e){for(const t of e){const s=this._contextEntriesNotInTimeline.get(t.relatedEventId);s?.isNonPersisted&&s?.addLocalRelation(t)&&s.contextForEntries?.forEach(i=>this._emitUpdateForEntry(i,"contextEntry"))}}_moveEntryToRemoteEntries(e){for(const t of e){const s=this._contextEntriesNotInTimeline.get(t.id);s&&(s.contextForEntries.forEach(i=>{i.setContextEntry(t),this._emitUpdateForEntry(i,"contextEntry")}),this._contextEntriesNotInTimeline.delete(t.id))}}_emitUpdateForEntry(e,t){const s=e.isPending?e.id:null,i=e.isPending?null:e.id;this._findAndUpdateEntryById(s,i,()=>t)}async _loadContextEntriesWhereNeeded(e){for(const t of e){if(!t.contextEventId)continue;const s=t.contextEventId;let i=e.find(r=>r.id===s);i||(i=this._findLoadedEventById(s)),i?t.setContextEntry(i):this._loadContextEntryNotInTimeline(t)}}async _loadContextEntryNotInTimeline(e){const t=e.contextEventId;let s=await this._getEventFromStorage(t);s||(s=await this._getEventFromHomeserver(t)),s&&(this._contextEntriesNotInTimeline.set(t,s),e.setContextEntry(s),this._emitUpdateForEntry(e,"contextEntry"))}_findLoadedEventById(e){return this.getByEventId(e)??this._contextEntriesNotInTimeline.get(e)}async _getEventFromStorage(e){return await this._timelineReader.readById(e)}async _getEventFromHomeserver(e){const t=await this._hsApi.context(this._roomId,e,0).response(),s=t.event.sender,i=t.state.find(a=>a.type===ge&&a.user_id===s),r={event:t.event,displayName:i.content.displayname,avatarUrl:i.content.avatar_url},o=new Jp(r,this._fragmentIdComparer);return this._decryptEntries&&await this._decryptEntries([o]).complete(),o}async loadAtTop(e){if(this._disposables.isDisposed)return!0;const t=this._remoteEntries.array.find(i=>!!i.eventType);if(!t)return!0;const s=this._disposables.track(this._timelineReader.readFrom(t.asEventKey(),Ze.Backward,e));try{const i=await s.complete();return this.addEntries(i),i.length<e}finally{this._disposables.disposeTracked(s)}}async _getOrLoadEntry(e,t){if(e){for(const s of this._localEntries)if(s.id===e)return s}return t?this.getByEventId(t)??await this._getEventFromStorage(t):null}getByEventId(e){for(let t=0;t<this._remoteEntries.length;t+=1){const s=this._remoteEntries.get(t);if(s.id===e)return s}return null}get entries(){return this._allEntries}get remoteEntries(){return this._remoteEntries.array}dispose(){this._closeCallback&&(this._disposables.dispose(),this._closeCallback(),this._closeCallback=null)}enableEncryption(e){this._decryptEntries=e,this._timelineReader.enableEncryption(e)}get powerLevels(){return this._powerLevels}get me(){return this._ownMember}}async function Yp({roomId:n,storage:e,txn:t}){return t||(t=await e.readTxn([e.storeNames.roomMembers])),(await t.roomMembers.getAll(n)).map(i=>new P(i))}async function Xp({summary:n,syncToken:e,roomId:t,hsApi:s,storage:i,setChangedMembersMap:r},o){const a=new Map;r(a);const c=await s.members(t,{at:e},{log:o}).response(),l=await i.readWriteTxn([i.storeNames.roomSummary,i.storeNames.roomMembers]);let h,d;try{h=n.writeHasFetchedMembers(!0,l);const{roomMembers:u}=l,p=c.chunk;if(!Array.isArray(p))throw new Error("malformed");o.set("members",p.length),d=await Promise.all(p.map(async _=>{const g=_?.state_key;if(!g)throw new Error("malformed");const w=a.get(g);if(w)return w;{const I=P.fromMemberEvent(t,_);return I&&u.set(I.serialize()),I}}))}catch(u){throw l.abort(),u}finally{r(null)}return await l.complete(),n.applyChanges(h),d}async function Zp(n,e){const{summary:t}=n;return t.data.hasFetchedMembers?Yp(n):e.wrapOrRun(n.log,"fetchMembers",s=>Xp(n,s))}async function e_(n,e){const t=await t_(n),{summary:s}=n;return!s.data.hasFetchedMembers&&!t?e.wrapOrRun(n.log,"fetchMember",i=>s_(n,i)):t}async function t_({roomId:n,userId:e,storage:t}){const i=await(await t.readTxn([t.storeNames.roomMembers])).roomMembers.get(n,e);return i?new P(i):null}async function s_({roomId:n,userId:e,hsApi:t,storage:s},i){let r;try{r=await t.state(n,"m.room.member",e,{log:i}).response()}catch(c){if(c.name==="HomeServerError"&&c.errcode==="M_NOT_FOUND")return null;throw c}const o=new P({roomId:n,userId:e,membership:r.membership,avatarUrl:r.avatar_url,displayName:r.displayname}),a=await s.readWriteTxn([s.storeNames.roomMembers]);try{a.roomMembers.set(o.serialize())}catch(c){throw a.abort(),c}return await a.complete(),o}class i_{constructor(e){this._retentionCount=1,this._freeCallback=e}retain(){this._retentionCount+=1}release(){this._retentionCount-=1,this._retentionCount===0&&this._freeCallback()}}class r_ extends i_{constructor({members:e,closeCallback:t}){super(t),this._members=new ct;for(const s of e)this._members.add(s.userId,s)}afterSync(e){for(const[t,s]of e.entries())this._members.set(t,s.member)}get members(){return this._members}}function yr(n,e,t){const s=e.joinCount+e.inviteCount-1;if(n.length>=s)if(n.length>1){const i=n[n.length-1];return n.slice(0,n.length-1).map(o=>o.name).join(", ")+" and "+i.name}else{const i=n[0];return i?i.name:(t.log({l:"could get get other member name",length:n.length,otherMember:!!i,otherMemberMembership:i?.membership}),"Unknown DM Name")}else return n.length<s?n.map(i=>i.name).join(", ")+` and ${s} others`:null}class Gr{constructor(e){this._roomId=e,this._members=new Map}async calculateChanges(e,t,s){const i=new Map,r=[];for(const o of this._members.keys())e.indexOf(o)===-1&&r.push(o);for(const[o,a]of t.entries())(this._members.has(o)||e.indexOf(o)!==-1)&&i.set(o,a.member);for(const o of e)if(!this._members.has(o)&&!i.has(o)){const a=await s.roomMembers.get(this._roomId,o);if(a){const c=new P(a);i.set(c.userId,c)}}return{updatedHeroMembers:i.values(),removedUserIds:r}}applyChanges({updatedHeroMembers:e,removedUserIds:t},s,i){for(const o of t)this._members.delete(o);for(const o of e)t.includes(o.userId)||this._members.set(o.userId,o);const r=Array.from(this._members.values()).sort((o,a)=>o.name.localeCompare(a.name));this._roomName=yr(r,s,i)}get roomName(){return this._roomName}get roomAvatarUrl(){if(this._members.size===1)for(const e of this._members.values())return e.avatarUrl;return null}get roomAvatarColorId(){if(this._members.size===1)for(const e of this._members.keys())return e;return null}}class n_{constructor(e){this._map=new Map,this._notifyEmpty=e}observe(e,t=null){let s=this._map.get(e);return s||(s=new o_(this,t,e),this._map.set(e,s)),s}updateEvents(e){for(let t=0;t<e.length;t+=1){const s=e[t];this._map.get(s.id)?.update(s)}}_remove(e){this._map.delete(e),this._map.size===0&&this._notifyEmpty()}}class o_ extends Oe{constructor(e,t,s){super(),this._eventMap=e,this._entry=t,this._id=s,Promise.resolve().then(()=>{this.hasSubscriptions||(this._eventMap._remove(this._id),this._eventMap=null)})}subscribe(e){if(!this._eventMap)throw new Error("ObservedEvent expired, subscribe right after calling room.observeEvent()");return super.subscribe(e)}onUnsubscribeLast(){this._eventMap._remove(this._id),this._eventMap=null,super.onUnsubscribeLast()}update(e){this._entry=e,this.emit(this._entry)}get(){return this._entry}}function a_(n){return n||Nl.item}const c_="m.room.power_levels";class oi{constructor({powerLevelEvent:e,createEvent:t,ownUserId:s,membership:i}){this._plEvent=e,this._createEvent=t,this._ownUserId=s,this._membership=i}canRedactFromSender(e){return e===this._ownUserId&&this._membership==="join"?!0:this.canRedact}canSendType(e){return this._myLevel>=this._getEventTypeLevel(e)}get canRedact(){return this._myLevel>=this._getActionLevel("redact")}get _myLevel(){return this._membership!=="join"?Number.MIN_SAFE_INTEGER:this.getUserLevel(this._ownUserId)}getUserLevel(e){if(this._plEvent){let t=this._plEvent.content?.users?.[e];if(typeof t!="number"&&(t=this._plEvent.content?.users_default),typeof t=="number")return t}else if(this._createEvent&&e===this._createEvent.content?.creator)return 100;return 0}_getActionLevel(e){const t=this._plEvent?.content[e];return typeof t=="number"?t:50}_getEventTypeLevel(e){const t=this._plEvent?.content?.events?.[e];if(typeof t=="number")return t;{const s=this._plEvent?.content?.events_default;return typeof s=="number"?s:0}}}class l_ extends ct{constructor(e){super(),this.type=e}async load(e,t){const s=await t.roomState.getAllForType(e,this.type);for(let i=0;i<s.length;++i){const{event:r}=s[i];this.add(r.state_key,r)}}handleStateEvent(e){e.type===this.type&&this.set(e.state_key,e)}setRemoveCallback(e){this.removeCallback=e}onUnsubscribeLast(){this.removeCallback?.()}}class h_ extends Oe{constructor(e,t){super(),this.type=e,this.stateKey=t}async load(e,t){this.event=(await t.roomState.get(e,this.type,this.stateKey))?.event}handleStateEvent(e){e.type===this.type&&e.state_key===this.stateKey&&(this.event=e,this.emit(this.get()))}get(){return this.event}setRemoveCallback(e){this.removeCallback=e}onUnsubscribeLast(){this.removeCallback?.()}}const d_="m.room.encrypted";class ic extends Nt{constructor({roomId:e,storage:t,hsApi:s,mediaRepository:i,emitCollectionChange:r,user:o,createRoomEncryption:a,getSyncToken:c,platform:l}){super(),this._roomId=e,this._storage=t,this._hsApi=s,this._mediaRepository=i,this._summary=new xp(e),this._fragmentIdComparer=new Fp([]),this._emitCollectionChange=r,this._timeline=null,this._user=o,this._changedMembersDuringSync=null,this._memberList=null,this._createRoomEncryption=a,this._roomEncryption=null,this._getSyncToken=c,this._platform=l,this._observedEvents=null,this._roomStateObservers=new Set,this._powerLevels=null,this._powerLevelLoading=null,this._observedMembers=null}async observeStateType(e,t=void 0){const s=new l_(e);return await this._addStateObserver(s,t),s}async observeStateTypeAndKey(e,t,s=void 0){const i=new h_(e,t);return await this._addStateObserver(i,s),i}async _addStateObserver(e,t){t||(t=await this._storage.readTxn([this._storage.storeNames.roomState])),await e.load(this.id,t),this._roomStateObservers.add(e),e.setRemoveCallback(()=>{this._roomStateObservers.delete(e)})}async _eventIdsToEntries(e,t){const s=[];return await Promise.all(e.map(async i=>{const r=await t.timelineEvents.getByEventId(this._roomId,i);r&&s.push(new _e(r,this._fragmentIdComparer))})),s}_getAdditionalTimelineRetryEntries(e,t){let s=this._roomEncryption.filterUndecryptedEventEntriesForKeys(this._timeline.remoteEntries,t);const i=e.reduce((r,o)=>(r.add(o.id),r),new Set);return s=s.filter(r=>!i.has(r.id)),s}async notifyRoomKey(e,t,s){if(!this._roomEncryption)return;const i=await this._storage.readTxn([this._storage.storeNames.timelineEvents,this._storage.storeNames.inboundGroupSessions]);let r=await this._eventIdsToEntries(t,i);if(this._timeline){const o=this._getAdditionalTimelineRetryEntries(r,[e]);r=r.concat(o)}if(r.length){await this._decryptEntries(It.Retry,r,i,s).complete(),this._timeline?.replaceEntries(r);const a=this._summary.data.applyTimelineEntries(r,!1,!1);await this._summary.writeAndApplyData(a,this._storage)&&this._emitUpdate()}}_setEncryption(e){return e&&!this._roomEncryption?(this._roomEncryption=e,this._timeline&&this._timeline.enableEncryption(this._decryptEntries.bind(this,It.Timeline)),!0):!1}_decryptEntries(e,t,s,i=null){return new u_(async(o,a)=>{if(s||(s=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions])),o.cancelled)return;const c=t.filter(_=>_.eventType===d_).map(_=>_.event);if(o.preparation=await this._roomEncryption.prepareDecryptAll(c,null,e,s),o.cancelled)return;const l=await o.preparation.decrypt();if(o.preparation=null,o.cancelled)return;const h=[this._storage.storeNames.groupSessionDecryptions],d=this._isTimelineOpen;d&&h.push(this._storage.storeNames.deviceIdentities);const u=await this._storage.readWriteTxn(h);let p;try{p=await l.write(u,a),d&&await p.verifyKnownSenders(u)}catch(_){throw u.abort(),_}await u.complete(),p.applyToEntries(t),this._observedEvents&&this._observedEvents.updateEvents(t),d&&p.hasUnverifiedSenders&&a.wrapDetached("fetch unknown senders keys",async _=>{const g=await p.fetchAndVerifyRemainingSenders(this._hsApi,_),w=[];g.applyToEntries(t,I=>w.push(I)),this._timeline?.replaceEntries(w),this._observedEvents?.updateEvents(w)})},a_(i))}async _getSyncRetryDecryptEntries(e,t,s){let r=(await Promise.all(e.map(async o=>{const a=await t.getEventIdsForMissingKey(o,s);if(a)return this._eventIdsToEntries(a,s)}))).reduce((o,a)=>a?o.concat(a):o,[]);if(this._timeline){const a=this._getAdditionalTimelineRetryEntries(r,e).map(c=>c.clone());r=r.concat(a)}return r}async load(e,t,s){s.set("id",this.id);try{if(e&&this._summary.load(e),this._summary.data.encryption){const i=this._createRoomEncryption(this,this._summary.data.encryption);this._setEncryption(i)}if(this._summary.data.needsHeroes){this._heroes=new Gr(this._roomId);const i=await this._heroes.calculateChanges(this._summary.data.heroes,[],t);this._heroes.applyChanges(i,this._summary.data,s)}}catch(i){throw new Ho(`Could not load room ${this._roomId}`,i)}}async observeMember(e){this._observedMembers||(this._observedMembers=new Map);const t=this._observedMembers.get(e);if(t)return t;const s=await e_({summary:this._summary,roomId:this._roomId,userId:e,storage:this._storage,hsApi:this._hsApi},this._platform.logger);if(!s)return null;const i=new ci(s,()=>this._observedMembers.delete(e));return this._observedMembers.set(e,i),i}async loadMemberList(e=void 0,t=null){if(this._memberList)return this._memberList.retain(),this._memberList;{const s=await Zp({summary:this._summary,roomId:this._roomId,hsApi:this._hsApi,storage:this._storage,txn:e,syncToken:this._getSyncToken(),setChangedMembersMap:i=>this._changedMembersDuringSync=i,log:t},this._platform.logger);return this._memberList=new r_({members:s,closeCallback:()=>{this._memberList=null}}),this._memberList}}fillGap(e,t,s=null){return this._platform.logger.wrapOrRun(s,"fillGap",async i=>{if(i.set("id",this.id),i.set("fragment",e.fragmentId),i.set("dir",e.direction.asApiString()),e.edgeReached){i.set("edgeReached",!0);return}const r=await this._hsApi.messages(this._roomId,{from:e.token,dir:e.direction.asApiString(),limit:t,filter:{lazy_load_members:!0,include_redundant_members:!0}},{log:i}).response(),o=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents,this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineRelations,this._storage.storeNames.timelineFragments]);let a,c;try{a=await this._writeGapFill(r.chunk,o,i);const l=new Za({roomId:this._roomId,fragmentIdComparer:this._fragmentIdComparer,ownUserId:this._user.id});c=await new zp({roomId:this._roomId,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer,relationWriter:l}).writeFragmentFill(e,r,e.token,o,i)}catch(l){throw o.abort(),l}await o.complete(),this._roomEncryption&&await this._decryptEntries(It.Timeline,c.entries,null,i).complete();for(const l of c.fragments)this._fragmentIdComparer.add(l);a&&this._applyGapFill(a),this._timeline&&(this._timeline.replaceEntries(c.updatedEntries),this._timeline.addEntries(c.entries))})}async _writeGapFill(e,t,s){}_applyGapFill(){}get name(){if(this._heroes)return this._heroes.roomName;const e=this._summary.data;return e.name?e.name:e.canonicalAlias?e.canonicalAlias:null}get id(){return this._roomId}get avatarUrl(){return this._summary.data.avatarUrl?this._summary.data.avatarUrl:this._heroes?this._heroes.roomAvatarUrl:null}get avatarColorId(){return this._roomId}get lastMessageTimestamp(){return this._summary.data.lastMessageTimestamp}get isLowPriority(){const e=this._summary.data.tags;return!!(e&&e["m.lowpriority"])}get isEncrypted(){return!!this._summary.data.encryption}get isJoined(){return this.membership==="join"}get isLeft(){return this.membership==="leave"}get canonicalAlias(){return this._summary.data.canonicalAlias}get joinedMemberCount(){return this._summary.data.joinCount}get mediaRepository(){return this._mediaRepository}get membership(){return this._summary.data.membership}get user(){return this._user}isDirectMessageForUserId(e){if(this._summary.data.dmUserId===e)return!0;{const{heroes:t,joinCount:s,inviteCount:i}=this._summary.data;if(t&&t.includes(e)&&s+i===2)return!0}return!1}async _loadPowerLevels(){const e=await this._storage.readTxn([this._storage.storeNames.roomState]),t=await e.roomState.get(this._roomId,"m.room.power_levels","");if(t)return new oi({powerLevelEvent:t.event,ownUserId:this._user.id,membership:this.membership});const s=await e.roomState.get(this._roomId,"m.room.create","");if(s)return new oi({createEvent:s.event,ownUserId:this._user.id,membership:this.membership});{const i=this.membership;return new oi({ownUserId:this._user.id,membership:i})}}async observePowerLevels(){this._powerLevelLoading&&await this._powerLevelLoading;let e=this._powerLevels;if(!e){this._powerLevelLoading=this._loadPowerLevels();const t=await this._powerLevelLoading;e=new ci(t,()=>{this._powerLevels=null}),this._powerLevels=e,this._powerLevelLoading=null}return e}enableKeyBackup(e){this._roomEncryption?.enableKeyBackup(e),this._timeline&&e&&this._platform.logger.run("enableKeyBackup",t=>this._roomEncryption.restoreMissingSessionsFromBackup(this._timeline.remoteEntries,t))}get _isTimelineOpen(){return!!this._timeline}_emitUpdate(){this.emit("change"),this._emitCollectionChange(this)}openTimeline(e=null){return this._platform.logger.wrapOrRun(e,"open timeline",async t=>{if(t.set("id",this.id),this._timeline)throw new Error("not dealing with load race here for now");this._timeline=new _i({roomId:this.id,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer,pendingEvents:this._getPendingEvents(),closeCallback:()=>{this._timeline=null,this._roomEncryption&&this._roomEncryption.notifyTimelineClosed()},clock:this._platform.clock,logger:this._platform.logger,powerLevelsObservable:await this.observePowerLevels(),hsApi:this._hsApi});try{this._roomEncryption&&this._timeline.enableEncryption(this._decryptEntries.bind(this,It.Timeline)),await this._timeline.load(this._user,this.membership,t)}catch(s){throw this._timeline.dispose(),s}return this._timeline})}_getPendingEvents(){return null}observeEvent(e){this._observedEvents||(this._observedEvents=new n_(()=>{this._observedEvents=null}));let t=null;this._timeline&&(t=this._timeline.getByEventId(e));const s=this._observedEvents.observe(e,t);return t||this._readEventById(e).then(i=>{s.update(i)}).catch(i=>{console.warn(`could not load event ${e} from storage`,i)}),s}async _readEventById(e){return await new sc({roomId:this._roomId,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer}).readById(e)}dispose(){this._roomEncryption?.dispose(),this._timeline?.dispose()}}class u_{constructor(e,t){this._cancelled=!1,this.preparation=null,this._promise=t.wrap("decryptEntries",s=>e(this,s))}complete(){return this._promise}get cancelled(){return this._cancelled}dispose(){this._cancelled=!0,this.preparation&&this.preparation.dispose()}}function Jt(n,e){return Jr(n,e,()=>[],(t,s)=>t.push(s))}function Jr(n,e,t,s){return n.reduce((i,r)=>{const o=e(r);let a=i.get(o);return a||(a=t(),i.set(o,a)),s(a,r),i},new Map)}function go(n,e){return n.reduce((t,s)=>{const i=e(s);return t[i]?t[i]+=1:t[i]=1,t},{})}function Cs(){return gi("t")}function gi(n){const t=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16);return n+"0".repeat(14-t.length)+t}function fo(n){return n.startsWith("t")&&n.length===15}function wr(n){const e=Jt(n,s=>s.device.userId);return{messages:Array.from(e.entries()).reduce((s,[i,r])=>(s[i]=r.reduce((o,a)=>(o[a.device.deviceId]=a.content,o),{}),s),{})}}class m_ extends Nt{constructor({roomId:e,storage:t,hsApi:s,pendingEvents:i}){super(),i=i||[],this._roomId=e,this._storage=t,this._hsApi=s,this._pendingEvents=new Ar((r,o)=>r.queueIndex-o.queueIndex),this._pendingEvents.setManyUnsorted(i.map(r=>this._createPendingEvent(r))),this._isSending=!1,this._offline=!1,this._roomEncryption=null,this._currentQueueIndex=0}addExistingPendingEvent(e){this._pendingEvents.set(this._createPendingEvent(e))}removePendingEvents(e){for(const t of e){const s=this._pendingEvents.array.findIndex(i=>i.remoteId===t.remoteId);if(s!==-1){const i=this._pendingEvents.get(s);this._pendingEvents.remove(s),i.dispose()}}}_createPendingEvent(e,t=null){const s=new sp({data:e,remove:()=>this._removeEvent(s),emitUpdate:i=>this._pendingEvents.update(s,i),attachments:t});return s}enableEncryption(e){this._roomEncryption=e}_sendLoop(e){this._isSending=!0,this._sendLoopLogItem=e.runDetached("send queue flush",async t=>{try{for(const s of this._pendingEvents)await t.wrap("send event",async i=>{i.set("queueIndex",s.queueIndex);try{this._currentQueueIndex=s.queueIndex,await this._sendEvent(s,i),this.emit("pendingEvent",s)}catch(r){r instanceof Ge?(this._offline=!0,i.set("offline",!0),s.setWaiting()):(i.catch(r),r.name==="HomeServerError"&&(r.statusCode===400||r.statusCode===403||r.statusCode===404)?(i.set("remove",!0),await s.abort()):s.setError(r))}finally{this._currentQueueIndex=0}})}finally{this._isSending=!1,this._sendLoopLogItem=null}})}async _sendEvent(e,t){if(e.needsUpload&&(await t.wrap("upload attachments",s=>e.uploadAttachments(this._hsApi,s)),await this._tryUpdateEvent(e)),e.needsEncryption){e.setEncrypting();const s=e.contentForEncryption,{type:i,content:r}=await t.wrap("encrypt",o=>this._roomEncryption.encrypt(e.eventType,s,this._hsApi,o));e.setEncrypted(i,r),await this._tryUpdateEvent(e)}if(e.needsSending){await e.send(this._hsApi,t);const s=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{await this._tryUpdateEventWithTxn(e,s),await this._resolveRemoteIdInPendingRelations(e.txnId,e.remoteId,s)}catch(i){throw s.abort(),i}await s.complete()}}async _resolveRemoteIdInPendingRelations(e,t,s){const i=this._pendingEvents.array.filter(r=>r.relatedTxnId===e&&r.relatedEventId!==t);for(const r of i)r.setRelatedEventId(t),await this._tryUpdateEventWithTxn(r,s);return i}async removeRemoteEchos(e,t,s){const i=[];for(const r of e){const o=r.unsigned&&r.unsigned.transaction_id;let a;if(o?a=this._pendingEvents.array.findIndex(c=>c.txnId===o):a=this._pendingEvents.array.findIndex(c=>c.remoteId===r.event_id),a!==-1){const c=this._pendingEvents.get(a),l=r.event_id;s.log({l:"removeRemoteEcho",queueIndex:c.queueIndex,remoteId:l,txnId:o}),t.pendingEvents.remove(c.roomId,c.queueIndex),i.push(c),await this._resolveRemoteIdInPendingRelations(o,l,t)}}return i}async _removeEvent(e){if(this._pendingEvents.array.indexOf(e)!==-1){const s=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{s.pendingEvents.remove(e.roomId,e.queueIndex)}catch{s.abort()}await s.complete();const i=this._pendingEvents.array.indexOf(e);i!==-1&&this._pendingEvents.remove(i)}e.dispose()}emitRemovals(e){for(const t of e){const s=this._pendingEvents.array.indexOf(t);s!==-1&&this._pendingEvents.remove(s),t.dispose()}}resumeSending(e){this._offline=!1,this._pendingEvents.length&&e.wrap("resumeSending",t=>{t.set("id",this._roomId),t.set("pendingEvents",this._pendingEvents.length),this._isSending||this._sendLoop(t),this._sendLoopLogItem&&t.refDetached(this._sendLoopLogItem)})}async enqueueEvent(e,t,s,i){const r=ut(t);let o=null;if(r){const a=Hr(r);if(fo(a)&&(o=a,Wa(r,null)),r.rel_type===lt&&this._pendingEvents.array.some(l=>{const h=ut(l.content);return l.eventType===e&&h&&h.key===r.key&&(l.relatedTxnId===o||h.event_id===r.event_id)})){i.set("already_annotating",!0);return}}await this._enqueueEvent(e,t,s,o,null,i)}async _enqueueEvent(e,t,s,i,r,o){const a=await this._createAndStoreEvent(e,t,i,r,s);this._pendingEvents.set(a),o.set("queueIndex",a.queueIndex),o.set("pendingEvents",this._pendingEvents.length),!this._isSending&&!this._offline&&this._sendLoop(o),this._sendLoopLogItem&&o.refDetached(this._sendLoopLogItem)}async enqueueRedaction(e,t,s){if(this._pendingEvents.array.some(a=>a.eventType===Pe&&(a.relatedTxnId===e||a.relatedEventId===e))){s.set("already_redacting",!0);return}let r,o;if(fo(e)){r=e;const a=e,c=this._pendingEvents.array.find(l=>l.txnId===a);if(c&&!c.remoteId&&c.status!==F.Sending){s.set("remove",r),await c.abort();return}else if(c)o=c.remoteId;else return}else{o=e;const a=this._pendingEvents.array.find(c=>c.remoteId===o);a&&(r=a.txnId)}s.set("relatedTxnId",r),s.set("relatedEventId",o),await this._enqueueEvent(Pe,{reason:t},null,r,o,s)}get pendingEvents(){return this._pendingEvents}async _tryUpdateEvent(e){const t=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{this._tryUpdateEventWithTxn(e,t)}catch(s){throw t.abort(),s}await t.complete()}async _tryUpdateEventWithTxn(e,t){await t.pendingEvents.exists(e.roomId,e.queueIndex)&&t.pendingEvents.update(e.data)}async _createAndStoreEvent(e,t,s,i,r){const o=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);let a;try{const c=o.pendingEvents,l=await c.getMaxQueueIndex(this._roomId)||0,d=Math.max(l,this._currentQueueIndex)+1,u=e!==Pe&&e!==zm&&!!this._roomEncryption;a=this._createPendingEvent({roomId:this._roomId,queueIndex:d,eventType:e,content:t,relatedTxnId:s,relatedEventId:i,txnId:Cs(),needsEncryption:u,needsUpload:!!r},r),c.add(a.data)}catch(c){throw o.abort(),c}return await o.complete(),a}dispose(){for(const e of this._pendingEvents)e.dispose()}}class rc{constructor({filename:e,blob:t,platform:s}){this._filename=e,this._unencryptedBlob=t,this._transferredBlob=this._unencryptedBlob,this._platform=s,this._mxcUrl=null,this._encryptionInfo=null,this._uploadRequest=null,this._aborted=!1,this._error=null,this._sentBytes=0}get size(){return this._transferredBlob.size}get sentBytes(){return this._sentBytes}abort(){this._uploadRequest?.abort()}get localPreview(){return this._unencryptedBlob}async encrypt(){if(this._encryptionInfo)throw new Error("already encrypted");const{info:e,blob:t}=await bp(this._platform,this._transferredBlob);this._transferredBlob=t,this._encryptionInfo=e}async upload(e,t,s){this._uploadRequest=e.uploadAttachment(this._transferredBlob,this._filename,{uploadProgress:r=>{this._sentBytes=r,t()},log:s});const{content_uri:i}=await this._uploadRequest.response();this._mxcUrl=i}applyToContent(e,t){if(!this._mxcUrl)throw new Error("upload has not finished");let s=e.substr(0,e.lastIndexOf("url"));Zs(`${s}info.size`,t,this._transferredBlob.size),Zs(`${s}info.mimetype`,t,this._unencryptedBlob.mimeType),this._encryptionInfo?Zs(`${s}file`,t,Object.assign(this._encryptionInfo,{mimetype:this._unencryptedBlob.mimeType,url:this._mxcUrl})):Zs(`${s}url`,t,this._mxcUrl)}dispose(){this._unencryptedBlob.dispose(),this._transferredBlob.dispose()}}function Zs(n,e,t){const s=n.split(".");let i=e;for(let o=0;o<s.length-1;o+=1){const a=s[o];i[a]||(i[a]={}),i=i[a]}const r=s[s.length-1];i[r]=t}const p_="m.room.encrypted";class yo extends ic{constructor(e){super(e),this._roomStateHandler=e.roomStateHandler,this._sendQueue=e.sendQueue;const t=new Za({roomId:this.id,fragmentIdComparer:this._fragmentIdComparer,ownUserId:this._user.id});this._syncWriter=new qp({roomId:this.id,fragmentIdComparer:this._fragmentIdComparer,relationWriter:t,memberWriter:new Wp(this.id)})}_setEncryption(e){return super._setEncryption(e)?(this._sendQueue.enableEncryption(this._roomEncryption),!0):!1}get sendQueue(){return this._sendQueue}async prepareSync(e,t,s,i,r){r.set("id",this.id),s&&r.set("newKeys",s.length);let o=this._summary.data.applySyncResponse(e,t,this._user.id),a=this._roomEncryption;!a&&o.encryption&&(r.set("enableEncryption",!0),a=this._createRoomEncryption(this,o.encryption));let c,l;if(a){let h=e?.timeline?.events||[];s&&(c=await this._getSyncRetryDecryptEntries(s,a,i),c.length&&(r.set("retry",c.length),h=h.concat(c.map(d=>d.event)))),h=h.filter(d=>d?.type===p_),h.length&&(l=await a.prepareDecryptAll(h,s,It.Sync,i))}return{roomEncryption:a,summaryChanges:o,decryptPreparation:l,decryptChanges:null,retryEntries:c}}async afterPrepareSync(e,t){e.decryptPreparation&&await t.wrap("decrypt",async s=>{s.set("id",this.id),e.decryptChanges=await e.decryptPreparation.decrypt(),e.decryptPreparation=null},t.level.Detail)}async writeSync(e,t,{summaryChanges:s,decryptChanges:i,roomEncryption:r,retryEntries:o},a,c){c.set("id",this.id);const l=s.isNewJoin(this._summary.data);l&&(a.roomState.removeAllForRoom(this.id),a.roomMembers.removeAllForRoom(this.id));const{entries:h,updatedEntries:d,newLiveKey:u,memberChanges:p,memberSync:_}=await c.wrap("syncWriter",R=>this._syncWriter.writeSync(e,l,s.hasFetchedMembers,a,R),c.level.Detail);let g;i&&(g=await c.wrap("decryptChanges",R=>i.write(a,R)),c.set("decryptionResults",g.results.size),c.set("decryptionErrors",g.errors.size),this._isTimelineOpen&&await g.verifyKnownSenders(a),g.applyToEntries(h),o?.length&&(g.applyToEntries(o),d.push(...o))),c.set("newEntries",h.length),c.set("updatedEntries",d.length);let w;r&&(w=await r.writeSync(e,p,a,c),c.set("shouldFlushKeyShares",w.shouldFlush));const I=h.concat(d);s=s.applyTimelineEntries(I,t,!this._isTimelineOpen,this._user.id),s.membership!=="join"?a.roomSummary.remove(this.id):s=this._summary.writeData(s,a),s&&c.set("summaryChanges",s.changedKeys(this._summary.data));let E;s?.needsHeroes&&(this._heroes||(this._heroes=new Gr(this._roomId)),E=await this._heroes.calculateChanges(s.heroes,p,a));let A;Array.isArray(e.timeline?.events)&&(A=await this._sendQueue.removeRemoteEchos(e.timeline.events,a,c));const v=this._getPowerLevelsEvent(e);return await this._runRoomStateHandlers(e,_,a,c),{roomResponse:e,summaryChanges:s,roomEncryption:r,newEntries:h,updatedEntries:d,newLiveKey:u,removedPendingEvents:A,memberChanges:p,heroChanges:E,powerLevelsEvent:v,encryptionChanges:w,decryption:g}}afterSync(e,t){const{summaryChanges:s,newEntries:i,updatedEntries:r,newLiveKey:o,removedPendingEvents:a,memberChanges:c,powerLevelsEvent:l,heroChanges:h,roomEncryption:d,roomResponse:u,encryptionChanges:p}=e;if(t.set("id",this.id),this._syncWriter.afterSync(o),this._setEncryption(d),this._roomEncryption&&this._roomEncryption.afterSync(p),c.size){if(this._changedMembersDuringSync)for(const[g,w]of c.entries())this._changedMembersDuringSync.set(g,w.member);if(this._memberList&&this._memberList.afterSync(c),this._roomStateHandler.updateRoomMembers(this,c),this._observedMembers&&this._updateObservedMembers(c),this._timeline){for(const[g,w]of c.entries())if(g===this._user.id){this._timeline.updateOwnMember(w.member);break}}}let _=!1;if(s&&(this._summary.applyChanges(s),this._summary.data.needsHeroes||(this._heroes=null),_=!0),this._heroes&&h){const g=this.name;this._heroes.applyChanges(h,this._summary.data,t),g!==this.name&&(_=!0)}l&&this._updatePowerLevels(l),_&&this._emitUpdate(),this._timeline&&(this._timeline.replaceEntries(r),this._timeline.addEntries(i)),this._observedEvents&&(this._observedEvents.updateEvents(r),this._observedEvents.updateEvents(i)),a&&this._sendQueue.emitRemovals(a),this._emitSyncRoomState(u)}_updateObservedMembers(e){for(const[t,s]of e){const i=this._observedMembers.get(t);i&&i.set(s.member)}}_getPowerLevelsEvent(e){let t;return qt(e,s=>{s.state_key===""&&s.type===c_&&(t=s)}),t}_updatePowerLevels(e){if(this._powerLevels){const t=new oi({powerLevelEvent:e,ownUserId:this._user.id,membership:this.membership});this._powerLevels.set(t)}}async afterSyncCompleted({encryptionChanges:e,decryption:t,newEntries:s,updatedEntries:i},r){const o=e?.shouldFlush,a=this._isTimelineOpen&&t?.hasUnverifiedSenders;(o||a)&&await r.wrap({l:"room",id:this.id},async c=>{const l=[];if(o&&l.push(this._roomEncryption.flushPendingRoomKeyShares(this._hsApi,null,c)),a){const h=c.wrap("verify senders",async d=>{const u=await t.fetchAndVerifyRemainingSenders(this._hsApi,d),p=[],_=g=>p.push(g);u.applyToEntries(s,_),u.applyToEntries(i,_),d.set("verifiedEntries",p.length),this._timeline?.replaceEntries(p),this._observedEvents?.updateEvents(p)});l.push(h)}await Promise.all(l)})}start(e,t){if(this._roomEncryption){const s=e?.get("share_room_key");s&&t.wrapDetached("flush room keys",i=>(i.set("id",this.id),this._roomEncryption.flushPendingRoomKeyShares(this._hsApi,s,i)))}this._sendQueue.resumeSending(t)}async load(e,t,s){try{await super.load(e,t,s),await this._syncWriter.load(t,s)}catch(i){throw new Ho(`Could not load room ${this._roomId}`,i)}}async _writeGapFill(e,t,s){return await this._sendQueue.removeRemoteEchos(e,t,s)}_applyGapFill(e){this._sendQueue.emitRemovals(e)}sendEvent(e,t,s,i=null){return this._platform.logger.wrapOrRun(i,"send",r=>(r.set("id",this.id),this._sendQueue.enqueueEvent(e,t,s,r)))}sendRedaction(e,t,s=null){return this._platform.logger.wrapOrRun(s,"redact",i=>(i.set("id",this.id),this._sendQueue.enqueueRedaction(e,t,i)))}async ensureMessageKeyIsShared(e=null){if(!!this._roomEncryption)return this._platform.logger.wrapOrRun(e,"ensureMessageKeyIsShared",t=>(t.set("id",this.id),this._roomEncryption.ensureMessageKeyIsShared(this._hsApi,t)))}get avatarColorId(){return this._heroes?.roomAvatarColorId||this._roomId}get isUnread(){return this._summary.data.isUnread}get notificationCount(){return this._summary.data.notificationCount}get highlightCount(){return this._summary.data.highlightCount}get isTrackingMembers(){return this._summary.data.isTrackingMembers}async _getLastEventId(){const e=this._syncWriter.lastMessageKey;if(e)return(await(await this._storage.readTxn([this._storage.storeNames.timelineEvents])).timelineEvents.get(this._roomId,e))?.event?.event_id}async clearUnread(e=null){if(this.isUnread||this.notificationCount)return await this._platform.logger.wrapOrRun(e,"clearUnread",async t=>{t.set("id",this.id);const s=await this._storage.readWriteTxn([this._storage.storeNames.roomSummary]);let i;try{i=this._summary.writeClearUnread(s)}catch(r){throw s.abort(),r}await s.complete(),this._summary.applyChanges(i),this._emitUpdate();try{const r=await this._getLastEventId();r&&await this._hsApi.receipt(this._roomId,"m.read",r)}catch(r){if(r.name!=="ConnectionError")throw r}})}leave(e=null){return this._platform.logger.wrapOrRun(e,"leave room",async t=>{t.set("id",this.id),await this._hsApi.leave(this.id,{log:t}).response()})}_getPendingEvents(){return this._sendQueue.pendingEvents}_runRoomStateHandlers(e,t,s,i){const r=[];return qt(e,o=>{r.push(this._roomStateHandler.handleRoomState(this,o,t,s,i))}),Promise.all(r)}_emitSyncRoomState(e){qt(e,t=>{for(const s of this._roomStateObservers)s.handleStateEvent(t)})}writeIsTrackingMembers(e,t){return this._summary.writeIsTrackingMembers(e,t)}applyIsTrackingMembersChanges(e){this._summary.applyChanges(e)}createAttachment(e,t){return new rc({blob:e,filename:t,platform:this._platform})}dispose(){super.dispose(),this._sendQueue.dispose()}}class __ extends ic{constructor(e){super(e),this._releaseCallback=e.releaseCallback,this._forgetCallback=e.forgetCallback,this._retentionCount=1,this._kickDetails=null,this._kickedBy=null}retain(){this._retentionCount+=1}release(){this._retentionCount-=1,this._retentionCount===0&&this._releaseCallback()}async _getKickAuthor(e,t){const s=await t.roomMembers.get(this.id,e);return s?new P(s):P.fromUserId(this.id,e,"join")}async load(e,t,s){const{summary:i,kickDetails:r}=e;return this._kickDetails=r,this._kickDetails&&(this._kickedBy=await this._getKickAuthor(this._kickDetails.sender,t)),super.load(i,t,s)}async writeSync(e,t,s,i,r){if(r.set("id",this.id),s==="leave"){const o=g_(t,this._user.id);if(o||e){const a=o||this._kickDetails;let c;o&&(c=await this._getKickAuthor(o.sender,i));const l=e||this._summary.data;return i.archivedRoomSummary.set({summary:l.serialize(),kickDetails:a}),{kickDetails:a,kickedBy:c,summaryData:l}}}else s==="join"&&i.archivedRoomSummary.remove(this.id);return{}}afterSync({summaryData:e,kickDetails:t,kickedBy:s},i){i.set("id",this.id),e&&this._summary.applyChanges(e),t&&(this._kickDetails=t),s&&(this._kickedBy=s),this._emitUpdate()}get isKicked(){return this._kickDetails?.membership==="leave"}get isBanned(){return this._kickDetails?.membership==="ban"}get kickedBy(){return this._kickedBy}get kickReason(){return this._kickDetails?.reason}isArchived(){return!0}forget(e=null){return this._platform.logger.wrapOrRun(e,"forget room",async t=>{t.set("id",this.id),await this._hsApi.forget(this.id,{log:t}).response();const s=this._storage.storeNames,i=await this._storage.readWriteTxn([s.roomState,s.archivedRoomSummary,s.roomMembers,s.timelineEvents,s.timelineFragments,s.timelineRelations,s.pendingEvents,s.inboundGroupSessions,s.groupSessionDecryptions,s.operations]);i.roomState.removeAllForRoom(this.id),i.archivedRoomSummary.remove(this.id),i.roomMembers.removeAllForRoom(this.id),i.timelineEvents.removeAllForRoom(this.id),i.timelineFragments.removeAllForRoom(this.id),i.timelineRelations.removeAllForRoom(this.id),i.pendingEvents.removeAllForRoom(this.id),i.inboundGroupSessions.removeAllForRoom(this.id),i.groupSessionDecryptions.removeAllForRoom(this.id),await i.operations.removeAllForScope(this.id),await i.complete(),this._retentionCount=0,this._releaseCallback(),this._forgetCallback(this.id)})}join(e=null){return this._platform.logger.wrapOrRun(e,"rejoin archived room",async t=>{await this._hsApi.join(this.id,{log:t}).response()})}}function g_(n,e){let t;if(qt(n,s=>{s.type===ge&&s.state_key===e&&s.sender!==s.state_key&&(t=s)}),t)return{membership:t.content?.membership,reason:t.content?.reason,sender:t.sender}}async function f_(n,e,t){const s=await Promise.all(n.map(async i=>{const r=await e.profile(i,{log:t}).response();return new y_(i,r.displayname,r.avatar_url)}));return s.sort((i,r)=>i.name.localeCompare(r.name)),s}class y_{constructor(e,t,s){this.userId=e,this.displayName=t,this.avatarUrl=s}get name(){return this.displayName||this.userId}}class w_{constructor(e){this.userId=e}get displayName(){}get name(){return this.userId}get avatarUrl(){}}function v_(n){switch(n){case ve.DirectMessage:case ve.Private:return!0;case ve.Public:return!1}}function b_(n){switch(n){case ve.DirectMessage:return"trusted_private_chat";case ve.Private:return"private_chat";case ve.Public:return"public_chat"}}class S_ extends Nt{constructor(e,t,s,i,r,o){if(super(),this.id=e,this.options=t,this.updateCallback=s,this.mediaRepository=i,this.platform=r,this.profiles=[],this._isCancelled=!1,this.isEncrypted=t.isEncrypted===void 0?v_(t.type):t.isEncrypted,t.name)this._calculatedName=t.name;else{const a={joinCount:1,inviteCount:t.invites?.length||0},c=(t.invites||[]).map(l=>new w_(l));this._calculatedName=yr(c,a,o)}}async create(e,t){try{let s;if(this.options.avatar){const{avatar:o}=this.options,a=new rc({filename:o.name,blob:o.blob,platform:this.platform});await a.upload(e,()=>{},t),s={info:o.info},a.applyToContent("url",s)}const i={is_direct:this.options.type===ve.DirectMessage,preset:b_(this.options.type),initial_state:[]};this.options.name&&(i.name=this.options.name),this.options.topic&&(i.topic=this.options.topic),this.options.invites&&(i.invite=this.options.invites),this.options.alias&&(i.room_alias_name=this.options.alias),this.options.isFederationDisabled===!0&&(i.creation_content={"m.federate":!1}),this.options.powerLevelContentOverride&&(i.power_level_content_override=this.options.powerLevelContentOverride),this.isEncrypted&&i.initial_state.push(Yl()),s&&i.initial_state.push({type:"m.room.avatar",state_key:"",content:s});const r=await e.createRoom(i,{log:t}).response();this._roomId=r.room_id}catch(s){this._error=s}this.emitChange()}async loadProfiles(e,t){try{if(!this.options.name&&this.options.invites){this.profiles=await f_(this.options.invites,e,t);const s={joinCount:1,inviteCount:this.options.invites.length};this._calculatedName=yr(this.profiles,s,t),this.emitChange()}}catch{}}emitChange(e){this.updateCallback(this,e),this.emit("change")}get avatarColorId(){return this.options.invites?.[0]??this._roomId??this.id}get avatarUrl(){return this.profiles?.[0]?.avatarUrl}get avatarBlobUrl(){return this.options.avatar?.blob?.url}get roomId(){return this._roomId}get name(){return this._calculatedName}get isBeingCreated(){return!0}get error(){return this._error}cancel(){this._isCancelled||(this.dispose(),this._isCancelled=!0,this.emitChange("isCancelled"))}get isCancelled(){return this._isCancelled}dispose(){this.options.avatar&&this.options.avatar.blob.dispose()}async adjustDirectMessageMapIfNeeded(e,t,s,i){if(!this.options.invites||this.options.type!==ve.DirectMessage)return;const r=this.options.invites[0],o="m.direct";await i.wrap("set "+o,async a=>{try{const c=await t.readWriteTxn([t.storeNames.accountData]);let l;try{l=await c.accountData.get(o),l||(l={type:o,content:{}});const h=l.content;let d=h[r];d||(h[r]=d=[]),d.push(this._roomId),c.accountData.set(l),await c.complete()}catch(h){throw c.abort(),h}await s.setAccountData(e.id,o,l.content,{log:a}).response()}catch(c){a.catch(c)}})}}class I_ extends Nt{constructor({roomId:e,user:t,hsApi:s,mediaRepository:i,emitCollectionRemove:r,emitCollectionUpdate:o,platform:a}){super(),this._roomId=e,this._user=t,this._hsApi=s,this._emitCollectionRemove=r,this._emitCollectionUpdate=o,this._mediaRepository=i,this._platform=a,this._inviteData=null,this._accepting=!1,this._rejecting=!1,this._accepted=!1,this._rejected=!1}get isInvite(){return!0}get id(){return this._roomId}get name(){return this._inviteData.name||this._inviteData.canonicalAlias}get isDirectMessage(){return this._inviteData.isDirectMessage}get avatarUrl(){return this._inviteData.avatarUrl}get avatarColorId(){return this._inviteData.avatarColorId||this.id}get timestamp(){return this._inviteData.timestamp}get isEncrypted(){return this._inviteData.isEncrypted}get inviter(){return this._inviter}isDirectMessageForUserId(e){return this.isDirectMessage&&this._inviter.userId===e}get isPublic(){return this._inviteData.joinRule==="public"}get canonicalAlias(){return this._inviteData.canonicalAlias}async accept(e=null){await this._platform.logger.wrapOrRun(e,"acceptInvite",async t=>{this._accepting=!0,this._emitChange("accepting"),await this._hsApi.join(this._roomId,{log:t}).response()})}async reject(e=null){await this._platform.logger.wrapOrRun(e,"rejectInvite",async t=>{this._rejecting=!0,this._emitChange("rejecting"),await this._hsApi.leave(this._roomId,{log:t}).response()})}get accepting(){return this._accepting}get accepted(){return this._accepted}get rejecting(){return this._rejecting}get rejected(){return this._rejected}get mediaRepository(){return this._mediaRepository}_emitChange(e){this.emit("change"),this._emitCollectionUpdate(this,e)}load(e,t){t.set("id",this.id),this._inviteData=e,this._inviter=e.inviter?new P(e.inviter):null}async writeSync(e,t,s,i){if(e==="invite"){i.set("id",this.id),i.set("add",!0);const r=t.invite_state?.events;if(!Array.isArray(r))return null;const o=this._createSummaryData(r);let a;!o.name&&!o.canonicalAlias&&(a=await this._createHeroes(r,i));const c=this._getMyInvite(r);if(!c)return null;const l=this._getInviter(c,r),h=this._createData(r,c,l,o,a);return s.invites.set(h),{inviteData:h,inviter:l}}else return i.set("id",this.id),i.set("membership",e),s.invites.remove(this.id),{removed:!0,membership:e}}afterSync(e,t){t.set("id",this.id),e&&(e.removed?(this._accepting=!1,this._rejecting=!1,e.membership==="join"?this._accepted=!0:this._rejected=!0,this.emit("change")):(this._inviteData=e.inviteData,this._inviter=e.inviter))}_createData(e,t,s,i,r){const o=r?r.roomName:i.name,a=r?r.roomAvatarUrl:i.avatarUrl,c=r?.roomAvatarColorId||this.id;return{roomId:this.id,isEncrypted:!!i.encryption,isDirectMessage:i.isDirectMessage,name:o,avatarUrl:a,avatarColorId:c,canonicalAlias:i.canonicalAlias,timestamp:this._platform.clock.now(),joinRule:this._getJoinRule(e),inviter:s?.serialize()}}_createSummaryData(e){return e.reduce((t,s)=>Xa(t,s,this._user.id),new qe(null,this.id))}async _createHeroes(e,t){const s=e.filter(h=>h.type===ge),i=s.filter(h=>h.state_key!==this._user.id),r=i.reduce((h,d)=>{const u=P.fromMemberEvent(this.id,d);return h.set(u.userId,new Ur(u,null)),h},new Map),o=i.map(h=>h.state_key),a=new Gr(this.id),c=await a.calculateChanges(o,r,null),l=new qe(null,this.id);return l.joinCount=s.reduce((h,d)=>h+(d.content?.membership==="join"?1:0),0),l.inviteCount=s.reduce((h,d)=>h+(d.content?.membership==="invite"?1:0),0),a.applyChanges(c,l,t),a}_getMyInvite(e){return e.find(t=>t.type===ge&&t.state_key===this._user.id)}_getInviter(e,t){const s=t.find(i=>i.type===ge&&i.state_key===e.sender);if(s)return P.fromMemberEvent(this.id,s)}_getJoinRule(e){const t=e.find(s=>s.type==="m.room.join_rules");return t?t.content?.join_rule:null}}class St{constructor(e){this._description=e}static httpPusher(e,t,s,i){return new St({kind:"http",append:!0,data:Object.assign({},i,{url:e+"/_matrix/push/v1/notify"}),pushkey:s,app_id:t,app_display_name:"Hydrogen",device_display_name:"Hydrogen",lang:"en"})}static createDefaultPayload(e){return{session_id:e}}async enable(e,t){try{t.set("endpoint",new URL(this._description.data.endpoint).host)}catch{t.set("endpoint",null)}await e.setPusher(this._description,{log:t}).response()}async disable(e,t){const s=Object.assign({},this._description,{kind:null});await e.setPusher(s,{log:t}).response()}serialize(){return this._description}equals(e){return this._description.app_id!==e._description.app_id||this._description.pushkey!==e._description.pushkey?!1:JSON.stringify(this._description.data)===JSON.stringify(e._description.data)}}class R_{constructor({storage:e,callHandler:t}){this._storage=e,this._olmDecryption=null,this._megolmDecryption=null,this._callHandler=t,this._senderDeviceCache=new tc(10,s=>s.curve25519Key)}enableEncryption({olmDecryption:e,megolmDecryption:t}){this._olmDecryption=e,this._megolmDecryption=t}obtainSyncLock(e){return this._olmDecryption?.obtainDecryptionLock(e)}async prepareSync(e,t,s,i){i.set("messageTypes",go(e,a=>a.type));const r=e.filter(a=>a.type==="m.room.encrypted");if(!this._olmDecryption){i.log("can't decrypt, encryption not enabled",i.level.Warn);return}const o=r.filter(a=>a.content?.algorithm===Pr);if(o.length){const a=await this._olmDecryption.decryptAll(o,t,s);i.set("decryptedTypes",go(a.results,l=>l.event?.type));for(const l of a.errors)i.child("decrypt_error").catch(l);const c=this._megolmDecryption.roomKeysFromDeviceMessages(a.results,i);return new k_(a,c)}}async writeSync(e,t){return e.olmDecryptChanges.write(t),{hasNewRoomKeys:(await Promise.all(e.newRoomKeys.map(r=>this._megolmDecryption.writeRoomKey(r,t)))).some(r=>!!r),decryptionResults:e.olmDecryptChanges.results}}async afterSyncCompleted(e,t,s,i){if(this._callHandler){const r=e.filter(o=>this._callHandler.handlesDeviceMessageEventType(o.event?.type));r.length&&await i.wrap("process call signalling messages",async o=>{for(const a of r){const c=await t.deviceForId(a.event.sender,a.event.content.device_id,s,o);a.setDevice(c),a.isVerified?this._callHandler.handleDeviceMessage(a.event,a.userId,a.deviceId,o):o.log({l:"could not verify olm fingerprint key matches, ignoring",ed25519Key:a.device.ed25519Key,claimedEd25519Key:a.claimedEd25519Key,deviceId:c.deviceId,userId:c.userId})}})}}}class k_{constructor(e,t){this.olmDecryptChanges=e,this.newRoomKeys=t,this.newKeysByRoom=Jt(t,s=>s.roomId)}}const _s=we+"olmAccount",vr=we+"areDeviceKeysUploaded",ai=we+"serverOTKCount";async function wo(n,e,t,s,i){const r=n.pickle(e),o=await i.readWriteTxn([i.storeNames.session]);try{o.session.add(_s,r),o.session.add(vr,t),o.session.add(ai,s)}catch(a){throw o.abort(),a}await o.complete()}class At{static async load({olm:e,pickleKey:t,hsApi:s,userId:i,deviceId:r,olmWorker:o,txn:a}){const c=await a.session.get(_s);if(c){const l=new e.Account,h=await a.session.get(vr);l.unpickle(t,c);const d=await a.session.get(ai);return new At({pickleKey:t,hsApi:s,account:l,userId:i,deviceId:r,areDeviceKeysUploaded:h,serverOTKCount:d,olm:e,olmWorker:o})}}static async adoptDehydratedDevice({olm:e,dehydratedDevice:t,pickleKey:s,hsApi:i,userId:r,olmWorker:o,storage:a}){const c=t.adoptUnpickledOlmAccount(),l=JSON.parse(c.one_time_keys()),d=Object.entries(l.curve25519).length,u=!0;return await wo(c,s,u,d,a),new At({pickleKey:s,hsApi:i,account:c,userId:r,deviceId:t.deviceId,areDeviceKeysUploaded:u,serverOTKCount:d,olm:e,olmWorker:o})}static async create({olm:e,pickleKey:t,hsApi:s,userId:i,deviceId:r,olmWorker:o,storage:a}){const c=new e.Account;o?await o.createAccountAndOTKs(c,c.max_number_of_one_time_keys()):(c.create(),c.generate_one_time_keys(c.max_number_of_one_time_keys()));const l=!1,h=0;return a&&await wo(c,t,l,h,a),new At({pickleKey:t,hsApi:s,account:c,userId:i,deviceId:r,areDeviceKeysUploaded:l,serverOTKCount:h,olm:e,olmWorker:o})}constructor({pickleKey:e,hsApi:t,account:s,userId:i,deviceId:r,areDeviceKeysUploaded:o,serverOTKCount:a,olm:c,olmWorker:l}){this._olm=c,this._pickleKey=e,this._hsApi=t,this._account=s,this._userId=i,this._deviceId=r,this._areDeviceKeysUploaded=o,this._serverOTKCount=a,this._olmWorker=l,this._identityKeys=JSON.parse(this._account.identity_keys())}get identityKeys(){return this._identityKeys}setDeviceId(e){this._deviceId=e}async uploadKeys(e,t,s){const i=JSON.parse(this._account.one_time_keys()),r=Object.entries(i.curve25519);if(r.length||!this._areDeviceKeysUploaded){const o={};if(!this._areDeviceKeysUploaded){s.set("identity",!0);const l=JSON.parse(this._account.identity_keys());o.device_keys=this._deviceKeysPayload(l)}r.length&&(s.set("otks",!0),o.one_time_keys=this._oneTimeKeysPayload(r));const a=t?this._deviceId:void 0,c=await this._hsApi.uploadKeys(a,o,{log:s}).response();this._serverOTKCount=c?.one_time_key_counts?.signed_curve25519,s.set("serverOTKCount",this._serverOTKCount),await this._updateSessionStorage(e,l=>{r.length&&(this._account.mark_keys_as_published(),l?.set(_s,this._account.pickle(this._pickleKey)),l?.set(ai,this._serverOTKCount)),this._areDeviceKeysUploaded||(this._areDeviceKeysUploaded=!0,l?.set(vr,this._areDeviceKeysUploaded))})}}async generateOTKsIfNeeded(e,t){const s=this._account.max_number_of_one_time_keys(),i=Math.floor(s/2);if(this._serverOTKCount<i){const r=JSON.parse(this._account.one_time_keys()),a=Object.entries(r.curve25519).length,c=i-a-this._serverOTKCount;return c>0&&await t.wrap("generate otks",l=>{l.set("max",s),l.set("server",this._serverOTKCount),l.set("unpublished",a),l.set("new",c),l.set("limit",i),this._account.generate_one_time_keys(c),this._updateSessionStorage(e,h=>{h.set(_s,this._account.pickle(this._pickleKey))})}),!0}return!1}createInboundOlmSession(e,t){const s=new this._olm.Session;try{return s.create_inbound_from(this._account,e,t),s}catch(i){throw s.free(),i}}async createOutboundOlmSession(e,t){const s=new this._olm.Session;try{return this._olmWorker?await this._olmWorker.createOutboundOlmSession(this._account,s,e,t):s.create_outbound(this._account,e,t),s}catch(i){throw s.free(),i}}writeRemoveOneTimeKey(e,t){this._account.remove_one_time_keys(e),t.session.set(_s,this._account.pickle(this._pickleKey))}writeSync(e,t,s){const i=e.signed_curve25519;if(Number.isSafeInteger(i)&&i!==this._serverOTKCount)return t.session.set(ai,i),s.set("otkCount",i),i}afterSync(e){Number.isSafeInteger(e)&&(this._serverOTKCount=e)}_keysAsSignableObject(e){const t={user_id:this._userId,device_id:this._deviceId,algorithms:[Pr,Le],keys:{}};for(const[s,i]of Object.entries(e))t.keys[`${s}:${this._deviceId}`]=i;return t}getDeviceKeysToSignWithCrossSigning(){const e=JSON.parse(this._account.identity_keys());return this._keysAsSignableObject(e)}_deviceKeysPayload(e){const t=this._keysAsSignableObject(e);return this.signObject(t),t}_oneTimeKeysPayload(e){const t={};for(const[s,i]of e){const r={key:i};this.signObject(r),t[`signed_curve25519:${s}`]=r}return t}async _updateSessionStorage(e,t){if(e){const s=await e.readWriteTxn([e.storeNames.session]);try{await t(s.session)}catch(i){throw s.abort(),i}await s.complete()}else await t(void 0)}signObject(e){const t=e.signatures||{},s=e.unsigned;delete e.signatures,delete e.unsigned,t[this._userId]=t[this._userId]||{},t[this._userId]["ed25519:"+this._deviceId]=this._account.sign(Vr.stringify(e)),e.signatures=t,s!==void 0&&(e.unsigned=s)}pickleWithKey(e){return this._account.pickle(e)}dispose(){this._account.free(),this._account=void 0}}class Qr{constructor(e,t){this._id=e,this._keyDescription=t}get id(){return this._id}get passphraseParams(){return this._keyDescription?.passphrase}get algorithm(){return this._keyDescription?.algorithm}async isCompatible(e,t){if(this.algorithm==="m.secret_storage.v1.aes-hmac-sha2"){const s=this._keyDescription;if(s.mac){const i=await E_(e.binaryKey,s.iv,t);return s.mac===i}else if(s.passphrase){const i=e.description._keyDescription;return i.passphrase?s.passphrase.algorithm===i.passphrase.algorithm&&s.passphrase.iterations===i.passphrase.iterations&&s.passphrase.salt===i.passphrase.salt:!1}}return!1}}class Ns{constructor(e,t){this._keyDescription=e,this._binaryKey=t}withDescription(e){return new Ns(e,this._binaryKey)}get description(){return this._keyDescription}get id(){return this._keyDescription.id}get binaryKey(){return this._binaryKey}get algorithm(){return this._keyDescription.algorithm}}async function E_(n,e,t){const{crypto:s,encoding:i}=t,{utf8:r,base64:o}=i,{derive:a,aes:c,hmac:l}=s,h=o.decode(e),d=new Uint8Array(8),u="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0",p=r.encode(""),_=await a.hkdf(n,d,p,"SHA-256",512),g=_.slice(0,32),w=_.slice(32),I=await c.encryptCTR({key:g,iv:h,data:r.encode(u)}),E=await l.compute(w,I,"SHA-256");return o.encode(E)}const M_=5e5,C_=256;async function T_(n,e,t){const{passphraseParams:s}=n;if(!s)throw new Error("not a passphrase key");if(s.algorithm!=="m.pbkdf2")throw new Error(`Unsupported passphrase algorithm: ${s.algorithm}`);const{utf8:i}=t.encoding,r=await t.crypto.derive.pbkdf2(i.encode(e),s.iterations||M_,i.encode(s.salt),"SHA-512",s.bits||C_);return new Ns(n,r)}const hs=[139,1];function A_(n,e,t,s){const i=s.encoding.base58.decode(e.replace(/ /g,""));let r=0;for(const a of i)r^=a;if(r!==0)throw new Error("Incorrect parity");for(let a=0;a<hs.length;++a)if(i[a]!==hs[a])throw new Error("Incorrect prefix");if(i.length!==hs.length+t.PRIVATE_KEY_LENGTH+1)throw new Error("Incorrect length");const o=Uint8Array.from(i.slice(hs.length,hs.length+t.PRIVATE_KEY_LENGTH));return new Ns(n,o)}const Yr=`${we}ssssKey`,vo=`${we}keyBackupVersion`;var Ts=(n=>(n[n.RecoveryKey=0]="RecoveryKey",n[n.Passphrase=1]="Passphrase",n))(Ts||{});async function nc(n){const e=await n.readTxn([n.storeNames.accountData]),s=(await e.accountData.get("m.secret_storage.default_key"))?.content?.key;if(!s)return;const i=await e.accountData.get(`m.secret_storage.key.${s}`);if(!!i)return new Qr(s,i.content)}async function x_(n,e,t){const s=await t.session.get(vo);return t.session.set(vo,e),t.session.set(Yr,{id:n.id,binaryKey:n.binaryKey}),s}async function N_(n){const e=await n.session.get(Yr);if(!e)return;const t=await n.accountData.get(`m.secret_storage.key.${e.id}`);if(t)return new Ns(new Qr(e.id,t.content),e.binaryKey)}async function D_(n){n.session.remove(Yr)}async function V_(n,e,t,s,i){const r=await nc(t);if(!r)throw new Error("Could not find a default secret storage key in account data");return await oc(n,e,r,s,i)}async function oc(n,e,t,s,i){let r;if(n===1)r=await T_(t,e,s);else if(n===0)r=A_(t,e,i,s);else throw new Error(`Invalid type: ${n}`);return r}async function P_(n,e,t){const s=await nc(e);if(await s?.isCompatible(n,t))return n.withDescription(s)}const ac="org.matrix.msc2697.v1.olm.libolm_pickle";async function L_(n,e,t,s){try{const i=await n.getDehydratedDevice({log:s}).response();if(i.device_data.algorithm===ac)return new U_(i,e,t)}catch(i){i.name!=="HomeServerError"&&(s.error=i);return}}async function O_(n,e,t,s,i){const o=(await e.createDehydratedDevice({device_data:{algorithm:ac,account:n.pickleWithKey(t.binaryKey.slice()),passphrase:t.description?.passphraseParams||{}},initial_device_display_name:s}).response()).device_id;return n.setDeviceId(o),await n.uploadKeys(void 0,!0,i),o}class U_{constructor(e,t,s){this._dehydratedDevice=e,this._olm=t,this._platform=s}async decrypt(e,t){const s=new Qr("dehydrated_device",this._dehydratedDevice.device_data.passphrase),i=await oc(e,t,s,this._platform,this._olm),r=new this._olm.Account;try{const o=this._dehydratedDevice.device_data.account;return r.unpickle(i.binaryKey.slice(),o),new F_(this._dehydratedDevice,r,i)}catch(o){if(r.free(),o.message==="OLM.BAD_ACCOUNT_KEY")return;throw o}}get deviceId(){return this._dehydratedDevice.device_id}}class F_{constructor(e,t,s){this._dehydratedDevice=e,this._account=t,this._key=s}async claim(e,t){try{return(await e.claimDehydratedDevice(this.deviceId,{log:t}).response()).success}catch{return!1}}adoptUnpickledOlmAccount(){const e=this._account;return this._account=void 0,e}get deviceId(){return this._dehydratedDevice.device_id}get key(){return this._key}dispose(){this._account?.free(),this._account=void 0}}class cc{tryTake(){return this._promise?!1:(this._promise=new Promise(e=>{this._resolve=e}),!0)}async take(){for(;!this.tryTake();)await this.released()}get isTaken(){return!!this._promise}release(){if(this._resolve){this._promise=void 0;const e=this._resolve;this._resolve=void 0,e()}}released(){return this._promise}}class lc{constructor(e){this.locks=e}release(){for(const e of this.locks)e.release()}}function hc(n,e,t,s){return{session:n.pickle(s),sessionId:n.session_id(),senderKey:e,lastUsed:t}}class fi{constructor(e,t,s,i=!1){this.data=e,this.pickleKey=t,this.olm=s,this.isNew=i,this.isModified=i}static create(e,t,s,i,r){const o=hc(t,e,r,i);return new fi(o,i,s,!0)}get id(){return this.data.sessionId}load(){const e=new this.olm.Session;return e.unpickle(this.pickleKey,this.data.session),e}unload(e){e.free()}save(e){this.data.session=e.pickle(this.pickleKey),this.isModified=!0}}class dc{constructor(e,t,s,i){this.event=e,this.senderCurve25519Key=t,this.claimedEd25519Key=s,this.encryptedEvent=i}setDevice(e){this.device=e}get isVerified(){return this.device?this.device.ed25519Key===this.claimedEd25519Key:!1}get isUnverified(){return this.device?!this.isVerified:!0}get userId(){return this.device?.userId}get deviceId(){return this.device?.deviceId}get isVerificationUnknown(){return!this.device}}var yi=(n=>(n[n.PreKey=0]="PreKey",n[n.Normal=1]="Normal",n))(yi||{});const bo=4;function uc(n){n.sort((e,t)=>t.data.lastUsed-e.data.lastUsed)}class B_{constructor(e,t,s,i,r,o){this.account=e,this.pickleKey=t,this.now=s,this.ownUserId=i,this.olm=r,this.senderKeyLock=o}async obtainDecryptionLock(e){const t=new Set;for(const i of e){const r=i.content?.sender_key;r&&t.add(r)}const s=await Promise.all(Array.from(t).map(i=>this.senderKeyLock.takeLock(i)));return new lc(s)}async decryptAll(e,t,s){try{const i=Jt(e,h=>h.content?.sender_key),r=this.now(),o=await Promise.all(Array.from(i.entries()).map(([h,d])=>this._decryptAllForSenderKey(h,d,r,s))),a=o.reduce((h,d)=>h.concat(d.results),[]),c=o.reduce((h,d)=>h.concat(d.errors),[]),l=o.map(h=>h.senderKeyDecryption);return new $_(l,a,c,this.account,t)}catch(i){throw t.release(),i}}async _decryptAllForSenderKey(e,t,s,i){const r=await this._getSessions(e,i),o=new K_(e,r,s),a=[],c=[];for(const l of t)try{const h=this._decryptForSenderKey(o,l,s);a.push(h)}catch(h){c.push(h)}return{results:a,errors:c,senderKeyDecryption:o}}_decryptForSenderKey(e,t,s){const i=e.senderKey,r=this._getMessageAndValidateEvent(t);let o;try{o=e.decrypt(r)}catch(a){throw new ie("OLM_BAD_ENCRYPTED_MESSAGE",t,{senderKey:i,error:a.message})}if(typeof o!="string"&&r.type===yi.PreKey){let a;try{a=this._createSessionAndDecrypt(i,r,s)}catch(c){throw new ie(`Could not create inbound olm session: ${c.message}`,t,{senderKey:i,error:c})}e.addNewSession(a.session),o=a.plaintext}if(typeof o=="string"){let a;try{a=JSON.parse(o)}catch(c){throw new ie("PLAINTEXT_NOT_JSON",t,{plaintext:o,error:c})}return this._validatePayload(a,t),new dc(a,i,a.keys.ed25519)}else throw new ie("OLM_NO_MATCHING_SESSION",t,{knownSessionIds:e.sessions.map(a=>a.id)})}_createSessionAndDecrypt(e,t,s){let i;const r=this.account.createInboundOlmSession(e,t.body);try{i=r.decrypt(t.type,t.body);const o=fi.create(e,r,this.olm,this.pickleKey,s);return o.unload(r),{session:o,plaintext:i}}catch(o){throw r.free(),o}}_getMessageAndValidateEvent(e){const t=e.content?.ciphertext;if(!t)throw new ie("OLM_MISSING_CIPHERTEXT",e);const s=t?.[this.account.identityKeys.curve25519];if(!s)throw new ie("OLM_NOT_INCLUDED_IN_RECIPIENTS",e);return s}async _getSessions(e,t){const i=(await t.olmSessions.getAll(e)).map(r=>new fi(r,this.pickleKey,this.olm));return uc(i),i}_validatePayload(e,t){if(e.sender!==t.sender)throw new ie("OLM_FORWARDED_MESSAGE",t,{sentBy:t.sender,encryptedBy:e.sender});if(e.recipient!==this.ownUserId)throw new ie("OLM_BAD_RECIPIENT",t,{recipient:e.recipient});if(e.recipient_keys?.ed25519!==this.account.identityKeys.ed25519)throw new ie("OLM_BAD_RECIPIENT_KEY",t,{key:e.recipient_keys?.ed25519});if(!e.type)throw new ie("missing type on payload",t,{payload:e});if(typeof e.keys?.ed25519!="string")throw new ie("Missing or invalid claimed ed25519 key on payload",t,{payload:e})}}class K_{constructor(e,t,s){this.senderKey=e,this.sessions=t,this.timestamp=s}addNewSession(e){this.sessions.unshift(e)}decrypt(e){for(const t of this.sessions){const s=this.decryptWithSession(t,e);if(typeof s=="string")return uc(this.sessions),s}}getModifiedSessions(){return this.sessions.filter(e=>e.isModified)}get hasNewSessions(){return this.sessions.some(e=>e.isNew)}decryptWithSession(e,t){if(t.type===void 0||t.body===void 0)throw new Error("Invalid message without type or body");const s=e.load();try{if(t.type===yi.PreKey&&!s.matches_inbound(t.body))return;try{const i=s.decrypt(t.type,t.body);return e.save(s),e.data.lastUsed=this.timestamp,i}catch(i){if(t.type===yi.PreKey)throw new Error(`Error decrypting prekey message with existing session id ${e.id}: ${i.message}`);return}}finally{e.unload(s)}}}class $_{constructor(e,t,s,i,r){this.senderKeyDecryptions=e,this.results=t,this.errors=s,this.account=i,this.lock=r}get hasNewSessions(){return this.senderKeyDecryptions.some(e=>e.hasNewSessions)}write(e){try{for(const t of this.senderKeyDecryptions){for(const s of t.getModifiedSessions())if(e.olmSessions.set(s.data),s.isNew){const i=s.load();try{this.account.writeRemoveOneTimeKey(i,e)}finally{s.unload(i)}}if(t.sessions.length>bo){const{senderKey:s,sessions:i}=t;for(let r=i.length-1;r>=bo;r-=1){const o=i[r];e.olmSessions.remove(s,o.id)}}}}finally{this.lock.release()}}}function j_(n){return n.reduce((e,t)=>!e||t<e?t:e,null)}const So="signed_curve25519",ei=20;class q_{constructor(e,t,s,i,r,o,a,c){this.account=e,this.pickleKey=t,this.olm=s,this.storage=i,this.now=r,this.ownUserId=o,this.olmUtil=a,this.senderKeyLock=c,this._batchLocks=new Array(ei);for(let l=0;l<ei;l+=1)this._batchLocks[l]=new cc}async _takeBatchLock(e){const t=this._batchLocks.filter(s=>!s.isTaken).slice(0,e);if(t.length<e){const s=this._batchLocks.filter(i=>i.isTaken).slice(0,e-t.length);t.push(...s)}return await Promise.all(t.map(s=>s.take())),new lc(t)}async encrypt(e,t,s,i,r){let o=[];for(let a=0;a<s.length;a+=ei){const c=s.slice(a,a+ei),l=await this._takeBatchLock(c.length);try{const h=await this._encryptForMaxDevices(e,t,c,i,r);o=o.concat(h)}finally{l.release()}}return o}async _encryptForMaxDevices(e,t,s,i,r){const o=await Promise.all(s.map(a=>this.senderKeyLock.takeLock(a.curve25519Key)));try{const{devicesWithoutSession:a,existingEncryptionTargets:c}=await this._findExistingSessions(s),l=this.now();let h=[];try{if(a.length){const p=await r.wrap("create sessions",_=>this._createNewSessions(a,i,l,_));h=h.concat(p)}await this._loadSessions(c),h=h.concat(c);const d={l:"encrypt",targets:h.length},u=r.wrap(d,()=>h.map(p=>{const _=this._encryptForDevice(e,t,p);return new W_(_,p.device)}));return await this._storeSessions(h,l),u}finally{for(const d of h)d.dispose()}}finally{for(const a of o)a.release()}}async _findExistingSessions(e){const t=await this.storage.readTxn([this.storage.storeNames.olmSessions]),s=await Promise.all(e.map(async o=>await t.olmSessions.getSessionIds(o.curve25519Key))),i=e.filter((o,a)=>!s[a]?.length),r=e.map((o,a)=>{const c=s[a];if(c?.length>0){const l=j_(c);return As.fromSessionId(o,l)}}).filter(o=>!!o);return{devicesWithoutSession:i,existingEncryptionTargets:r}}_encryptForDevice(e,t,s){const{session:i,device:r}=s,o=JSON.stringify(this._buildPlainTextMessageForDevice(e,t,r)),a=i.encrypt(o);return{algorithm:Pr,sender_key:this.account.identityKeys.curve25519,ciphertext:{[r.curve25519Key]:a}}}_buildPlainTextMessageForDevice(e,t,s){return{keys:{ed25519:this.account.identityKeys.ed25519},recipient_keys:{ed25519:s.ed25519Key},recipient:s.userId,sender:this.ownUserId,content:t,type:e}}async _createNewSessions(e,t,s,i){const r=await i.wrap("claim",o=>this._claimOneTimeKeys(t,e,o));try{for(const o of r){const{device:a,oneTimeKey:c}=o;o.session=await this.account.createOutboundOlmSession(a.curve25519Key,c)}await this._storeSessions(r,s)}catch(o){for(const a of r)a.dispose();throw o}return r}async _claimOneTimeKeys(e,t,s){const i=Jr(t,c=>c.userId,()=>new Map,(c,l)=>c.set(l.deviceId,l)),r=Array.from(i.entries()).reduce((c,[l,h])=>(c[l]=Array.from(h.values()).reduce((d,u)=>(d[u.deviceId]=So,d),{}),c),{}),o=await e.claimKeys({timeout:1e4,one_time_keys:r},{log:s}).response();Object.keys(o.failures).length&&s.log({l:"failures",servers:Object.keys(o.failures)},s.level.Warn);const a=o?.one_time_keys;return this._verifyAndCreateOTKTargets(a,i,s)}_verifyAndCreateOTKTargets(e,t,s){const i=[];for(const[r,o]of Object.entries(e))for(const[a,c]of Object.entries(o)){const[l,h]=Object.entries(c)[0],[d]=l.split(":");if(d===So){const u=t.get(r)?.get(a);if(u&&lr(this.olmUtil,r,a,u.ed25519Key,h,s)){const _=As.fromOTK(u,h.key);i.push(_)}}}return i}async _loadSessions(e){const t=await this.storage.readTxn([this.storage.storeNames.olmSessions]);let s=!1;try{await Promise.all(e.map(async i=>{const r=await t.olmSessions.get(i.device.curve25519Key,i.sessionId);if(r&&!s){const o=new this.olm.Session;o.unpickle(this.pickleKey,r.session),i.session=o}}))}catch(i){s=!0;for(const r of e)r.dispose();throw i}}async _storeSessions(e,t){const s=await this.storage.readWriteTxn([this.storage.storeNames.olmSessions]);try{for(const i of e){const r=hc(i.session,i.device.curve25519Key,t,this.pickleKey);s.olmSessions.set(r)}}catch(i){throw s.abort(),i}await s.complete()}}class As{constructor(e,t,s){this.device=e,this.oneTimeKey=t,this.sessionId=s,this.session=null}static fromOTK(e,t){return new As(e,t,null)}static fromSessionId(e,t){return new As(e,null,t)}dispose(){this.session&&this.session.free()}}class W_{constructor(e,t){this.content=e,this.device=t}}class H_{constructor(e,t,s,i){this._roomId=e,this._results=t,this._errors=s,this._replayEntries=i}async write(e){return await Promise.all(this._replayEntries.map(async t=>{try{this._handleReplayAttack(this._roomId,t,e)}catch(s){this._errors.set(t.eventId,s)}})),{results:this._results,errors:this._errors}}async _handleReplayAttack(e,t,s){const{messageIndex:i,sessionId:r,eventId:o,timestamp:a}=t,c=await s.groupSessionDecryptions.get(e,r,i);if(c&&c.eventId!==o){const h=c.timestamp<a?o:c.eventId;throw this._results.delete(o),new ie("MEGOLM_REPLAYED_INDEX",event,{messageIndex:i,badEventId:h,otherEventId:c.eventId})}c||s.groupSessionDecryptions.set(e,r,i,{eventId:o,timestamp:a})}}function br(n,e){if(n)for(const[t,s]of n.entries())e.set(t,s)}class z_{constructor(e,t,s){this._roomId=e,this._sessionDecryptions=t,this._initialErrors=s}async decrypt(){try{const e=this._initialErrors,t=new Map,s=[];return await Promise.all(this._sessionDecryptions.map(async i=>{const r=await i.decryptAll();br(r.errors,e),br(r.results,t),s.push(...r.replayEntries)})),new H_(this._roomId,t,e,s)}finally{this.dispose()}}dispose(){for(const e of this._sessionDecryptions)e.dispose()}}class G_{constructor(e,t,s){this.sessionId=e,this.messageIndex=t,this.event=s}get eventId(){return this.event.event_id}get timestamp(){return this.event.origin_server_ts}}class J_{constructor(e,t,s,i){this.key=e,this.events=t,this.olmWorker=s,this.keyLoader=i,this.decryptionRequests=s?[]:void 0}async decryptAll(){const e=[],t=new Map;let s;return await this.keyLoader.useKey(this.key,async i=>{for(const r of this.events)try{const o=r.content.ciphertext;let a;if(this.olmWorker){const d=this.olmWorker.megolmDecrypt(i,o);this.decryptionRequests.push(d),a=await d.response()}else a=i.decrypt(o);const{plaintext:c}=a;let l;try{l=JSON.parse(c)}catch(d){throw new ie("PLAINTEXT_NOT_JSON",r,{plaintext:c,err:d})}if(l.room_id!==this.key.roomId)throw new ie("MEGOLM_WRONG_ROOM",r,{encryptedRoomId:l.room_id,eventRoomId:this.key.roomId});e.push(new G_(this.key.sessionId,a.message_index,r));const h=new dc(l,this.key.senderKey,this.key.claimedEd25519Key,r);t.set(r.event_id,h)}catch(o){if(o.name==="AbortError")return;s||(s=new Map),s.set(r.event_id,o)}}),{results:t,errors:s,replayEntries:e}}dispose(){if(this.decryptionRequests)for(const e of this.decryptionRequests)e.abort()}}function Xr(n){return n.content?.sender_key}function Zr(n){return n.content?.session_id}function Q_(n){return n.content?.ciphertext}function Y_(n){return typeof Xr(n)=="string"&&typeof Zr(n)=="string"&&typeof Q_(n)=="string"}class X_{constructor(){this.events=[]}get senderKey(){return Xr(this.events[0])}get sessionId(){return Zr(this.events[0])}}function Sr(n){return Jr(n,e=>`${Xr(e)}|${Zr(e)}`,()=>new X_,(e,t)=>e.events.push(t))}class mc{isForSession(e,t,s){return this.roomId===e&&this.senderKey===t&&this.sessionId===s}get isBetter(){return this._isBetter}set isBetter(e){this._isBetter=e}}function pc(n,e){return n.first_known_index()<e.first_known_index()}class en extends mc{checkBetterThanKeyInStorage(e,t){return this._checkBetterThanKeyInStorage(e,void 0,t)}async write(e,t){let s;if(this.isBetter===void 0&&await this._checkBetterThanKeyInStorage(e,(r,o)=>{s=r.pickle(o)},t),this.isBetter===!1)return!1;s||(s=await e.useKey(this,(r,o)=>r.pickle(o)));const i={roomId:this.roomId,senderKey:this.senderKey,sessionId:this.sessionId,session:s,backup:this.backupStatus,source:this.keySource,claimedKeys:{ed25519:this.claimedEd25519Key}};return t.inboundGroupSessions.set(i),!0}get eventIds(){return this._eventIds}async _checkBetterThanKeyInStorage(e,t,s){if(this.isBetter!==void 0)return this.isBetter;let i=e.getCachedKey(this.roomId,this.senderKey,this.sessionId);if(!i){const r=await fc(this.roomId,this.senderKey,this.sessionId,s);r&&(r.hasSession?i=r:r.eventIds&&(this._eventIds=r.eventIds))}if(i){const r=i;await e.useKey(this,async o=>{await e.useKey(r,(a,c)=>{this.isBetter=pc(o,a),r.isBetter=!this.isBetter,this.isBetter&&t&&t(o,c)})})}else this.isBetter=!0;return this.isBetter}get backupStatus(){return Si.NotBackedUp}}class Z_ extends en{constructor(e){super(),this._decryptionResult=e}get roomId(){return this._decryptionResult.event.content?.room_id}get senderKey(){return this._decryptionResult.senderCurve25519Key}get sessionId(){return this._decryptionResult.event.content?.session_id}get claimedEd25519Key(){return this._decryptionResult.claimedEd25519Key}get serializationKey(){return this._decryptionResult.event.content?.session_key}get serializationType(){return"create"}get keySource(){return xs.DeviceMessage}loadInto(e){e.create(this.serializationKey)}}class eg extends en{constructor(e,t,s){super(),this._roomId=e,this.outboundSession=t,this.identityKeys=s,this.isBetter=!0,this._sessionKey=this.outboundSession.session_key()}get roomId(){return this._roomId}get senderKey(){return this.identityKeys.curve25519}get sessionId(){return this.outboundSession.session_id()}get claimedEd25519Key(){return this.identityKeys.ed25519}get serializationKey(){return this._sessionKey}get serializationType(){return"create"}get keySource(){return xs.Outbound}loadInto(e){e.create(this.serializationKey)}}class tg extends en{constructor(e,t,s){super(),this._roomId=e,this._sessionId=t,this._backupInfo=s}get roomId(){return this._roomId}get senderKey(){return this._backupInfo.sender_key}get sessionId(){return this._sessionId}get claimedEd25519Key(){return this._backupInfo.sender_claimed_keys?.ed25519}get serializationKey(){return this._backupInfo.session_key}get serializationType(){return"import_session"}get keySource(){return xs.Backup}loadInto(e){e.import_session(this.serializationKey)}get backupStatus(){return Si.BackedUp}}class _c extends mc{constructor(e){super(),this.isBetter=!0,this.storageEntry=e}get roomId(){return this.storageEntry.roomId}get senderKey(){return this.storageEntry.senderKey}get sessionId(){return this.storageEntry.sessionId}get claimedEd25519Key(){return this.storageEntry.claimedKeys.ed25519}get eventIds(){return this.storageEntry.eventIds}get serializationKey(){return this.storageEntry.session||""}get serializationType(){return"unpickle"}loadInto(e,t){e.unpickle(t,this.serializationKey)}get hasSession(){return!!this.serializationKey}}function sg(n){const e=n.event.content?.session_key,t=new Z_(n);if(typeof t.roomId=="string"&&typeof t.sessionId=="string"&&typeof t.senderKey=="string"&&typeof e=="string")return t}function gc(n,e,t){const s=t.session_key,i=t.sender_key,r=t.sender_claimed_keys?.ed25519;if(typeof n=="string"&&typeof e=="string"&&typeof i=="string"&&typeof s=="string"&&typeof r=="string")return new tg(n,e,t)}async function fc(n,e,t,s){const i=await s.inboundGroupSessions.get(n,e,t);if(i)return new _c(i)}class ig{constructor(e,t){this.keyLoader=e,this.olmWorker=t}async addMissingKeyEventIds(e,t,s,i,r){let o=await r.inboundGroupSessions.get(e,t,s);if(!o?.session){if(o){const a=new Set(o.eventIds);for(const c of i)a.add(c);o.eventIds=Array.from(a)}else o={roomId:e,senderKey:t,sessionId:s,eventIds:i};r.inboundGroupSessions.set(o)}}async getEventIdsForMissingKey(e,t,s,i){const r=await i.inboundGroupSessions.get(e,t,s);if(r&&!r.session)return r.eventIds}async hasSession(e,t,s,i){return typeof(await i.inboundGroupSessions.get(e,t,s))?.session=="string"}async prepareDecryptAll(e,t,s,i){const r=new Map,o=[];for(const l of t)Y_(l)?o.push(l):r.set(l.event_id,new ie("MEGOLM_INVALID_EVENT",l));const a=Sr(o),c=[];return await Promise.all(Array.from(a.values()).map(async l=>{const h=await this.getRoomKey(e,l.senderKey,l.sessionId,s,i);if(h)c.push(new J_(h,l.events,this.olmWorker,this.keyLoader));else for(const d of l.events)r.set(d.event_id,new ie("MEGOLM_NO_SESSION",d))})),new z_(e,c,r)}async getRoomKey(e,t,s,i,r){if(i){const c=i.find(l=>l.isForSession(e,t,s));if(c&&await c.checkBetterThanKeyInStorage(this.keyLoader,r))return c}const o=this.keyLoader.getCachedKey(e,t,s);if(o)return o;const a=await fc(e,t,s,r);if(a&&a.serializationKey)return a}writeRoomKey(e,t){return e.write(this.keyLoader,t)}roomKeysFromDeviceMessages(e,t){const s=[];for(const i of e)i.event?.type!=="m.room_key"||i.event.content?.algorithm!==Le||t.wrap("room_key",r=>{const o=sg(i);o?(r.set("roomId",o.roomId),r.set("id",o.sessionId),s.push(o)):(r.logLevel=r.level.Warn,r.set("invalid",!0))},t.level.Detail);return s}roomKeyFromBackup(e,t,s){return gc(e,t,s)}dispose(){this.keyLoader.dispose()}}class rg extends ec{constructor(e,t,s){super(s),this.pickleKey=t,this.olm=e}getCachedKey(e,t,s){const i=this.findCachedKeyIndex(e,t,s);if(i!==-1)return this._getByIndexAndMoveUp(i).key}async useKey(e,t){const s=await this.allocateOperation(e);try{return await t(s.session,this.pickleKey)}finally{this.releaseOperation(s)}}get running(){return this._entries.some(e=>e.refCount!==0)}dispose(){for(let e=0;e<this._entries.length;e+=1)this._entries[e].dispose();this._entries.splice(0,this._entries.length)}async allocateOperation(e){let t;for(;(t=this.findIndexForAllocation(e))===-1;)await this.operationBecomesUnused();if(t<this.size){const s=this._getByIndexAndMoveUp(t);return s.isForKey(e)?(s.refCount+=1,s):(s.refCount=1,s.key=e,e.loadInto(s.session,this.pickleKey),s)}else{const s=new this.olm.InboundGroupSession;e.loadInto(s,this.pickleKey);const i=new ng(e,s);return this._set(i),i}}releaseOperation(e){e.refCount-=1,e.refCount<=0&&this.resolveUnusedOperation&&(this.resolveUnusedOperation(),this.operationBecomesUnusedPromise=this.resolveUnusedOperation=void 0)}operationBecomesUnused(){return this.operationBecomesUnusedPromise||(this.operationBecomesUnusedPromise=new Promise(e=>{this.resolveUnusedOperation=e})),this.operationBecomesUnusedPromise}findIndexForAllocation(e){let t=this.findIndexSameKey(e);return t===-1&&(this.size<this.limit?t=this.size:(t=this.findIndexSameSessionUnused(e),t===-1&&(t=this.findIndexOldestUnused()))),t}findCachedKeyIndex(e,t,s){return this._entries.reduce((i,r,o,a)=>{const c=i===-1?void 0:a[i];return r.isBest===!0&&r.isForSameSession(e,t,s)&&(!c||r.isBetter(c))?o:i},-1)}findIndexSameKey(e){return this._entries.findIndex(t=>t.isForSameSession(e.roomId,e.senderKey,e.sessionId)&&t.isForKey(e))}findIndexSameSessionUnused(e){return this._entries.reduce((t,s,i,r)=>{const o=t===-1?void 0:r[t];return s.refCount===0&&s.isForSameSession(e.roomId,e.senderKey,e.sessionId)&&(!o||!s.isBetter(o))?i:t},-1)}findIndexOldestUnused(){for(let e=this._entries.length-1;e>=0;e-=1)if(this._entries[e].refCount===0)return e;return-1}}class ng{constructor(e,t){this.key=e,this.session=t,this.refCount=1}isForSameSession(e,t,s){return this.key.roomId===e&&this.key.senderKey===t&&this.key.sessionId===s}isBetter(e){return pc(this.session,e.session)}isForKey(e){return this.key.serializationKey===e.serializationKey&&this.key.serializationType===e.serializationType}dispose(){this.session.free(),this.session=void 0}get isBest(){return this.key.isBetter}}const og="m.megolm_backup.v1.curve25519-aes-sha2";class tn{constructor(e,t){this.encryption=e,this.decryption=t}static fromAuthData(e,t,s){const i=e.public_key,r=new s.PkDecryption,o=new s.PkEncryption;try{const a=r.init_with_private_key(t);if(a!==i)throw new Error(`Bad backup key, public key does not match. Calculated ${a} but expected ${i}`);o.set_recipient_key(a)}catch(a){throw r.free(),o.free(),a}return new tn(o,r)}decryptRoomKey(e){const t=this.decryption.decrypt(e.ephemeral,e.mac,e.ciphertext);return JSON.parse(t)}encryptRoomKey(e,t){const s={algorithm:Le,sender_key:e.senderKey,sender_claimed_keys:{ed25519:e.claimedEd25519Key},forwarding_curve25519_key_chain:[],session_key:t};return this.encryption.encrypt(JSON.stringify(s))}dispose(){this.decryption?.free(),this.decryption=void 0,this.encryption?.free(),this.encryption=void 0}}const ag=200;class sn{constructor(e,t,s,i,r,o,a=1e4){this.backupInfo=e,this.crypto=t,this.hsApi=s,this.keyLoader=i,this.storage=r,this.platform=o,this.maxDelay=a,this.operationInProgress=new Te(void 0),this._stopped=!1,this._needsNewKey=!1,this._hasBackedUpAllKeys=!1}get hasStopped(){return this._stopped}get error(){return this._error}get version(){return this.backupInfo.version}get needsNewKey(){return this._needsNewKey}get hasBackedUpAllKeys(){return this._hasBackedUpAllKeys}async getRoomKey(e,t,s){const i=await this.hsApi.roomKeyForRoomAndSession(this.backupInfo.version,e,t,{log:s}).response();if(!i.session_data)return;const r=this.crypto.decryptRoomKey(i.session_data);if(r?.algorithm===Le)return gc(e,t,r);r?.algorithm&&s.set("unknown algorithm",r.algorithm)}markAllForBackup(e){return e.inboundGroupSessions.markAllAsNotBackedUp()}flush(e){this.operationInProgress.get()||e.wrapDetached("flush key backup",async t=>{if(this._needsNewKey){t.set("needsNewKey",this._needsNewKey);return}this._stopped=!1,this._error=void 0,this._hasBackedUpAllKeys=!1;const s=this._runFlushOperation(t);this.operationInProgress.set(s);try{await s.result,this._hasBackedUpAllKeys=!0}catch(i){this._stopped=!0,i.name==="HomeServerError"&&(i.errcode==="M_WRONG_ROOM_KEYS_VERSION"||i.errcode==="M_NOT_FOUND")?(t.set("wrong_version",!0),this._needsNewKey=!0):(i.name!=="AbortError"||i.name==="StorageError"&&i.errcode==="AbortError")&&(this._error=i),t.catch(i)}this.operationInProgress.set(void 0)})}_runFlushOperation(e){return new Ga(async(t,s)=>{let i=0,r=0;for(;;){const o=this.platform.random()*this.maxDelay,a=this.platform.clock.createTimeout(o);t(a),await a.elapsed();const c=await this.storage.readTxn([$.inboundGroupSessions]);t(c),i=r+await c.inboundGroupSessions.countNonBackedUpSessions(),s(new Io(i,r));const l=(await c.inboundGroupSessions.getFirstNonBackedUpSessions(ag)).map(u=>new _c(u));if(l.length===0){e.set("total",i);return}const h=await this.encodeKeysForBackup(l),d=this.hsApi.uploadRoomKeysToBackup(this.backupInfo.version,h,{log:e});t(d),await d.response(),await this.markKeysAsBackedUp(l,t),r+=l.length,s(new Io(i,r))}})}async encodeKeysForBackup(e){const t={rooms:{}},s=t.rooms;for(const i of e){let r=s[i.roomId];r||(r=s[i.roomId]={sessions:{}}),r.sessions[i.sessionId]=await this.encodeRoomKey(i)}return t}async markKeysAsBackedUp(e,t){const s=await this.storage.readWriteTxn([$.inboundGroupSessions]);t(s);try{await Promise.all(e.map(i=>s.inboundGroupSessions.markAsBackedUp(i.roomId,i.senderKey,i.sessionId)))}catch(i){throw s.abort(),i}await s.complete()}async encodeRoomKey(e){return await this.keyLoader.useKey(e,t=>{const s=t.first_known_index(),i=t.export_session(s);return{first_message_index:s,forwarded_count:0,is_verified:!1,session_data:this.crypto.encryptRoomKey(e,i)}})}dispose(){this.crypto.dispose()}static async fromSecretStorage(e,t,s,i,r,o,a){const c=await s.readSecret("m.megolm_backup.v1",a);if(c){const l=new Uint8Array(e.encoding.base64.decode(c)),h=await i.roomKeysVersion().response();if(h.algorithm===og){const d=tn.fromAuthData(h.auth_data,l,t);return new sn(h,d,i,r,o,e)}else throw new Error(`Unknown backup algorithm: ${h.algorithm}`)}}}class Io{constructor(e,t){this.total=e,this.finished=t}}function cg(n,e,t,s,i){let r=!1;if(t instanceof Uint8Array){const c=new n.PkSigning;i=c.init_with_seed(t),t=c,r=!0}const o=e.signatures||{};delete e.signatures;const a=e.unsigned;e.unsigned&&delete e.unsigned;try{const c=o[s]||{};return o[s]=c,c["ed25519:"+i]=t.sign(Vr.stringify(e))}finally{e.signatures=o,a&&(e.unsigned=a),r&&t.free()}}class lg{constructor(e){this._isMasterKeyTrusted=!1,this.storage=e.storage,this.secretStorage=e.secretStorage,this.platform=e.platform,this.deviceTracker=e.deviceTracker,this.olm=e.olm,this.hsApi=e.hsApi,this.ownUserId=e.ownUserId,this.e2eeAccount=e.e2eeAccount}async init(e){e.wrap("CrossSigning.init",async t=>{const s=await this.storage.readTxn([this.storage.storeNames.accountData]),i=await this.secretStorage.readSecret("m.cross_signing.master",s),r=new this.olm.PkSigning;let o;try{const c=new Uint8Array(this.platform.encoding.base64.decode(i));o=r.init_with_seed(c)}finally{r.free()}const a=await this.deviceTracker.getCrossSigningKeysForUser(this.ownUserId,this.hsApi,t);t.set({publishedMasterKey:a.masterKey,derivedPublicKey:o}),this._isMasterKeyTrusted=a.masterKey===o,t.set("isMasterKeyTrusted",this.isMasterKeyTrusted)})}async signOwnDevice(e){e.wrap("CrossSigning.signOwnDevice",async t=>{if(!this._isMasterKeyTrusted){t.set("mskNotTrusted",!0);return}const s=this.e2eeAccount.getDeviceKeysToSignWithCrossSigning(),i=await this.signDevice(s),r={[i.user_id]:{[i.device_id]:i}};await this.hsApi.uploadSignatures(r,{log:t}).response()})}async signDevice(e){const t=await this.storage.readTxn([this.storage.storeNames.accountData]),s=await this.secretStorage.readSecret("m.cross_signing.self_signing",t),i=new Uint8Array(this.platform.encoding.base64.decode(s));return cg(this.olm,e,i,this.ownUserId,""),e}get isMasterKeyTrusted(){return this._isMasterKeyTrusted}}class hg{constructor({pickleKey:e,olm:t,account:s,keyLoader:i,storage:r,now:o,ownDeviceId:a}){this._pickleKey=e,this._olm=t,this._account=s,this._keyLoader=i,this._storage=r,this._now=o,this._ownDeviceId=a}discardOutboundSession(e,t){t.outboundGroupSessions.remove(e)}async createRoomKeyMessage(e,t){let s=await t.outboundGroupSessions.get(e);if(s){const i=new this._olm.OutboundGroupSession;try{return i.unpickle(this._pickleKey,s.session),this._createRoomKeyMessage(i,e)}finally{i.free()}}}createWithheldMessage(e,t,s){return{algorithm:e.algorithm,code:t,reason:s,room_id:e.room_id,sender_key:this._account.identityKeys.curve25519,session_id:e.session_id}}async ensureOutboundSession(e,t){let s=new this._olm.OutboundGroupSession;try{const i=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions,this._storage.storeNames.outboundGroupSessions]);let r;try{let o=await i.outboundGroupSessions.get(e);r=await this._readOrCreateSession(s,o,e,t,i),r&&this._writeSession(this._now(),s,e,i)}catch(o){throw i.abort(),o}return await i.complete(),r}finally{s.free()}}async _readOrCreateSession(e,t,s,i,r){if(t&&e.unpickle(this._pickleKey,t.session),!t||this._needsToRotate(e,t.createdAt,i)){t&&(e.free(),e=new this._olm.OutboundGroupSession),e.create();const o=this._createRoomKeyMessage(e,s);return await new eg(s,e,this._account.identityKeys).write(this._keyLoader,r),o}}_writeSession(e,t,s,i){i.outboundGroupSessions.set({roomId:s,session:t.pickle(this._pickleKey),createdAt:e})}async encrypt(e,t,s,i){let r=new this._olm.OutboundGroupSession;try{const o=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions,this._storage.storeNames.outboundGroupSessions]);let a,c;try{let l=await o.outboundGroupSessions.get(e);a=await this._readOrCreateSession(r,l,e,i,o),c=this._encryptContent(e,r,t,s);const h=a?this._now():l.createdAt;this._writeSession(h,r,e,o)}catch(l){throw o.abort(),l}return await o.complete(),new dg(c,a)}finally{r&&r.free()}}_needsToRotate(e,t,s){let i=6048e5;Number.isSafeInteger(s?.rotation_period_ms)&&(i=s?.rotation_period_ms);let r=100;if(Number.isSafeInteger(s?.rotation_period_msgs)&&(r=s?.rotation_period_msgs),this._now()>t+i||e.message_index()>=r)return!0}_encryptContent(e,t,s,i){const r=JSON.stringify({room_id:e,type:s,content:i}),o=t.encrypt(r);return{algorithm:Le,sender_key:this._account.identityKeys.curve25519,ciphertext:o,session_id:t.session_id(),device_id:this._ownDeviceId}}_createRoomKeyMessage(e,t){return{room_id:t,session_id:e.session_id(),session_key:e.session_key(),algorithm:Le,chain_index:e.message_index()}}}class dg{constructor(e,t){this.content=e,this.roomKeyMessage=t}}const Ro="m.room.encrypted",ko="m.room.history_visibility",ug=60*1e3;class mg{constructor({room:e,deviceTracker:t,olmEncryption:s,megolmEncryption:i,megolmDecryption:r,encryptionParams:o,storage:a,keyBackup:c,notifyMissingMegolmSession:l,clock:h}){this._room=e,this._deviceTracker=t,this._olmEncryption=s,this._megolmEncryption=i,this._megolmDecryption=r,this._encryptionParams=o,this._senderDeviceCache=new Map,this._storage=a,this._keyBackup=c,this._notifyMissingMegolmSession=l,this._clock=h,this._isFlushingRoomKeyShares=!1,this._lastKeyPreShareTime=null,this._keySharePromise=null,this._historyVisibility=void 0,this._disposed=!1}enableKeyBackup(e){this._keyBackup&&!!e||(this._keyBackup=e)}async restoreMissingSessionsFromBackup(e,t){const s=e.filter(h=>h.isEncrypted&&!h.isDecrypted&&h.event).map(h=>h.event),i=Sr(s),r=Array.from(i.values()),o=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions]),a=await Promise.all(r.map(async h=>this._megolmDecryption.hasSession(this._room.id,h.senderKey,h.sessionId,o))),c=r.filter((h,d)=>!a[d]);if(c.length)for(var l=c.length-1;l>=0;l--){const h=c[l];await t.wrap("session",d=>this._requestMissingSessionFromBackup(h.senderKey,h.sessionId,d))}}notifyTimelineClosed(){this._senderDeviceCache=new Map}async writeSync(e,t,s,i){let r=await this._loadHistoryVisibilityIfNeeded(this._historyVisibility,s);const o=[],a=[];if(await qt(e,l=>{if(l.state_key===""&&l.type===ko){const h=l?.content?.history_visibility;if(h!==r)return i.wrap({l:"history_visibility changed",from:r,to:h},async d=>{r=h;const u=await this._deviceTracker.writeHistoryVisibility(this._room,r,s,d);o.push(...u.added),a.push(...u.removed)})}}),t.size){const l=await this._deviceTracker.writeMemberChanges(this._room,t,r,s);o.push(...l.added),a.push(...l.removed)}a.length&&(i.log({l:"discardOutboundSession",leftUsers:a}),this._megolmEncryption.discardOutboundSession(this._room.id,s));let c=!1;return o.length&&(c=await this._addShareRoomKeyOperationForMembers(o,s,i)),{shouldFlush:c,historyVisibility:r}}afterSync({historyVisibility:e}){this._historyVisibility=e}async _loadHistoryVisibilityIfNeeded(e,t=void 0){if(!e){t||(t=await this._storage.readTxn([this._storage.storeNames.roomState]));const s=await t.roomState.get(this._room.id,ko,"");if(s)return s.event?.content?.history_visibility}return e}async prepareDecryptAll(e,t,s,i){const r=new Map,o=[];for(const c of e)c.redacted_because||c.unsigned?.redacted_because||(c.content?.algorithm!==Le&&r.set(c.event_id,new Error("Unsupported algorithm: "+c.content?.algorithm)),o.push(c));const a=await this._megolmDecryption.prepareDecryptAll(this._room.id,o,t,i);return new pg(a,r,s,this,e)}async _processDecryptionResults(e,t,s,i,r,o){const a=e.filter(l=>s.get(l.event_id)?.code==="MEGOLM_NO_SESSION");if(!a.length)return;const c=Sr(a);i===It.Sync&&await Promise.all(Array.from(c.values()).map(async l=>{const h=l.events.map(d=>d.event_id);return this._megolmDecryption.addMissingKeyEventIds(this._room.id,l.senderKey,l.sessionId,h,r)})),this._keyBackup&&o.wrapDetached("check key backup",async l=>{if(l.set("source",i),l.set("events",a.length),l.set("sessions",c.size),i===It.Sync){if(await this._clock.createTimeout(1e4).elapsed(),this._disposed)return;const h=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions]);await Promise.all(Array.from(c).map(async([d,u])=>{await this._megolmDecryption.hasSession(this._room.id,u.senderKey,u.sessionId,h)&&c.delete(d)}))}await Promise.all(Array.from(c.values()).map(h=>l.wrap("session",d=>this._requestMissingSessionFromBackup(h.senderKey,h.sessionId,d))))})}async _verifyDecryptionResults(e,t){await Promise.all(e.map(async s=>{let i=this._senderDeviceCache.get(s.senderCurve25519Key);i||(i=await this._deviceTracker.getDeviceByCurve25519Key(s.senderCurve25519Key,t),this._senderDeviceCache.set(s.senderCurve25519Key,i)),i&&s.setDevice(i)}))}async _fetchKeyAndVerifyDecryptionResults(e,t,s){const i=e.filter(r=>r.isVerificationUnknown);return i.length?s.wrap("fetch unverified senders",async r=>{const o=Array.from(i.reduce((h,d)=>h.add(d.encryptedEvent.sender),new Set));r.set("senders",o),await this._deviceTracker.devicesForUsers(o,t,r);const a=await this._storage.readTxn([this._storage.storeNames.deviceIdentities]);await this._verifyDecryptionResults(i,a);const l=i.filter(h=>!h.isVerificationUnknown).reduce((h,d)=>(h.set(d.encryptedEvent.event_id,d),h),new Map);return new Ir(l,new Map,this)}):new Ir(new Map,new Map,this)}async _requestMissingSessionFromBackup(e,t,s){if(!this._keyBackup){s.set("enabled",!1),this._notifyMissingMegolmSession();return}s.set("id",t),s.set("senderKey",e);try{const i=await this._keyBackup.getRoomKey(this._room.id,t,s);if(i){if(i.senderKey!==e){s.set("wrong_sender_key",i.senderKey),s.logLevel=s.level.Warn;return}let r=!1,o;const a=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions]);try{r=await this._megolmDecryption.writeRoomKey(i,a),s.set("isBetter",r),r&&(o=i.eventIds)}catch(c){throw a.abort(),c}await a.complete(),r&&await s.wrap("retryDecryption",c=>this._room.notifyRoomKey(i,o||[],c))}}catch(i){i.name==="HomeServerError"&&i.errcode==="M_NOT_FOUND"?(s.error=i,s.logLevel=s.level.Error):s.set("not_found",!0)}}getEventIdsForMissingKey(e,t){return this._megolmDecryption.getEventIdsForMissingKey(this._room.id,e.senderKey,e.sessionId,t)}async ensureMessageKeyIsShared(e,t){if(!(this._lastKeyPreShareTime?.measure()<ug)){this._lastKeyPreShareTime=this._clock.createMeasure();try{this._keySharePromise=(async()=>{const s=await this._megolmEncryption.ensureOutboundSession(this._room.id,this._encryptionParams);s&&(this._keyBackup?.flush(t),await t.wrap("share key",i=>this._shareNewRoomKey(s,e,i)))})(),await this._keySharePromise}finally{this._keySharePromise=null}}}async encrypt(e,t,s,i){this._keySharePromise&&(i.set("waitForRunningKeyShare",!0),await this._keySharePromise);const r=await i.wrap("megolm encrypt",()=>this._megolmEncryption.encrypt(this._room.id,e,t,this._encryptionParams));return r.roomKeyMessage&&(this._keyBackup?.flush(i),await i.wrap("share key",o=>this._shareNewRoomKey(r.roomKeyMessage,s,o))),{type:Ro,content:r.content}}needsToShareKeys(e){for(const t of e.values())if(t.hasJoined)return!0;return!1}async _shareNewRoomKey(e,t,s){this._historyVisibility=await this._loadHistoryVisibilityIfNeeded(this._historyVisibility),await this._deviceTracker.trackRoom(this._room,this._historyVisibility,s);const i=await this._deviceTracker.devicesForTrackedRoom(this._room.id,t,s),r=Array.from(i.reduce((c,l)=>c.add(l.userId),new Set));let o=await this._storage.readWriteTxn([this._storage.storeNames.operations]),a;try{a=this._writeRoomKeyShareOperation(e,r,o)}catch(c){throw o.abort(),c}await this._processShareRoomKeyOperation(a,t,s)}async _addShareRoomKeyOperationForMembers(e,t,s){const i=await this._megolmEncryption.createRoomKeyMessage(this._room.id,t);return i?(s.log({l:"share key for new members",userIds:e,id:i.session_id,chain_index:i.chain_index}),this._writeRoomKeyShareOperation(i,e,t),!0):!1}async flushPendingRoomKeyShares(e,t,s){if(!this._isFlushingRoomKeyShares){this._isFlushingRoomKeyShares=!0;try{t||(t=await(await this._storage.readTxn([this._storage.storeNames.operations])).operations.getAllByTypeAndScope("share_room_key",this._room.id));for(const i of t)i.type==="share_room_key"&&await s.wrap("operation",r=>this._processShareRoomKeyOperation(i,e,r))}finally{this._isFlushingRoomKeyShares=!1}}}_writeRoomKeyShareOperation(e,t,s){const r={id:Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(),type:"share_room_key",scope:this._room.id,userIds:t,roomKeyMessage:e};return s.operations.add(r),r}async _processShareRoomKeyOperation(e,t,s){s.set("id",e.id),this._historyVisibility=await this._loadHistoryVisibilityIfNeeded(this._historyVisibility),await this._deviceTracker.trackRoom(this._room,this._historyVisibility,s);const i=await this._deviceTracker.devicesForRoomMembers(this._room.id,e.userIds,t,s),r=await s.wrap("olm encrypt",a=>this._olmEncryption.encrypt("m.room_key",e.roomKeyMessage,i,t,a)),o=i.filter(a=>!r.some(c=>c.device===a));await s.wrap("send",a=>this._sendMessagesToDevices(Ro,r,t,a)),o.length&&await s.wrap("missingDevices",async a=>{a.set("devices",o.map(h=>h.deviceId));const c=e.userIds.filter(h=>o.some(d=>d.userId===h));a.set("unsentUserIds",c),e.userIds=c,await this._updateOperationsStore(h=>h.update(e));const l=this._megolmEncryption.createWithheldMessage(e.roomKeyMessage,"m.no_olm","OTKs exhausted");await this._sendSharedMessageToDevices("org.matrix.room_key.withheld",l,o,t,a)}),await this._updateOperationsStore(a=>a.remove(e.id))}async _updateOperationsStore(e){const t=await this._storage.readWriteTxn([this._storage.storeNames.operations]);try{e(t.operations)}catch(s){throw t.abort(),s}await t.complete()}async _sendSharedMessageToDevices(e,t,s,i,r){const o=Jt(s,l=>l.userId),a={messages:Array.from(o.entries()).reduce((l,[h,d])=>(l[h]=d.reduce((u,p)=>(u[p.deviceId]=t,u),{}),l),{})},c=Cs();await i.sendToDevice(e,a,c,{log:r}).response()}async _sendMessagesToDevices(e,t,s,i){i.set("messages",t.length);const r=wr(t),o=Cs();await s.sendToDevice(e,r,o,{log:i}).response()}filterUndecryptedEventEntriesForKeys(e,t){return e.filter(s=>{if(s.isEncrypted&&!s.isDecrypted){const{event:i}=s;if(i){const r=i.content?.sender_key,o=i.content?.session_id;return t.some(a=>r===a.senderKey&&o===a.sessionId)}}return!1})}dispose(){this._disposed=!0}}class pg{constructor(e,t,s,i,r){this._megolmDecryptionPreparation=e,this._extraErrors=t,this._source=s,this._roomEncryption=i,this._events=r}async decrypt(){return new _g(await this._megolmDecryptionPreparation.decrypt(),this._extraErrors,this._source,this._roomEncryption,this._events)}dispose(){this._megolmDecryptionPreparation.dispose()}}class _g{constructor(e,t,s,i,r){this._megolmDecryptionChanges=e,this._extraErrors=t,this._source=s,this._roomEncryption=i,this._events=r}async write(e,t){const{results:s,errors:i}=await this._megolmDecryptionChanges.write(e);return br(this._extraErrors,i),await this._roomEncryption._processDecryptionResults(this._events,s,i,this._source,e,t),new Ir(s,i,this._roomEncryption)}}class Ir{constructor(e,t,s){this.results=e,this.errors=t,this._roomEncryption=s}applyToEntries(e,t=void 0){for(const s of e){const i=this.results.get(s.id);if(i)s.setDecryptionResult(i),t?.(s);else{const r=this.errors.get(s.id);r&&(s.setDecryptionError(r),t?.(s))}}}verifyKnownSenders(e){return this._roomEncryption._verifyDecryptionResults(Array.from(this.results.values()),e)}get hasUnverifiedSenders(){for(const e of this.results.values())if(e.isVerificationUnknown)return!0;return!1}fetchAndVerifyRemainingSenders(e,t){return this._roomEncryption._fetchKeyAndVerifyDecryptionResults(Array.from(this.results.values()),e,t)}}const gs=0,sr=1;function yc(n,e=void 0){return{userId:n,roomIds:e?[e]:[],crossSigningKeys:void 0,deviceTrackingStatus:gs}}function gg(n,e,t){if(n){if(!n.roomIds.includes(t))return n.roomIds.push(t),n}else return n=yc(e,t),n}function Eo(n){const e=n.device_id;return{userId:n.user_id,deviceId:e,ed25519Key:n.keys[`ed25519:${e}`],curve25519Key:n.keys[`curve25519:${e}`],algorithms:n.algorithms,displayName:n.unsigned?.device_display_name}}class fg{constructor({storage:e,getSyncToken:t,olmUtil:s,ownUserId:i,ownDeviceId:r}){this._storage=e,this._getSyncToken=t,this._identityChangedForRoom=null,this._olmUtil=s,this._ownUserId=i,this._ownDeviceId=r}async writeDeviceChanges(e,t,s){const{userIdentities:i}=t;s.set("changed",e.length),await Promise.all(e.map(async r=>{const o=await i.get(r);o&&(s.log({l:"outdated",id:r}),o.deviceTrackingStatus=gs,i.set(o))}))}async writeMemberChanges(e,t,s,i){const r=[],o=[];return await Promise.all(Array.from(t.values()).map(async a=>{if(Ks(a.membership,s))await this._addRoomToUserIdentity(a.roomId,a.userId,i)&&r.push(a.userId);else if(Ks(a.previousMembership,s)){const{roomId:c}=a;if(a.userId===this._ownUserId){const l=await i.roomMembers.getAllUserIds(c);await Promise.all(l.map(h=>this._removeRoomFromUserIdentity(c,h,i)))}else await this._removeRoomFromUserIdentity(c,a.userId,i);o.push(a.userId)}})),{added:r,removed:o}}async trackRoom(e,t,s){if(e.isTrackingMembers||!e.isEncrypted)return;const i=await e.loadMemberList(void 0,s),r=await this._storage.readWriteTxn([this._storage.storeNames.roomSummary,this._storage.storeNames.userIdentities,this._storage.storeNames.deviceIdentities]);try{let o;try{o=e.writeIsTrackingMembers(!0,r);const a=Array.from(i.members.values());s.set("members",a.length),await Promise.all(a.map(async c=>{Ks(c.membership,t)?await this._addRoomToUserIdentity(c.roomId,c.userId,r):await this._removeRoomFromUserIdentity(c.roomId,c.userId,r)}))}catch(a){throw r.abort(),a}await r.complete(),e.applyIsTrackingMembersChanges(o)}finally{i.release()}}async getCrossSigningKeysForUser(e,t,s){return await s.wrap("DeviceTracker.getMasterKeyForUser",async i=>{let r=await this._storage.readTxn([this._storage.storeNames.userIdentities]),o=await r.userIdentities.get(e);return o&&o.deviceTrackingStatus!==gs?o.crossSigningKeys:(await this._queryKeys([e],t,i),r=await this._storage.readTxn([this._storage.storeNames.userIdentities]),o=await r.userIdentities.get(e),o?.crossSigningKeys)})}async writeHistoryVisibility(e,t,s,i){const r=[],o=[];return e.isTrackingMembers&&e.isEncrypted&&await i.wrap("rewriting userIdentities",async a=>{const c=await e.loadMemberList(s,a);try{const l=Array.from(c.members.values());a.set("members",l.length),await Promise.all(l.map(async h=>{Ks(h.membership,t)?await this._addRoomToUserIdentity(h.roomId,h.userId,s)&&r.push(h.userId):await this._removeRoomFromUserIdentity(h.roomId,h.userId,s)&&o.push(h.userId)}))}finally{c.release()}}),{added:r,removed:o}}async _addRoomToUserIdentity(e,t,s){const{userIdentities:i}=s,r=await i.get(t),o=gg(r,t,e);return o?(i.set(o),!0):!1}async _removeRoomFromUserIdentity(e,t,s){const{userIdentities:i,deviceIdentities:r}=s,o=await i.get(t);return o?(o.roomIds=o.roomIds.filter(a=>a!==e),o.roomIds.length===0?(i.remove(t),r.removeAllForUser(t)):i.set(o),!0):!1}async _queryKeys(e,t,s){const i=await t.queryKeys({timeout:1e4,device_keys:e.reduce((h,d)=>(h[d]=[],h),{}),token:this._getSyncToken()},{log:s}).response(),r=s.wrap("master keys",h=>this._filterValidMasterKeys(i,h)),o=s.wrap("self-signing keys",h=>this._filterVerifiedCrossSigningKeys(i.self_signing_keys,"self_signing",r,h)),a=s.wrap("verify",h=>this._filterVerifiedDeviceKeys(i.device_keys,h)),c=await this._storage.readWriteTxn([this._storage.storeNames.userIdentities,this._storage.storeNames.deviceIdentities]);let l;try{l=(await Promise.all(a.map(async({userId:d,verifiedKeys:u})=>{const p=u.map(Eo),_={masterKey:r.get(d),selfSigningKey:o.get(d)};return await this._storeQueriedDevicesForUserId(d,_,p,c)}))).reduce((d,u)=>d.concat(u),[]),s.set("devices",l.length)}catch(h){throw c.abort(),h}return await c.complete(),l}async _storeQueriedDevicesForUserId(e,t,s,i){const r=await i.deviceIdentities.getAllDeviceIds(e);for(const l of r)s.every(h=>h.deviceId!==l)&&i.deviceIdentities.remove(e,l);const o=[],a=[];await Promise.all(s.map(async l=>{if(r.includes(l.deviceId)){const h=await i.deviceIdentities.get(l.userId,l.deviceId);if(h.ed25519Key!==l.ed25519Key){o.push(h);return}}o.push(l),a.push(l)}));for(const l of a)i.deviceIdentities.set(l);let c=await i.userIdentities.get(e);return c||(c=yc(e)),c.deviceTrackingStatus=sr,c.crossSigningKeys=t,i.userIdentities.set(c),o}_filterValidMasterKeys(e,t){const s=new Map,i=e.master_keys;return i&&Object.entries(i).filter(([o,a])=>!(a.user_id!==o||!Array.isArray(a.usage)||!a.usage.includes("master"))).reduce((o,[a,c])=>{const l=Object.keys(c.keys);if(l.length!==1)return!1;const h=c.keys[l[0]];return o.set(a,h),o},s),s}_filterVerifiedCrossSigningKeys(e,t,s,i){const r=new Map;return e&&Object.entries(e).filter(([a,c])=>{if(c.user_id!==a||!Array.isArray(c.usage)||!c.usage.includes(t))return!1;const l=s.get(a);return lr(this._olmUtil,a,l,l,c,i)}).reduce((a,[c,l])=>{const h=Object.keys(l.keys);if(h.length!==1)return!1;const d=l.keys[h[0]];return a.set(c,d),a},r),r}_filterVerifiedDeviceKeys(e,t){const s=new Set;return Object.entries(e).map(([r,o])=>{const c=Object.entries(o).filter(([l,h])=>{const d=h.device_id;if(h.user_id!==r||d!==l)return!1;const p=h.keys?.[`ed25519:${l}`],_=h.keys?.[`curve25519:${l}`];if(typeof p!="string"||typeof _!="string")return!1;if(s.has(_))return t.log({l:"ignore device with duplicate curve25519 key",keys:h},t.level.Warn),!1;s.add(_);const g=this._hasValidSignature(h,t);return g||t.log({l:"ignore device with invalid signature",keys:h},t.level.Warn),g}).map(([,l])=>l);return{userId:r,verifiedKeys:c}})}_hasValidSignature(e,t){const s=e.device_id,i=e.user_id,r=e?.keys?.[`${ea}:${s}`];return lr(this._olmUtil,i,s,r,e,t)}async devicesForTrackedRoom(e,t,s){const i=await this._storage.readTxn([this._storage.storeNames.roomMembers,this._storage.storeNames.userIdentities]),r=await i.roomMembers.getAllUserIds(e);return await this._devicesForUserIdsInTrackedRoom(e,r,i,t,s)}async devicesForRoomMembers(e,t,s,i){const r=await this._storage.readTxn([this._storage.storeNames.userIdentities]);return await this._devicesForUserIdsInTrackedRoom(e,t,r,s,i)}async devicesForUsers(e,t,s){const i=await this._storage.readTxn([this._storage.storeNames.userIdentities]),r=[],o=[];return await Promise.all(e.map(async a=>{const c=await i.userIdentities.get(a);c&&c.deviceTrackingStatus===sr?r.push(c):(!c||c.deviceTrackingStatus===gs)&&o.push(a)})),this._devicesForUserIdentities(r,o,t,s)}async deviceForId(e,t,s,i){let o=await(await this._storage.readTxn([this._storage.storeNames.deviceIdentities])).deviceIdentities.get(e,t);if(o)i.set("existingDevice",!0);else{const a=await s.queryKeys({timeout:1e4,device_keys:{[e]:[t]},token:this._getSyncToken()},{log:i}).response(),l=i.wrap("verify",u=>this._filterVerifiedDeviceKeys(a.device_keys,u)).find(u=>u.userId===e).verifiedKeys.find(u=>u.device_id===t);if(!l)return;o=Eo(l);const h=await this._storage.readWriteTxn([this._storage.storeNames.deviceIdentities]),d=await h.deviceIdentities.get(e,t);if(d)o=d,i.set("existingDeviceAfterFetch",!0);else{try{h.deviceIdentities.set(o),i.set("newDevice",!0)}catch(u){throw h.abort(),u}await h.complete()}}return o}async _devicesForUserIdsInTrackedRoom(e,t,s,i,r){const a=(await Promise.all(t.map(d=>s.userIdentities.get(d)))).filter(d=>d&&d.roomIds.includes(e)),c=a.filter(d=>d.deviceTrackingStatus===sr),l=a.filter(d=>d.deviceTrackingStatus===gs).map(d=>d.userId);let h=await this._devicesForUserIdentities(c,l,i,r);return h=h.filter(d=>!(d.userId===this._ownUserId&&d.deviceId===this._ownDeviceId)),h}async _devicesForUserIdentities(e,t,s,i){i.set("uptodate",e.length),i.set("outdated",t.length);let r;t.length&&(r=await this._queryKeys(t,s,i));const o=await this._storage.readTxn([this._storage.storeNames.deviceIdentities]);let c=(await Promise.all(e.map(l=>o.deviceIdentities.getAllForUserId(l.userId)))).reduce((l,h)=>l.concat(h),[]);return r&&r.length&&(c=c.concat(r)),c}async getDeviceByCurve25519Key(e,t){return await t.deviceIdentities.getByCurve25519Key(e)}}class yg{constructor(){this._map=new Map}async takeLock(e){let t=this._map.get(e);return t?await t.take():(t=new cc,t.tryTake(),this._map.set(e,t)),t.released().then(()=>{Promise.resolve().then(()=>{t.isTaken||this._map.delete(e)})}),t}}class wg{constructor({key:e,platform:t}){this._key=e,this._platform=t}async readSecret(e,t){const s=await t.accountData.get(e);if(!s)return;const i=s?.content?.encrypted?.[this._key.id];if(!i)throw new Error(`Secret ${s.type} is not encrypted for key ${this._key.id}`);if(this._key.algorithm==="m.secret_storage.v1.aes-hmac-sha2")return await this._decryptAESSecret(s.type,i);throw new Error(`Unsupported algorithm for key ${this._key.id}: ${this._key.algorithm}`)}async _decryptAESSecret(e,t){const{base64:s,utf8:i}=this._platform.encoding,r=await this._platform.crypto.derive.hkdf(this._key.binaryKey,new Uint8Array(8).buffer,i.encode(e),"SHA-256",512),o=r.slice(0,32),a=r.slice(32),c=s.decode(t.ciphertext);if(!await this._platform.crypto.hmac.verify(a,s.decode(t.mac),c,"SHA-256"))throw new Error("Bad MAC");const h=await this._platform.crypto.aes.decryptCTR({key:o,iv:s.decode(t.iv),data:c});return i.decode(h)}}function wc(n,e,t=!1){for(const[s,i]of Object.entries(e)){if(n[s]instanceof Object&&i){wc(n[s],i);continue}if(i!=null||!t){n[s]=i;continue}}return n}/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0
THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.
See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */var Rr=(n=>(n.Video="video",n.Audio="audio",n))(Rr||{});function ht(n){return n?.getAudioTracks()[0]}function He(n){return n?.getVideoTracks()[0]}function kr(n,e,t){return t.wrap("mute",s=>{s.set("cameraMuted",e.camera),s.set("microphoneMuted",e.microphone);const i=ht(n.userMedia);if(i){const o=!e.microphone;s.set("microphone enabled",o),i.enabled=o}const r=He(n.userMedia);if(r){const o=!e.camera;s.set("camera enabled",o),r.enabled=o}})}class Qt{constructor(e=!1,t=!1,s=!1,i=!1){this.isMicrophoneMuted=e,this.isCameraMuted=t,this.hasMicrophoneTrack=s,this.hasCameraTrack=i}updateTrackInfo(e){this.hasMicrophoneTrack=!!ht(e),this.hasCameraTrack=!!He(e)}get microphone(){return!this.hasMicrophoneTrack||this.isMicrophoneMuted}get camera(){return!this.hasCameraTrack||this.isCameraMuted}toggleCamera(){return new Qt(this.microphone,!this.camera,this.hasMicrophoneTrack,this.hasCameraTrack)}toggleMicrophone(){return new Qt(!this.microphone,this.camera,this.hasMicrophoneTrack,this.hasCameraTrack)}equals(e){return this.microphone===e.microphone&&this.camera===e.camera}}const vt="call",ir=3600*1e3;var Er=(n=>(n[n.InviteGlare=0]="InviteGlare",n[n.Handle=1]="Handle",n[n.Ignore=2]="Ignore",n))(Er||{});class vg{constructor(e,t){this.userMedia=e,this.screenShare=t}}class bg{constructor(e,t,s){this.callId=e,this.options=t,this.logItem=s,this._state=T.Fledgling,this.candidateSendQueue=[],this.remoteCandidateBuffer=new Map,this.disposables=new Ri,this.statePromiseMap=new Map,this._remoteTrackToStreamId=new Map,this._remoteStreams=new Map,this.makingOffer=!1,this.ignoreOffer=!1,this.sentEndOfCandidates=!1,this._remoteMuteSettings=new Qt,this.onIceConnectionStateChange=async(r,o)=>{if(this._state===T.Ended)return;let a=!1;if(r=="connected")this.iceDisconnectedTimeout?.abort(),this.iceDisconnectedTimeout=void 0,this.setState(T.Connected,o);else if(r=="failed")a=!0,this.iceDisconnectedTimeout?.abort(),this.iceDisconnectedTimeout=void 0,await this._hangup(B.IceFailed,o);else if(r=="disconnected"){a=!0,this.iceDisconnectedTimeout=this.options.createTimeout(30*1e3);try{await this.iceDisconnectedTimeout.elapsed(),await this._hangup(B.IceFailed,o)}catch(c){if(!(c instanceof Ce))throw c}}if(a){const c=await this.peerConnection.getStats(),l={};c.forEach((h,d)=>{l[d]=h}),o.set("peerConnectionStats",l)}},s.log({l:"create PeerCall",id:e}),this._remoteMedia=new vg,this.peerConnection=t.webRTC.createPeerConnection(this.options.forceTURN,[this.options.turnServer.get()],0),this.disposables.track(this.options.turnServer.subscribe(r=>{this.logItem.log({l:"updating turn server",turnServer:r}),this.peerConnection.setConfiguration({iceServers:[r]})}));const i=(r,o,a)=>{const c=h=>{this.options.errorBoundary.try(()=>o(h))};this.peerConnection.addEventListener(r,c);const l=()=>{this.peerConnection.removeEventListener(r,c)};this.disposables.track(l)};i("iceconnectionstatechange",async()=>{const r=this.peerConnection.iceConnectionState;await s.wrap({l:"onIceConnectionStateChange",status:r},async o=>{await this.onIceConnectionStateChange(r,o)})}),i("icecandidate",async r=>{await s.wrap("onLocalIceCandidate",async o=>{r.candidate&&await this.handleLocalIceCandidate(r.candidate,o)})}),i("icegatheringstatechange",async()=>{const r=this.peerConnection.iceGatheringState;await s.wrap({l:"onIceGatheringStateChange",status:r},async o=>{await this.handleIceGatheringState(r,o)})}),i("track",r=>{s.wrap("onRemoteTrack",o=>{this.onRemoteTrack(r.track,r.streams,o)})}),i("datachannel",r=>{s.wrap("onRemoteDataChannel",o=>{this._dataChannel=r.channel,this.options.emitUpdate(this,void 0,o)})}),i("negotiationneeded",()=>{const r=this.peerConnection.signalingState,o=()=>s.wrap({l:"onNegotiationNeeded",signalingState:r},a=>this.handleNegotiation(a));this.responsePromiseChain=this.responsePromiseChain?.then(o)??o(),this.responsePromiseChain.catch(a=>this.options.errorBoundary.reportError(a))})}get dataChannel(){return this._dataChannel}get state(){return this._state}get hangupReason(){return this._hangupReason}get remoteMedia(){return this._remoteMedia}get remoteMuteSettings(){return this._remoteMuteSettings}call(e,t,s){return s.wrap("call",async i=>{this._state===T.Fledgling&&(i.set("signalingState",this.peerConnection.signalingState),this.direction=fs.Outbound,this.setState(T.CreateOffer,i),this.localMuteSettings=t,await this.updateLocalMedia(e,i),this.localMedia?.dataChannelOptions&&(this._dataChannel=this.peerConnection.createDataChannel("channel",this.localMedia.dataChannelOptions)),await this.waitForState([T.InviteSent,T.CreateAnswer]))})}answer(e,t,s){return s.wrap("answer",async i=>{if(this._state!==T.Ringing)return;this.setState(T.CreateAnswer,i),this.localMuteSettings=t,await this.updateLocalMedia(e,i);let r;try{r=await this.peerConnection.createAnswer()}catch(o){await i.wrap("Failed to create answer",a=>{a.catch(o),this.terminate(ue.Local,B.CreateAnswer,a)});return}try{await this.peerConnection.setLocalDescription(r),this.setState(T.Connecting,i)}catch(o){await i.wrap("Error setting local description!",a=>{a.catch(o),this.terminate(ue.Local,B.SetLocalDescription,a)});return}try{await this.delay(200)}catch{return}await this.sendAnswer(i)})}setMedia(e,t){return t.wrap("setMedia",async s=>{s.set("userMedia_audio",!!ht(e.userMedia)),s.set("userMedia_video",!!He(e.userMedia)),s.set("screenShare_video",!!He(e.screenShare)),s.set("datachannel",!!e.dataChannelOptions),await this.updateLocalMedia(e,s);const i={call_id:this.callId,version:1,[Ve]:this.getSDPMetadata()};await this.sendSignallingMessage({type:x.SDPStreamMetadataChangedPrefix,content:i},s)})}setMuted(e,t){return t.wrap("setMuted",async s=>{if(this.localMuteSettings=e,s.set("cameraMuted",e.camera),s.set("microphoneMuted",e.microphone),this.localMedia){kr(this.localMedia,e,s);const i={call_id:this.callId,version:1,[Ve]:this.getSDPMetadata()};await this.sendSignallingMessage({type:x.SDPStreamMetadataChangedPrefix,content:i},s)}})}hangup(e,t){return t.wrap("hangup",s=>this._hangup(e,s))}async _hangup(e,t){this._state===T.Ended||this._state===T.Ending||(this.setState(T.Ending,t),await this.sendHangupWithCallId(this.callId,e,t),this.terminate(ue.Local,e,t))}getMessageAction(e){const t=this.callId===e.content.call_id;return e.type===x.Invite&&!t?0:t?1:2}handleIncomingSignallingMessage(e,t,s){let i;return s.wrap({l:"receive signalling message",type:e.type,callId:e.content.call_id,payload:e.content},async r=>{if(i=r,this.getMessageAction(e)!==1){r.set("wrongCallId",!0);return}switch(e.type){case x.Invite:await this.handleFirstInvite(e.content,t,r);break;case x.Answer:await this.handleAnswer(e.content,t,r);break;case x.Negotiate:await this.onNegotiateReceived(e.content,r);break;case x.Candidates:await this.handleRemoteIceCandidates(e.content,t,r);break;case x.SDPStreamMetadataChanged:case x.SDPStreamMetadataChangedPrefix:this.updateRemoteSDPStreamMetadata(e.content[Ve],r);break;case x.Hangup:r.set("reason",e.content.reason),this.terminate(ue.Remote,e.content.reason??B.UserHangup,r);break;default:r.log(`Unknown event type for call: ${e.type}`);break}}),i}sendHangupWithCallId(e,t,s){const i={call_id:e,version:1};return t&&(i.reason=t),this.sendSignallingMessage({type:x.Hangup,content:i},s)}async handleNegotiation(e){this.makingOffer=!0;try{try{await this.peerConnection.setLocalDescription()}catch(s){e.log("Error setting local description!").catch(s),this.terminate(ue.Local,B.SetLocalDescription,e);return}if(this.peerConnection.iceGatheringState==="gathering")try{await this.delay(200)}catch{return}if(this._state===T.Ended)return;const t=this.peerConnection.localDescription;if(e.set("includedCandidates",this.candidateSendQueue.length),this.candidateSendQueue=[],this._state===T.CreateOffer){const s={call_id:this.callId,offer:t,[Ve]:this.getSDPMetadata(),version:1,lifetime:ds};await this.sendSignallingMessage({type:x.Invite,content:s},e),this.setState(T.InviteSent,e)}else if(this._state===T.Connected||this._state===T.Connecting){const s={call_id:this.callId,description:t,[Ve]:this.getSDPMetadata(),version:1,lifetime:ds};await this.sendSignallingMessage({type:x.Negotiate,content:s},e)}}finally{this.makingOffer=!1}if(this.sendCandidateQueue(e),this._state===T.InviteSent){const t=this.logItem.child("invite timeout");e.refDetached(t),await t.run(async s=>{try{await this.delay(ds)}catch{return}this._state===T.InviteSent&&await this._hangup(B.InviteTimeout,s)})}}handleInviteGlare(e,t,s){if(e.type!==x.Invite)return{shouldReplace:!1};const{content:i}=e,r=i.call_id,o=this.callId>r;let a;return s.wrap("handling call glare",async c=>{a=c,o?(c.log("Glare detected: answering incoming call "+r+" and canceling outgoing call "),this._state!==T.Fledgling&&this._state!==T.CreateOffer&&await this.sendHangupWithCallId(this.callId,B.Replaced,c),this.close(B.Replaced,c),this.dispose()):(c.log("Glare detected: rejecting incoming call "+r+" and keeping outgoing call "),await this.sendHangupWithCallId(r,B.Replaced,c))}),{shouldReplace:o,log:a}}handleHangupReceived(e,t){this.terminate(ue.Remote,e.reason||B.UserHangup,t)}async handleFirstInvite(e,t,s){this._state!==T.Fledgling||this.opponentPartyId!==void 0||await this.handleInvite(e,t,s)}async handleInvite(e,t,s){this.opponentPartyId=t,this.direction=fs.Inbound;const i=e[Ve];i?this.updateRemoteSDPStreamMetadata(i,s):s.log("Call did not get any SDPStreamMetadata! Can not send/receive multiple streams");try{await this.peerConnection.setRemoteDescription(e.offer),await this.addBufferedIceCandidates(s)}catch(r){await s.wrap("Call failed to set remote description",async o=>(o.catch(r),this.terminate(ue.Local,B.SetRemoteDescription,o)));return}if(this.peerConnection.getReceivers().length===0){await s.wrap("Call no remote stream or no tracks after setting remote description!",async r=>this.terminate(ue.Local,B.SetRemoteDescription,r));return}this.setState(T.Ringing,s);try{await this.delay(e.lifetime??ds)}catch{return}this._state===T.Ringing&&(s.log("Invite has expired. Hanging up."),this.hangupParty=ue.Remote,this.setState(T.Ended,s),this.peerConnection.signalingState!="closed"&&this.peerConnection.close())}async handleAnswer(e,t,s){if(this._state===T.Ended){s.log("Ignoring answer because call has ended");return}if(this.opponentPartyId!==void 0){s.log(`Ignoring answer: we already have an answer/reject from ${this.opponentPartyId}`);return}this.opponentPartyId=t,await this.addBufferedIceCandidates(s),this.setState(T.Connecting,s);const i=e[Ve];i?this.updateRemoteSDPStreamMetadata(i,s):s.log("Did not get any SDPStreamMetadata! Can not send/receive multiple streams");try{await this.peerConnection.setRemoteDescription(e.answer)}catch(r){await s.wrap("Failed to set remote description",o=>{o.catch(r),this.terminate(ue.Local,B.SetRemoteDescription,o)});return}}async handleIceGatheringState(e,t){if(e==="complete"&&!this.sentEndOfCandidates){const s={candidate:""};await this.queueCandidate(s,t),this.sentEndOfCandidates=!0}}async handleLocalIceCandidate(e,t){t.set("sdpMid",e.sdpMid),t.set("candidate",e.candidate),this._state!==T.Ended&&(e.candidate!==""||!this.sentEndOfCandidates)&&(await this.queueCandidate(e,t),e.candidate===""&&(this.sentEndOfCandidates=!0))}async handleRemoteIceCandidates(e,t,s){if(this.state===T.Ended){s.log("Ignoring remote ICE candidate because call has ended");return}const i=e.candidates;if(!i){s.log("Ignoring candidates event with no candidates!");return}const r=e.version===0?null:t||null;if(this.opponentPartyId===void 0){s.log(`Buffering ${i.length} candidates until we pick an opponent`);const o=this.remoteCandidateBuffer.get(r)||[];o.push(...i),this.remoteCandidateBuffer.set(r,o);return}if(this.opponentPartyId!==t){s.log(`Ignoring candidates from party ID ${t}: we have chosen party ID ${this.opponentPartyId}`);return}await this.addIceCandidates(i,s)}async onNegotiateReceived(e,t){const s=e.description;if(!s||!s.sdp||!s.type){t.log("Ignoring invalid m.call.negotiate event");return}const i=this.direction===fs.Inbound,r=s.type==="offer"&&(this.makingOffer||this.peerConnection.signalingState!=="stable");if(this.ignoreOffer=!i&&r,this.ignoreOffer){t.log("Ignoring colliding negotiate event because we're impolite");return}const o=e[Ve];o?this.updateRemoteSDPStreamMetadata(o,t):t.log("Received negotiation event without SDPStreamMetadata!");try{if(await this.peerConnection.setRemoteDescription(s),s.type==="offer"){await this.peerConnection.setLocalDescription();const a={call_id:this.callId,description:this.peerConnection.localDescription,[Ve]:this.getSDPMetadata(),version:1,lifetime:ds};await this.sendSignallingMessage({type:x.Negotiate,content:a},t)}}catch(a){t.log("Failed to complete negotiation").catch(a)}}async sendAnswer(e){const t=this.peerConnection.localDescription,s={call_id:this.callId,version:1,answer:{sdp:t.sdp,type:t.type},[Ve]:this.getSDPMetadata()};e.log(`Discarding ${this.candidateSendQueue.length} candidates that will be sent in answer`),this.candidateSendQueue=[];try{await this.sendSignallingMessage({type:x.Answer,content:s},e)}catch(i){throw this.terminate(ue.Local,B.SendAnswer,e),i}this.sendCandidateQueue(e)}async queueCandidate(e,t){if(this.candidateSendQueue.push(e),this._state===T.Ringing)return;this.flushCandidatesLog=this.flushCandidatesLog??this.logItem.child("flush candidate queue"),t.refDetached(this.flushCandidatesLog);const{flushCandidatesLog:s}=this;try{await this.delay(this.direction===fs.Inbound?500:2e3)}catch{return}this.sendCandidateQueue(s),this.flushCandidatesLog=void 0}async sendCandidateQueue(e){if(this.candidateSendQueue.length===0||this._state===T.Ended)return;const t=this.candidateSendQueue;return this.candidateSendQueue=[],e.wrap({l:"send candidates",size:t.length},async s=>{try{await this.sendSignallingMessage({type:x.Candidates,content:{call_id:this.callId,version:1,candidates:t}},s),await this.sendCandidateQueue(s)}catch(i){s.catch(i),this.terminate(ue.Local,B.SignallingFailed,s)}})}updateRemoteSDPStreamMetadata(e,t){this.remoteSDPStreamMetadata=wc(this.remoteSDPStreamMetadata||{},e,!0),this.updateRemoteMedia(t)}async addBufferedIceCandidates(e){if(this.remoteCandidateBuffer&&this.opponentPartyId){const t=this.remoteCandidateBuffer.get(this.opponentPartyId);t&&(e.log(`Adding ${t.length} buffered candidates for opponent ${this.opponentPartyId}`),await this.addIceCandidates(t,e)),this.remoteCandidateBuffer=void 0}}async addIceCandidates(e,t){for(const s of e){let i;(s.sdpMid===null||s.sdpMid===void 0)&&(s.sdpMLineIndex===null||s.sdpMLineIndex===void 0)?i=t.log("Got remote end-of-ICE candidates"):i=t.log(`Adding remote ICE ${s.sdpMid} candidate: ${s.candidate}`);try{await this.peerConnection.addIceCandidate(s)}catch(r){this.ignoreOffer||i.catch(r)}}}setState(e,t){if(e!==this._state){t.log({l:"change state",status:e,oldState:this._state}),this._state,this._state=e;let s=this.statePromiseMap.get(e);s&&(s.resolve(),this.statePromiseMap.delete(e)),this.options.emitUpdate(this,void 0,t)}}waitForState(e){return Promise.race(e.map(t=>{let s=this.statePromiseMap.get(t);if(!s){let i;const r=new Promise(o=>{i=o});s={resolve:i,promise:r},this.statePromiseMap.set(t,s)}return s.promise}))}terminate(e,t,s){this._state!==T.Ended&&(this.hangupParty=e,this._hangupReason=t,this.setState(T.Ended,s),this.localMedia=void 0,this.peerConnection&&this.peerConnection.signalingState!=="closed"&&this.peerConnection.close())}getSDPMetadata(){const e={};if(this.localMedia?.userMedia){const t=this.localMedia.userMedia.id;e[t]={purpose:rt.Usermedia,audio_muted:this.localMuteSettings?.microphone??!1,video_muted:this.localMuteSettings?.camera??!1}}if(this.localMedia?.screenShare){const t=this.localMedia.screenShare.id;e[t]={purpose:rt.Screenshare}}return e}findReceiverForStream(e,t){return this.peerConnection.getReceivers().find(s=>s.track.kind===e&&this._remoteTrackToStreamId.get(s.track.id)===t)}findTransceiverForTrack(e){return this.peerConnection.getTransceivers().find(t=>t.sender.track?.id===e.id)}onRemoteTrack(e,t,s){if(s.set("kind",e.kind),s.set("id",e.id),s.set("streams",t.map(r=>r.id)),t.length===0){s.log({l:`ignoring ${e.kind} streamless track`,id:e.id});return}const i=t[0];if(this._remoteTrackToStreamId.set(e.id,i.id),!this._remoteStreams.has(i.id)){const r=a=>{this.logItem.wrap({l:"removetrack",id:a.track.id},c=>{const l=this._remoteTrackToStreamId.get(a.track.id);if(l){this._remoteTrackToStreamId.delete(a.track.id);const h=this._remoteStreams.get(l);h&&h.stream.getTracks().length===0&&(this.disposables.disposeTracked(o),this._remoteStreams.delete(i.id),this.updateRemoteMedia(c))}})};i.addEventListener("removetrack",r);const o=()=>{i.removeEventListener("removetrack",r)};this.disposables.track(o),this._remoteStreams.set(i.id,{disposeListener:o,stream:i})}this.updateRemoteMedia(s)}updateRemoteMedia(e){e.wrap("reevaluating remote media",t=>{if(this._remoteMedia.userMedia=void 0,this._remoteMedia.screenShare=void 0,this.remoteSDPStreamMetadata)for(const s of this._remoteStreams.values()){const{stream:i}=s,r=this.remoteSDPStreamMetadata[i.id];if(r)if(r.purpose===rt.Usermedia){this._remoteMedia.userMedia=i;const o=this.findReceiverForStream(Rr.Audio,i.id);o&&(o.track.enabled=!r.audio_muted);const a=this.findReceiverForStream(Rr.Video,i.id);a&&(a.track.enabled=!r.video_muted),this._remoteMuteSettings=new Qt(r.audio_muted??!1,r.video_muted??!1,!!o?.track,!!a?.track),t.log({l:"setting userMedia",micMuted:this._remoteMuteSettings.microphone,cameraMuted:this._remoteMuteSettings.camera})}else r.purpose===rt.Screenshare&&(this._remoteMedia.screenShare=i,t.log("setting screenShare"));else t.log({l:"no metadata yet for stream, ignoring for now",id:i.id})}this.options.emitUpdate(this,void 0,t)})}updateLocalMedia(e,t){return t.wrap("updateLocalMedia",async s=>{const i=this.peerConnection.getSenders(),r=async(o,a,c)=>{const l=async(h,d)=>{const u=i.find(_=>_.track===h),p=o??a;if(p!==a&&(h&&(p.removeTrack(h),h.stop()),d&&p.addTrack(d)),d&&u)try{await s.wrap(`attempting to replace ${c} ${d.kind} track`,_=>u.replaceTrack(d));return}catch{}u&&s.wrap(`removing ${c} ${u.track.kind} track`,_=>{this.peerConnection.removeTrack(u)}),d&&s.wrap(`adding ${c} ${d.kind} track`,_=>{const g=this.peerConnection.addTrack(d,p);this.options.webRTC.prepareSenderForPurpose(this.peerConnection,g,c)})};!o&&!a||(await l(ht(o),ht(a)),await l(He(o),He(a)))};await r(this.localMedia?.userMedia,e?.userMedia,rt.Usermedia),await r(this.localMedia?.screenShare,e?.screenShare,rt.Screenshare),this.localMedia||(this.localMedia=e)})}async delay(e){const t=this.disposables.track(this.options.createTimeout(e));try{await t.elapsed()}finally{this.disposables.untrack(t)}}sendSignallingMessage(e,t){return t.wrap({l:"send",id:e.type},async s=>this.options.sendSignallingMessage(e,s))}dispose(){this.disposables.dispose(),this.iceDisconnectedTimeout?.abort(),this.peerConnection.close(),this.options.emitUpdate=(e,t,s)=>{s.log("emitting update from PeerCall after disposal",this.logItem.level.Error),console.trace("emitting update from PeerCall after disposal")}}close(e,t){e===void 0&&(e=B.UserHangup),this.terminate(ue.Local,e,t)}}var ue=(n=>(n.Local="local",n.Remote="remote",n))(ue||{}),T=(n=>(n.Fledgling="fledgling",n.CreateOffer="create_offer",n.InviteSent="invite_sent",n.CreateAnswer="create_answer",n.Connecting="connecting",n.Connected="connected",n.Ringing="ringing",n.Ending="ending",n.Ended="ended",n))(T||{}),fs=(n=>(n.Inbound="inbound",n.Outbound="outbound",n))(fs||{});const ds=6e4;function Sg(n){return n===x.Invite||n===x.Candidates||n===x.Answer||n===x.Hangup||n===x.SDPStreamMetadataChanged||n===x.SDPStreamMetadataChangedPrefix||n===x.Negotiate}class vc{constructor(e){this.errorCallback=e}try(e,t){try{let s=e();return s instanceof Promise&&(s=s.catch(i=>(this._error=i,this.reportError(i),t))),s}catch(s){return this._error=s,this.reportError(s),t}}reportError(e){try{this.errorCallback(e)}catch(t){console.error("error in ErrorBoundary callback",t)}}get error(){return this._error}}const Ig=[B.UserHangup,B.AnsweredElsewhere,B.Replaced,B.UserBusy,B.Transfered,B.NewSession];class Rg{constructor(e,t,s,i){this.localMedia=e,this.localMuteSettings=t,this.turnServer=s,this.logItem=i,this.retryCount=0,this.queuedSignallingMessages=[],this.outboundSeqCounter=0}get canDequeueNextSignallingMessage(){if(this.queuedSignallingMessages.length===0)return!1;const t=this.queuedSignallingMessages[0].content.seq;return this.lastIgnoredSeqNr!==void 0&&t===this.lastIgnoredSeqNr+1?!0:this.lastProcessedSeqNr===void 0?t===0:t<=this.lastProcessedSeqNr+1}dispose(){this.peerCall?.dispose(),this.localMedia.dispose(),this.logItem.finish()}}class kg{constructor(e,t,s,i){this.member=e,this.callDeviceMembership=t,this.options=s,this.errorBoundary=new vc(r=>{this.options.emitUpdate(this,"error"),this.connection&&this.connection.logItem.log("error at boundary").catch(r)}),this.emitUpdateFromPeerCall=async(r,o,a)=>{const c=this.connection;if(r.state===T.Ringing)c.logItem.wrap("ringing, answer peercall",l=>(a.refDetached(l),r.answer(c.localMedia,c.localMuteSettings,l)));else if(r.state===T.Ended){const l=r.hangupReason;if(r.dispose(),c.peerCall=void 0,l&&!Ig.includes(l)){c.retryCount+=1;const{retryCount:h}=c;await c.logItem.wrap({l:"retry connection",retryCount:h},async d=>{if(a.refDetached(d),h<=3)await this.callIfNeeded(d);else{const u=await this.disconnect(!1);u&&d.refDetached(u)}})}}this.options.emitUpdate(this,o)},this.sendSignallingMessage=async(r,o)=>{const a=r;a.content.seq=this.connection.outboundSeqCounter++,a.content.conf_id=this.options.confId,a.content.device_id=this.options.ownDeviceId,a.content.party_id=this.options.ownDeviceId,a.content.sender_session_id=this.options.sessionId,a.content.dest_session_id=this.sessionId;let c,l=r.type;const h=await this.options.encryptDeviceMessage(this.member.userId,this.deviceId,a,o);h?(c=wr(h),l="m.room.encrypted"):c=wr([{content:a.content,device:this}]),o.set("payload",a.content),await this.options.hsApi.sendToDevice(l,c,Cs(),{log:o}).response()},this._renewExpireTimeout(i)}get error(){return this.errorBoundary.error}get usesFoci(){const e=this.callDeviceMembership["m.foci.active"];return Array.isArray(e)&&e.length>0}_renewExpireTimeout(e){this.expireTimeout?.dispose(),this.expireTimeout=void 0;const t=wi(this.callDeviceMembership);if(typeof t!="number")return;const s=Math.max(0,t-this.options.clock.now());e?.set("expiresIn",s),this.expireTimeout=this.options.clock.createTimeout(s+10),this.expireTimeout.elapsed().then(()=>{this.options.emitUpdate(this,"isExpired")},i=>{})}get logItem(){return this.connection?.logItem}get remoteMedia(){return this.connection?.peerCall?.remoteMedia}get isExpired(){return!this.isConnected&&Mr(this.callDeviceMembership,this.options.clock.now())}get remoteMuteSettings(){return this.connection?.peerCall?.remoteMuteSettings}get isConnected(){return this.connection?.peerCall?.state===T.Connected}get userId(){return this.member.userId}get deviceId(){return this.callDeviceMembership.device_id}get sessionId(){return this.callDeviceMembership.session_id}get dataChannel(){return this.connection?.peerCall?.dataChannel}connect(e,t,s,i){return this.errorBoundary.try(async()=>{if(this.connection)return;const r=new Rg(e.clone(),t,s,i);this.connection=r;let o;return await r.logItem.wrap("connect",async a=>{o=a,await this.callIfNeeded(a)}),o})}callIfNeeded(e){return e.wrap("callIfNeeded",async t=>{let s;if(this.member.userId===this.options.ownUserId?s=this.deviceId>this.options.ownDeviceId:s=this.member.userId>this.options.ownUserId,s){const i=this.connection;i.peerCall=this._createPeerCall(gi("c")),await i.peerCall.call(i.localMedia,i.localMuteSettings,t)}else t.set("wait_for_invite",!0)})}disconnect(e){return this.errorBoundary.try(async()=>{const{connection:t}=this;if(!t)return;let s;return await t.logItem.wrap("disconnect",async i=>{s=i,e&&t.peerCall&&await t.peerCall.hangup(B.UserHangup,i)}),t.dispose(),this.connection=void 0,s})}updateCallInfo(e,t){this.errorBoundary.try(()=>{this.callDeviceMembership=e,this._renewExpireTimeout(t),this.connection&&this.connection.logItem.refDetached(t)})}updateRoomMember(e){this.member=e,this.options.emitUpdate(this)}handleDeviceMessage(e,t){this.errorBoundary.try(()=>{t.wrap({l:"Member.handleDeviceMessage",type:e.type,seq:e.content?.seq},s=>{const{connection:i}=this;if(i){const r=e.content.dest_session_id;if(r!==this.options.sessionId){const c=i.logItem.log({l:"ignoring to_device event with wrong session_id",destSessionId:r,type:e.type});s.refDetached(c);return}if(i.peerCall&&i.peerCall.getMessageAction(e)===Er.InviteGlare){const{shouldReplace:l,log:h}=i.peerCall.handleInviteGlare(e,this.deviceId,i.logItem);h&&h.refDetached(h),l&&(i.peerCall.dispose(),i.peerCall=void 0)}e.type===x.Invite&&!i.peerCall&&(i.peerCall=this._createPeerCall(e.content.call_id));const o=ze(i.queuedSignallingMessages,e,(c,l)=>c.content.seq-l.content.seq);i.queuedSignallingMessages.splice(o,0,e);let a=!1;i.peerCall&&(a=this.dequeueSignallingMessages(i,i.peerCall,e,s)),a||s.refDetached(i.logItem.log({l:"queued message",type:e.type,seq:e.content.seq,idx:o}))}else t.log({l:"member not connected",userId:this.userId,deviceId:this.deviceId})})})}dequeueSignallingMessages(e,t,s,i){let r=!1;for(;e.canDequeueNextSignallingMessage;){const o=e.queuedSignallingMessages.shift(),a=o===s;r=r||a,i.wrap(a?"process message":"dequeue message",c=>{const l=o.content?.seq;if(c.set("seq",l),c.set("type",o.type),t.getMessageAction(o)===Er.Handle){const d=t.handleIncomingSignallingMessage(o,this.deviceId,e.logItem);c.refDetached(d),e.lastProcessedSeqNr=l}else c.set("ignored",!0),e.lastIgnoredSeqNr=l})}return r}async setMedia(e,t){return this.errorBoundary.try(async()=>{const{connection:s}=this;s&&(s.localMedia=e.replaceClone(s.localMedia,t),await s.peerCall?.setMedia(s.localMedia,s.logItem))})}async setMuted(e){return this.errorBoundary.try(async()=>{const{connection:t}=this;t&&(t.localMuteSettings=e,await t.peerCall?.setMuted(e,t.logItem))})}_createPeerCall(e){const t=this.connection;return new bg(e,Object.assign({},this.options,{errorBoundary:this.errorBoundary,emitUpdate:this.emitUpdateFromPeerCall,sendSignallingMessage:this.sendSignallingMessage,turnServer:t.turnServer}),t.logItem)}dispose(){this.connection?.dispose(),this.connection=void 0,this.expireTimeout?.dispose(),this.expireTimeout=void 0,this.options.emitUpdate=()=>{}}}function wi(n){const e=n.expires_ts;if(Number.isSafeInteger(e))return e}function Mr(n,e,t=0){const s=wi(n);return typeof s=="number"?s+t<=e:!0}function $t(n,e){return JSON.stringify(n)+","+JSON.stringify(e)}function Mo(n,e){return n.startsWith(JSON.stringify(e)+",")}function Eg(n){return JSON.parse(`[${n}]`)[1]}class Mg{constructor(e,t,s,i,r,o){this.logItem=e,this.membersLogItem=t,this.localMedia=s,this.localPreviewMedia=i,this.localMuteSettings=r,this.turnServer=o}dispose(){this.localMedia.dispose(),this.localPreviewMedia.dispose(),this.logItem.finish(),this.renewMembershipTimeout?.dispose()}}class rr extends Nt{constructor(e,t,s,i,r,o,a){super(),this.id=e,this.isLoadedFromStorage=t,this.startTime=i,this.callContent=r,this.roomId=o,this.options=a,this._members=new ct,this.bufferedDeviceMessages=new Map,this.errorBoundary=new vc(c=>{this.emitChange(),this.joinedData&&(this.joinedData.logItem.log("error at boundary").catch(c),console.error(c))}),this._state=s?"fledgling":"created",this._memberOptions=Object.assign({},a,{confId:this.id,emitUpdate:c=>{const l=$t(c.userId,c.deviceId);if(c.isExpired&&!c.isConnected){const h=this.options.logger.log({l:"removing expired member from call",memberKey:l,callId:this.id});c.logItem?.refDetached(h),c.dispose(),this._members.remove(l)}else this._members.update(l)},encryptDeviceMessage:(c,l,h,d)=>this.options.encryptDeviceMessage(this.roomId,c,l,h,d)})}get localMedia(){return this.joinedData?.localMedia}get localPreviewMedia(){return this.joinedData?.localPreviewMedia}get members(){return this._members}get isTerminated(){return!!this.callContent?.["m.terminated"]}get usesFoci(){for(const e of this._members.values())if(e.usesFoci)return!0;return!1}get duration(){if(typeof this.startTime=="number")return this.options.clock.now()-this.startTime}get isRinging(){return this._state==="created"&&this.intent==="m.ring"&&!this.isMember(this.options.ownUserId)}get name(){return this.callContent?.["m.name"]}get intent(){return this.callContent?.["m.intent"]}get type(){return this.callContent?.["m.type"]}get logItem(){return this.joinedData?.logItem}get error(){return this.errorBoundary.error}join(e,t){return this.options.logger.wrapOrRun(t,"Call.join",async s=>{if(this._state!=="created"||this.joinedData||this.usesFoci){e.dispose();return}const i=this.options.logger.child({l:"Call.connection",t:vt,id:this.id,ownSessionId:this.options.sessionId}),r=await this.options.turnServerSource.getSettings(i),o=i.child("member connections"),a=new Qt;a.updateTrackInfo(e.userMedia);const c=e.asPreview(),l=new Mg(i,o,e,c,a,r);this.joinedData=l,await l.logItem.wrap("join",async h=>{s.refDetached(h),this._state="joining",this.emitChange(),await h.wrap("update member state",async d=>{const u=await this._createMemberPayload(!0);d.set("payload",u),await this.options.hsApi.sendState(this.roomId,x.GroupCallMember,this.options.ownUserId,u,{log:d}).response(),this.emitChange()});for(const d of this._members.values())this.connectToMember(d,l,h)})})}async setMedia(e){if((this._state==="joining"||this._state==="joined")&&this.joinedData){const t=this.joinedData.localMedia;this.joinedData.localMedia=e,this.joinedData.localPreviewMedia?.dispose(),this.joinedData.localPreviewMedia=e.asPreview(),this.joinedData.localMuteSettings.updateTrackInfo(e.userMedia),this.emitChange(),await Promise.all(Array.from(this._members.values()).map(s=>s.setMedia(e,t))),t?.dispose()}}async setMuted(e){const{joinedData:t}=this;if(!t)return;const s=t.localMuteSettings;e.updateTrackInfo(t.localMedia.userMedia),t.localMuteSettings=e,s.equals(e)||(this.localPreviewMedia&&kr(this.localPreviewMedia,e,this.joinedData.logItem),this.localMedia&&kr(this.localMedia,e,this.joinedData.logItem),await Promise.all(Array.from(this._members.values()).map(i=>i.setMuted(t.localMuteSettings))),this.emitChange())}get muteSettings(){return this.joinedData?.localMuteSettings}get hasJoined(){return this._state==="joining"||this._state==="joined"}async leave(e){await this.options.logger.wrapOrRun(e,"Call.leave",async t=>{const{joinedData:s}=this;if(!!s)try{s.renewMembershipTimeout?.dispose(),s.renewMembershipTimeout=void 0;const i=await this._createMemberPayload(!1);i?(await this.options.hsApi.sendState(this.roomId,x.GroupCallMember,this.options.ownUserId,i,{log:t}).response(),(this.intent===Ms.Ring||this.intent===Ms.Prompt)&&this._members.size===0&&await this.terminate(t)):t.set("already_left",!0)}finally{if(!this.disconnect(t))throw this.errorBoundary.error}})}terminate(e){return this.options.logger.wrapOrRun(e,{l:"terminate call",t:vt},async t=>{if(this._state==="fledgling")return;await this.options.hsApi.sendState(this.roomId,x.GroupCall,this.id,Object.assign({},this.callContent,{"m.terminated":!0}),{log:t}).response()})}create(e,t){return t.wrap({l:"create call",t:vt},async s=>{if(this._state!=="fledgling")return;this._state="creating",this.emitChange(),this.callContent=Object.assign({"m.type":e},this.callContent),await this.options.hsApi.sendState(this.roomId,x.GroupCall,this.id,this.callContent,{log:s}).response(),this._state="created",this.emitChange()})}updateCallEvent(e,t){this.errorBoundary.try(()=>{t.wrap({l:"update call",t:vt,id:this.id},s=>{typeof this.startTime!="number"&&(this.startTime=e.origin_server_ts),this.callContent=e.content,this._state==="creating"&&(this._state="created"),s.set("status",this._state),this.emitChange()})})}updateRoomMembers(e){this.errorBoundary.try(()=>{for(const t of e.values()){const{member:s}=t;for(const i of this._members.values())i.userId===s.userId&&i.updateRoomMember(s)}})}updateMembership(e,t,s,i){this.errorBoundary.try(async()=>{await i.wrap({l:"update call membership",t:vt,id:this.id,userId:e},async r=>{const o=this.options.clock.now(),a=s["m.devices"],c=this.getDeviceIdsForUserId(e);for(const h of a){const d=h.device_id,u=$t(e,d);e===this.options.ownUserId&&d===this.options.ownDeviceId?r.wrap("update own membership",p=>{this.hasJoined&&(this.joinedData&&this.joinedData.logItem.refDetached(p),this._setupRenewMembershipTimeout(h,p)),this._state==="joining"&&(p.set("joined",!0),this._state="joined",this.emitChange())}):await r.wrap({l:"update device membership",id:u,sessionId:h.session_id},async p=>{if(Mr(h,o)){p.set("expired",!0);const w=this._members.get(u);w&&(w.dispose(),this._members.remove(u),p.set("removed",!0));return}let _=this._members.get(u);const g=_&&_.sessionId!==h.session_id;if(_&&!g)p.set("update",!0),_.updateCallInfo(h,p);else{if(_&&g){p.set("removedSessionId",_.sessionId);const w=await _.disconnect(!1);w&&p.refDetached(w),_.dispose(),this._members.remove(u),_=void 0}p.set("add",!0),_=new kg(t,h,this._memberOptions,p),this._members.add(u,_),this.joinedData&&this.connectToMember(_,this.joinedData,p)}this.flushPendingIncomingDeviceMessages(_,p)})}const l=new Set(a.map(h=>h.device_id));for(const h of c)l.has(h)||this.removeMemberDevice(e,h,r);e===this.options.ownUserId&&!l.has(this.options.ownDeviceId)&&this.removeOwnDevice(r)})})}removeMembership(e,t){this.errorBoundary.try(()=>{const s=this.getDeviceIdsForUserId(e);t.wrap({l:"remove call member",t:vt,id:this.id,userId:e},i=>{for(const r of s)this.removeMemberDevice(e,r,i);e===this.options.ownUserId&&this.removeOwnDevice(i)})})}flushPendingIncomingDeviceMessages(e,t){const s=$t(e.userId,e.deviceId),i=this.bufferedDeviceMessages.get(s);if(i){for(const r of i)r.content.sender_session_id===e.sessionId&&(e.handleDeviceMessage(r,t),i.delete(r));i.size===0&&this.bufferedDeviceMessages.delete(s)}}getDeviceIdsForUserId(e){return Array.from(this._members.keys()).filter(t=>Mo(t,e)).map(t=>Eg(t))}isMember(e){return Array.from(this._members.keys()).some(t=>Mo(t,e))}removeOwnDevice(e){e.wrap("remove own membership",t=>{this.disconnect(t)})}disconnect(e){return this.errorBoundary.try(async()=>{if(this.hasJoined){for(const t of this._members.values()){const s=await t.disconnect(!0);s&&e.refDetached(s)}this._state="created"}this.joinedData?.dispose(),this.joinedData=void 0,this.emitChange()},!1)||!0}async removeMemberDevice(e,t,s){const i=$t(e,t);await s.wrap({l:"remove device member",id:i},async r=>{const o=this._members.get(i);if(o){r.set("leave",!0);const a=await o.disconnect(!1);a&&r.refDetached(a),o.dispose(),this._members.remove(i)}})}handleDeviceMessage(e,t,s,i){this.errorBoundary.try(()=>{const r=$t(t,s);let o=this._members.get(r);if(o&&e.content.sender_session_id===o.sessionId)o.handleDeviceMessage(e,i);else{i.log({l:"call: buffering to_device message, member not found",t:vt,id:this.id,userId:t,deviceId:s,sessionId:e.content.sender_session_id,type:e.type});let a=this.bufferedDeviceMessages.get(r);a||(a=new Set,this.bufferedDeviceMessages.set(r,a)),a.add(e)}})}async _createMemberPayload(e){const{storage:t}=this.options,r=(await(await t.readTxn([t.storeNames.roomState])).roomState.get(this.roomId,x.GroupCallMember,this.options.ownUserId))?.event?.content??{["m.calls"]:[]};let o=r["m.calls"],a=o.find(l=>l["m.call_id"]===this.id);a||(a={["m.call_id"]:this.id,["m.devices"]:[]},o.push(a));const c=this.options.clock.now();return a["m.devices"]=a["m.devices"].filter(l=>!(l.device_id===this.options.ownDeviceId||wi(l)===void 0||Mr(l,c,ir))),e&&a["m.devices"].push({device_id:this.options.ownDeviceId,session_id:this.options.sessionId,expires_ts:c+ir,feeds:[{purpose:"m.usermedia"}]}),r["m.calls"]=o.filter(l=>l["m.devices"].length!==0),r}async connectToMember(e,t,s){const i=$t(e.userId,e.deviceId),r=t.membersLogItem.child({l:"member",id:i,sessionId:e.sessionId});await s.wrap({l:"connect",id:i},async o=>{const a=await e.connect(t.localMedia,t.localMuteSettings,t.turnServer,r);a&&o.refDetached(a)})}emitChange(){this.emit("change"),this.options.emitUpdate(this)}_setupRenewMembershipTimeout(e,t){const{joinedData:s}=this;if(!s)return;s.renewMembershipTimeout?.dispose(),s.renewMembershipTimeout=void 0;const i=wi(e);if(typeof i!="number")return;const r=i-this.options.clock.now(),o=Math.max(1e4,Math.ceil((.2+this.options.random()*.8)*(.08333*ir))),a=Math.max(0,r-o);t.set("expiresIn",r),t.set("renewIn",a),s.renewMembershipTimeout=this.options.clock.createTimeout(a),s.renewMembershipTimeout.elapsed().then(()=>{s.logItem.wrap("renew membership",async c=>{const l=await this._createMemberPayload(!0);c.set("payload",l),await this.options.hsApi.sendState(this.roomId,x.GroupCallMember,this.options.ownUserId,l,{log:c}).response()})},()=>{})}dispose(){this.joinedData?.dispose();for(const e of this._members.values())e.dispose()}}const Co=5*60,Cg={urls:["stun:turn.matrix.org"],username:"",credential:""};class Tg{constructor(e,t,s=Cg){this.hsApi=e,this.clock=t,this.defaultSettings=s,this.isPolling=!1}getSettings(e){return e.wrap("get turn server",async t=>{if(!this.isPolling){const s=await this.doRequest(t),i=s?To(s):this.defaultSettings;t.set("iceServer",i),this.currentObservable?this.currentObservable.set(i):this.currentObservable=new ci(i,()=>{this.stopPollLoop()},()=>{this.runLoop(s?.ttl??Co)})}return this.currentObservable})}async runLoop(e){let t=e;for(this.isPolling=!0;this.isPolling;)try{this.pollTimeout=this.clock.createTimeout(t*1e3),await this.pollTimeout.elapsed(),this.pollTimeout=void 0;const s=await this.doRequest(void 0);if(s){const i=To(s);Ag(this.currentObservable,i)&&this.currentObservable.set(i),s.ttl>0?t=s.ttl:this.stopPollLoop()}else t=Co}catch(s){s.name}}async doRequest(e){try{return this.pollRequest=this.hsApi.getTurnServer({log:e}),await this.pollRequest.response()}catch(t){if(t.name==="HomeServerError")return;throw t}finally{this.pollRequest=void 0}}stopPollLoop(){this.isPolling=!1,this.currentObservable=void 0,this.pollTimeout?.dispose(),this.pollTimeout=void 0,this.pollRequest?.abort(),this.pollRequest=void 0}dispose(){this.stopPollLoop()}}function Ag(n,e){const t=n.get();if(!t)return!0;const s=Array.isArray(t.urls)?t.urls:[t.urls],i=Array.isArray(e.urls)?e.urls:[e.urls];return!(s.length===i.length&&!i.some(o=>!s.includes(o)))||e.username!==t.username||e.credential!==t.credential}function To(n){return{urls:n.uris,username:n.username,credential:n.password,credentialType:"password"}}function xg(n,e){return JSON.stringify(n)+","+JSON.stringify(e)}class Ng{constructor(e){this.options=e,this._calls=new ct,this.roomMemberToCallIds=new Map,this.sessionId=gi("s"),this.groupCallOptions=Object.assign({},this.options,{turnServerSource:new Tg(this.options.hsApi,this.options.clock),emitUpdate:(t,s)=>this._calls.update(t.id,s),createTimeout:this.options.clock.createTimeout,sessionId:this.sessionId})}loadCalls(e,t){return this.options.logger.wrapOrRun(t,"CallHandler.loadCalls",async s=>{e||(e=Ms.Ring),s.set("intent",e);const i=await this._getLoadTxn(),r=await i.calls.getByIntent(e);await this._loadCallEntries(r,i,s)})}loadCallsForRoom(e,t,s){return this.options.logger.wrapOrRun(s,"CallHandler.loadCallsForRoom",async i=>{i.set("intent",e),i.set("roomId",t);const r=await this._getLoadTxn(),o=await r.calls.getByIntentAndRoom(e,t);await this._loadCallEntries(o,r,i)})}async _getLoadTxn(){const e=this.options.storage.storeNames;return await this.options.storage.readTxn([e.calls,e.roomState])}async _loadCallEntries(e,t,s){s.set("entries",e.length),await Promise.all(e.map(async r=>{if(this._calls.get(r.callId))return;const o=await t.roomState.get(r.roomId,x.GroupCall,r.callId);if(o){const a=new rr(o.event.state_key,!0,!1,r.timestamp,o.event.content,o.roomId,this.groupCallOptions);this._calls.set(a.id,a)}}));const i=Array.from(new Set(e.map(r=>r.roomId)));await Promise.all(i.map(async r=>{const o=await t.roomState.getAllForType(r,x.GroupCallMember);await Promise.all(o.map(async a=>{const c=a.event.sender,l=await t.roomState.get(r,ge,c);let h;l&&(h=P.fromMemberEvent(l.event)),h||(h=P.fromUserId(r,c,"join")),this.handleCallMemberEvent(a.event,h,r,s)}))})),s.set("newSize",this._calls.size)}createCall(e,t,s,i,r){return this.options.logger.wrapOrRun(r,"CallHandler.createCall",async o=>{i||(i=Ms.Ring);const a=new rr(gi("conf-"),!1,!0,void 0,{"m.name":s,"m.intent":i},e,this.groupCallOptions);this._calls.set(a.id,a);try{await a.create(t,o);const c=await this.options.storage.readWriteTxn([this.options.storage.storeNames.calls]);c.calls.add({intent:a.intent,callId:a.id,timestamp:this.options.clock.now(),roomId:e}),await c.complete()}catch(c){throw this._calls.remove(a.id),c}return a})}get calls(){return this._calls}async handleRoomState(e,t,s,i,r){if(t.type===x.GroupCall&&this.handleCallEvent(t,e.id,i,r),t.type===x.GroupCallMember){let o=await s.lookupMemberAtEvent(t.sender,t,i);o||(o=P.fromUserId(e.id,t.sender,"join")),this.handleCallMemberEvent(t,o,e.id,r)}}updateRoomMembers(e,t){for(const s of this._calls.values())s.roomId===e.id&&s.updateRoomMembers(t)}handlesDeviceMessageEventType(e){return Sg(e)}handleDeviceMessage(e,t,s,i){this._calls.get(e.content.conf_id)?.handleDeviceMessage(e,t,s,i)}handleCallEvent(e,t,s,i){const r=e.state_key;let o=this._calls.get(r);o?(o.updateCallEvent(e,i),o.isTerminated&&(o.disconnect(i),this._calls.remove(o.id),s.calls.remove(o.intent,t,o.id))):e.content["m.terminated"]||(o=new rr(e.state_key,!1,!1,e.origin_server_ts,e.content,t,this.groupCallOptions),this._calls.set(o.id,o),s.calls.add({intent:o.intent,callId:o.id,timestamp:e.origin_server_ts,roomId:t}))}handleCallMemberEvent(e,t,s,i){const r=e.state_key,o=xg(s,r),a=e.content["m.calls"]??[];for(const h of a){const d=h["m.call_id"];this._calls.get(d)?.updateMembership(r,t,h,i)}const c=new Set(a.map(h=>h["m.call_id"]));let l=this.roomMemberToCallIds.get(o);if(l)for(const h of l)c.has(h)||this._calls.get(h)?.removeMembership(r,i);c.size===0?this.roomMemberToCallIds.delete(o):this.roomMemberToCallIds.set(o,c)}dispose(){this.groupCallOptions.turnServerSource.dispose();for(const e of this._calls.values())e.dispose()}}class Dg extends bi{async handleRoomState(e,t,s,i,r){const o=[];for(let a of this._handlers)o.push(a.handleRoomState(e,t,s,i,r));await Promise.all(o)}updateRoomMembers(e,t){for(let s of this._handlers)s.updateRoomMembers(e,t)}}const bt="DEFAULT_KEY",us="pusher";class Vg{constructor({storage:e,hsApi:t,sessionInfo:s,olm:i,olmWorker:r,platform:o,mediaRepository:a,features:c,sendQueuePool:l}){this._platform=o,this._storage=e,this._hsApi=t,this._mediaRepository=a,this._features=c,this._syncInfo=null,this._sessionInfo=s,this._rooms=new ct,this._roomUpdateCallback=(h,d)=>this._rooms.update(h.id,d),this._activeArchivedRooms=new Map,this._invites=new ct,this._inviteUpdateCallback=(h,d)=>this._invites.update(h.id,d),this._roomsBeingCreatedUpdateCallback=(h,d)=>{h.isCancelled?this._roomsBeingCreated.remove(h.id):this._roomsBeingCreated.update(h.id,d)},this._roomsBeingCreated=new ct,this._user=new Qp(s.userId),this._roomStateHandler=new Dg,this._deviceMessageHandler=new R_({storage:e,callHandler:this._callHandler}),this._olm=i,this._olmUtil=null,this._e2eeAccount=null,this._deviceTracker=null,this._olmEncryption=null,this._keyLoader=null,this._megolmEncryption=null,this._megolmDecryption=null,this._getSyncToken=()=>this.syncToken,this._olmWorker=r,this._keyBackup=new Te(void 0),this._crossSigning=void 0,this._observedRoomStatus=new Map,this.sendQueuePool=l,i&&(this._olmUtil=new i.Utility,this._deviceTracker=new fg({storage:e,getSyncToken:this._getSyncToken,olmUtil:this._olmUtil,ownUserId:s.userId,ownDeviceId:s.deviceId})),this._createRoomEncryption=this._createRoomEncryption.bind(this),this._forgetArchivedRoom=this._forgetArchivedRoom.bind(this),this.needsKeyBackup=new Te(!1),c.calls&&this._setupCallHandler()}get fingerprintKey(){return this._e2eeAccount?.identityKeys.ed25519}get hasSecretStorageKey(){return this._hasSecretStorageKey}get sessionId(){return this._sessionInfo.id}get deviceId(){return this._sessionInfo.deviceId}get userId(){return this._sessionInfo.userId}get homeserver(){return this._sessionInfo.homeServer}get accessToken(){return this._sessionInfo.accessToken}get callHandler(){return this._callHandler}async isGuest(){if(typeof this._guestUser<"u")return this._guestUser;const e=await this._hsApi.whoami().response();return this._guestUser=e.is_guest,Boolean(e.is_guest)}_setupCallHandler(){this._callHandler=new Ng({clock:this._platform.clock,random:this._platform.random,hsApi:this._hsApi,encryptDeviceMessage:async(e,t,s,i,r)=>{if(!this._deviceTracker||!this._olmEncryption){r.set("encryption_disabled",!0);return}const o=await r.wrap("get device key",async a=>{const c=this._deviceTracker.deviceForId(t,s,this._hsApi,a);return c||a.set("not_found",!0),c});if(o)return await this._olmEncryption.encrypt(i.type,i.content,[o],this._hsApi,r)},storage:this._storage,webRTC:this._platform.webRTC,ownDeviceId:this._sessionInfo.deviceId,ownUserId:this._sessionInfo.userId,logger:this._platform.logger,forceTURN:!1}),this.observeRoomState(this._callHandler)}_setupEncryption(){const e=new yg,t=new B_(this._e2eeAccount,bt,this._platform.clock.now,this._user.id,this._olm,e);this._olmEncryption=new q_(this._e2eeAccount,bt,this._olm,this._storage,this._platform.clock.now,this._user.id,this._olmUtil,e),this._keyLoader=new rg(this._olm,bt,20),this._megolmEncryption=new hg({account:this._e2eeAccount,pickleKey:bt,olm:this._olm,storage:this._storage,keyLoader:this._keyLoader,now:this._platform.clock.now,ownDeviceId:this._sessionInfo.deviceId}),this._megolmDecryption=new ig(this._keyLoader,this._olmWorker),this._deviceMessageHandler.enableEncryption({olmDecryption:t,megolmDecryption:this._megolmDecryption})}_createRoomEncryption(e,t){if(!this._olmEncryption)throw new Error("creating room encryption before encryption got globally enabled");return t.algorithm!==Le?null:new mg({room:e,deviceTracker:this._deviceTracker,olmEncryption:this._olmEncryption,megolmEncryption:this._megolmEncryption,megolmDecryption:this._megolmDecryption,storage:this._storage,keyBackup:this._keyBackup?.get(),encryptionParams:t,notifyMissingMegolmSession:()=>{this._keyBackup.get()||this.needsKeyBackup.set(!0)},clock:this._platform.clock})}enableSecretStorage(e,t,s=void 0){return this._platform.logger.wrapOrRun(s,"enable secret storage",async i=>{if(!this._olm)throw new Error("olm required");this._keyBackup.get()&&(this._keyBackup.get().dispose(),this._keyBackup.set(null));const r=await V_(e,t,this._storage,this._platform,this._olm),o=await this._storage.readTxn([this._storage.storeNames.accountData]);if(await this._createKeyBackup(r,o,i))return await this._writeSSSSKey(r,i),this._keyBackup.get().flush(i),r;throw new Error("Could not read key backup with the given key")})}async _writeSSSSKey(e,t){const s=this._keyBackup.get();if(!s)return;const i=s.version,r=await this._storage.readWriteTxn([this._storage.storeNames.session,this._storage.storeNames.inboundGroupSessions]);try{const o=await x_(e,i,r);if(t.set("previousBackupVersion",o),t.set("backupVersion",i),!!o&&o!==i){const a=await s.markAllForBackup(r);t.set("amountMarkedForBackup",a)}}catch(o){throw r.abort(),o}await r.complete()}async disableSecretStorage(){const e=await this._storage.readWriteTxn([this._storage.storeNames.session]);try{D_(e)}catch(t){throw e.abort(),t}if(await e.complete(),this._keyBackup.get()){for(const t of this._rooms.values())t.isEncrypted&&t.enableKeyBackup(void 0);this._keyBackup.get().dispose(),this._keyBackup.set(null)}}_createKeyBackup(e,t,s){return s.wrap("enable key backup",async i=>{try{const r=new wg({key:e,platform:this._platform}),o=await sn.fromSecretStorage(this._platform,this._olm,r,this._hsApi,this._keyLoader,this._storage,t);if(o){this._features.crossSigning&&(this._crossSigning=new lg({storage:this._storage,secretStorage:r,platform:this._platform,olm:this._olm,deviceTracker:this._deviceTracker,hsApi:this._hsApi,ownUserId:this.userId,e2eeAccount:this._e2eeAccount}),await i.wrap("enable cross-signing",a=>this._crossSigning.init(a)));for(const a of this._rooms.values())a.isEncrypted&&a.enableKeyBackup(o);return this._keyBackup.set(o),!0}else i.set("no_backup",!0)}catch(r){i.catch(r)}return!1})}get keyBackup(){return this._keyBackup}get crossSigning(){return this._crossSigning}get hasIdentity(){return!!this._e2eeAccount}async createIdentity(e){this._olm&&(this._e2eeAccount||(this._e2eeAccount=await this._createNewAccount(this._sessionInfo.deviceId,this._storage),e.set("keys",this._e2eeAccount.identityKeys),this._setupEncryption()),await this._e2eeAccount.generateOTKsIfNeeded(this._storage,e),await e.wrap("uploadKeys",t=>this._e2eeAccount.uploadKeys(this._storage,!1,t)))}async dehydrateIdentity(e,t){return t.set("deviceId",e.deviceId),this._olm?e.deviceId!==this.deviceId?(t.set("wrong_device",!0),!1):this._e2eeAccount?(t.set("account_already_setup",!0),!1):await e.claim(this._hsApi,t)?(this._e2eeAccount=await At.adoptDehydratedDevice({dehydratedDevice:e,hsApi:this._hsApi,olm:this._olm,pickleKey:bt,userId:this._sessionInfo.userId,olmWorker:this._olmWorker,deviceId:this.deviceId,storage:this._storage}),t.set("keys",this._e2eeAccount.identityKeys),this._setupEncryption(),!0):(t.set("already_claimed",!0),!1):(t.set("no_olm",!0),!1)}_createNewAccount(e,t=void 0){return At.create({hsApi:this._hsApi,olm:this._olm,pickleKey:bt,userId:this._sessionInfo.userId,olmWorker:this._olmWorker,deviceId:e,storage:t})}setupDehydratedDevice(e,t=null){return this._platform.logger.wrapOrRun(t,"setupDehydratedDevice",async s=>{const i=await this._createNewAccount("temp-device-id");try{const r=await O_(i,this._hsApi,e,"Dehydrated device",s);return s.set("deviceId",r),r}finally{i.dispose()}})}async load(e){const t=await this._storage.readTxn([this._storage.storeNames.session,this._storage.storeNames.roomSummary,this._storage.storeNames.invites,this._storage.storeNames.roomMembers,this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineFragments,this._storage.storeNames.pendingEvents]);this._syncInfo=await t.session.get("sync"),this._olm&&(this._e2eeAccount=await At.load({hsApi:this._hsApi,olm:this._olm,pickleKey:bt,userId:this._sessionInfo.userId,deviceId:this._sessionInfo.deviceId,olmWorker:this._olmWorker,txn:t}),this._e2eeAccount&&(e.set("keys",this._e2eeAccount.identityKeys),this._setupEncryption()));const s=await this._getPendingEventsByRoom(t),i=await t.invites.getAll(),r=Promise.all(i.map(async c=>{const l=this.createInvite(c.roomId);e.wrap("invite",h=>l.load(c,h)),this._invites.add(l.id,l)})),o=await t.roomSummary.getAll(),a=Promise.all(o.map(async c=>{const l=this.createJoinedRoom(c.roomId,s.get(c.roomId));await e.wrap("room",h=>l.load(c,t,h)),this._rooms.add(l.id,l)}));await Promise.all([r,a]);for(const[c,l]of this.invites){const h=this.rooms.get(c);h&&h.setInvite(l)}}dispose(){this._olmWorker?.dispose(),this._olmWorker=void 0,this._keyBackup.get()?.dispose(),this._keyBackup.set(void 0),this._megolmDecryption?.dispose(),this._megolmDecryption=void 0,this._e2eeAccount?.dispose(),this._e2eeAccount=void 0,this._callHandler?.dispose(),this._callHandler=void 0;for(const e of this._rooms.values())e.dispose();this._rooms=void 0}async start(e,t,s){if(e){const a=await this._storage.readWriteTxn([this._storage.storeNames.session]);a.session.set("serverVersions",e),await a.complete()}if(!this._keyBackup.get()){t&&await s.wrap("SSSSKeyFromDehydratedDeviceKey",async l=>{const h=await P_(t.key,this._storage,this._platform);h&&(l.set("success",!0),await this._writeSSSSKey(h))});const a=await this._storage.readTxn([this._storage.storeNames.session,this._storage.storeNames.accountData]),c=await N_(a);c&&await this._createKeyBackup(c,a,s)&&this._keyBackup.get()?.flush(s),this._keyBackup.get()||this._keyBackup.set(null)}const r=await(await this._storage.readWriteTxn([this._storage.storeNames.operations])).operations.getAll(),o=Jt(r,a=>a.scope);for(const a of this._rooms.values()){let c;const l=o.get(a.id);l&&(c=Jt(l,h=>h.type)),a.start(c,s)}}async _getPendingEventsByRoom(e){return(await e.pendingEvents.getAll()).reduce((s,i)=>{const r=s.get(i.roomId);return r?r.push(i):s.set(i.roomId,[i]),s},new Map)}get rooms(){return this._rooms}findDirectMessageForUserId(e){for(const[,t]of this._rooms)if(t.isDirectMessageForUserId(e))return t;for(const[,t]of this._invites)if(t.isDirectMessageForUserId(e))return t}createJoinedRoom(e,t){const s=this.sendQueuePool.createQueue(e,t);return new yo({roomId:e,getSyncToken:this._getSyncToken,storage:this._storage,emitCollectionChange:this._roomUpdateCallback,hsApi:this._hsApi,mediaRepository:this._mediaRepository,pendingEvents:t,user:this._user,createRoomEncryption:this._createRoomEncryption,platform:this._platform,roomStateHandler:this._roomStateHandler,sendQueue:s})}_createArchivedRoom(e){const t=new __({roomId:e,getSyncToken:this._getSyncToken,storage:this._storage,emitCollectionChange:()=>{},releaseCallback:()=>this._activeArchivedRooms.delete(e),forgetCallback:this._forgetArchivedRoom,hsApi:this._hsApi,mediaRepository:this._mediaRepository,user:this._user,createRoomEncryption:this._createRoomEncryption,platform:this._platform});return this._activeArchivedRooms.set(e,t),t}_createWorldReadableRoom(e){return new yo({roomId:e,getSyncToken:this._getSyncToken,storage:this._storage,emitCollectionChange:this._roomUpdateCallback,hsApi:this._hsApi,mediaRepository:this._mediaRepository,pendingEvents:[],user:this._user,platform:this._platform,roomStateHandler:this._roomStateHandler})}get invites(){return this._invites}createInvite(e){return new I_({roomId:e,hsApi:this._hsApi,emitCollectionUpdate:this._inviteUpdateCallback,mediaRepository:this._mediaRepository,user:this._user,platform:this._platform})}get roomsBeingCreated(){return this._roomsBeingCreated}createRoom(e){let t;return this._platform.logger.runDetached("create room",async s=>{const i=`local-${Math.floor(this._platform.random()*Number.MAX_SAFE_INTEGER)}`;t=new S_(i,e,this._roomsBeingCreatedUpdateCallback,this._mediaRepository,this._platform,s),this._roomsBeingCreated.set(i,t);const r=[t.create(this._hsApi,s)];e.loadProfiles!==!1&&r.push(t.loadProfiles(this._hsApi,s)),await Promise.all(r),t.roomId&&(this.rooms.get(t.roomId)&&this._tryReplaceRoomBeingCreated(t.roomId,s),await t.adjustDirectMessageMapIfNeeded(this._user,this._storage,this._hsApi,s))}),t}async obtainSyncLock(e){const t=e.to_device?.events;if(Array.isArray(t)&&t.length)return await this._deviceMessageHandler.obtainSyncLock(t)}async prepareSync(e,t,s,i){const r=e.to_device?.events;if(Array.isArray(r)&&r.length)return await i.wrap("deviceMsgs",o=>this._deviceMessageHandler.prepareSync(r,t,s,o))}async writeSync(e,t,s,i,r){const o={syncInfo:null,e2eeAccountChanges:null,hasNewRoomKeys:!1,deviceMessageDecryptionResults:null},a=e.next_batch;if(a!==this.syncToken){const d={token:a,filterId:t};i.session.set("sync",d),o.syncInfo=d}const c=e.device_one_time_keys_count;this._e2eeAccount&&c&&(o.e2eeAccountChanges=this._e2eeAccount.writeSync(c,i,r));const l=e.device_lists;if(this._deviceTracker&&Array.isArray(l?.changed)&&l.changed.length&&await r.wrap("deviceLists",d=>this._deviceTracker.writeDeviceChanges(l.changed,i,d)),s){const{hasNewRoomKeys:d,decryptionResults:u}=await r.wrap("deviceMsgs",p=>this._deviceMessageHandler.writeSync(s,i,p));o.hasNewRoomKeys=d,o.deviceMessageDecryptionResults=u}const h=e.account_data;if(Array.isArray(h?.events))for(const d of h.events)typeof d.type=="string"&&i.accountData.set(d);return o}afterSync({syncInfo:e,e2eeAccountChanges:t}){e&&(this._syncInfo=e),this._e2eeAccount&&this._e2eeAccount.afterSync(t)}async afterSyncCompleted(e,t,s){t||await this._e2eeAccount.generateOTKsIfNeeded(this._storage,s)&&await s.wrap("uploadKeys",r=>this._e2eeAccount.uploadKeys(this._storage,!1,r)),e.hasNewRoomKeys&&this._keyBackup.get()?.flush(s),e.deviceMessageDecryptionResults&&await this._deviceMessageHandler.afterSyncCompleted(e.deviceMessageDecryptionResults,this._deviceTracker,this._hsApi,s)}_tryReplaceRoomBeingCreated(e,t){for(const[,s]of this._roomsBeingCreated)if(s.roomId===e){const i=this._observedRoomStatus.get(s.id);i&&(t.log("replacing room being created").set("localId",s.id).set("roomId",s.roomId),i.set(i.get()|j.Replaced)),s.dispose(),this._roomsBeingCreated.remove(s.id);return}}async applyRoomCollectionChangesAfterSync(e,t,s,i){for(const r of t)r.shouldAdd?(this._rooms.add(r.id,r.room),this._tryReplaceRoomBeingCreated(r.id,i)):r.shouldRemove&&this._rooms.remove(r.id);for(const r of e)r.shouldAdd?this._invites.add(r.id,r.invite):r.shouldRemove&&this._invites.remove(r.id);if(this._observedRoomStatus.size!==0){for(const r of s)r.shouldAdd&&this._observedRoomStatus.get(r.id)?.set(j.Archived);for(const r of t)r.shouldAdd&&this._observedRoomStatus.get(r.id)?.set(j.Joined);for(const r of e){const o=this._observedRoomStatus.get(r.id);if(o){const a=o.get()|j.Invited;if(r.shouldAdd)o.set(a);else if(r.shouldRemove){const c=a^j.Invited;o.set(c)}}}}}_forgetArchivedRoom(e){const t=this._observedRoomStatus.get(e);t&&t.set((t.get()|j.Archived)^j.Archived)}get syncToken(){return this._syncInfo?.token}get syncFilterId(){return this._syncInfo?.filterId}get user(){return this._user}get mediaRepository(){return this._mediaRepository}enablePushNotifications(e){return e?this._enablePush():this._disablePush()}async _enablePush(){return this._platform.logger.run("enablePush",async e=>{const t=St.createDefaultPayload(this._sessionInfo.id),s=await this._platform.notificationService.enablePush(St,t);if(!s)return e.set("no_pusher",!0),!1;await s.enable(this._hsApi,e);const i=await this._storage.readWriteTxn([this._storage.storeNames.session]);return i.session.set(us,s.serialize()),await i.complete(),!0})}async _disablePush(){return this._platform.logger.run("disablePush",async e=>{await this._platform.notificationService.disablePush();const s=await(await this._storage.readTxn([this._storage.storeNames.session])).session.get(us);if(!s)return!0;await new St(s).disable(this._hsApi,e);const r=await this._storage.readWriteTxn([this._storage.storeNames.session]);return r.session.remove(us),await r.complete(),!0})}async arePushNotificationsEnabled(){return await this._platform.notificationService.isPushEnabled()?!!await(await this._storage.readTxn([this._storage.storeNames.session])).session.get(us):!1}async checkPusherEnabledOnHomeserver(){const t=await(await this._storage.readTxn([this._storage.storeNames.session])).session.get(us);if(!t)return!1;const s=new St(t);return((await this._hsApi.getPushers().response())?.pushers||[]).map(o=>new St(o)).some(o=>o.equals(s))}async getRoomStatus(e){if(!!this._roomsBeingCreated.get(e))return j.BeingCreated;if(!!this._rooms.get(e))return j.Joined;{const i=!!this._invites.get(e),o=await(await this._storage.readTxn([this._storage.storeNames.archivedRoomSummary])).archivedRoomSummary.has(e);return i&&o?j.Invited|j.Archived:i?j.Invited:o?j.Archived:j.None}}async observeRoomStatus(e){let t=this._observedRoomStatus.get(e);if(!t){let s;t=new ci(s,()=>{this._observedRoomStatus.delete(e)}),this._observedRoomStatus.set(e,t),s=await this.getRoomStatus(e),t.get()===void 0&&t.set(s)}return t}observeRoomState(e){return this._roomStateHandler.subscribe(e)}createOrGetArchivedRoomForSync(e){let t=this._activeArchivedRooms.get(e);return t?t.retain():t=this._createArchivedRoom(e),t}loadArchivedRoom(e,t=null){return this._platform.logger.wrapOrRun(t,"loadArchivedRoom",async s=>{s.set("id",e);const i=this._activeArchivedRooms.get(e);if(i)return i.retain(),i;const r=await this._storage.readTxn([this._storage.storeNames.archivedRoomSummary,this._storage.storeNames.roomMembers]),o=await r.archivedRoomSummary.get(e);if(o){const a=this._createArchivedRoom(e);return await a.load(o,r,s),a}})}loadWorldReadableRoom(e,t=null){return this._platform.logger.wrapOrRun(t,"loadWorldReadableRoom",async s=>{s.set("id",e);const i=this._createWorldReadableRoom(e);await this._fetchWorldReadableRoomEvents(e,100,"b",null,s);let r=await this._prepareWorldReadableRoomSummary(e,s);const o=await this._storage.readTxn([this._storage.storeNames.timelineFragments,this._storage.storeNames.timelineEvents,this._storage.storeNames.roomMembers]);return await i.load(r,o,s),i})}async _prepareWorldReadableRoomSummary(e,t=null){return this._platform.logger.wrapOrRun(t,"prepareWorldReadableRoomSummary",async s=>{s.set("id",e);let i={};const r=await this._hsApi.currentState(e).response();for(let o=0;o<r.length;o++)r[o].type==="m.room.name"?i.name=r[o].content.name:r[o].type==="m.room.canonical_alias"?i.canonicalAlias=r[o].content.alias:r[o].type==="m.room.avatar"&&(i.avatarUrl=r[o].content.url);return i})}async _fetchWorldReadableRoomEvents(e,t=30,s="b",i=null,r=null){return this._platform.logger.wrapOrRun(r,"fetchWorldReadableRoomEvents",async o=>{o.set("id",e);let a={limit:t,dir:"b",filter:{lazy_load_members:!0,include_redundant_members:!0}};i!==null&&(a.from=i);const c=await this._hsApi.messages(e,a,{log:o}).response();o.set("/messages endpoint response",c),await this.deleteWorldReadableRoomData(e,o);const l=await this._storage.readWriteTxn([this._storage.storeNames.timelineFragments,this._storage.storeNames.timelineEvents]),h={roomId:e,id:0,previousId:null,nextId:null,previousToken:c.start,nextToken:null};l.timelineFragments.add(h);let d=H.defaultLiveKey;for(let u=0;u<c.chunk.length;u++){u&&(d=d.previousKey());let p=await this._storage.readWriteTxn([this._storage.storeNames.timelineEvents]),_=Or(d,e,c.chunk[u]);await p.timelineEvents.tryInsert(_,o)}return c})}async deleteWorldReadableRoomData(e,t=null){return this._platform.logger.wrapOrRun(t,"deleteWorldReadableRoomData",async s=>{s.set("id",e);const i=await this._storage.readWriteTxn([this._storage.storeNames.timelineFragments,this._storage.storeNames.timelineEvents]);i.timelineFragments.removeAllForRoom(e),i.timelineEvents.removeAllForRoom(e)})}joinRoom(e,t=null){return this._platform.logger.wrapOrRun(t,"joinRoom",async s=>(await this._hsApi.joinIdOrAlias(e,{log:s}).response()).room_id)}async isWorldReadableRoom(e,t=null){return this._platform.logger.wrapOrRun(t,"isWorldReadableRoom",async s=>{try{let i;return e.startsWith("!")?i=e:i=(await this._hsApi.resolveRoomAlias(e).response()).room_id,(await this._hsApi.state(i,"m.room.history_visibility","",{log:s}).response()).history_visibility==="world_readable"}catch{return!1}})}}class Pg{constructor({username:e,password:t,homeserver:s}){this._username=e,this._password=t,this.homeserver=s}async login(e,t,s){return await e.passwordLogin(this._username,this._password,t,{log:s}).response()}}class Lg{constructor({homeserver:e,loginToken:t}){this.homeserver=e,this._loginToken=t}async login(e,t,s){return await e.tokenLogin(this._loginToken,Cs(),t,{log:s}).response()}}class Og{constructor(e){this._homeserver=e}get homeserver(){return this._homeserver}createSSORedirectURL(e){return`${this._homeserver}/_matrix/client/r0/login/sso/redirect?redirectUrl=${encodeURIComponent(e)}`}}class rn{constructor(e,t){this._session=e,this._params=t}setNextStage(e){this._nextStage=e}get nextStage(){return this._nextStage}}class Ug extends rn{generateAuthenticationData(){return{session:this._session,type:this.type}}get type(){return"m.login.dummy"}}class Fg extends rn{generateAuthenticationData(){return{session:this._session,type:this.type}}get type(){return"m.login.terms"}get privacyPolicy(){return this._params?.policies.privacy_policy}get termsOfService(){return this._params?.policies.terms_of_service}}class Bg extends rn{constructor(e,t,s){super(e,t),this._type=s}generateAuthenticationData(){if(!this._token)throw new Error("No token provided for TokenAuth");return{session:this._session,type:this._type,token:this._token}}setToken(e){this._token=e}get type(){return this._type}}class Kg{constructor(e,t,s,i){this.homeserver=e,this._hsApi=t,this._accountDetails=s,this._flowSelector=i??(r=>r[0])}async start(){const e=await this._hsApi.register(this._accountDetails.username,this._accountDetails.password,this._accountDetails.initialDeviceDisplayName,void 0,this._accountDetails.inhibitLogin).response();return this.parseStagesFromResponse(e)}async submitStage(e){const t=e.generateAuthenticationData(),{username:s,password:i,initialDeviceDisplayName:r,inhibitLogin:o}=this._accountDetails,a=this._hsApi.register(s,i,r,t,o),c=await a.response(),l=await a.responseCode(),h={...c,status:l};return this.parseRegistrationResponse(h,e)}parseStagesFromResponse(e){const{session:t,params:s}=e,i=this._flowSelector(e.flows);if(!i)throw new Error("flowSelector did not return any flow!");let r,o;for(const a of i.stages){const c=this._createRegistrationStage(a,t,s);r?(o.setNextStage(c),o=c):(r=c,o=c)}return r}async parseRegistrationResponse(e,t){switch(e.status){case 200:this._registerResponse=e;return;case 401:if(e.completed?.includes(t.type))return t.nextStage;throw new Error("This stage could not be completed!")}}_createRegistrationStage(e,t,s){switch(e){case"m.login.dummy":return new Ug(t,s?.[e]);case"m.login.terms":return new Fg(t,s?.[e]);case"org.matrix.msc3231.login.registration_token":case"m.login.registration_token":return new Bg(t,s?.[e],e);default:throw new Error(`Unknown stage: ${e}`)}}get authData(){if(this._registerResponse)return{accessToken:this._registerResponse.access_token,homeserver:this.homeserver,userId:this._registerResponse.user_id,deviceId:this._registerResponse.device_id}}}class $g extends Nt{constructor(e){super(),this._queues=new Map;const{storage:t,hsApi:s}=e;this._storage=t,this._hsApi=s}createQueue(e,t){const s=new m_({roomId:e,storage:this._storage,hsApi:this._hsApi,pendingEvents:t});return s.on("pendingEvent",i=>this.emit("pendingEvent",i)),this._queues.set(e,s),s}getQueue(e){return this._queues.get(e)}}class jg{constructor(e){const{platform:t,features:s,reconnector:i}=e;this._platform=t,this._features=s,this._reconnector=i}make(e){const{sessionInfo:t,storage:s,olm:i,olmWorker:r}=e,o=new $e({homeserver:t.homeServer,accessToken:t.accessToken,request:this._platform.request,reconnector:this._reconnector}),a=new Rp({hsApi:o,clock:this._platform.clock}),c=new Sp({homeserver:t.homeServer,platform:this._platform}),l=new $g({storage:s,hsApi:o});return{session:new Vg({platform:this._platform,features:this._features,storage:s,sessionInfo:t,hsApi:a.hsApi,olm:i,olmWorker:r,mediaRepository:c,sendQueuePool:l}),scheduler:a}}}const C=tt("NotLoading","Login","LoginFailed","QueryAccount","AccountSetup","Loading","SessionSetup","Migrating","FirstSync","Error","Ready"),Ye=tt("Connection","Credentials","Unknown");class Ei{constructor(e,t=new kt(0)){this._platform=e,this._sessionStartedByReconnector=!1,this._status=new Te(C.NotLoading),this._error=null,this._loginFailure=null,this._reconnector=null,this._session=null,this._sync=null,this._sessionId=null,this._storage=null,this._requestScheduler=null,this._olmPromise=e.loadOlm(),this._workerPromise=e.loadOlmWorker(),this._accountSetup=void 0,this._features=t,this._reconnector=new wp({onlineStatus:this._platform.onlineStatus,retryDelay:new Qa(this._platform.clock.createTimeout),createMeasure:this._platform.clock.createMeasure}),this._sessionFactory=new jg({platform:e,features:t,reconnector:this._reconnector})}createNewSessionId(){return Math.floor(this._platform.random()*Number.MAX_SAFE_INTEGER).toString()}get sessionId(){return this._sessionId}async startWithExistingSession(e){this._status.get()===C.NotLoading&&(this._status.set(C.Loading),await this._platform.logger.run("load session",async t=>{t.set("id",e);try{await this._loadSessionInfo(e,null,t),t.set("status",this._status.get())}catch(s){t.catch(s),this._error=s,this._status.set(C.Error)}}))}_parseLoginOptions(e,t){const s=e.flows,i={homeserver:t};for(const r of s)r.type==="m.login.password"?i.password=(o,a)=>new Pg({homeserver:t,username:o,password:a}):r.type==="m.login.sso"&&s.find(o=>o.type==="m.login.token")?i.sso=new Og(t):r.type==="m.login.token"&&(i.token=o=>new Lg({homeserver:t,loginToken:o}));return i}queryLogin(e){return new Ga(async t=>{e=await za(e,(r,o)=>t(this._platform.request(r,o)));const s=new $e({homeserver:e,request:this._platform.request}),i=await t(s.getLoginFlows()).response();return this._parseLoginOptions(i,e)})}async startRegistration(e,t,s,i,r){const o=this._platform.request,a=new $e({homeserver:e,request:o});return new Kg(e,a,{username:t,password:s,initialDeviceDisplayName:i},r)}async doGuestLogin(e){const t=this._status.get();t!==C.LoginFailed&&t!==C.NotLoading&&t!==C.Error||(this._resetStatus(),await this._platform.logger.run("login",async s=>{this._status.set(C.Login);try{const i=this._platform.request,o=await new $e({homeserver:e,request:i}).guestLogin().response();await this.startWithAuthData({accessToken:o.access_token,deviceId:o.device_id,userId:o.user_id,homeserver:e})}catch(i){this._error=i,this._status.set(C.Error)}}))}async startWithAuthData({accessToken:e,deviceId:t,userId:s,homeserver:i}){await this._platform.logger.run("startWithAuthData",async r=>{await this._createSessionAfterAuth({accessToken:e,deviceId:t,userId:s,homeserver:i},!0,r)})}async startWithLogin(e,{inspectAccountSetup:t}={}){const s=this._status.get();s!==C.LoginFailed&&s!==C.NotLoading&&s!==C.Error||(this._resetStatus(),await this._platform.logger.run("login",async i=>{this._status.set(C.Login);let r;try{const o=this._platform.request,a=new $e({homeserver:e.homeserver,request:o}),c=await e.login(a,"Hydrogen",i);r={deviceId:c.device_id,userId:c.user_id,homeserver:e.homeserver,accessToken:c.access_token}}catch(o){this._error=o,o.name==="HomeServerError"?(o.errcode==="M_FORBIDDEN"?this._loginFailure=Ye.Credentials:this._loginFailure=Ye.Unknown,i.set("loginFailure",this._loginFailure),this._status.set(C.LoginFailed)):o.name==="ConnectionError"?(this._loginFailure=Ye.Connection,this._status.set(C.LoginFailed)):this._status.set(C.Error);return}await this._createSessionAfterAuth(r,t,i)}))}async _createSessionAfterAuth({deviceId:e,userId:t,accessToken:s,homeserver:i},r,o){const a=this.createNewSessionId(),c=this._platform.clock.now(),l={id:a,deviceId:e,userId:t,homeServer:i,homeserver:i,accessToken:s,lastUsed:c};let h;r&&(h=await this._inspectAccountAfterLogin(l,o),h&&(l.deviceId=h.deviceId)),await this._platform.sessionInfoStorage.add(l);try{await this._loadSessionInfo(a,h,o),o.set("status",this._status.get())}catch(d){o.catch(d),h?.dispose(),this._error=d,this._status.set(C.Error)}}async _loadSessionInfo(e,t,s){s.set("appVersion",this._platform.version);const i=await this._platform.sessionInfoStorage.get(e);if(!i)throw new Error("Invalid session id: "+e);this._sessionStartedByReconnector=!1,this._status.set(C.Loading),this._sessionId=i.id,this._storage=await this._platform.storageFactory.create(i.id,s);const r=await this._olmPromise;let o=null;this._workerPromise&&(o=await this._workerPromise),this._reconnector.start();const{session:a,scheduler:c}=this._sessionFactory.make({storage:this._storage,olm:r,olmWorker:o,sessionInfo:i});if(this._session=a,this._requestScheduler=c,this._requestScheduler.start(),await this._session.load(s),t?(await s.wrap("dehydrateIdentity",l=>this._session.dehydrateIdentity(t,l)),await this._session.setupDehydratedDevice(t.key,s)):this._session.hasIdentity||(this._status.set(C.SessionSetup),await s.wrap("createIdentity",l=>this._session.createIdentity(l))),this._sync=this._platform.syncFactory.make({hsApi:this._requestScheduler.hsApi,storage:this._storage,session:this._session}),this._reconnectSubscription=this._reconnector.connectionStatus.subscribe(l=>{l===zt.Online&&this._platform.logger.runDetached("reconnect",async h=>{this._requestScheduler.start(),await this._sync.start(),this._sessionStartedByReconnector=!0;const d=t;t=void 0,await h.wrap("session start",u=>this._session.start(this._reconnector.lastVersionsResponse,d,u))})}),await s.wrap("wait first sync",()=>this._waitForFirstSync()),!this._isDisposed&&(this._status.set(C.Ready),!this._sessionStartedByReconnector)){const l=await this._requestScheduler.hsApi.versions({timeout:1e4,log:s}).response();if(this._isDisposed)return;const h=t;t=void 0,await s.wrap("session start",d=>this._session.start(l,h,d))}}async _waitForFirstSync(){await this._sync.start(),this._status.set(C.FirstSync),this._waitForFirstSyncHandle=this._sync.status.waitFor(e=>e===L.Stopped?this._sync.error?.name!=="ConnectionError":e===L.Syncing);try{if(await this._waitForFirstSyncHandle.promise,this._sync.status.get()===L.Stopped&&this._sync.error)throw this._sync.error}catch(e){if(e.name==="AbortError")return;throw e}finally{this._waitForFirstSyncHandle=null}}_inspectAccountAfterLogin(e,t){return t.wrap("inspectAccount",async s=>{this._status.set(C.QueryAccount);const i=new $e({homeserver:e.homeServer,accessToken:e.accessToken,request:this._platform.request}),r=await this._olmPromise;let o;try{o=await L_(i,r,this._platform,s)}catch(a){if(a.name==="HomeServerError")s.set("not_supported",!0);else throw a}if(o){let a;const c=new Promise(h=>a=h);this._accountSetup=new qg(o,a),this._status.set(C.AccountSetup),await c;const l=this._accountSetup?._dehydratedDevice;return this._accountSetup=null,l}})}get accountSetup(){return this._accountSetup}get loadStatus(){return this._status}get loadError(){return this._error}get loginFailure(){return this._loginFailure}get sync(){return this._sync}get session(){return this._session}get reconnector(){return this._reconnector}get _isDisposed(){return!this._reconnector.isStarted}startLogout(e){return this._platform.logger.run("logout",async t=>{this._sessionId=e,t.set("id",this._sessionId);const s=await this._platform.sessionInfoStorage.get(this._sessionId);if(!s)throw new Error(`Could not find session for id ${this._sessionId}`);try{await new $e({homeserver:s.homeServer,accessToken:s.accessToken,request:this._platform.request}).logout({log:t}).response()}catch{}await this.deleteSession(t)})}startForcedLogout(e){return this._platform.logger.run("forced-logout",async t=>{this._sessionId=e,t.set("id",this._sessionId),await this.deleteSession(t)})}dispose(){this._reconnectSubscription&&(this._reconnectSubscription(),this._reconnectSubscription=null),this._reconnector.stop(),this._requestScheduler&&(this._requestScheduler.stop(),this._requestScheduler=null),this._sync&&(this._sync.stop(),this._sync=null),this._session&&(this._session.dispose(),this._session=null),this._waitForFirstSyncHandle&&(this._waitForFirstSyncHandle.dispose(),this._waitForFirstSyncHandle=null),this._storage&&(this._storage.close(),this._storage=null)}async deleteSession(e){this._sessionId&&(this.dispose(),await Promise.all([e.wrap("storageFactory",()=>this._platform.storageFactory.delete(this._sessionId)),e.wrap("sessionInfoStorage",()=>this._platform.sessionInfoStorage.delete(this._sessionId))]),this._sessionId=null)}_resetStatus(){this._status.set(C.NotLoading),this._error=null,this._loginFailure=null}}class qg{constructor(e,t){this._encryptedDehydratedDevice=e,this._dehydratedDevice=void 0,this._finishStage=t}get encryptedDehydratedDevice(){return this._encryptedDehydratedDevice}finish(e){this._dehydratedDevice=e,this._finishStage()}}class Wg extends k{constructor(e){super(e),this._showStatus=!1,this._showSpinner=!1,this._sessionId=e.sessionId,this._logoutPromise=this.forceLogout()}async forceLogout(){try{await new Ei(this.platform).startForcedLogout(this._sessionId)}catch(e){this._error=e,this._showSpinner=!1,this._showStatus=!0,this.emitChange("error")}}async proceed(){this._showSpinner=!0,this._showStatus=!0,this.emitChange("showStatus"),await this._logoutPromise,this._error||this.navigation.push("login",!0)}get status(){return this._error?this.i18n`Could not log out of device: ${this._error.message}`:this.i18n`Logging out… Please don't close the app.`}get showStatus(){return this._showStatus}get showSpinner(){return this._showSpinner}}class Hg extends k{constructor(e){super(e),this._isBusy=!1,this._errorMessage="";const{loginOptions:t,attemptLogin:s}=e;this._loginOptions=t,this._attemptLogin=s}get isBusy(){return this._isBusy}get errorMessage(){return this._errorMessage}setBusy(e){this._isBusy=e,this.emitChange("isBusy")}_showError(e){this._errorMessage=e,this.emitChange("errorMessage")}async login(e,t){this._errorMessage="",this.emitChange("errorMessage");const s=await this._attemptLogin(this._loginOptions.password(e,t));let i="";switch(s){case Ye.Credentials:i=this.i18n`Your username and/or password don't seem to be correct.`;break;case Ye.Connection:i=this.i18n`Can't connect to ${this._loginOptions.homeserver}.`;break;case Ye.Unknown:i=this.i18n`Something went wrong while checking your login and password.`;break}i&&this._showError(i)}}class zg extends k{constructor(e){super(e),this._isBusy=!1,this._sso=e.loginOptions.sso,this._isBusy=!1}get isBusy(){return this._isBusy}setBusy(e){this._isBusy=e,this.emitChange("isBusy")}async startSSOLogin(){await this.platform.settingsStorage.setString("sso_ongoing_login_homeserver",this._sso.homeserver);const e=this._sso.createSSORedirectURL(this.urlRouter.createSSOCallbackURL());this.platform.openUrl(e)}}class Gg extends k{constructor(e){super(e),this._errorMessage="";const{loginToken:t,client:s,attemptLogin:i}=e;this._loginToken=t,this._client=s,this._attemptLogin=i,this._errorMessage="",this.performSSOLoginCompletion()}get errorMessage(){return this._errorMessage}_showError(e){this._errorMessage=e,this.emitChange("errorMessage")}async performSSOLoginCompletion(){if(!this._loginToken)return;const e=await this.platform.settingsStorage.getString("sso_ongoing_login_homeserver");let t;try{t=await this._client.queryLogin(e).result}catch(r){this._showError(r.message);return}if(!t.token){this.navigation.push("session");return}const s=await this._attemptLogin(t.token(this._loginToken));let i="";switch(s){case Ye.Credentials:i=this.i18n`Your login token is invalid.`;break;case Ye.Connection:i=this.i18n`Can't connect to ${e}.`;break;case Ye.Unknown:i=this.i18n`Something went wrong while checking your login token.`;break}i&&this._showError(i)}}const me=tt("Enabled","SetupKey","SetupPhrase","Pending","NewVersionAvailable"),ms=tt("Writing","Stopped","Done","Pending");class Jg extends k{constructor(e){super(e),this._session=e.session,this._error=null,this._isBusy=!1,this._dehydratedDeviceId=void 0,this._status=void 0,this._backupOperation=new or(this._session.keyBackup,t=>t.operationInProgress),this._progress=new or(this._backupOperation,t=>t.progress),this.track(this._backupOperation.subscribe(()=>{this._reevaluateStatus(),this.emitChange("isBackingUp")})),this.track(this._progress.subscribe(()=>this.emitChange("backupPercentage"))),this._reevaluateStatus(),this.track(this._session.keyBackup.subscribe(()=>{this._reevaluateStatus()&&this.emitChange("status")}))}_reevaluateStatus(){if(this._isBusy)return!1;let e;const t=this._session.keyBackup.get();t?e=t.needsNewKey?me.NewVersionAvailable:me.Enabled:t===null?e=this.showPhraseSetup()?me.SetupPhrase:me.SetupKey:e=me.Pending;const s=e!==this._status;return this._status=e,s}get decryptAction(){return this.i18n`Set up`}get purpose(){return this.i18n`set up key backup`}offerDehydratedDeviceSetup(){return!0}get dehydratedDeviceId(){return this._dehydratedDeviceId}get isBusy(){return this._isBusy}get backupVersion(){return this._session.keyBackup.get()?.version}get isMasterKeyTrusted(){return this._session.crossSigning?.isMasterKeyTrusted??!1}get canSignOwnDevice(){return!!this._session.crossSigning}async signOwnDevice(){this._session.crossSigning&&await this.logger.run("KeyBackupViewModel.signOwnDevice",async e=>{await this._session.crossSigning.signOwnDevice(e)})}get backupWriteStatus(){const e=this._session.keyBackup.get();if(e){if(e.hasStopped)return ms.Stopped}else return ms.Pending;return e.operationInProgress.get()?ms.Writing:e.hasBackedUpAllKeys?ms.Done:ms.Pending}get backupError(){return this._session.keyBackup.get()?.error?.message}get status(){return this._status}get error(){return this._error?.message}showPhraseSetup(){this._status===me.SetupKey&&(this._status=me.SetupPhrase,this.emitChange("status"))}showKeySetup(){this._status===me.SetupPhrase&&(this._status=me.SetupKey,this.emitChange("status"))}async _enterCredentials(e,t,s){if(t)try{this._isBusy=!0,this.emitChange("isBusy");const i=await this._session.enableSecretStorage(e,t);s&&(this._dehydratedDeviceId=await this._session.setupDehydratedDevice(i))}catch(i){console.error(i),this._error=i,this.emitChange("error")}finally{this._isBusy=!1,this._reevaluateStatus(),this.emitChange("")}}enterSecurityPhrase(e,t){this._enterCredentials(Ts.Passphrase,e,t)}enterSecurityKey(e,t){this._enterCredentials(Ts.RecoveryKey,e,t)}async disable(){try{this._isBusy=!0,this.emitChange("isBusy"),await this._session.disableSecretStorage()}catch(e){console.error(e),this._error=e,this.emitChange("error")}finally{this._isBusy=!1,this._reevaluateStatus(),this.emitChange("")}}get isBackingUp(){return!!this._backupOperation.get()}get backupPercentage(){const e=this._progress.get();return e?Math.round(e.finished/e.total*100):0}get backupInProgressLabel(){const e=this._progress.get();return e?this.i18n`${e.finished} of ${e.total}`:this.i18n`…`}cancelBackup(){this._backupOperation.get()?.abort()}startBackup(){this._session.keyBackup.get()?.flush()}}class Qg extends k{constructor(e){super(e),this._accountSetup=e.accountSetup,this._dehydratedDevice=void 0,this._decryptDehydratedDeviceViewModel=void 0,this._accountSetup.encryptedDehydratedDevice&&(this._decryptDehydratedDeviceViewModel=new Yg(this,t=>{this._dehydratedDevice=t,this._decryptDehydratedDeviceViewModel=void 0,this.emitChange("deviceDecrypted")}))}get decryptDehydratedDeviceViewModel(){return this._decryptDehydratedDeviceViewModel}get deviceDecrypted(){return!!this._dehydratedDevice}get dehydratedDeviceId(){return this._accountSetup.encryptedDehydratedDevice.deviceId}finish(){this._accountSetup.finish(this._dehydratedDevice)}}class Yg extends k{constructor(e,t){super(e.options),this._accountSetupViewModel=e,this._isBusy=!1,this._status=me.SetupKey,this._error=void 0,this._decryptedCallback=t}get decryptAction(){return this.i18n`Restore`}get purpose(){return this.i18n`claim your dehydrated device`}get offerDehydratedDeviceSetup(){return!1}get dehydratedDeviceId(){return this._accountSetupViewModel._dehydratedDevice?.deviceId}get isBusy(){return this._isBusy}get backupVersion(){return 0}get status(){return this._status}get error(){return this._error?.message}showPhraseSetup(){this._status===me.SetupKey&&(this._status=me.SetupPhrase,this.emitChange("status"))}showKeySetup(){this._status===me.SetupPhrase&&(this._status=me.SetupKey,this.emitChange("status"))}async _enterCredentials(e,t){if(t)try{this._isBusy=!0,this.emitChange("isBusy");const{encryptedDehydratedDevice:s}=this._accountSetupViewModel._accountSetup,i=await s.decrypt(e,t);this._decryptedCallback(i)}catch(s){console.error(s),this._error=s,this.emitChange("error")}finally{this._isBusy=!1,this.emitChange("")}}enterSecurityPhrase(e){this._enterCredentials(Ts.Passphrase,e)}enterSecurityKey(e){this._enterCredentials(Ts.RecoveryKey,e)}disable(){}}class bc extends k{constructor(e){super(e);const{client:t,ready:s,homeserver:i,deleteSessionOnCancel:r}=e;this._client=t,this._ready=s,this._homeserver=i,this._deleteSessionOnCancel=r,this._loading=!1,this._error=null,this.backUrl=this.urlRouter.urlForSegment("session",!0),this._accountSetupViewModel=void 0}async start(){if(!this._loading)try{this._loading=!0,this.emitChange("loading"),this._waitHandle=this._client.loadStatus.waitFor(s=>(s===C.AccountSetup?this._accountSetupViewModel=new Qg(this.childOptions({accountSetup:this._client.accountSetup})):this._accountSetupViewModel=void 0,this.emitChange("loadLabel"),s===C.FirstSync&&this._client.sync.status.get()===L.CatchupSync||s===C.LoginFailed||s===C.Error||s===C.Ready));try{await this._waitHandle.promise}catch{return}const e=this._client.loadStatus.get(),t=this._client.loadError;if(e===C.FirstSync||e===C.Ready){const s=this._client;this._client=null,this._ready(s)}t&&console.error("session load error",t)}catch(e){this._error=e,console.error("error thrown during session load",e.stack)}finally{this._loading=!1,this.emitChange("loading")}}dispose(){this._client&&(this._client.dispose(),this._client=null),this._waitHandle&&(this._waitHandle.dispose(),this._waitHandle=null)}get loading(){const e=this._client;return e&&e.loadStatus.get()===C.AccountSetup?!1:this._loading}get loadLabel(){const e=this._client,t=this._getError();if(t||e&&e.loadStatus.get()===C.Error)return`Something went wrong: ${t&&t.message}.`;if(e)switch(e.loadStatus.get()){case C.QueryAccount:return"Querying account encryption setup\u2026";case C.AccountSetup:return"";case C.SessionSetup:return"Setting up your encryption keys\u2026";case C.Loading:return"Loading your conversations\u2026";case C.FirstSync:return"Getting your conversations from the server\u2026";default:return this._client.loadStatus.get()}return"Preparing\u2026"}_getError(){return this._error||this._client?.loadError}get hasError(){return!!this._getError()}async exportLogs(){const e=await this.logger.export();this.platform.saveFileAs(e.asBlob(),`hydrogen-logs-${this.platform.clock.now()}.json`)}async logout(){await this._client.startLogout(this.navigation.path.get("session").value),this.navigation.push("session",!0)}get accountSetupViewModel(){return this._accountSetupViewModel}}class Xg extends k{constructor(e){super(e),this._hideHomeserver=!1,this._isBusy=!1,this._errorMessage="";const{ready:t,defaultHomeserver:s,loginToken:i}=e;this._ready=t,this._loginToken=i,this._client=new Ei(this.platform,this.features),this._homeserver=s,this._initViewModels()}get passwordLoginViewModel(){return this._passwordLoginViewModel}get startSSOLoginViewModel(){return this._startSSOLoginViewModel}get completeSSOLoginViewModel(){return this._completeSSOLoginViewModel}get homeserver(){return this._homeserver}get resolvedHomeserver(){return this._loginOptions?.homeserver}get errorMessage(){return this._errorMessage}get showHomeserver(){return!this._hideHomeserver}get loadViewModel(){return this._loadViewModel}get isBusy(){return this._isBusy}get isFetchingLoginOptions(){return!!this._abortQueryOperation}goBack(){this.navigation.push("session")}_initViewModels(){this._loginToken?(this._hideHomeserver=!0,this._completeSSOLoginViewModel=this.track(new Gg(this.childOptions({client:this._client,attemptLogin:e=>this.attemptLogin(e),loginToken:this._loginToken}))),this.emitChange("completeSSOLoginViewModel")):this.queryHomeserver()}_showPasswordLogin(){this._passwordLoginViewModel=this.track(new Hg(this.childOptions({loginOptions:this._loginOptions,attemptLogin:e=>this.attemptLogin(e)}))),this.emitChange("passwordLoginViewModel")}_showSSOLogin(){this._startSSOLoginViewModel=this.track(new zg(this.childOptions({loginOptions:this._loginOptions}))),this.emitChange("startSSOLoginViewModel")}_showError(e){this._errorMessage=e,this.emitChange("errorMessage")}_setBusy(e){this._isBusy=e,this._passwordLoginViewModel?.setBusy(e),this._startSSOLoginViewModel?.setBusy(e),this.emitChange("isBusy")}async attemptLogin(e){this._setBusy(!0),this._client.startWithLogin(e,{inspectAccountSetup:!0});const t=this._client.loadStatus;return await t.waitFor(r=>r!==C.Login).promise,this._setBusy(!1),t.get()===C.LoginFailed?this._client.loginFailure:(this._hideHomeserver=!0,this.emitChange("hideHomeserver"),this._disposeViewModels(),this._createLoadViewModel(),null)}_createLoadViewModel(){this._loadViewModelSubscription=this.disposeTracked(this._loadViewModelSubscription),this._loadViewModel=this.disposeTracked(this._loadViewModel),this._loadViewModel=this.track(new bc(this.childOptions({ready:e=>{this._client=null,this._ready(e)},client:this._client,homeserver:this._homeserver}))),this._loadViewModel.start(),this.emitChange("loadViewModel"),this._loadViewModelSubscription=this.track(this._loadViewModel.disposableOn("change",()=>{this._loadViewModel.loading||(this._loadViewModelSubscription=this.disposeTracked(this._loadViewModelSubscription)),this._setBusy(!1)}))}_disposeViewModels(){this._startSSOLoginViewModel=this.disposeTracked(this._startSSOLoginViewModel),this._passwordLoginViewModel=this.disposeTracked(this._passwordLoginViewModel),this._completeSSOLoginViewModel=this.disposeTracked(this._completeSSOLoginViewModel),this.emitChange("disposeViewModels")}async setHomeserver(e){this._homeserver=e,this._loginOptions=void 0,this._queriedHomeserver=void 0,this._showError(""),this._disposeViewModels(),this._abortQueryOperation=this.disposeTracked(this._abortQueryOperation),this.emitChange("loginViewModels"),this.disposeTracked(this._abortHomeserverQueryTimeout);const t=this.clock.createTimeout(1e3);this._abortHomeserverQueryTimeout=this.track(()=>t.abort());try{await t.elapsed()}catch(s){if(s.name==="AbortError")return;throw s}this._abortHomeserverQueryTimeout=this.disposeTracked(this._abortHomeserverQueryTimeout),this.queryHomeserver()}async queryHomeserver(){if(!(this._homeserver===this._queriedHomeserver||this._homeserver==="")){this._queriedHomeserver=this._homeserver,this._abortHomeserverQueryTimeout=this.disposeTracked(this._abortHomeserverQueryTimeout),this._abortQueryOperation=this.disposeTracked(this._abortQueryOperation);try{const e=this._client.queryLogin(this._homeserver);this._abortQueryOperation=this.track(()=>e.abort()),this.emitChange("isFetchingLoginOptions"),this._loginOptions=await e.result,this.emitChange("resolvedHomeserver")}catch(e){if(e.name==="AbortError")return;this._loginOptions=void 0}finally{this._abortQueryOperation=this.disposeTracked(this._abortQueryOperation),this.emitChange("isFetchingLoginOptions")}this._loginOptions?(this._loginOptions.sso&&this._showSSOLogin(),this._loginOptions.password&&this._showPasswordLogin(),!this._loginOptions.sso&&!this._loginOptions.password&&this._showError("This homeserver supports neither SSO nor password based login flows")):this._showError(`Could not query login methods supported by ${this.homeserver}`)}}dispose(){super.dispose(),this._client&&this._client.deleteSession()}}class Zg extends k{constructor(e){super(e),this._sessionId=e.sessionId,this._busy=!1,this._showConfirm=!0,this._error=void 0}get showConfirm(){return this._showConfirm}get busy(){return this._busy}get cancelUrl(){return this.urlRouter.urlForSegment("session",!0)}async logout(){this._busy=!0,this._showConfirm=!1,this.emitChange("busy");try{await new Ei(this.platform).startLogout(this._sessionId),this.navigation.push("session",!0)}catch(e){this._error=e,this._busy=!1,this.emitChange("busy")}}get status(){return this._error?this.i18n`Could not log out of device: ${this._error.message}`:this.i18n`Logging out… Please don't close the app.`}}function le(n){let e=n.charAt(0);return(e==="!"||e==="@"||e==="#")&&(e=n.charAt(1)),e.toUpperCase()}function ef(n){let e=0,t,s;if(n.length===0)return e;for(t=0;t<n.length;t++)s=n.charCodeAt(t),e=(e<<5)-e+s,e|=0;return Math.abs(e)}function he(n){return ef(n)%8+1}function fe(n,e,t,s){if(n){const i=e*t.devicePixelRatio;return s.mxcUrlThumbnail(n,i,i,"crop")}}class tf extends k{constructor(e,t){super(e),this._pickerVM=t,this._sessionInfo=e.sessionInfo,this._isDeleting=!1,this._isClearing=!1,this._error=null,this._exportDataUrl=null}get error(){return this._error&&this._error.message}get id(){return this._sessionInfo.id}get openUrl(){return this.urlRouter.urlForSegment("session",this.id)}get label(){const{userId:e,comment:t}=this._sessionInfo;return t?`${e} (${t})`:e}get sessionInfo(){return this._sessionInfo}get exportDataUrl(){return this._exportDataUrl}get avatarColorNumber(){return he(this._sessionInfo.userId)}get avatarInitials(){return le(this._sessionInfo.userId)}}class sf extends k{constructor(e){super(e),this._sessions=new Ar((t,s)=>t.id.localeCompare(s.id)),this._loadViewModel=null,this._error=null}async load(){const e=await this.platform.sessionInfoStorage.getAll();this._sessions.setManyUnsorted(e.map(t=>new tf(this.childOptions({sessionInfo:t}),this)))}get loadViewModel(){return this._loadViewModel}get sessions(){return this._sessions}get cancelUrl(){return this.urlRouter.urlForSegment("login")}}const Ao=["roomBeingCreated","invite","room"];class nn extends k{constructor(e){super(e),this._isOpen=!1,this._hidden=!1}get hidden(){return this._hidden}set hidden(e){e!==this._hidden&&(this._hidden=e,this.emitChange("hidden"))}close(){this._isOpen&&(this._isOpen=!1,this.emitChange("isOpen"))}open(){this._isOpen||(this._isOpen=!0,this.emitChange("isOpen"))}get isOpen(){return this._isOpen}compare(e){return e.kind!==this.kind?Ao.indexOf(this.kind)-Ao.indexOf(e.kind):0}get avatarLetter(){return le(this.name)}get avatarColorNumber(){return he(this._avatarSource.avatarColorId)}avatarUrl(e){return fe(this._avatarSource.avatarUrl,e,this.platform,this._avatarSource.mediaRepository)}get avatarTitle(){return this.name}}class rf extends nn{constructor(e){super(e);const{room:t}=e;this._room=t,this._url=this.urlRouter.openRoomActionUrl(this._room.id)}get kind(){return"room"}get url(){return this._url}compare(e){const t=super.compare(e);if(t!==0)return t;const s=this._room,i=e._room;if(s.isLowPriority!==i.isLowPriority)return s.isLowPriority?1:-1;const r=s.lastMessageTimestamp,o=i.lastMessageTimestamp,a=Number.isSafeInteger(r),c=Number.isSafeInteger(o);if(a!==c)return c?1:-1;const l=o-r;if(l===0||!c||!a){const h=this.name.localeCompare(e.name);return h===0?this._room.id.localeCompare(e._room.id):h}return l}get isUnread(){return this._room.isUnread}get name(){return this._room.name||this.i18n`Empty Room`}get badgeCount(){return this._room.notificationCount}get isHighlighted(){return this._room.highlightCount!==0}get _avatarSource(){return this._room}}function Cr(n,e){return n===e?0:n<e?-1:1}class nf extends nn{constructor(e){super(e);const{invite:t}=e;this._invite=t,this._url=this.urlRouter.openRoomActionUrl(this._invite.id)}get busy(){return this._invite.accepting||this._invite.rejecting}get kind(){return"invite"}get url(){return this._url}get name(){return this._invite.name}get isHighlighted(){return!0}get isUnread(){return!0}get badgeCount(){return this.i18n`!`}get _avatarSource(){return this._invite}compare(e){const t=super.compare(e);if(t!==0)return t;const s=e._invite.timestamp-this._invite.timestamp;return s!==0?s:Cr(this._invite.id,e._invite.id)}}class of extends nn{constructor(e){super(e);const{roomBeingCreated:t}=e;this._roomBeingCreated=t,this._url=this.urlRouter.openRoomActionUrl(this._roomBeingCreated.id)}get busy(){return!this._roomBeingCreated.error}get kind(){return"roomBeingCreated"}get isHighlighted(){return!this.busy}get badgeCount(){return!this.busy&&this.i18n`Failed`}get url(){return this._url}get name(){return this._roomBeingCreated.name}get _avatarSource(){return this._roomBeingCreated}compare(e){const t=super.compare(e);if(t!==0)return t;const s=Cr(this.name,e.name);return s===0?Cr(this._roomBeingCreated.id,e._roomBeingCreated.id):s}avatarUrl(e){return this._roomBeingCreated.avatarBlobUrl??super.avatarUrl(e)}}class af{constructor(e){this._parts=e.split(" ").map(t=>t.toLowerCase().trim())}matches(e){const t=e.name.toLowerCase();return this._parts.every(s=>t.includes(s))}}class cf extends k{constructor(e){super(e);const{session:t}=e;this._tileViewModelsMap=this._mapTileViewModels(t.roomsBeingCreated,t.invites,t.rooms),this._tileViewModelsFilterMap=new ul(this._tileViewModelsMap),this._tileViewModels=this._tileViewModelsFilterMap.sortValues((s,i)=>s.compare(i)),this._currentTileVM=null,this._setupNavigation(),this._closeUrl=this.urlRouter.urlForSegment("session"),this._settingsUrl=this.urlRouter.urlForSegment("settings")}_mapTileViewModels(e,t,s){return t.join(e,s).mapValues((r,o)=>{let a;return r.isBeingCreated?a=new of(this.childOptions({roomBeingCreated:r,emitChange:o})):r.isInvite?a=new nf(this.childOptions({invite:r,emitChange:o})):a=new rf(this.childOptions({room:r,emitChange:o})),this.navigation.path.get("room")?.value===r.id&&(a.open(),this._updateCurrentVM(a)),a})}_updateCurrentVM(e){this._currentTileVM?.close(),this._currentTileVM=e}get closeUrl(){return this._closeUrl}get settingsUrl(){return this._settingsUrl}showCreateRoomView(){this.navigation.push("create-room")}showJoinRoomView(){this.navigation.push("join-room")}_setupNavigation(){const e=this.navigation.observe("room");this.track(e.subscribe(s=>this._open(s)));const t=this.navigation.observe("rooms");this.gridEnabled=!!t.get(),this.track(t.subscribe(s=>{const i=this.gridEnabled^!!s;this.gridEnabled=!!s,i&&this.emitChange("gridEnabled")}))}_open(e){this._currentTileVM?.close(),this._currentTileVM=null,e&&(this._currentTileVM=this._tileViewModelsMap.get(e),this._currentTileVM?.open())}toggleGrid(){const e=this.navigation.path.get("room");let t=this.navigation.path.until("session");this.gridEnabled?e&&(t=t.with(e),t=ar(this.navigation,t)):e?(t=t.with(this.navigation.segment("rooms",[e.value])),t=t.with(e),t=ar(this.navigation,t)):(t=t.with(this.navigation.segment("rooms",[])),t=t.with(this.navigation.segment("empty-grid-tile",0))),this.navigation.applyPath(t)}get tileViewModels(){return this._tileViewModels}clearFilter(){this._tileViewModelsFilterMap.setApply(null),this._tileViewModelsFilterMap.applyOnce((e,t)=>t.hidden=!1)}setFilter(e){if(e=e.trim(),e.length===0)return this.clearFilter(),!1;{const t=!this._tileViewModelsFilterMap.hasApply(),s=new af(e);return this._tileViewModelsFilterMap.setApply((i,r)=>{r.hidden=!s.matches(r)}),t}}}class Me{constructor(e,t,s,i){this._remove=e,this._update=t,this._replace=s,this._updateParams=i}get shouldReplace(){return this._replace}get shouldRemove(){return this._remove}get shouldUpdate(){return this._update}get updateParams(){return this._updateParams}static Remove(){return new Me(!0,!1,!1,null)}static Update(e){return new Me(!1,!0,!1,e)}static Nothing(){return new Me(!1,!1,!1,null)}static Replace(e){return new Me(!1,!1,!0,e)}}class lf extends Xt{constructor(e,t){super(),this._entries=e,this._tiles=null,this._entrySubscription=null,this._tileOptions=t,this._emitSpontanousUpdate=this._emitSpontanousUpdate.bind(this)}_createTile(e){const t=this._tileOptions.tileClassForEntry(e,this._tileOptions);if(t)return new t(e,this._tileOptions)}_emitSpontanousUpdate(e,t){const s=e.lowerEntry,i=this._findTileIdx(s);this.emitUpdate(i,e,t)}onSubscribeFirst(){this._entrySubscription=this._entries.subscribe(this),this._populateTiles()}_populateTiles(){this._silent=!0,this._tiles=[];let e=null;for(let s of this._entries)(!e||!e.tryIncludeEntry(s))&&(e=this._createTile(s),e&&this._tiles.push(e));let t=null;for(let s of this._tiles)t&&t.updateNextSibling(s),s.updatePreviousSibling(t),t=s;t&&t.updateNextSibling(null);for(let s=0;s<this._tiles.length;s+=1){const i=this._tiles[s];i.needsDateSeparator&&(this._addTileAt(s,i.createDateSeparator(),!0),s+=1)}for(const s of this._tiles)s.setUpdateEmit(this._emitSpontanousUpdate);this._silent=!1}_findTileIdx(e){return ze(this._tiles,e,(t,s)=>-s.compareEntry(t))}_findTileAtIdx(e,t){const s=this._getTileAtIdx(t);if(s&&s.compareEntry(e)===0)return s}_getTileAtIdx(e){return e>=0&&e<this._tiles.length?this._tiles[e]:null}onUnsubscribeLast(){this._entrySubscription=this._entrySubscription();for(let e=0;e<this._tiles.length;e+=1)this._tiles[e].dispose();this._tiles=null}onReset(){this._buildInitialTiles(),this.emitReset()}onAdd(e,t){const s=this._findTileIdx(t),i=this._getTileAtIdx(s-1);if(i&&i.tryIncludeEntry(t)){this.emitUpdate(s-1,i);return}const r=this._getTileAtIdx(s);if(r&&r.tryIncludeEntry(t)){this.emitUpdate(s,r);return}const o=this._createTile(t);o&&(this._addTileAt(s,o),this._evaluateDateHeaderAtIdx(s))}_evaluateDateHeaderAtIdx(e){for(let t=0;t<3;t+=1){const s=e+t;if(s>=this._tiles.length)break;const i=this._tiles[s],r=s>0?this._tiles[s-1]:void 0,o=r?.shape===ee.DateHeader;i.needsDateSeparator&&!o?(e+=1,this._addTileAt(s,i.createDateSeparator())):!i.needsDateSeparator&&o&&this._removeTile(s-1,r)}}_addTileAt(e,t,s=!1){const i=e>0?this._tiles[e-1]:void 0,r=this._tiles[e];i?.updateNextSibling(t),t.updatePreviousSibling(i),t.updateNextSibling(r),r?.updatePreviousSibling(t),this._tiles.splice(e,0,t),s||this.emitAdd(e,t),t.setUpdateEmit(this._emitSpontanousUpdate)}onUpdate(e,t,s){if(!this._tiles)return;const i=this._findTileIdx(t),r=this._findTileAtIdx(t,i);if(r){const o=r.updateEntry(t,s);if(o.shouldReplace){const a=this._createTile(t);a?(this._replaceTile(i,r,a,o.updateParams),a.setUpdateEmit(this._emitSpontanousUpdate)):this._removeTile(i,r)}o.shouldRemove&&this._removeTile(i,r),o.shouldUpdate&&this.emitUpdate(i,r,o.updateParams)}}_replaceTile(e,t,s,i){t.dispose();const r=this._getTileAtIdx(e-1),o=this._getTileAtIdx(e+1);this._tiles[e]=s,r?.updateNextSibling(s),s.updatePreviousSibling(r),s.updateNextSibling(o),o?.updatePreviousSibling(s),this.emitUpdate(e,s,i)}_removeTile(e,t){const s=this._getTileAtIdx(e-1),i=this._getTileAtIdx(e+1);this._tiles.splice(e,1),t.dispose(),this.emitRemove(e,t),s?.updateNextSibling(i),i?.updatePreviousSibling(s),s&&s.shape===ee.DateHeader&&(!i||!i.needsDateSeparator)&&this._removeTile(e-1,s)}onRemove(e,t){const s=this._findTileIdx(t),i=this._findTileAtIdx(t,s);i&&(i.removeEntry(t)?this._removeTile(s,i):this.emitUpdate(s,i))}onMove(){}[Symbol.iterator](){return this._tiles.values()}get length(){return this._tiles.length}getFirst(){return this._tiles[0]}getTileIndex(e){const t=ze(this._tiles,e,(i,r)=>i.compare(r));return this._tiles[t]?.compare(e)===0?t:-1}sliceIterator(e,t){return this._tiles.slice(e,t)[Symbol.iterator]()}}class hf extends k{constructor(e){super(e);const{timeline:t,tileOptions:s}=e;this._timeline=this.track(t),this._tiles=new lf(t.entries,s),this._startTile=null,this._endTile=null,this._topLoadingPromise=null,this._requestedStartTile=null,this._requestedEndTile=null,this._requestScheduled=!1,this._showJumpDown=!1}setVisibleTileRange(e,t){this._requestedStartTile=e,this._requestedEndTile=t,this._requestScheduled||(Promise.resolve().then(()=>{this._setVisibleTileRange(this._requestedStartTile,this._requestedEndTile),this._requestScheduled=!1}),this._requestScheduled=!0)}_setVisibleTileRange(e,t){let s;if(e&&t){this._startTile=e,this._endTile=t;const i=this._tiles.getTileIndex(this._startTile),r=this._tiles.getTileIndex(this._endTile);for(const o of this._tiles.sliceIterator(i,r+1))o.notifyVisible();s=i<10,this._setShowJumpDown(r<this._tiles.length-1)}else s=!0,this._setShowJumpDown(!1);s&&!this._topLoadingPromise&&(this._topLoadingPromise=this._timeline.loadAtTop(10).then(i=>{this._topLoadingPromise=null,i||this.setVisibleTileRange(this._requestedStartTile,this._requestedEndTile)}))}get tiles(){return this._tiles}_setShowJumpDown(e){this._showJumpDown!==e&&(this._showJumpDown=e,this.emitChange("showJumpDown"))}get showJumpDown(){return this._showJumpDown}}class df extends k{constructor(e){super(e.options),this._roomVM=e,this._isEmpty=!0,this._replyVM=null}setReplyingTo(e){(new Boolean(e)!==new Boolean(this._replyVM)||!this._replyVM?.id.equals(e.asEventKey()))&&(this._replyVM=this.disposeTracked(this._replyVM),e&&(this._replyVM=this.track(this._roomVM._createTile(e)),this._replyVM.notifyVisible()),this.emitChange("replyViewModel"),this.emit("focus"))}clearReplyingTo(){this.setReplyingTo(null)}get replyViewModel(){return this._replyVM}get isEncrypted(){return this._roomVM.isEncrypted}async sendMessage(e){const t=await this._roomVM._sendMessage(e,this._replyVM);return t&&(this._isEmpty=!0,this.emitChange("canSend"),this.clearReplyingTo()),t}sendPicture(){this._roomVM._pickAndSendPicture()}sendFile(){this._roomVM._pickAndSendFile()}sendVideo(){this._roomVM._pickAndSendVideo()}get canSend(){return!this._isEmpty}async setInput(e){const t=this._isEmpty;this._isEmpty=e.length===0,t&&!this._isEmpty&&this._roomVM._room.ensureMessageKeyIsShared(),t!==this._isEmpty&&this.emitChange("canSend")}get kind(){return"composer"}}async function uf(n,e,t,s){const i=new Map;n.text&&i.set("text",n.text),i.set("user_agent",n.userAgent),i.set("app",n.app),i.set("version",n.version),n.label&&i.set("label",n.label),i.set("file",{name:"logs.json",blob:e});const r=new Map;r.set("Accept","application/json");const o=s(t,{method:"POST",body:i,headers:r});let a;try{a=await o.response()}catch(h){throw new Error(`Could not submit logs to ${t}, got error ${h.message}`)}const{status:c,body:l}=a;if(c<200||c>=300)throw new Error(`Could not submit logs to ${t}, got status code ${c} with body ${l}`)}async function Sc(n,e){const{bugReportEndpointUrl:t}=e.config;if(!t)throw new Error("no server configured to submit logs");const i=e.logger.reporters.find(o=>!!o.export);if(!i)throw new Error("No logger that can export configured");const r=await i.export();await uf({app:"hydrogen",userAgent:e.description,version:e.version,text:`Submit logs from settings for user ${n.userId} on device ${n.deviceId}`},r.asBlob(),t,e.request)}class mf extends k{get message(){return this.error.message}get error(){return this.getOption("error")}close(){this.getOption("onClose")()}async submitLogs(){try{return await Sc(this.getOption("session"),this.platform),!0}catch{return!1}}}class is extends k{get errorViewModel(){return this._errorViewModel}reportError(e){this._errorViewModel?.error!==e&&(this.disposeTracked(this._errorViewModel),this._errorViewModel=this.track(new mf(this.childOptions({error:e,onClose:()=>{this._errorViewModel=this.disposeTracked(this._errorViewModel),this.emitChange("errorViewModel")}}))),this.emitChange("errorViewModel"))}logAndCatch(e,t,s=void 0){try{let i=this.logger.run(e,t);return i instanceof Promise&&(i=i.catch(r=>(this.reportError(r),s))),i}catch(i){return this.reportError(i),s}}}class xo extends is{constructor(e){super(e);const t=new Jc(this.call,"change");this.track(t.subscribe(()=>this.onUpdate()));const s=new wl("self",t).mapValues((r,o)=>new pf(this.childOptions({call:r,emitChange:o})),()=>{}),i=this.call.members.filterValues(r=>r.isConnected).mapValues((r,o)=>new on(this.childOptions({member:r,emitChange:o,mediaRepository:this.getOption("room").mediaRepository})),(r,o)=>o?.onUpdate());this.memberViewModels=i.join(s).sortValues((r,o)=>r.compare(o)),this.track(this.memberViewModels.subscribe({onRemove:()=>{this.emitChange()},onAdd:()=>{this.emitChange()},onUpdate:()=>{},onReset:()=>{},onMove:()=>{}}))}get isCameraMuted(){return this.call.muteSettings?.camera??!0}get isMicrophoneMuted(){return this.call.muteSettings?.microphone??!0}get memberCount(){return this.memberViewModels.length}get name(){return this.call.name}get id(){return this.call.id}get call(){return this.getOption("call")}onUpdate(){this.call.error&&this.reportError(this.call.error)}async hangup(){this.logAndCatch("CallViewModel.hangup",async e=>{this.call.hasJoined&&await this.call.leave(e)})}async toggleCamera(){this.logAndCatch("Call.toggleCamera",async e=>{const{localMedia:t,muteSettings:s}=this.call;if(s&&t){if(s.camera&&!He(t.userMedia)){const i=await this.platform.mediaDevices.getMediaTracks(!s.microphone,!0);await this.call.setMedia(t.withUserMedia(i))}else await this.call.setMuted(s.toggleCamera());this.emitChange()}})}async toggleMicrophone(){this.logAndCatch("Call.toggleMicrophone",async e=>{const{localMedia:t,muteSettings:s}=this.call;if(s&&t){if(s.microphone&&!ht(t.userMedia)){const i=await this.platform.mediaDevices.getMediaTracks(!0,!s.camera);await this.call.setMedia(t.withUserMedia(i))}else await this.call.setMuted(s.toggleMicrophone());this.emitChange()}})}}class pf extends is{constructor(e){super(e),this.init()}async init(){const e=this.getOption("room");this.memberObservable=await e.observeMember(e.user.id),this.track(this.memberObservable.subscribe(()=>{this.emitChange(void 0)}))}get errorViewModel(){}get stream(){return this.call.localPreviewMedia?.userMedia}get call(){return this.getOption("call")}get isCameraMuted(){return this.call.muteSettings?.camera??!0}get isMicrophoneMuted(){return this.call.muteSettings?.microphone??!0}get avatarLetter(){const e=this.memberObservable?.get();return e?le(e.name):this.getOption("room").user.id}get avatarColorNumber(){return he(this.getOption("room").user.id)}avatarUrl(e){const t=this.memberObservable?.get();if(t)return fe(t.avatarUrl,e,this.platform,this.getOption("room").mediaRepository)}get avatarTitle(){const e=this.memberObservable?.get();return e?e.name:this.getOption("room").user.id}compare(e){return-1}}class on extends is{get stream(){return this.member.remoteMedia?.userMedia}get member(){return this.getOption("member")}get isCameraMuted(){return this.member.remoteMuteSettings?.camera??!0}get isMicrophoneMuted(){return this.member.remoteMuteSettings?.microphone??!0}get avatarLetter(){return le(this.member.member.name)}get avatarColorNumber(){return he(this.member.userId)}avatarUrl(e){const{avatarUrl:t}=this.member.member,s=this.getOption("mediaRepository");return fe(t,e,this.platform,s)}get avatarTitle(){return this.member.member.name}onUpdate(){this.mapMemberSyncErrorIfNeeded()}mapMemberSyncErrorIfNeeded(){this.member.error&&this.reportError(this.member.error)}compare(e){if(e instanceof on){const t=this.member.member.userId,s=e.member.member.userId;return t===s?0:t<s?-1:1}else return-e.compare(this)}}function bs(n){return{w:n.width,h:n.height,mimetype:n.blob.mimeType,size:n.blob.size}}class We{constructor(e,t,s){this.userMedia=e,this.screenShare=t,this.dataChannelOptions=s}withUserMedia(e){return new We(e,this.screenShare?.clone(),this.dataChannelOptions)}withScreenShare(e){return new We(this.userMedia?.clone(),e,this.dataChannelOptions)}withDataChannel(e){return new We(this.userMedia?.clone(),this.screenShare?.clone(),e)}asPreview(){const e=this.clone(),t=e.userMedia;if(t&&t.getVideoTracks().length>0){const s=ht(t);s&&(s.stop(),t.removeTrack(s))}return e}replaceClone(e,t){const s=(i,r,o)=>i?.id===o?.id?r:o?.clone();return new We(s(t?.userMedia,e?.userMedia,this.userMedia),s(t?.screenShare,e?.screenShare,this.screenShare),this.dataChannelOptions)}clone(){return new We(this.userMedia?.clone(),this.screenShare?.clone(),this.dataChannelOptions)}dispose(){ht(this.userMedia)?.stop(),He(this.userMedia)?.stop(),He(this.screenShare)?.stop()}}class _f extends k{constructor(e,t){super(t),this._firstTileInDay=e}setUpdateEmit(e){this._emitUpdate=e}get upperEntry(){return this.refEntry}get lowerEntry(){return this.refEntry}get refEntry(){return this._firstTileInDay.lowerEntry}compare(e){return this.compareEntry(e.upperEntry)}get relativeDate(){return this._dateString||(this._dateString=this.timeFormatter.formatRelativeDate(new Date(this.refEntry.timestamp))),this._dateString}get machineReadableDate(){return this._machineReadableString||(this._machineReadableString=this.timeFormatter.formatMachineReadableDate(new Date(this.refEntry.timestamp))),this._machineReadableString}get shape(){return ee.DateHeader}get needsDateSeparator(){return!1}createDateSeparator(){}compareEntry(e){const t=this.refEntry.compare(e);return t===0?-1:t}updateEntry(e,t){return Me.Nothing()}removeEntry(e){return!1}tryIncludeEntry(){return!1}get comparisonIsNotCommutative(){return!0}updatePreviousSibling(e){this._firstTileInDay.updatePreviousSibling(e)}updateNextSibling(e){if(!e)return;this._firstTileInDay=e;const t=this._dateString;this._dateString=void 0,this._machineReadableString=void 0,t&&t!==this.relativeDate&&this._emitUpdate?.(this,"relativeDate")}notifyVisible(){}dispose(){}}class rs extends is{constructor(e,t){super(t),this._entry=e,this._date=this._entry.timestamp?new Date(this._entry.timestamp):void 0,this._needsDateSeparator=!1,this._emitUpdate=void 0}get shape(){return null}get isContinuation(){return!1}get needsDateSeparator(){return this._needsDateSeparator}createDateSeparator(){return new _f(this,this.childOptions({}))}_updateDateSeparator(e){e&&e._date&&this._date?this._needsDateSeparator=e._date.getFullYear()!==this._date.getFullYear()||e._date.getMonth()!==this._date.getMonth()||e._date.getDate()!==this._date.getDate():this._needsDateSeparator=!!this._date}get id(){return this._entry.asEventKey()}get eventId(){return this._entry.id}get isPending(){return this._entry.isPending}get isUnsent(){return this._entry.isPending&&this._entry.pendingEvent.status!==F.Sent}get canAbortSending(){return this._entry.isPending&&!this._entry.pendingEvent.hasStartedSending}abortSending(){this._entry.pendingEvent?.abort()}setUpdateEmit(e){this._emitUpdate=e}emitChange(e){this._emitUpdate&&this._emitUpdate(this,e),super.emitChange(e)}get upperEntry(){return this._entry}get lowerEntry(){return this._entry}get comparisonIsNotCommutative(){return!1}compare(e){return e.comparisonIsNotCommutative?-e.compare(this):this.upperEntry.compare(e.upperEntry)}compareEntry(e){return this._entry.compare(e)}updateEntry(e,t){const s=this.shape==="redacted";return!e.isGap&&e.isRedacted!==s?Me.Replace("shape"):(this._entry=e,Me.Update(t))}removeEntry(){return!0}tryIncludeEntry(){return!1}updatePreviousSibling(e){e?.shape!==ee.DateHeader&&this._updateDateSeparator(e)}updateNextSibling(){}notifyVisible(){}dispose(){this.setUpdateEmit(null),super.dispose()}get _room(){return this._roomVM.room}get _roomVM(){return this._options.roomVM}get _timeline(){return this._options.timeline}get _powerLevels(){return this._timeline.powerLevels}get _ownMember(){return this._options.timeline.me}get displayName(){return this._entry.displayName||this.sender}get sender(){return this._entry.sender}}class gf extends rs{constructor(e,t){super(e,t),this._loading=!1,this._waitingForConnection=!1,this._isAtTop=!0,this._siblingChanged=!1}get needsDateSeparator(){return!1}async fill(e=!1){if(!this._loading&&!this._entry.edgeReached){this._loading=!0,this.emitChange("isLoading");try{await this._room.fillGap(this._entry,10)}catch(t){return t instanceof Ge?(await this._waitForReconnection(),e?!1:await this.fill(!0)):(this.reportError(t),!1)}finally{this._loading=!1,this.emitChange("isLoading")}return!0}return!1}async notifyVisible(){if(this.errorViewModel)return;let e=0,t;this._siblingChanged=!1;do t=await this.fill(),e=e+1;while(e<10&&!this._siblingChanged&&t&&!this.isDisposed)}get isAtTop(){return this._isAtTop}updatePreviousSibling(e){super.updatePreviousSibling(e);const t=!e;this._isAtTop!==t&&(this._isAtTop=t,this.emitChange("isAtTop")),this._siblingChanged=!0}updateNextSibling(){this._siblingChanged=!0}updateEntry(e,t){return super.updateEntry(e,t),e.isGap?Me.Nothing():Me.Remove()}async _waitForReconnection(){this._waitingForConnection=!0,this.emitUpdate("status"),await this.options.client.reconnector.connectionStatus.waitFor(e=>e===zt.Online).promise,this._waitingForConnection=!1,this.emitUpdate("status")}get shape(){return"gap"}get isLoading(){return this._loading}get showSpinner(){return this.isLoading||this._waitingForConnection}get status(){const e=this._entry.prev_batch?"previous":"next";return this._waitingForConnection?"Waiting for connection\u2026":this.errorViewModel?`Could not load ${e} messages`:this.isLoading?"Loading more messages\u2026":"Gave up loading more messages"}}class ff{constructor(e){this._parentTile=e,this._map=new ct,this._reactions=this._map.sortValues((t,s)=>t._compare(s))}update(e,t){if(e){for(const s in e)if(e.hasOwnProperty(s)){const i=e[s],r=this._map.get(s);r?r._tryUpdate(i)&&this._map.update(s):this._map.add(s,new No(s,i,null,this._parentTile))}}if(t)for(const[s,i]of t.entries()){const r=this._map.get(s);r?(r._tryUpdatePending(i),this._map.update(s)):this._map.add(s,new No(s,null,i,this._parentTile))}for(const s of this._map.keys()){const i=t?.has(s),r=e?.hasOwnProperty(s);!r&&!i?this._map.remove(s):r?i||this._map.get(s)._tryUpdatePending(null)&&this._map.update(s):this._map.get(s)._tryUpdate(null)&&this._map.update(s)}}get reactions(){return this._reactions}getReaction(e){return this._map.get(e)}}class No{constructor(e,t,s,i){this._key=e,this._annotation=t,this._pending=s,this._parentTile=i,this._isToggling=!1}_tryUpdate(e){const t=!!this._annotation!=!!e,i=this._annotation&&e&&(e.me!==this._annotation.me||e.count!==this._annotation.count||e.firstTimestamp!==this._annotation.firstTimestamp);return t||i?(this._annotation=e,!0):!1}_tryUpdatePending(e){return!e&&!this._pending?!1:(this._pending=e,!0)}get key(){return this._key}get count(){return(this._pending?.count||0)+(this._annotation?.count||0)}get isPending(){return this._pending!==null}get isActive(){return this._annotation?.me||this.isPending}get firstTimestamp(){let e=Number.MAX_SAFE_INTEGER;return this._annotation&&(e=Math.min(e,this._annotation.firstTimestamp)),this._pending&&(e=Math.min(e,this._pending.firstTimestamp)),e}_compare(e){if(e===this)return 0;if(this.count!==e.count)return e.count-this.count;{const t=this.firstTimestamp-e.firstTimestamp;return t===0?this.key<e.key?-1:1:t}}async toggle(e=null){if(this._isToggling){console.log("busy toggling reaction already");return}this._isToggling=!0;try{await this._parentTile.toggleReaction(this.key,e)}finally{this._isToggling=!1}}}class pt extends rs{constructor(e,t){super(e,t),this._isContinuation=!1,this._reactions=null,this._replyTile=null,(this._entry.annotations||this._entry.pendingAnnotations)&&this._updateReactions(),this._updateReplyTileIfNeeded(void 0)}notifyVisible(){super.notifyVisible(),this._replyTile?.notifyVisible()}get _mediaRepository(){return this._room.mediaRepository}get permaLink(){return`https://matrix.to/#/${encodeURIComponent(this._room.id)}/${encodeURIComponent(this._entry.id)}`}get senderProfileLink(){return`https://matrix.to/#/${encodeURIComponent(this.sender)}`}get memberPanelLink(){return`${this.urlRouter.urlUntilSegment("room")}/member/${this.sender}`}get avatarColorNumber(){return he(this._entry.sender)}avatarUrl(e){return fe(this._entry.avatarUrl,e,this.platform,this._mediaRepository)}get avatarLetter(){return le(this.sender)}get avatarTitle(){return this.sender}get time(){return this._date&&this.timeFormatter.formatTime(this._date)}get isOwn(){return this._entry.sender===this._ownMember.userId}get isContinuation(){return this._isContinuation}get isUnverified(){return this._entry.isUnverified}get isReply(){return this._entry.isReply}_getContent(){return this._entry.content}updatePreviousSibling(e){super.updatePreviousSibling(e);let t=!1;if(e&&e instanceof pt&&e.sender===this.sender){const s=this._entry.timestamp,i=e._entry.timestamp;t=s-i<5*60*1e3}t!==this._isContinuation&&(this._isContinuation=t,this.emitChange("isContinuation"))}updateEntry(e,t){const s=super.updateEntry(e,t);return s.shouldUpdate&&this._updateReactions(),this._updateReplyTileIfNeeded(t),s}_updateReplyTileIfNeeded(e){const t=this._entry.contextEntry;if(t){const s=this._replyTile?.updateEntry(t,e);if(s?.shouldReplace||!this._replyTile){this.disposeTracked(this._replyTile);const i=this._options.tileClassForEntry,r=i(t,this._options);r&&(this._replyTile=new r(t,this._options))}s?.shouldUpdate&&this._replyTile?.emitChange()}}startReply(){this._roomVM.startReply(this._entry)}createReplyContent(e,t){return this._entry.createReplyContent(e,t)}redact(e,t){return this._room.sendRedaction(this._entry.id,e,t)}get canRedact(){return this._powerLevels.canRedactFromSender(this._entry.sender)}get reactions(){return this.shape!=="redacted"?this._reactions:null}get canReact(){return this._powerLevels.canSendType("m.reaction")}react(e,t=null){return this.logger.wrapOrRun(t,"react",async s=>{if(!this.canReact){s.set("powerlevel_lacking",!0);return}if(this._entry.haveAnnotation(e)){s.set("already_reacted",!0);return}const i=this._entry.pendingAnnotations?.get(e)?.redactionEntry;i&&!i.pendingEvent.hasStartedSending?(s.set("abort_redaction",!0),await i.pendingEvent.abort()):await this._room.sendEvent("m.reaction",this._entry.annotate(e),null,s)})}redactReaction(e,t=null){return this.logger.wrapOrRun(t,"redactReaction",async s=>{if(!this._powerLevels.canRedactFromSender(this._ownMember.userId)){s.set("powerlevel_lacking",!0);return}if(!this._entry.haveAnnotation(e)){s.set("not_yet_reacted",!0);return}let i=this._entry.pendingAnnotations?.get(e)?.annotationEntry;i||(i=await this._timeline.getOwnAnnotationEntry(this._entry.id,e)),i?await this._room.sendRedaction(i.id,null,s):s.set("no_reaction",!0)})}toggleReaction(e,t=null){return this.logger.wrapOrRun(t,"toggleReaction",async s=>{this._entry.haveAnnotation(e)?await this.redactReaction(e,s):await this.react(e,s)})}_updateReactions(){const{annotations:e,pendingAnnotations:t}=this._entry;!e&&!t?this._reactions&&(this._reactions=null):(this._reactions||(this._reactions=new ff(this)),this._reactions.update(e,t))}get replyTile(){return this._entry.contextEventId?this._replyTile:null}}const yf="(?:https|http|ftp):\\/\\/",Ic="[^\\s.,?!)]",Do="[a-zA-Z0-9:.\\[\\]-]",wf=`${Do}*(?=${Do})${Ic}`,vf=`(?:[\\/#](?:[^\\s]*${Ic})?)`,bf=`${yf}${wf}${vf}?`,Sf=new RegExp(bf,"gi");function Rc(n,e){const t=n.matchAll(Sf);let s=0;for(let r of t){const o=n.slice(s,r.index);e(o,!1),e(r[0],!0);const a=r[0].length;s=r.index+a}const i=n.slice(s);e(i,!1)}function If(n){const e=[],t=n.split(`
`),s=(i,r)=>{r?e.push(new Tr(i,[new Yt(i)])):e.push(new Yt(i))};for(let i=0;i<t.length;i+=1){const r=t[i];r.length&&Rc(r,s),i>=t.length-1||e.push(new kc)}return new an(n,e)}function Rf(n){return new an(n,[new Yt(n)])}class kf{constructor(e,t){this.level=e,this.inlines=t}get type(){return"header"}}class Vo{constructor(e,t){this.language=e,this.text=t}get type(){return"codeblock"}}class Ef{constructor(e,t){this.items=t,this.startOffset=e}get type(){return"list"}}class Mf{constructor(e,t){this.head=e,this.body=t}get type(){return"table"}}class Cf{get type(){return"rule"}}class kc{get type(){return"newline"}}class ti{constructor(e,t){this.format=e.toLowerCase(),this.children=t}get type(){return"format"}}class Tf{constructor(e,t,s,i,r){this.src=e,this.width=t,this.height=s,this.alt=i,this.title=r}get type(){return"image"}}class Af{constructor(e,t,s){this.id=e,this.href=t,this.children=s}get type(){return"pill"}get avatarColorNumber(){return he(this.id)}get avatarInitials(){return le(this.id)}}class Tr{constructor(e,t){this.url=e,this.inlines=t}get type(){return"link"}}class Yt{constructor(e){this.text=e}get type(){return"text"}}function xf(n){return n.type==="format"&&n.format==="blockquote"}class an{constructor(e,t){this.sourceString=e,this.parts=t}insertEmote(e){let t=0;for(;t<this.parts.length&&xf(this.parts[t]);t++);this.parts.splice(t,0,new Yt(e))}}const ys=tt("Plain","Html");class Ec extends pt{constructor(e,t){super(e,t),this._messageBody=null,this._format=null}get shape(){return"message"}_parseBody(e){return Rf(e)}_getBodyFormat(){return ys.Plain}get body(){const e=this._getBody(),t=this._getBodyFormat();return(!this._messageBody||this._messageBody.sourceString!==e||this._format!==t)&&(this._messageBody=this._parseBody(e,t),this._format=t),this._messageBody}}const Nf=["EM","STRONG","CODE","DEL","SPAN"],Df=["DIV","BLOCKQUOTE"],Vf=["https","http","ftp","mailto","magnet"].map(n=>`${n}://`),Pf="https://matrix.to",Po=`${Pf}/#/`;class Lf{constructor(e,t){this.result=e,this.mediaRepository=t}parsePillLink(e){if(!e.startsWith(Po))return null;const t=e.substring(Po.length);return t[0]==="@"?t:null}parseLink(e,t){const s=this.result.getAttributeValue(e,"href"),i=s?.toLowerCase();if(!i||!Vf.some(o=>i.startsWith(o)))return new ti("span",t);const r=this.parsePillLink(s);return r?new Af(r,s,t):new Tr(s,t)}parseList(e){const t=this.result;let s=null;t.getNodeElementName(e)==="OL"&&(s=parseInt(t.getAttributeValue(e,"start"))||1);const i=[];for(const r of t.getChildNodes(e)){if(t.getNodeElementName(r)!=="LI")continue;const o=this.parseAnyNodes(t.getChildNodes(r));i.push(o)}return new Ef(s,i)}_ensureElement(e,t){return e&&this.result.isElementNode(e)&&this.result.getNodeElementName(e)===t}parseCodeBlock(e){const t=this.result;let s;for(const o of t.getChildNodes(e)){s=o;break}let i=null;if(!this._ensureElement(s,"CODE"))return new Vo(i,this.result.getNodeText(e));const r=t.getAttributeValue(s,"class")||"";for(const o of r.split(" "))if(o.startsWith("language-")&&!o.startsWith("language-_")){i=o.substring(9);break}return new Vo(i,this.result.getNodeText(s))}parseImage(e){const t=this.result,s=t.getAttributeValue(e,"src")||"",i=this.mediaRepository.mxcUrl(s);if(!i)return null;const r=parseInt(t.getAttributeValue(e,"width"))||null,o=parseInt(t.getAttributeValue(e,"height"))||null,a=t.getAttributeValue(e,"alt"),c=t.getAttributeValue(e,"title");return new Tf(i,r,o,a,c)}parseTableRow(e,t){const s=[];for(const i of this.result.getChildNodes(e)){if(!this._ensureElement(i,t))continue;const r=this.result.getChildNodes(i),o=this.parseInlineNodes(r);s.push(o)}return s}parseTableHead(e){let t=null;for(const s of this.result.getChildNodes(e)){t=s;break}return this._ensureElement(t,"TR")?this.parseTableRow(t,"TH"):null}parseTableBody(e){const t=[];for(const s of this.result.getChildNodes(e))!this._ensureElement(s,"TR")||t.push(this.parseTableRow(s,"TD"));return t}parseTable(e){const t=Array.from(this.result.getChildNodes(e));let s,i;return this._ensureElement(t[0],"THEAD")&&this._ensureElement(t[1],"TBODY")?(s=this.parseTableHead(t[0]),i=this.parseTableBody(t[1])):this._ensureElement(t[0],"TBODY")&&(s=null,i=this.parseTableBody(t[0])),new Mf(s,i)}parseInlineElement(e){const t=this.result,s=t.getNodeElementName(e),i=t.getChildNodes(e);switch(s){case"A":{const r=this.parseInlineNodes(i);return this.parseLink(e,r)}case"BR":return new kc;default:{if(!Nf.includes(s))return null;const r=this.parseInlineNodes(i);return new ti(s,r)}}}parseInlineNode(e){return this.result.isElementNode(e)?this.parseInlineElement(e):null}parseBlockElement(e){const t=this.result,s=t.getNodeElementName(e),i=t.getChildNodes(e);switch(s){case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":{const r=this.parseInlineNodes(i);return new kf(parseInt(s[1]),r)}case"UL":case"OL":return this.parseList(e);case"PRE":return this.parseCodeBlock(e);case"HR":return new Cf;case"IMG":return this.parseImage(e);case"P":{const r=this.parseInlineNodes(i);return new ti(s,r)}case"TABLE":return this.parseTable(e);default:{if(!Df.includes(s))return null;const r=this.parseAnyNodes(i);return new ti(s,r)}}}parseBlockNode(e){return this.result.isElementNode(e)?this.parseBlockElement(e):null}_parseTextParts(e,t){if(!this.result.isTextNode(e))return!1;const s=(i,r)=>{r?t.push(new Tr(i,[new Yt(i)])):t.push(new Yt(i))};return Rc(this.result.getNodeText(e),s),!0}_isAllowedNode(e){return!this._ensureElement(e,"MX-REPLY")}_parseInlineNodes(e,t){for(const s of e){if(this._parseTextParts(s,t))continue;const i=this.parseInlineNode(s);if(i){t.push(i);continue}this._isAllowedNode(s)&&this._parseInlineNodes(this.result.getChildNodes(s),t)}}parseInlineNodes(e){const t=[];return this._parseInlineNodes(e,t),t}_parseAnyNodes(e,t){for(const s of e){if(this._parseTextParts(s,t))continue;const i=this.parseInlineNode(s)||this.parseBlockNode(s);if(i){t.push(i);continue}this._isAllowedNode(s)&&this._parseAnyNodes(this.result.getChildNodes(s),t)}}parseAnyNodes(e){const t=[];return this._parseAnyNodes(e,t),t}}function Of(n,e,t){const s=n.parseHTML(t),r=new Lf(s,e).parseAnyNodes(s.rootNodes);return new an(t,r)}class Uf extends Ec{_getContentString(e){return this._getContent()?.[e]||""}_getPlainBody(){return this._getContentString("body")}_getFormattedBody(){return this._getContentString("formatted_body")}_getBody(){return this._getBodyFormat()===ys.Html?this._getFormattedBody():this._getPlainBody()}_getBodyFormat(){return this._getContent()?.format==="org.matrix.custom.html"?ys.Html:ys.Plain}_parseBody(e,t){let s;return t===ys.Html?s=Of(this.platform,this._mediaRepository,e):s=If(e),this._getContent()?.msgtype==="m.emote"&&s.insertEmote(`* ${this.displayName} `),s}}class Lo extends pt{get shape(){return"redacted"}get description(){const{redactionReason:e}=this._entry;return this.isRedacting?e?this.i18n`This message is being deleted (${e})…`:this.i18n`This message is being deleted…`:e?this.i18n`This message has been deleted (${e}).`:this.i18n`This message has been deleted.`}get isRedacting(){return this._entry.isRedacting}get canRedact(){return!1}abortPendingRedaction(){return this._entry.abortPendingRedaction()}}const Ff=300,Bf=400;class Mc extends pt{constructor(e,t){super(e,t),this._decryptedThumbnail=null,this._decryptedFile=null,this._isVisible=!1,this._error=null,this._downloading=!1,this._downloadError=null}async downloadMedia(){if(this._downloading||this.isPending)return;const e=this._getContent(),t=e.body;this._downloading=!0,this.emitChange("status");let s;try{s=await this._mediaRepository.downloadAttachment(e),this.platform.saveFileAs(s,t)}catch(i){this._downloadError=i}finally{s?.dispose(),this._downloading=!1}this.emitChange("status")}get isUploading(){return this.isPending&&this._entry.pendingEvent.status===F.UploadingAttachments}get uploadPercentage(){const{pendingEvent:e}=this._entry;return e&&Math.round(e.attachmentsSentBytes/e.attachmentsTotalBytes*100)}get status(){const{pendingEvent:e}=this._entry;switch(e?.status){case F.Waiting:return this.i18n`Waiting…`;case F.EncryptingAttachments:case F.Encrypting:return this.i18n`Encrypting…`;case F.UploadingAttachments:return this.i18n`Uploading…`;case F.Sending:return this.i18n`Sending…`;case F.Error:return this.i18n`Error: ${e.error.message}`;default:return this._downloadError?"Download failed":this._downloading?this.i18n`Downloading…`:""}}get thumbnailUrl(){if(!this._isVisible)return"";if(this._decryptedThumbnail)return this._decryptedThumbnail.url;{const e=this._getContent().info?.thumbnail_url;if(e)return this._mediaRepository.mxcUrlThumbnail(e,this.width,this.height,"scale")}if(this._entry.isPending){const e=this._entry.pendingEvent.getAttachment("info.thumbnail_url");return e&&e.localPreview.url}if(this._isMainResourceImage()){if(this._decryptedFile)return this._decryptedFile.url;{const e=this._getContent()?.url;if(typeof e=="string")return this._mediaRepository.mxcUrlThumbnail(e,this.width,this.height,"scale")}}return""}notifyVisible(){super.notifyVisible(),this._isVisible=!0,this.emitChange("thumbnailUrl"),this.isPending||this._tryLoadEncryptedThumbnail()}get width(){const e=this._getContent()?.info;return Math.round(e?.w*this._scaleFactor())}get height(){const e=this._getContent()?.info;return Math.round(e?.h*this._scaleFactor())}get mimeType(){return this._getContent()?.info?.mimetype}get label(){return this._getContent().body}get error(){return this._error?`Could not load media: ${this._error.message}`:null}setViewError(e){this._error=e,this.emitChange("error")}async _loadEncryptedFile(e){const t=await this._mediaRepository.downloadEncryptedFile(e,!0);if(this.isDisposed){t.dispose();return}return this.track(t)}async _tryLoadEncryptedThumbnail(){try{const e=this._getContent().info?.thumbnail_file,t=this._getContent().file;e?(this._decryptedThumbnail=await this._loadEncryptedFile(e),this.emitChange("thumbnailUrl")):t&&this._isMainResourceImage()&&(this._decryptedFile=await this._loadEncryptedFile(t),this.emitChange("thumbnailUrl"))}catch(e){this._error=e,this.emitChange("error")}}_scaleFactor(){const e=this._getContent()?.info,t=Ff/e?.h,s=Bf/e?.w;return Math.min(s,t,1)}_isMainResourceImage(){return!0}}class Kf extends Mc{constructor(e,t){super(e,t),this._lightboxUrl=this.urlRouter.urlForSegments([this.navigation.segment("room",this._room.id),this.navigation.segment("lightbox",this._entry.id)])}get lightboxUrl(){return this.isPending?"":this._lightboxUrl}get shape(){return"image"}}class $f extends Mc{async loadVideo(){const e=this._getContent().file;e&&!this._decryptedFile&&(this._decryptedFile=await this._loadEncryptedFile(e),this.emitChange("videoUrl"))}get videoUrl(){if(this._decryptedFile)return this._decryptedFile.url;const e=this._getContent()?.url;return typeof e=="string"?this._mediaRepository.mxcUrl(e):""}get shape(){return"video"}_isMainResourceImage(){return!1}}function jf(n,e=2){if(Number.isSafeInteger(n)){const t=Math.min(3,Math.floor(Math.log(n)/Math.log(1024))),s=Math.round(n/Math.pow(1024,t)).toFixed(e);switch(t){case 0:return`${s} bytes`;case 1:return`${s} KB`;case 2:return`${s} MB`;case 3:return`${s} GB`}}return""}class qf extends pt{constructor(e,t){super(e,t),this._downloadError=null,this._downloading=!1}async download(){if(this._downloading||this.isPending)return;const e=this._getContent(),t=e.body;this._downloading=!0,this.emitChange("label");let s;try{s=await this._mediaRepository.downloadAttachment(e),this.platform.saveFileAs(s,t)}catch(i){this._downloadError=i}finally{s?.dispose(),this._downloading=!1}this.emitChange("label")}get label(){if(this._downloadError)return`Could not download file: ${this._downloadError.message}`;const t=this._getContent().body;if(this._entry.isPending){const{pendingEvent:s}=this._entry;switch(s?.status){case F.Waiting:return this.i18n`Waiting to send ${t}…`;case F.EncryptingAttachments:case F.Encrypting:return this.i18n`Encrypting ${t}…`;case F.UploadingAttachments:{const i=Math.round(s.attachmentsSentBytes/s.attachmentsTotalBytes*100);return this.i18n`Uploading ${t}: ${i}%`}case F.Sending:case F.Sent:return this.i18n`Sending ${t}…`;case F.Error:return this.i18n`Error: could not send ${t}: ${s.error.message}`;default:return`Unknown send status for ${t}`}}else{const s=jf(this._getContent().info?.size);return this._downloading?this.i18n`Downloading ${t} (${s})…`:this.i18n`Download ${t} (${s})`}}get shape(){return"file"}}class Wf extends pt{get shape(){return"location"}get mapsLink(){try{const e=new URL(this._getContent().geo_uri);if(e.protocol!=="geo:")return"";const[t,...s]=e.pathname.split(";"),[i,r]=t.split(","),o=parseFloat(i),a=parseFloat(r);let c;for(const l of s){const[h,d]=l.split("=");h==="u"&&(c=parseFloat(d))}if(this.platform.isIOS)return`http://maps.apple.com/?ll=${o},${a}`;{let l=`geo:${o},${a}`;return c&&(l=l+`;u=${c}`),l}}catch{return""}}get label(){return this.i18n`${this.displayName} sent their location`}}class Hf extends rs{get shape(){return"announcement"}get announcement(){const e=this._entry.content;return`${this._entry.displayName||this._entry.sender} named the room "${e?.name}"`}}class zf extends rs{get shape(){return"announcement"}get announcement(){const{sender:e,content:t,prevContent:s,stateKey:i}=this._entry,r=this._entry.displayName||e,o=e===i?r:this._entry.content?.displayname||i,a=t&&t.membership,c=s&&s.membership;if(c==="join"&&a==="join"){if(t.avatar_url!==s.avatar_url)return`${r} changed their avatar`;if(t.displayname!==s.displayname)return t.displayname?`${s.displayname??i} changed their name to ${t.displayname}`:`${i} removed their name (${s.displayname})`}else{if(a==="join")return`${o} joined the room`;if(a==="invite")return`${o} was invited to the room by ${r}`;if(c==="invite"){if(a==="join")return`${o} accepted the invitation to join the room`;if(a==="leave")return`${o} declined the invitation to join the room`}else if(a==="leave"){if(i===e)return`${o} left the room`;{const l=t.reason;return`${o} was kicked from the room by ${r}${l?`: ${l}`:""}`}}else if(a==="ban")return`${o} was banned from the room by ${r}`}return`${e} membership changed to ${t.membership}`}}class Gf extends Ec{updateEntry(e,t){const s=super.updateEntry(e,t);return e.eventType!=="m.room.encrypted"?Me.Replace("shape"):s}get shape(){return"message-status"}_getBody(){const e=this._entry.decryptionError,t=e?.code;let s;return t==="MEGOLM_NO_SESSION"?s=this.i18n`The sender hasn't sent us the key for this message yet.`:s=e?.message||this.i18n`Could not decrypt message because of unknown reason.`,s}}class Jf extends rs{get shape(){return"announcement"}get announcement(){const e=this._entry.displayName||this._entry.sender;return this.i18n`${e} has enabled end-to-end encryption`}}class Qf extends pt{get shape(){return"missing-attachment"}get label(){const e=this._getContent().body;return this._getContent().msgtype==="m.image"?this.i18n`The image ${e} wasn't fully sent previously and could not be recovered.`:this.i18n`The file ${e} wasn't fully sent previously and could not be recovered.`}}class Yf extends rs{constructor(e,t){super(e,t);const s=this.getOption("session").callHandler.calls;this._callSubscription=void 0,this._memberSizeSubscription=void 0;const i=s.get(this._entry.stateKey);i&&!i.isTerminated&&(this._call=i,this.memberViewModels=this._setupMembersList(this._call),this._callSubscription=this.track(this._call.disposableOn("change",()=>{this._onCallUpdate()})),this._memberSizeSubscription=this.track(this._call.members.observeSize().subscribe(()=>{this.emitChange("memberCount")})),this._onCallUpdate())}_onCallUpdate(){this._call.isTerminated?(this._durationInterval=this.disposeTracked(this._durationInterval),this._callSubscription=this.disposeTracked(this._callSubscription),this._call=void 0):this._durationInterval||(this._durationInterval=this.track(this.platform.clock.createInterval(()=>{this.emitChange("duration")},1e3))),this.emitChange()}_setupMembersList(e){return e.members.mapValues((t,s)=>new Xf(this.childOptions({member:t,emitChange:s,mediaRepository:this.getOption("room").mediaRepository}))).sortValues((t,s)=>t.userId.localeCompare(s.userId))}get memberCount(){return this._call?this._call.members.size:0}get confId(){return this._entry.stateKey}get duration(){return this._call&&this._call.duration?this.timeFormatter.formatDuration(this._call.duration):""}get shape(){return"call"}get canJoin(){return this._call&&!this._call.hasJoined&&!this._call.usesFoci}get canLeave(){return this._call&&this._call.hasJoined}get title(){return this._call?this.type===ni.Video?`${this.displayName} started a video call`:`${this.displayName} started a voice call`:this.type===ni.Video?"Video call ended":"Voice call ended"}get typeLabel(){return this._call&&this._call.usesFoci?"This call uses a stream-forwarding unit, which isn't supported yet, so you can't join this call.":this.type===ni.Video?"Video call":"Voice call"}get type(){return this._entry.event.content["m.type"]}async join(){await this.logAndCatch("CallTile.join",async e=>{if(this.canJoin){const t=await this.platform.mediaDevices.getMediaTracks(!1,!0),s=new We().withUserMedia(t);await this._call.join(s,e)}})}async leave(){await this.logAndCatch("CallTile.leave",async e=>{this.canLeave&&await this._call.leave(e)})}}class Xf extends k{get _member(){return this.getOption("member")}get userId(){return this._member.userId}get avatarLetter(){return le(this._member.member.name)}get avatarColorNumber(){return he(this._member.userId)}avatarUrl(e){const{avatarUrl:t}=this._member.member,s=this.getOption("mediaRepository");return fe(t,e,this.platform,s)}get avatarTitle(){return this._member.member.name}}function Zf(n,e){if(n.isGap)return gf;if(n.isPending&&n.pendingEvent.isMissingAttachments)return Qf;if(n.eventType)switch(n.eventType){case"m.room.message":{if(n.isRedacted)return Lo;const t=n.content;switch(t&&t.msgtype){case"m.text":case"m.notice":case"m.emote":return Uf;case"m.image":return Kf;case"m.video":return $f;case"m.file":return qf;case"m.location":return Wf;default:return}}case"m.room.name":return Hf;case"m.room.member":return zf;case"m.room.encrypted":return n.isRedacted?Lo:Gf;case"m.room.encryption":return Jf;case"org.matrix.msc3401.call":return e.features.calls&&n.stateKey&&!n.prevContent?Yf:void 0;default:return}}async function Cc(n,e){try{const t=await e.joinRoom(n);return await(await e.observeRoomStatus(t)).waitFor(i=>i===j.Joined),t}catch(t){throw(t.statusCode??t.status)===400?new Error(`'${n}' is not a legal room ID or alias`):(t.statusCode??t.status)===404||(t.statusCode??t.status)===502||t.message=="Internal Server eor"?new Error(`Room '${n}' could not be found`):(t.statusCode??t.status)===403?new Error(`You are not invited to join '${n}'`):t}}class vi extends is{constructor(e){super(e);const{room:t,tileClassForEntry:s}=e;this._room=t,this._timelineVM=null,this._tileClassForEntry=s??Zf,this._tileOptions=void 0,this._onRoomChange=this._onRoomChange.bind(this),this._composerVM=null,t.isArchived?this._composerVM=this.track(new ty(this.childOptions({archivedRoom:t}))):t.isWorldReadable||this._recreateComposerOnPowerLevelChange(),this._clearUnreadTimout=null,this._closeUrl=this.urlRouter.urlUntilSegment("session"),this._setupCallViewModel()}_setupCallViewModel(){if(!this.features.calls)return;const e=this.getOption("session").callHandler.calls;this._callObservable=new Yc(e.filterValues(s=>s.roomId===this._room.id&&s.hasJoined)),this._callViewModel=void 0,this.track(this._callObservable.subscribe(s=>{s&&this._callViewModel&&s.id===this._callViewModel.id||(this._callViewModel=this.disposeTracked(this._callViewModel),s&&(this._callViewModel=this.track(new xo(this.childOptions({call:s,room:this._room})))),this.emitChange("callViewModel"))}));const t=this._callObservable.get();t&&(this._callViewModel=this.track(new xo(this.childOptions({call:t,room:this._room}))))}async load(){this.logAndCatch("RoomViewModel.load",async e=>{this._room.on("change",this._onRoomChange);const t=await this._room.openTimeline(e);this._tileOptions=this.childOptions({session:this.getOption("session"),roomVM:this,timeline:t,tileClassForEntry:this._tileClassForEntry}),this._timelineVM=this.track(new hf(this.childOptions({tileOptions:this._tileOptions,timeline:t}))),this.emitChange("timelineViewModel"),await this._clearUnreadAfterDelay(e)})}async _recreateComposerOnPowerLevelChange(){const e=await this._room.observePowerLevels(),t=()=>e.get().canSendType("m.room.message");let s=t();const i=r=>{this._composerVM=this.disposeTracked(this._composerVM),r?this._composerVM=this.track(new df(this)):this._composerVM=this.track(new sy(this.childOptions())),this.emitChange("powerLevelObservable")};this.track(e.subscribe(()=>{const r=t();s!==r&&(i(r),s=r)})),i(s)}async _clearUnreadAfterDelay(e){if(!(this._room.isArchived||this._clearUnreadTimout)){this._clearUnreadTimout=this.clock.createTimeout(2e3);try{await this._clearUnreadTimout.elapsed(),await this._room.clearUnread(e),this._clearUnreadTimout=null}catch(t){if(t.name==="AbortError")e.set("clearUnreadCancelled",!0);else throw t}}}focus(){this.logAndCatch("RoomViewModel.focus",async e=>{this._clearUnreadAfterDelay(e)})}dispose(){super.dispose(),this._room.off("change",this._onRoomChange),this._room.isArchived&&this._room.release(),this._clearUnreadTimout&&(this._clearUnreadTimout.abort(),this._clearUnreadTimout=null)}_onRoomChange(){this._composerVM?.emitChange(),this.emitChange()}get kind(){return"room"}get closeUrl(){return this._closeUrl}get name(){return this._room.name||this.i18n`Empty Room`}get id(){return this._room.id}get timelineViewModel(){return this._timelineVM}get isEncrypted(){return this._room.isEncrypted}get avatarLetter(){return le(this.name)}get avatarColorNumber(){return he(this._room.avatarColorId)}avatarUrl(e){return fe(this._room.avatarUrl,e,this.platform,this._room.mediaRepository)}get avatarTitle(){return this.name}get canLeave(){return this._room.isJoined}leaveRoom(){this._room.leave()}get canForget(){return this._room.isArchived}forgetRoom(){this._room.forget()}get canRejoin(){return this._room.isArchived}rejoinRoom(){this._room.join()}_createTile(e){if(this._tileOptions){const t=this._tileOptions.tileClassForEntry(e,this._tileOptions);if(t)return new t(e,this._tileOptions)}}_sendMessage(e,t){return this.logAndCatch("RoomViewModel.sendMessage",async s=>{let i=!1;if(!this._room.isArchived&&e){let r="m.text";if(e.startsWith("//"))e=e.substring(1).trim();else if(e.startsWith("/")){const a=await this._processCommand(e);r=a.msgtype,e=a.message}let o;t?(s.set("replyingTo",t.eventId),o=await t.createReplyContent(r,e)):o={msgtype:r,body:e},await this._room.sendEvent("m.room.message",o,void 0,s),i=!0}return s.set("success",i),i},!1)}async _processCommandJoin(e){try{const t=this._options.client.session,s=await Cc(e,t);this.navigation.push("room",s)}catch(t){this.reportError(t)}}async _processCommand(e){let t;const[s,...i]=e.substring(1).split(" ");switch(s){case"me":e=i.join(" "),t="m.emote";break;case"join":if(i.length===1){const r=i[0];await this._processCommandJoin(r)}else this.reportError(new Error("join syntax: /join <room-id>"));break;case"shrug":e="\xAF\\_(\u30C4)_/\xAF "+i.join(" "),t="m.text";break;case"tableflip":e="(\u256F\xB0\u25A1\xB0\uFF09\u256F\uFE35 \u253B\u2501\u253B "+i.join(" "),t="m.text";break;case"unflip":e="\u252C\u2500\u2500\u252C \u30CE( \u309C-\u309C\u30CE) "+i.join(" "),t="m.text";break;case"lenny":e="( \u0361\xB0 \u035C\u0296 \u0361\xB0) "+i.join(" "),t="m.text";break;default:this.reportError(new Error(`no command name "${s}". To send the message instead of executing, please type "/${e}"`)),e=void 0}return{msgtype:t,message:e}}_pickAndSendFile(){return this.logAndCatch("RoomViewModel.sendFile",async e=>{const t=await this.platform.openFile();if(!t){e.set("cancelled",!0);return}return this._sendFile(t,e)})}async _sendFile(e,t){const s={body:e.name,msgtype:"m.file"};await this._room.sendEvent("m.room.message",s,{url:this._room.createAttachment(e.blob,e.name)},t)}_pickAndSendVideo(){return this.logAndCatch("RoomViewModel.sendVideo",async e=>{if(!this.platform.hasReadPixelPermission())throw new Error("Please allow canvas image data access, so we can scale your images down.");const t=await this.platform.openFile("video/*");if(!t)return;if(!t.blob.mimeType.startsWith("video/"))return this._sendFile(t,e);let s;try{s=await this.platform.loadVideo(t.blob)}catch(l){throw l instanceof window.MediaError&&l.code===4?new Error(`this browser does not support videos of type ${t?.blob.mimeType}.`):l}const i={body:t.name,msgtype:"m.video",info:ey(s)},r={url:this._room.createAttachment(s.blob,t.name)},a=await this.platform.settingsStorage.getInt("sentImageSizeLimit")||Math.min(s.maxDimension,800),c=await s.scale(a);i.info.thumbnail_info=bs(c),r["info.thumbnail_url"]=this._room.createAttachment(c.blob,t.name),await this._room.sendEvent("m.room.message",i,r,e)})}async _pickAndSendPicture(){this.logAndCatch("RoomViewModel.sendPicture",async e=>{if(!this.platform.hasReadPixelPermission()){alert("Please allow canvas image data access, so we can scale your images down.");return}const t=await this.platform.openFile("image/*");if(!t){e.set("cancelled",!0);return}if(!t.blob.mimeType.startsWith("image/"))return this._sendFile(t,e);let s=await this.platform.loadImage(t.blob);const i=await this.platform.settingsStorage.getInt("sentImageSizeLimit");if(i&&s.maxDimension>i){const a=await s.scale(i);s.dispose(),s=a}const r={body:t.name,msgtype:"m.image",info:bs(s)},o={url:this._room.createAttachment(s.blob,t.name)};if(s.maxDimension>600){const a=await s.scale(400);r.info.thumbnail_info=bs(a),o["info.thumbnail_url"]=this._room.createAttachment(a.blob,t.name)}await this._room.sendEvent("m.room.message",r,o,e)})}get room(){return this._room}get composerViewModel(){return this._composerVM}get callViewModel(){return this._callViewModel}openDetailsPanel(){let e=this.navigation.path.until("room");e=e.with(this.navigation.segment("right-panel",!0)),e=e.with(this.navigation.segment("details",!0)),this.navigation.applyPath(e)}startReply(e){this._room.isArchived||this._composerVM.setReplyingTo(e)}startCall(){return this.logAndCatch("RoomViewModel.startCall",async e=>{if(!this.features.calls){e.set("feature_disbled",!0);return}e.set("roomId",this._room.id);let t;try{const r=await this.platform.mediaDevices.getMediaTracks(!1,!0);t=new We().withUserMedia(r)}catch(r){throw new Error(`Could not get local audio and/or video stream: ${r.message}`)}const s=this.getOption("session");let i;try{i=await s.callHandler.createCall(this._room.id,"m.video","A call "+Math.round(this.platform.random()*100),void 0,e)}catch(r){throw new Error(`Could not create call: ${r.message}`)}try{await i.join(t,e)}catch(r){throw new Error(`Could not join call: ${r.message}`)}})}}function ey(n){const e=bs(n);return e.duration=n.duration,e}class ty extends k{constructor(e){super(e),this._archivedRoom=e.archivedRoom}get description(){return this._archivedRoom.isKicked?this._archivedRoom.kickReason?this.i18n`You were kicked from the room by ${this._archivedRoom.kickedBy.name} because: ${this._archivedRoom.kickReason}`:this.i18n`You were kicked from the room by ${this._archivedRoom.kickedBy.name}.`:this._archivedRoom.isBanned?this._archivedRoom.kickReason?this.i18n`You were banned from the room by ${this._archivedRoom.kickedBy.name} because: ${this._archivedRoom.kickReason}`:this.i18n`You were banned from the room by ${this._archivedRoom.kickedBy.name}.`:this.i18n`You left this room`}get kind(){return"disabled"}}class sy extends k{get description(){return this.i18n`You do not have the powerlevel necessary to send messages`}get kind(){return"disabled"}}class Tc extends k{constructor(e){super(e);const{roomIdOrAlias:t,session:s,isWorldReadablePromise:i,guestJoinAllowed:r}=e;this._session=s,this.roomIdOrAlias=t,this._error=null,this._busy=!1,this._guestJoinAllowed=typeof r<"u"&&r,this.checkingPreviewCapability=!0,i.then(()=>{this.checkingPreviewCapability=!1,this.emitChange("checkingPreviewCapability")}),this._joinAllowed=!1,this._session.isGuest().then(o=>{this._joinAllowed=o?this._guestJoinAllowed:!0,this.emitChange("joinAllowed")}),this._closeUrl=this.urlRouter.urlUntilSegment("session")}get closeUrl(){return this._closeUrl}get error(){return this._error?.message}get joinAllowed(){return this._joinAllowed}async join(){this._busy=!0,this.emitChange("busy");try{const e=await this._session.joinRoom(this.roomIdOrAlias);this.navigation.push("room",e)}catch(e){this._error=e,this._busy=!1,this.emitChange("error")}}get busy(){return this._busy}get kind(){return"unknown"}}class iy extends vi{constructor(e){e.room.isWorldReadable=!0,super(e);const{room:t,session:s,guestJoinAllowed:i}=e;this._room=t,this._session=s,this._error=null,this._busy=!1,this._guestJoinAllowed=typeof i<"u"&&i,this._joinAllowed=!1,this._session.isGuest().then(r=>{this._joinAllowed=r?this._guestJoinAllowed:!0,this.emitChange("joinAllowed")})}get kind(){return"preview"}get busy(){return this._busy}get joinAllowed(){return this._joinAllowed}async join(){this._busy=!0,this.emitChange("busy");try{const e=await this._session.joinRoom(this._room.id);this.navigation.push("room",e)}catch(e){this._error=e,this._busy=!1,this.emitChange("error")}}login(){this.navigation.push("login")}dispose(){super.dispose(),this._busy||this._session.deleteWorldReadableRoomData(this._room.id)}}class ry extends k{constructor(e){super(e);const{invite:t,mediaRepository:s}=e;this._invite=t,this._mediaRepository=s,this._onInviteChange=this._onInviteChange.bind(this),this._error=null,this._closeUrl=this.urlRouter.urlUntilSegment("session"),this._invite.on("change",this._onInviteChange),this._inviter=null,this._invite.inviter&&(this._inviter=new ny(this._invite.inviter,s,this.platform)),this._roomDescription=this._createRoomDescription()}get kind(){return"invite"}get closeUrl(){return this._closeUrl}get name(){return this._invite.name}get id(){return this._invite.id}get isEncrypted(){return this._invite.isEncrypted}get isDirectMessage(){return this._invite.isDirectMessage}get inviter(){return this._inviter}get busy(){return this._invite.accepting||this._invite.rejecting}get error(){return this._error?`Something went wrong: ${this._error.message}`:""}get avatarLetter(){return le(this.name)}get avatarColorNumber(){return he(this._invite.avatarColorId)}avatarUrl(e){return fe(this._invite.avatarUrl,e,this.platform,this._mediaRepository)}_createRoomDescription(){const e=[];return this._invite.isPublic?e.push("Public room"):e.push("Private room"),this._invite.canonicalAlias&&e.push(this._invite.canonicalAlias),e.join(" \u2022 ")}get roomDescription(){return this._roomDescription}get avatarTitle(){return this.name}focus(){}async accept(){try{await this._invite.accept()}catch(e){this._error=e,this.emitChange("error")}}async reject(){try{await this._invite.reject()}catch(e){this._error=e,this.emitChange("error")}}_onInviteChange(){this.emitChange()}dispose(){super.dispose(),this._invite.off("change",this._onInviteChange)}}class ny{constructor(e,t,s){this._member=e,this._mediaRepository=t,this._platform=s}get id(){return this._member.userId}get name(){return this._member.name}get avatarLetter(){return le(this.name)}get avatarColorNumber(){return he(this._member.userId)}avatarUrl(e){return fe(this._member.avatarUrl,e,this._platform,this._mediaRepository)}get avatarTitle(){return this.name}}class oy extends k{constructor(e){super(e);const{roomBeingCreated:t,mediaRepository:s}=e;this._roomBeingCreated=t,this._mediaRepository=s,this._onRoomChange=this._onRoomChange.bind(this),this._closeUrl=this.urlRouter.urlUntilSegment("session"),this._roomBeingCreated.on("change",this._onRoomChange)}get kind(){return"roomBeingCreated"}get closeUrl(){return this._closeUrl}get name(){return this._roomBeingCreated.name}get id(){return this._roomBeingCreated.id}get isEncrypted(){return this._roomBeingCreated.isEncrypted}get error(){const{error:e}=this._roomBeingCreated;return e?e.name==="ConnectionError"?this.i18n`You seem to be offline`:e.message:""}get avatarLetter(){return le(this.name)}get avatarColorNumber(){return he(this._roomBeingCreated.avatarColorId)}get avatarTitle(){return this.name}avatarUrl(e){return this._roomBeingCreated.avatarBlobUrl??fe(this._roomBeingCreated.avatarUrl,e,this.platform,this._mediaRepository)}focus(){}_onRoomChange(){this.emitChange()}cancel(){this._roomBeingCreated.cancel(),this.navigation.applyPath(this.navigation.path.until("session"))}dispose(){super.dispose(),this._roomBeingCreated.off("change",this._onRoomChange)}}class ay extends k{constructor(e){super(e),this._eventId=e.eventId,this._unencryptedImageUrl=null,this._decryptedImage=null,this._closeUrl=this.urlRouter.urlUntilSegment("room"),this._date=null,this._subscribeToEvent(e.room,e.eventId)}_subscribeToEvent(e,t){const s=e.observeEvent(t);this.track(s.subscribe(i=>{this._loadEvent(e,i)})),this._loadEvent(e,s.get())}async _loadEvent(e,t){if(!t)return;const{mediaRepository:s}=e;this._eventEntry=t;const{content:i}=this._eventEntry;this._date=this._eventEntry.timestamp?new Date(this._eventEntry.timestamp):null,i.url?(this._unencryptedImageUrl=s.mxcUrl(i.url),this.emitChange("imageUrl")):i.file&&(this._decryptedImage=this.track(await s.downloadEncryptedFile(i.file)),this.emitChange("imageUrl"))}get imageWidth(){return this._eventEntry?.content?.info?.w}get imageHeight(){return this._eventEntry?.content?.info?.h}get name(){return this._eventEntry?.content?.body}get sender(){return this._eventEntry?.displayName}get imageUrl(){return this._decryptedImage?this._decryptedImage.url:this._unencryptedImageUrl?this._unencryptedImageUrl:""}get date(){return this._date&&this._date.toLocaleDateString({},{weekday:"long",year:"numeric",month:"long",day:"numeric"})}get time(){return this._date&&this._date.toLocaleTimeString({},{hour:"numeric",minute:"2-digit"})}get closeUrl(){return this._closeUrl}close(){this.platform.history.pushUrl(this.closeUrl)}}const ne=tt("Disconnected","Connecting","FirstSync","Sending","Syncing","SyncError");class cy extends k{constructor(e){super(e);const{sync:t,reconnector:s,session:i}=e;this._sync=t,this._reconnector=s,this._status=this._calculateState(s.connectionStatus.get(),t.status.get()),this._session=i,this._setupKeyBackupUrl=this.urlRouter.urlForSegment("settings"),this._dismissSecretStorage=!1}start(){const e=()=>this._updateStatus();this.track(this._sync.status.subscribe(e)),this.track(this._reconnector.connectionStatus.subscribe(e)),this.track(this._session.needsKeyBackup.subscribe(()=>{this.emitChange()}))}get setupKeyBackupUrl(){return this._setupKeyBackupUrl}get isShown(){return this._session.needsKeyBackup.get()&&!this._dismissSecretStorage||this._status!==ne.Syncing}get statusLabel(){switch(this._status){case ne.Disconnected:{const e=Math.round(this._reconnector.retryIn/1e3);return this.i18n`Disconnected, trying to reconnect in ${e}s…`}case ne.Connecting:return this.i18n`Trying to reconnect now…`;case ne.FirstSync:return this.i18n`Catching up with your conversations…`;case ne.SyncError:return this.i18n`Sync failed because of ${this._sync.error}`}return this._session.needsKeyBackup.get()?this.i18n`Set up session backup to decrypt older messages.`:""}get isWaiting(){switch(this._status){case ne.Connecting:case ne.FirstSync:return!0;default:return!1}}_updateStatus(){const e=this._calculateState(this._reconnector.connectionStatus.get(),this._sync.status.get());e!==this._status&&(e===ne.Disconnected?this._retryTimer=this.track(this.clock.createInterval(()=>{this.emitChange("statusLabel")},1e3)):this._retryTimer=this.disposeTracked(this._retryTimer),this._status=e,this.emitChange())}_calculateState(e,t){if(e!==zt.Online)switch(e){case zt.Reconnecting:return ne.Connecting;case zt.Waiting:return ne.Disconnected}else if(t!==L.Syncing)switch(t){case L.InitialSync:case L.CatchupSync:return ne.FirstSync;case L.Stopped:return ne.SyncError}else return ne.Syncing}get isConnectNowShown(){return this._status===ne.Disconnected}get isSecretStorageShown(){return this._status===ne.Syncing&&this._session.needsKeyBackup.get()&&!this._dismissSecretStorage}get canDismiss(){return this.isSecretStorageShown}dismiss(){this.isSecretStorageShown&&(this._dismissSecretStorage=!0,this.emitChange())}connectNow(){this.isConnectNowShown&&this._reconnector.tryNow()}}function Oo(n){return n.map((e,t)=>{if(!n.slice(0,t).includes(e))return e})}class ly extends k{constructor(e){super(e),this._width=e.width,this._height=e.height,this._createRoomViewModelObservable=e.createRoomViewModelObservable,this._selectedIndex=0,this._viewModelsObservables=[],this._setupNavigation()}_setupNavigation(){const e=this.navigation.observe("empty-grid-tile");this.track(e.subscribe(s=>{typeof s=="number"&&this._setFocusIndex(s)})),typeof e.get()=="number"&&(this._selectedIndex=e.get());const t=this.navigation.observe("room");this.track(t.subscribe(s=>{s&&this._setFocusRoom(s)}))}roomViewModelAt(e){return this._viewModelsObservables[e]?.get()}get focusIndex(){return this._selectedIndex}get width(){return this._width}get height(){return this._height}_switchToRoom(e){let t=this.navigation.path.until("rooms");t=t.with(this.navigation.segment("room",e)),t=ar(this.navigation,t),this.navigation.applyPath(t)}focusTile(e){if(e===this._selectedIndex)return;const t=this._viewModelsObservables[e];t?this._switchToRoom(t.id):this.navigation.push("empty-grid-tile",e)}initializeRoomIdsAndTransferVM(e,t){e=Oo(e);let s=!1;if(t){const r=e.indexOf(t.id);r!==-1&&(this._viewModelsObservables[r]=this.track(t),t.subscribe(o=>this._refreshRoomViewModel(o)),s=!0)}this.setRoomIds(e);const i=this.navigation.path.get("room");if(i){const r=this._viewModelsObservables.findIndex(o=>o&&o.id===i.value);r!==-1&&(this._selectedIndex=r)}return s}setRoomIds(e){e=Oo(e);let t=!1;const s=this._height*this._width;for(let i=0;i<s;i+=1){const r=e[i],o=this._viewModelsObservables[i];if(!o&&r||o&&o.id!==r){if(o&&(this._viewModelsObservables[i]=this.disposeTracked(o)),r){const a=this._createRoomViewModelObservable(r);this._viewModelsObservables[i]=this.track(a),a.subscribe(c=>this._refreshRoomViewModel(c)),a.initialize()}t=!0}}return t&&this.emitChange(),t}_refreshRoomViewModel(e){this.emitChange(),e?.focus()}releaseRoomViewModel(e){const t=this._viewModelsObservables.findIndex(s=>s&&s.id===e);if(t!==-1){const s=this._viewModelsObservables[t];return this.untrack(s),s.unsubscribeAll(),this._viewModelsObservables[t]=null,s}}_setFocusIndex(e){if(e===this._selectedIndex||e>=this._width*this._height)return;this._selectedIndex=e,this._viewModelsObservables[this._selectedIndex]?.get()?.focus(),this.emitChange("focusIndex")}_setFocusRoom(e){const t=this._viewModelsObservables.findIndex(s=>s?.id===e);t>=0&&this._setFocusIndex(t)}}class hy extends k{constructor(e){super(e),this.featureViewModels=[new nr(this.childOptions({name:this.i18n`Audio/video calls`,description:this.i18n`Allows starting and participating in A/V calls compatible with Element Call (MSC3401). Look for the start call option in the room menu ((...) in the right corner) to start a call.`,feature:si.Calls})),new nr(this.childOptions({name:this.i18n`Cross-Signing`,description:this.i18n`Allows verifying the identity of people you chat with. This feature is still evolving constantly, expect things to break.`,feature:si.CrossSigning})),new nr(this.childOptions({name:this.i18n`Open the same session in multiple tabs`,description:this.i18n`Allows having the same session open in multiple browser tabs or windows. This feature is currently not functional and is intended only for usage by Hydrogen developers. Do not enable.`,feature:si.SameSessionInMultipleTabs}))]}}class nr extends k{get enabled(){return this.features.isFeatureEnabled(this.getOption("feature"))}async enableFeature(e){let t;e?t=this.features.withFeature(this.getOption("feature")):t=this.features.withoutFeature(this.getOption("feature")),await t.store(this.platform.settingsStorage),this.platform.restart()}get id(){return`${this.getOption("feature")}`}get name(){return this.getOption("name")}get description(){return this.getOption("description")}}class dy{constructor(){this.supported=null,this.enabled=!1,this.updating=!1,this.enabledOnServer=null,this.serverError=null}}function uy(n){const t=Math.ceil(n.length/4);let s="";for(let i=0;i<t;i+=1)s+=(s.length?" ":"")+n.slice(i*4,(i+1)*4);return s}class Ac extends k{constructor(e){super(e),this._updateService=e.updateService;const{client:t}=e;this._client=t,this._keyBackupViewModel=this.track(new Jg(this.childOptions({session:this._session}))),this._closeUrl=this.urlRouter.urlUntilSegment("session"),this._estimate=null,this.sentImageSizeLimit=null,this.minSentImageSizeLimit=400,this.maxSentImageSizeLimit=4e3,this.pushNotifications=new dy,this._activeTheme=void 0,this._logsFeedbackMessage=void 0,this._featuresViewModel=new hy(this.childOptions())}get _session(){return this._client.session}async logout(){this.navigation.push("logout",this._client.sessionId)}setSentImageSizeLimit(e){e>this.maxSentImageSizeLimit||e<this.minSentImageSizeLimit?(this.sentImageSizeLimit=null,this.platform.settingsStorage.remove("sentImageSizeLimit")):(this.sentImageSizeLimit=Math.round(e),this.platform.settingsStorage.setInt("sentImageSizeLimit",e)),this.emitChange("sentImageSizeLimit")}async load(){this._estimate=await this.platform.estimateStorageUsage(),this.sentImageSizeLimit=await this.platform.settingsStorage.getInt("sentImageSizeLimit"),this.pushNotifications.supported=await this.platform.notificationService.supportsPush(),this.pushNotifications.enabled=await this._session.arePushNotificationsEnabled(),this._activeTheme=await this.platform.themeLoader.getActiveTheme(),this.emitChange("")}get closeUrl(){return this._closeUrl}get fingerprintKey(){const e=this._session.fingerprintKey;return e?uy(e):null}get deviceId(){return this._session.deviceId}get userId(){return this._session.userId}get version(){const{updateService:e}=this.platform;return e?`${e.version} (${e.buildHash})`:this.i18n`development version`}checkForUpdate(){this.platform.updateService?.checkForUpdate()}get showUpdateButton(){return!!this.platform.updateService}get keyBackupViewModel(){return this._keyBackupViewModel}get featuresViewModel(){return this._featuresViewModel}get storageQuota(){return this._formatBytes(this._estimate?.quota)}get storageUsage(){return this._formatBytes(this._estimate?.usage)}get themeMapping(){return this.platform.themeLoader.themeMapping}get activeTheme(){return this._activeTheme}_formatBytes(e){return typeof e=="number"?Math.round(e/(1024*1024)).toFixed(1)+" MB":this.i18n`unknown`}async exportLogs(){const e=await this.exportLogsBlob();this.platform.saveFileAs(e,`hydrogen-logs-${this.platform.clock.now()}.json`)}async exportLogsBlob(){return(await this.logger.reporters.find(s=>typeof s.export=="function").export()).asBlob()}get canSendLogsToServer(){return!!this.platform.config.bugReportEndpointUrl}get logsServer(){const{bugReportEndpointUrl:e}=this.platform.config;try{if(e)return new URL(e).hostname}catch{}return""}async sendLogsToServer(){this._logsFeedbackMessage=this.i18n`Sending logs…`;try{await Sc(this._session,this.platform),this._logsFeedbackMessage=this.i18n`Logs sent succesfully!`}catch(e){this._logsFeedbackMessage=e.message,this.emitChange()}}get logsFeedbackMessage(){return this._logsFeedbackMessage}async togglePushNotifications(){this.pushNotifications.updating=!0,this.pushNotifications.enabledOnServer=null,this.pushNotifications.serverError=null,this.emitChange("pushNotifications.updating");try{await this._session.enablePushNotifications(!this.pushNotifications.enabled)&&(this.pushNotifications.enabled=!this.pushNotifications.enabled,this.pushNotifications.enabled&&this.platform.notificationService.showNotification(this.i18n`Push notifications are now enabled`))}finally{this.pushNotifications.updating=!1,this.emitChange("pushNotifications.updating")}}async checkPushEnabledOnServer(){this.pushNotifications.enabledOnServer=null,this.pushNotifications.serverError=null;try{this.pushNotifications.enabledOnServer=await this._session.checkPusherEnabledOnHomeserver(),this.emitChange("pushNotifications.enabledOnServer")}catch(e){this.pushNotifications.serverError=e,this.emitChange("pushNotifications.serverError")}}changeThemeOption(e,t){this.platform.themeLoader.setTheme(e,t),this.emitChange("themeOption")}}class my extends k{constructor(e){super(e);const{session:t}=e;this._session=t,this._name=void 0,this._topic=void 0,this._roomAlias=void 0,this._isPublic=!1,this._isEncrypted=!0,this._isAdvancedShown=!1,this._isFederationDisabled=!1,this._avatarScaledBlob=void 0,this._avatarFileName=void 0,this._avatarInfo=void 0,this._closeUrl=this.urlRouter.urlUntilSegment("session")}get isPublic(){return this._isPublic}get isEncrypted(){return this._isEncrypted}get canCreate(){return!!this._name}avatarUrl(){return this._avatarScaledBlob.url}get avatarTitle(){return this._name}get avatarLetter(){return""}get avatarColorNumber(){return 0}get hasAvatar(){return!!this._avatarScaledBlob}get isFederationDisabled(){return this._isFederationDisabled}get isAdvancedShown(){return this._isAdvancedShown}get closeUrl(){return this._closeUrl}setName(e){this._name=e,this.emitChange("canCreate")}setRoomAlias(e){this._roomAlias=e}setTopic(e){this._topic=e}setPublic(e){this._isPublic=e,this.emitChange("isPublic")}setEncrypted(e){this._isEncrypted=e,this.emitChange("isEncrypted")}setFederationDisabled(e){this._isFederationDisabled=e,this.emitChange("isFederationDisabled")}toggleAdvancedShown(){this._isAdvancedShown=!this._isAdvancedShown,this.emitChange("isAdvancedShown")}create(){let e;this._avatarScaledBlob&&(e={info:this._avatarInfo,name:this._avatarFileName,blob:this._avatarScaledBlob});const t=this._session.createRoom({type:this.isPublic?ve.Public:ve.Private,name:this._name??void 0,topic:this._topic??void 0,isEncrypted:!this.isPublic&&this._isEncrypted,isFederationDisabled:this._isFederationDisabled,alias:this.isPublic?py(this._roomAlias):void 0,avatar:e});this.navigation.push("room",t.id)}async selectAvatar(){if(!this.platform.hasReadPixelPermission()){alert("Please allow canvas image data access, so we can scale your images down.");return}this._avatarScaledBlob&&this._avatarScaledBlob.dispose(),this._avatarScaledBlob=void 0,this._avatarFileName=void 0,this._avatarInfo=void 0;const e=await this.platform.openFile("image/*");if(!e||!e.blob.mimeType.startsWith("image/")){this.emitChange("hasAvatar");return}let t=await this.platform.loadImage(e.blob);const s=800;if(t.maxDimension>s){const i=await t.scale(s);t.dispose(),t=i}this._avatarScaledBlob=t.blob,this._avatarInfo=bs(t),this._avatarFileName=e.name,this.emitChange("hasAvatar")}}function py(n){n.startsWith("#")&&(n=n.substr(1));const e=n.indexOf(":");return e!==-1&&(n=n.substr(0,e)),n}class _y extends k{constructor(e){super(e),this._joinInProgress=!1,this._session=e.session,this._closeUrl=this.urlRouter.urlUntilSegment("session")}get closeUrl(){return this._closeUrl}async join(e){this._error=void 0,this._joinInProgress=!0,this.emitChange("joinInProgress");try{const t=await Cc(e,this._session);this.navigation.push("room",t)}catch(t){this._error=t,this._joinInProgress=!1,this.emitChange("error")}}get joinInProgress(){return this._joinInProgress}get status(){if(this._error)return this._error.message;if(this._joinInProgress)return"Joining room"}}class Uo extends Te{constructor(e,t){super(null),this._statusSubscription=null,this._sessionViewModel=e,this.id=t}async initialize(){const{session:e}=this._sessionViewModel._client,t=await e.observeRoomStatus(this.id);this.set(await this._statusToViewModel(t.get())),this._statusSubscription=t.subscribe(async s=>{this.get()?.dispose(),this.set(await this._statusToViewModel(s))})}async _statusToViewModel(e){if(e&j.Replaced)if(e&j.BeingCreated){const{session:t}=this._sessionViewModel._client,s=t.roomsBeingCreated.get(this.id);this._sessionViewModel.notifyRoomReplaced(s.id,s.roomId)}else throw new Error("Don't know how to replace a room with this status: "+(e^j.Replaced));else return e&j.BeingCreated?this._sessionViewModel._createRoomBeingCreatedViewModel(this.id):e&j.Invited?this._sessionViewModel._createInviteViewModel(this.id):e&j.Joined?this._sessionViewModel._createRoomViewModelInstance(this.id):e&j.Archived?await this._sessionViewModel._createArchivedRoomViewModel(this.id):this._sessionViewModel._createUnknownRoomViewModel(this.id,this._isWorldReadablePromise())}async _isWorldReadablePromise(){const{session:e}=this._sessionViewModel._client;if(await e.isWorldReadableRoom(this.id)){const s=await this._sessionViewModel._createWorldReadableRoomViewModel(this.id);if(s)return this.get()?.dispose(),this.set(s),!0}return!1}dispose(){this._statusSubscription&&(this._statusSubscription=this._statusSubscription()),this.unsubscribeAll(),this.get()?.dispose()}}class gy extends k{constructor(e){super(e),this._room=e.room,this._onRoomChange=this._onRoomChange.bind(this),this._room.on("change",this._onRoomChange)}get type(){return"room-details"}get shouldShowBackButton(){return!1}get previousSegmentName(){return!1}get roomId(){return this._room.id}get canonicalAlias(){return this._room.canonicalAlias}get name(){return this._room.name}get isEncrypted(){return!!this._room.isEncrypted}get memberCount(){return this._room.joinedMemberCount}get avatarLetter(){return le(this.name)}get avatarColorNumber(){return he(this._room.avatarColorId)}avatarUrl(e){return fe(this._room.avatarUrl,e,this.platform,this._room.mediaRepository)}get avatarTitle(){return this.name}_onRoomChange(){this.emitChange()}dispose(){super.dispose(),this._room.off("change",this._onRoomChange)}openPanel(e){let t=this.navigation.path.until("room");t=t.with(this.navigation.segment("right-panel",!0)),t=t.with(this.navigation.segment(e,!0)),this.navigation.applyPath(t)}}class fy extends k{constructor(e){super(e),this._member=this._options.member,this._mediaRepository=e.mediaRepository,this._previousName=null,this._nameChanged=!0}get name(){return`${this._member.name}${this._disambiguationPart}`}get _disambiguationPart(){return this._disambiguate?` (${this.userId})`:""}get userId(){return this._member.userId}get previousName(){return this._previousName}get nameChanged(){return this._nameChanged}get detailsUrl(){const e=this.navigation.path.get("room").value;return`${this.urlRouter.openRoomActionUrl(e)}/member/${encodeURIComponent(this._member.userId)}`}_updatePreviousName(e){const t=this._member.name;t!==e?(this._previousName=t,this._nameChanged=!0):this._nameChanged=!1}setDisambiguation(e){this._disambiguate=e,this.emitChange()}updateFrom(e){this._updatePreviousName(e.name),this._member=e}get avatarLetter(){return le(this.name)}get avatarColorNumber(){return he(this.userId)}avatarUrl(e){return fe(this._member.avatarUrl,e,this.platform,this._mediaRepository)}get avatarTitle(){return this.name}}function yy(n){const e=new Intl.Collator,t=s=>s.charAt(0)==="@"?s.slice(1):s;return function(i,r){const o=n.getUserLevel(i.userId),a=n.getUserLevel(r.userId);if(o!==a)return a-o;const c=t(i.name),l=t(r.name);return e.compare(c,l)}}class wy{constructor(){this._map=new Map}_unDisambiguate(e,t){const s=t.indexOf(e);if(s!==-1){const[i]=t.splice(s,1);i.setDisambiguation(!1)}}_handlePreviousName(e){const t=e.previousName;if(typeof t!="string")return;const s=this._map.get(t);if(Array.isArray(s)){if(this._unDisambiguate(e,s),s.length===1){const i=s[0];i.setDisambiguation(!1),this._map.set(t,i)}}else this._map.delete(t)}_updateMap(e){const t=e.name,s=this._map.get(t);if(s){if(Array.isArray(s))return s.findIndex(i=>i.userId===e.userId)!==-1?void 0:(s.push(e),s);if(e.userId!==s.userId){const i=[s,e];return this._map.set(t,i),i}}else this._map.set(t,e)}disambiguate(e){if(!e.nameChanged)return;this._handlePreviousName(e),this._updateMap(e)?.forEach(s=>s.setDisambiguation(!0))}}class vy extends k{constructor(e){super(e);const t=e.members,s=e.powerLevelsObservable;this.track(s.subscribe(()=>{}));const i=s.get();this.memberTileViewModels=this._mapTileViewModels(t.members.filterValues(r=>r.membership==="join")).sortValues(yy(i)),this.nameDisambiguator=new wy,this.mediaRepository=e.mediaRepository}get type(){return"member-list"}get shouldShowBackButton(){return!0}get previousSegmentName(){return"details"}_mapTileViewModels(e){const t=(i,r)=>{const o=this.mediaRepository,a=new fy(this.childOptions({member:i,emitChange:r,mediaRepository:o}));return this.nameDisambiguator.disambiguate(a),a},s=(i,r,o)=>{r.updateFrom(o),this.nameDisambiguator.disambiguate(r)};return e.mapValues(t,s)}}class by extends k{constructor(e){super(e),this._observableMember=e.observableMember,this._mediaRepository=e.mediaRepository,this._member=this._observableMember.get(),this._isEncrypted=e.isEncrypted,this._powerLevelsObservable=e.powerLevelsObservable,this._session=e.session,this.track(this._powerLevelsObservable.subscribe(()=>this._onPowerLevelsChange())),this.track(this._observableMember.subscribe(()=>this._onMemberChange()))}get name(){return this._member.name}get userId(){return this._member.userId}get type(){return"member-details"}get shouldShowBackButton(){return!0}get previousSegmentName(){return"members"}get role(){return this.powerLevel>=100?this.i18n`Admin`:this.powerLevel>=50?this.i18n`Moderator`:this.powerLevel===0?this.i18n`Default`:this.i18n`Custom (${this.powerLevel})`}_onMemberChange(){this._member=this._observableMember.get(),this.emitChange("member")}_onPowerLevelsChange(){this.emitChange("role")}get avatarLetter(){return le(this.name)}get avatarColorNumber(){return he(this.userId)}avatarUrl(e){return fe(this._member.avatarUrl,e,this.platform,this._mediaRepository)}get avatarTitle(){return this.name}get isEncrypted(){return this._isEncrypted}get powerLevel(){return this._powerLevelsObservable.get()?.getUserLevel(this._member.userId)}get linkToUser(){return`https://matrix.to/#/${encodeURIComponent(this._member.userId)}`}async openDirectMessage(){let t=this._session.findDirectMessageForUserId(this.userId)?.id;t||(t=(await this._session.createRoom({type:ve.DirectMessage,invites:[this.userId]})).id),this.navigation.push("room",t)}}class Sy extends k{constructor(e){super(e),this._room=e.room,this._session=e.session,this._members=null,this._setupNavigation()}get activeViewModel(){return this._activeViewModel}async _getMemberListArguments(){this._members||(this._members=await this._room.loadMemberList(),this.track(()=>this._members.release()));const e=this._room,t=await this._room.observePowerLevels();return{members:this._members,powerLevelsObservable:t,mediaRepository:e.mediaRepository}}async _getMemberDetailsArguments(){const t=this.navigation.path.get("member").value,s=await this._room.observeMember(t);if(!s)return!1;const i=this._room.isEncrypted,r=await this._room.observePowerLevels();return{observableMember:s,isEncrypted:i,powerLevelsObservable:r,mediaRepository:this._room.mediaRepository,session:this._session}}_setupNavigation(){this._hookUpdaterToSegment("details",gy,()=>({room:this._room})),this._hookUpdaterToSegment("members",vy,()=>this._getMemberListArguments()),this._hookUpdaterToSegment("member",by,()=>this._getMemberDetailsArguments(),()=>{const e=`${this.urlRouter.urlUntilSegment("room")}/members`;this.urlRouter.pushUrl(e)})}_hookUpdaterToSegment(e,t,s,i){const r=this.navigation.observe(e),o=this._setupUpdater(e,t,s,i);this.track(r.subscribe(o))}_setupUpdater(e,t,s,i){const r=async(o=!1)=>{if(o||(this._activeViewModel=this.disposeTracked(this._activeViewModel)),!!this.navigation.path.get(e)?.value){const c=await s();if(!c&&i){i();return}this._activeViewModel=this.track(new t(this.childOptions(c)))}this.emitChange("activeViewModel")};return r(!0),r}closePanel(){const e=this.navigation.path.until("room");this.navigation.applyPath(e)}showPreviousPanel(){const e=this.activeViewModel.previousSegmentName;if(e){let t=this.navigation.path.until("room");t=t.with(this.navigation.segment("right-panel",!0)),t=t.with(this.navigation.segment(e,!0)),this.navigation.applyPath(t)}}}class Iy extends is{constructor(e){super(e)}dismiss(){this.getOption("dismiss")()}}class Ry extends Iy{constructor(e){super(e),this.track(this.call.members.observeSize().subscribe(()=>{this.emitChange("memberCount")})),this.track(this.navigation.observe("room").subscribe(t=>{t===this.call.roomId&&this.dismiss()}))}async join(){await this.logAndCatch("CallToastNotificationViewModel.join",async e=>{const t=await this.platform.mediaDevices.getMediaTracks(!1,!0),s=new We().withUserMedia(t);await this.call.join(s,e);const i=this.urlRouter.openRoomActionUrl(this.call.roomId);this.urlRouter.pushUrl(i)})}get call(){return this.getOption("call")}get room(){return this.getOption("room")}get roomName(){return this.room.name}get memberCount(){return this.call.members.size}get avatarLetter(){return le(this.roomName)}get avatarColorNumber(){return he(this.room.avatarColorId)}avatarUrl(e){return fe(this.room.avatarUrl,e,this.platform,this.room.mediaRepository)}get avatarTitle(){return this.roomName}}class ky extends k{constructor(e){super(e),this.toastViewModels=new Bo;const t=this.getOption("session");if(this.features.calls){const s=t.callHandler.calls;this.track(s.subscribe(this))}}async onAdd(e,t){if(this._shouldShowNotification(t)){const s=await this._findRoomForCall(t),i=()=>{const r=this.toastViewModels.array.findIndex(o=>o.call===t);r!==-1&&this.toastViewModels.remove(r)};this.toastViewModels.append(new Ry(this.childOptions({call:t,room:s,dismiss:i})))}}onRemove(e,t){const s=this.toastViewModels.array.findIndex(i=>i.call===t);s!==-1&&this.toastViewModels.remove(s)}onUpdate(e,t){const s=this.toastViewModels.array.findIndex(i=>i.call===t);s!==-1&&this.toastViewModels.update(s,this.toastViewModels.at(s))}onReset(){for(let e=0;e<this.toastViewModels.length;++e)this.toastViewModels.remove(e)}async _findRoomForCall(e){const t=e.roomId,s=this.getOption("session"),i=s.rooms;return await(await s.observeRoomStatus(t)).waitFor(a=>a===j.Joined).promise,i.get(t)}_shouldShowNotification(e){const t=this.navigation.path.get("room")?.value;return!e.isLoadedFromStorage&&e.roomId!==t&&!e.usesFoci}}class Ey extends k{constructor(e){super(e);const{client:t}=e;this._client=this.track(t),this._sessionStatusViewModel=this.track(new cy(this.childOptions({sync:t.sync,reconnector:t.reconnector,session:t.session}))),this._leftPanelViewModel=this.track(new cf(this.childOptions({session:this._client.session}))),this._settingsViewModel=null,this._roomViewModelObservable=null,this._gridViewModel=null,this._createRoomViewModel=null,this._joinRoomViewModel=null,this._toastCollectionViewModel=this.track(new ky(this.childOptions({session:this._client.session}))),this._setupNavigation(),this._setupForcedLogoutOnAccessTokenInvalidation()}_setupNavigation(){const e=this.navigation.observe("rooms");this.track(e.subscribe(c=>{this._updateGrid(c)})),e.get()&&this._updateGrid(e.get());const t=this.navigation.observe("room");this.track(t.subscribe(c=>{this._gridViewModel||this._updateRoom(c),this._updateRightPanel()})),this._gridViewModel||this._updateRoom(t.get());const s=this.navigation.observe("settings");this.track(s.subscribe(c=>{this._updateSettings(c)})),this._updateSettings(s.get());const i=this.navigation.observe("create-room");this.track(i.subscribe(c=>{this._updateCreateRoom(c)})),this._updateCreateRoom(i.get());const r=this.navigation.observe("join-room");this.track(r.subscribe(c=>{this._updateJoinRoom(c)})),this._updateJoinRoom(r.get());const o=this.navigation.observe("lightbox");this.track(o.subscribe(c=>{this._updateLightbox(c)})),this._updateLightbox(o.get());const a=this.navigation.observe("right-panel");this.track(a.subscribe(()=>this._updateRightPanel())),this._updateRightPanel()}_setupForcedLogoutOnAccessTokenInvalidation(){this.track(this._client.sync.status.subscribe(e=>{if(e===L.Stopped&&this._client.sync.error?.errcode==="M_UNKNOWN_TOKEN"){const s=[this.navigation.segment("logout",this.id),this.navigation.segment("forced",!0)],i=this.navigation.pathFrom(s);this.navigation.applyPath(i)}}))}get id(){return this._client.sessionId}start(){this._sessionStatusViewModel.start(),this.features.calls&&(this._client.session.callHandler.loadCalls("m.ring"),this._client.session.callHandler.loadCalls("m.prompt"))}get activeMiddleViewModel(){return this._roomViewModelObservable?.get()||this._gridViewModel||this._settingsViewModel||this._createRoomViewModel||this._joinRoomViewModel}get roomGridViewModel(){return this._gridViewModel}get leftPanelViewModel(){return this._leftPanelViewModel}get sessionStatusViewModel(){return this._sessionStatusViewModel}get settingsViewModel(){return this._settingsViewModel}get currentRoomViewModel(){return this._roomViewModelObservable?.get()}get rightPanelViewModel(){return this._rightPanelViewModel}get createRoomViewModel(){return this._createRoomViewModel}get joinRoomViewModel(){return this._joinRoomViewModel}get toastCollectionViewModel(){return this._toastCollectionViewModel}_updateGrid(e){const t=!(this._gridViewModel&&e),s=this.navigation.path.get("room");if(e)this._gridViewModel?this._gridViewModel.setRoomIds(e):(this._gridViewModel=this.track(new ly(this.childOptions({width:3,height:2,createRoomViewModelObservable:i=>new Uo(this,i)}))),this._roomViewModelObservable?.unsubscribeAll(),this._gridViewModel.initializeRoomIdsAndTransferVM(e,this._roomViewModelObservable)?this._roomViewModelObservable=this.untrack(this._roomViewModelObservable):this._roomViewModelObservable&&(this._roomViewModelObservable=this.disposeTracked(this._roomViewModelObservable)));else if(this._gridViewModel&&!e){if(s){const i=this._gridViewModel.releaseRoomViewModel(s.value);i&&(this._roomViewModelObservable=this.track(i),this._roomViewModelObservable.subscribe(()=>{this.emitChange("activeMiddleViewModel")}))}this._gridViewModel=this.disposeTracked(this._gridViewModel)}t&&this.emitChange("activeMiddleViewModel")}_createRoomViewModelInstance(e){const t=this._client.session.rooms.get(e);if(t){const s=new vi(this.childOptions({room:t,session:this._client.session}));return s.load(),s}return null}_createUnknownRoomViewModel(e,t){return new Tc(this.childOptions({roomIdOrAlias:e,session:this._client.session,isWorldReadablePromise:t}))}async _createWorldReadableRoomViewModel(e){const t=new iy(this.childOptions({room:await this._client.session.loadWorldReadableRoom(e),session:this._client.session}));return t.load(),t}async _createArchivedRoomViewModel(e){const t=await this._client.session.loadArchivedRoom(e);if(t){const s=new vi(this.childOptions({room:t,session:this._client.session}));return s.load(),s}return null}_createInviteViewModel(e){const t=this._client.session.invites.get(e);return t?new ry(this.childOptions({invite:t,mediaRepository:this._client.session.mediaRepository})):null}_createRoomBeingCreatedViewModel(e){const t=this._client.session.roomsBeingCreated.get(e);return t?new oy(this.childOptions({roomBeingCreated:t,mediaRepository:this._client.session.mediaRepository})):null}_updateRoom(e){if(this._roomViewModelObservable?.id===e)return;if(this._roomViewModelObservable&&(this._roomViewModelObservable=this.disposeTracked(this._roomViewModelObservable)),!e){this.emitChange("activeMiddleViewModel");return}const t=new Uo(this,e);this._roomViewModelObservable=this.track(t),this._roomViewModelObservable.subscribe(()=>{this.emitChange("activeMiddleViewModel")}),t.initialize()}_updateSettings(e){this._settingsViewModel&&(this._settingsViewModel=this.disposeTracked(this._settingsViewModel)),e&&(this._settingsViewModel=this.track(new Ac(this.childOptions({client:this._client}))),this._settingsViewModel.load()),this.emitChange("activeMiddleViewModel")}_updateCreateRoom(e){this._createRoomViewModel&&(this._createRoomViewModel=this.disposeTracked(this._createRoomViewModel)),e&&(this._createRoomViewModel=this.track(new my(this.childOptions({session:this._client.session})))),this.emitChange("activeMiddleViewModel")}_updateJoinRoom(e){this._joinRoomViewModel&&(this._joinRoomViewModel=this.disposeTracked(this._joinRoomViewModel)),e&&(this._joinRoomViewModel=this.track(new _y(this.childOptions({session:this._client.session})))),this.emitChange("activeMiddleViewModel")}_updateLightbox(e){if(this._lightboxViewModel&&(this._lightboxViewModel=this.disposeTracked(this._lightboxViewModel)),e){const t=this._roomFromNavigation();this._lightboxViewModel=this.track(new ay(this.childOptions({eventId:e,room:t})))}this.emitChange("lightboxViewModel")}get lightboxViewModel(){return this._lightboxViewModel}_roomFromNavigation(){const e=this.navigation.path.get("room")?.value;return this._client.session.rooms.get(e)}_updateRightPanel(){if(this._rightPanelViewModel=this.disposeTracked(this._rightPanelViewModel),!!this.navigation.path.get("right-panel")?.value){const t=this._roomFromNavigation();this._rightPanelViewModel=this.track(new Sy(this.childOptions({room:t,session:this._client.session})))}this.emitChange("rightPanelViewModel")}notifyRoomReplaced(e,t){this.navigation.push("room",t)}}class Fo extends vi{constructor(e){super(e),this._singleRoomMode=e.singleRoomMode}async load(){super.load()}get urlRouter(){return super.urlRouter}get singleRoomMode(){return this._singleRoomMode}get navigation(){return super.navigation}i18n(e,...t){return super.i18n(e,t)}openDetailsPanel(){super.openDetailsPanel()}get canLeave(){return super.canLeave}get canForget(){return super.canForget}forgetRoom(){super.forgetRoom()}get canRejoin(){return super.canRejoin}rejoinRoom(){super.rejoinRoom()}}class My extends Tc{constructor(e){super(e),this._singleRoomId=e.singleRoomId}get navigation(){return super.navigation}get urlRouter(){return super.urlRouter}get closeUrl(){if(this._singleRoomId){const e=this.navigation.path.with(new pe("session"));return this.urlRouter.urlForPath(e)}return super.closeUrl}}class Cy extends Ac{constructor(e){super(e),this._singleRoomId=e.singleRoomId}async load(){return super.load()}get urlRouter(){return super.urlRouter}get navigation(){return super.navigation}get closeUrl(){if(this.singleRoomMode){const e=this.navigation.path.with(new pe("room",this._singleRoomId));return this.urlRouter.urlForPath(e)}return super.closeUrl}get singleRoomMode(){return!!this._singleRoomId}}class Ty extends Ey{constructor(e){super(e),this._singleRoomId=e.singleRoomId}get id(){return super.id}start(){super.start()}i18n(e,...t){return super.i18n(e,t)}get activeMiddleViewModel(){return super.activeMiddleViewModel}get roomGridViewModel(){return super.roomGridViewModel}get leftPanelViewModel(){return super.leftPanelViewModel}get sessionStatusViewModel(){return super.sessionStatusViewModel}get currentRoomViewModel(){return this._roomViewModelObservable?.get()}get rightPanelViewModel(){return super.rightPanelViewModel}get createRoomViewModel(){return super.createRoomViewModel}get joinRoomViewModel(){return super.joinRoomViewModel}_updateSettings(e){this.settingsViewModel&&(this.settingsViewModel=super.disposeTracked(super.settingsViewModel)),e&&(this.settingsViewModel=super.track(new Cy(super.childOptions({client:this.client,singleRoomId:this._singleRoomId}))),this.settingsViewModel.load()),super.emitChange("activeMiddleViewModel")}get settingsViewModel(){return this._settingsViewModel}set settingsViewModel(e){this._settingsViewModel=e}dispose(){super.dispose()}get client(){return this._client}_createRoomViewModelInstance(e){const t=this.client.session.rooms.get(e);if(t){const s=new Fo(super.childOptions({room:t,singleRoomMode:this._singleRoomId!==void 0}));return s.load(),s}return null}async _createArchivedRoomViewModel(e){const t=await this.client.session.loadArchivedRoom(e);if(t){const s=new Fo(super.childOptions({room:t}));return s.load(),s}return null}async _createUnknownRoomViewModel(e,t){return new My(super.childOptions({roomIdOrAlias:e,session:this.client.session,isWorldReadablePromise:t,guestJoinAllowed:!1,singleRoomId:this._singleRoomId}))}}class Ay extends k{constructor(e){super(e),this._resolvedSingleRoomId=void 0,this._singleRoomIdOrAlias=this.platform.config.roomId}get activeSection(){return this._error?U.Error:this._loginViewModel?U.Login:this._logoutViewModel?U.Logout:this._forcedLogoutViewModel?U.ForcedLogout:this._sessionPickerViewModel?U.SessionPicker:this._sessionLoadViewModel?U.SessionLoading:this._sessionViewModel?U.Session:this._unknownRoomViewModel?U.UnknownRoom:U.Redirecting}get loginViewModel(){return this._loginViewModel}get logoutViewModel(){return this._logoutViewModel}get forcedLogoutViewModel(){return this._forcedLogoutViewModel}get sessionPickerViewModel(){return this._sessionPickerViewModel}get sessionLoadViewModel(){return this._sessionLoadViewModel}get unknownRoomViewModel(){return this._unknownRoomViewModel}get sessionViewModel(){return this._sessionViewModel}get error(){return this._error}get singleRoomMode(){return!!this._singleRoomIdOrAlias}async start(){return Fl().forEach(e=>{this.track(this.navigation.observe(e).subscribe(()=>void this._applyNavigation(!1)))}),this.track(this.navigation.observe("sso").subscribe(()=>void this._applyNavigation(!1))),this._applyNavigation(!0)}async _applyNavigation(e){const t=this.navigation.path.get("login"),s=this.navigation.path.get("logout")?.value,i=this.navigation.path.get("forced")?.value,r=this.navigation.path.get("sso")?.value;let o=this.navigation.path.get("session")?.value;if(o===!0&&(o=null),t)this.activeSection!==U.Login&&this._showLogin(void 0);else if(s&&i)this.activeSection!==U.ForcedLogout&&this._showForcedLogout(s);else if(s)this.activeSection!==U.Logout&&this._showLogout(s);else if(o){const a=await this.getSingleRoomId();if(a&&this.navigation.push("room",a),!this._sessionViewModel||this._sessionViewModel.id!==o)if(this._pendingClient&&this._pendingClient.sessionId===o){const c=this._pendingClient;this._pendingClient=null,await this._showSession(c)}else this._pendingClient&&(this._pendingClient.dispose(),this._pendingClient=null),await this._showSessionLoader(o)}else if(r)this.urlRouter.normalizeUrl(),this.activeSection!==U.Login&&this._showLogin(r);else try{await this._showInitialScreen()}catch(a){console.error(a),this._setSection(()=>this._error=a)}}async _showInitialScreen(){let e=await this.platform.sessionInfoStorage.getAll();if(e.length>1){for(let i=0;i<e.length-1;i++)await this.platform.sessionInfoStorage.delete(e[i].id);e=await this.platform.sessionInfoStorage.getAll(),e.length>1&&console.error("Expected to have a single session, but multiple sessions were found.")}let t=e.length>1;if(this.platform.history.getLastSessionUrl()==="#/session"&&(t=!1),!(t&&this.urlRouter.tryRestoreLastUrl())){if(e.length===1){this.navigation.push(U.Session,e[0].id);return}this.navigation.push(U.Login)}}async resolveRoomAlias(e){if(e.startsWith("!"))return e;const t=await za(e.split(":")[1],this.platform.request);return(await new $e({homeserver:t,request:this.platform.request,accessToken:"",reconnector:this.platform.reconnector}).resolveRoomAlias(e).response()).room_id}_showLogin(e){this._setSection(()=>{const t=this.childOptions({defaultHomeserver:this.platform.config.defaultHomeserver,ready:s=>{this._pendingClient=s,this.navigation.push("session",s.sessionId)},loginToken:e});this._loginViewModel=new Xg(t)})}_showLogout(e){this._setSection(()=>{this._logoutViewModel=new Zg(this.childOptions({sessionId:e}))})}_showForcedLogout(e){this._setSection(()=>{this._forcedLogoutViewModel=new Wg(this.childOptions({sessionId:e}))})}async _showPicker(){this._setSection(()=>{this._sessionPickerViewModel=new sf(this.childOptions({}))});try{await this._sessionPickerViewModel.load()}catch(e){this._setSection(()=>this._error=e)}}async _showSessionLoader(e){const t=new Ei(this.platform,this.features);await t.startWithExistingSession(e),this._setSection(()=>{this._sessionLoadViewModel=new bc(this.childOptions({client:t,ready:s=>this._showSession(s)})),this._sessionLoadViewModel.start()})}async _showSession(e){const t=await this.getSingleRoomId();this._setSection(()=>{this._sessionViewModel=new Ty(this.childOptions({client:e,singleRoomId:t})),this._sessionViewModel.start()})}_setSection(e){this._error=void 0,this._sessionPickerViewModel=this.disposeTracked(this._sessionPickerViewModel),this._sessionLoadViewModel=this.disposeTracked(this._sessionLoadViewModel),this._loginViewModel=this.disposeTracked(this._loginViewModel),this._logoutViewModel=this.disposeTracked(this._logoutViewModel),this._forcedLogoutViewModel=this.disposeTracked(this._forcedLogoutViewModel),this._sessionViewModel=this.disposeTracked(this._sessionViewModel),e(),this._sessionPickerViewModel&&this.track(this._sessionPickerViewModel),this._sessionLoadViewModel&&this.track(this._sessionLoadViewModel),this._loginViewModel&&this.track(this._loginViewModel),this._logoutViewModel&&this.track(this._logoutViewModel),this._forcedLogoutViewModel&&this.track(this._forcedLogoutViewModel),this._sessionViewModel&&this.track(this._sessionViewModel),this.emitChange("activeSection")}async getSingleRoomId(){if(!this._singleRoomIdOrAlias||this._singleRoomIdOrAlias==="")return null;if(this._resolvedSingleRoomId===void 0)try{this._resolvedSingleRoomId=await this.resolveRoomAlias(this._singleRoomIdOrAlias)}catch(e){console.warn(e),this._resolvedSingleRoomId=null}return this._resolvedSingleRoomId}get platform(){return super.platform}}class xy extends Kr{constructor(e,t){super(e,t)}_toggleOptionsMenu(e){if(super._optionsPopup&&super._optionsPopup.isOpen)super._optionsPopup.close();else{const t=super.value,s=[];if(s.push(O.option(t.i18n`Room details`,()=>t.openDetailsPanel())),t.canLeave&&s.push(O.option(t.i18n`Leave room`,()=>super._confirmToLeaveRoom()).setDestructive()),t.canForget&&s.push(O.option(t.i18n`Forget room`,()=>t.forgetRoom()).setDestructive()),t.canRejoin&&s.push(O.option(t.i18n`Rejoin room`,()=>t.rejoinRoom())),t.singleRoomMode&&s.push(O.option(t.i18n`Settings`,()=>t.navigation.push("settings"))),!s.length)return;const i=new es(new O(s));i.trackInTemplateView(this),i.showRelativeTo(e.target,10),super._optionsPopup=i}}}class Ny extends xa{constructor(e){super(e)}render(e,t){return e.div({className:{SessionView:!0,"middle-shown":s=>!!s.activeMiddleViewModel,"right-shown":s=>!!s.rightPanelViewModel}},[e.view(new Sa(t.sessionStatusViewModel)),e.view(new pa(t.leftPanelViewModel)),e.mapView(s=>s.activeMiddleViewModel,()=>t.roomGridViewModel?new Ia(t.roomGridViewModel,ks):t.settingsViewModel?new Ma(t.settingsViewModel):t.createRoomViewModel?new Ca(t.createRoomViewModel):t.joinRoomViewModel?new Aa(t.joinRoomViewModel):t.currentRoomViewModel?t.currentRoomViewModel.kind==="invite"?new qr(t.currentRoomViewModel):t.currentRoomViewModel.kind==="room"?new xy(t.currentRoomViewModel,ks):t.currentRoomViewModel.kind==="roomBeingCreated"?new jr(t.currentRoomViewModel):t.currentRoomViewModel.kind==="preview"?new wa(t.currentRoomViewModel):new $r(t.currentRoomViewModel):new Xe(s=>s.div({className:"room-placeholder"},s.h2(t.i18n`Choose a room on the left side.`)))),e.mapView(s=>s.lightboxViewModel,s=>s?new ba(s):null),e.mapView(s=>s.rightPanelViewModel,s=>s?new Ta(s):null)])}}class Dy extends b{constructor(e){super(e)}render(e,t){return e.div({className:{RootView:!0,"single-room-mode":t.singleRoomMode}},e.mapView(s=>s.activeSection,s=>{switch(s){case U.Login:return new Da(t.loginViewModel);case U.Logout:return new Va(t.logoutViewModel);case U.ForcedLogout:return new Pa(t.forcedLogoutViewModel);case U.Session:return new Ny(t.sessionViewModel);case U.SessionPicker:return new Oa(t.sessionPickerViewModel);case U.Redirecting:return new Xe(i=>i.p("Loading..."));case U.SessionLoading:return new La(t.sessionLoadViewModel);case U.UnknownRoom:return new $r(t.unknownRoomViewModel);case U.Error:return new Xe(i=>i.div({className:"StatusView"},[i.h1("Something went wrong"),i.p(t.error?.message)]));default:throw new Error(`Unknown section: ${t.activeSection}`)}}))}}class Vy{constructor(e){if(this._rootNode=document.querySelector(`#${e}`),!this._rootNode)throw new Error(`Element with id #${e} not found.`);this._rootNode.className="hydrogen",this._platform=new pp({container:this._rootNode,assetPaths:jo,config:{bugReportEndpointUrl:null,...Ul.fromQueryParams()},options:{development:!1}}),this._navigation=Bl(),this._router=new _p(this._platform.history,this._navigation,Cl,Tl),this._router.attach()}async start(){await this._platform.init(),this._platform.setNavigation(this._navigation);const e=await kt.load(this._platform.settingsStorage);this._rootViewModel=new Ay({logger:new $o,platform:this._platform,navigation:this._navigation,urlRouter:this._router,features:e});const t=new Dy(this._rootViewModel);return this._rootNode.appendChild(t.mount()),this._rootViewModel.start()}}const Py=new Vy("root");Py.start().catch(n=>{throw new Error("Failed to start app: "+n)});
